@page "/reset-password"
@using System.ComponentModel.DataAnnotations
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.WebUtilities

<div class="login-container">
    <div class="login-card">
        <h1 class="text-center mb-4">Redefinir Palavra-passe</h1>

        @if (!loaded)
        {
            <p class="text-center">A carregar...</p>
        }
        else if (string.IsNullOrEmpty(Email) || string.IsNullOrEmpty(Token))
        {
            <div class="alert alert-danger">Link de redefinição de palavra-passe inválido.</div>
            <div class="text-center mt-3">
                <a href="/login">Voltar ao Login</a>
            </div>
        }
        else
        {
            @if (!string.IsNullOrEmpty(Message))
            {
                <div class="alert @(ResetSucceeded ? "alert-success" : "alert-danger") mb-3">@Message</div>
            }

            @if (!ResetSucceeded)
            {
                <EditForm Model="model" OnValidSubmit="HandleReset" FormName="ResetPasswordForm">
                    <DataAnnotationsValidator />
                    <ErrorDisplay />
                    <div class="mb-3">
                        <label class="form-label" for="email">Email</label>
                        <InputText id="email" class="form-control" @bind-Value="model.Email" disabled />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="password">Nova Palavra-passe</label>
                        <InputText id="password" type="password" class="form-control" @bind-Value="model.Password" placeholder="Inserir nova palavra-passe..." />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="confirmPassword">Confirmar Palavra-passe</label>
                        <InputText id="confirmPassword" type="password" class="form-control" @bind-Value="model.ConfirmPassword" placeholder="Confirmar palavra-passe..." />
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-primary-purple">Redefinir Palavra-passe</button>
                    </div>
                    <div class="text-center mt-3">
                        <a href="/login">Voltar ao Login</a>
                    </div>
                </EditForm>
            }
            else
            {
                <div class="text-center mt-3">
                    <a href="/login" class="btn btn-primary btn-primary-purple">Ir para o Login</a>
                </div>
            }
        }
    </div>
</div>

@code {
    private bool loaded = false;
    private string? Email;
    private string? Token;
    [SupplyParameterFromForm]
    private ResetModel model { get; set; } = new();
    private string? Message;
    private bool ResetSucceeded;

    public class ResetModel
    {
        [Required(ErrorMessage = "O email é obrigatório")]
        [EmailAddress(ErrorMessage = "Por favor, introduza um email válido")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "A palavra-passe é obrigatória")]
        [StringLength(100, ErrorMessage = "A {0} deve ter pelo menos {2} caracteres.", MinimumLength = 8)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "A confirmação de palavra-passe é obrigatória")]
        [DataType(DataType.Password)]
        [Compare("Password", ErrorMessage = "A palavra-passe e a confirmação não coincidem.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("email", out var email))
        {
            Email = email!;
            model.Email = Email;
        }
        if (query.TryGetValue("code", out var code))
        {
            // Don't double-decode - QueryHelpers already decodes the query string
            Token = code!;
        }
        loaded = true;
    }

    private async Task HandleReset()
    {
        Message = null;
        ResetSucceeded = false;
        if (Email == null || Token == null)
        {
            Message = "Token de redefinição de palavra-passe inválido.";
            return;
        }
        var user = await UserManager.FindByEmailAsync(Email);
        if (user == null)
        {
            // Do not reveal that the user does not exist
            Message = "Redefinição de palavra-passe concluída.";
            ResetSucceeded = true;
            return;
        }
        var result = await UserManager.ResetPasswordAsync(user, Token, model.Password);
        if (result.Succeeded)
        {
            Message = "A sua palavra-passe foi redefinida com sucesso. Pode agora fazer login com a nova palavra-passe.";
            ResetSucceeded = true;
        }
        else
        {
            Message = string.Join("; ", result.Errors.Select(e => e.Description));
        }
    }
}