@page "/forgot-password"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity.UI.Services
@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender EmailSender
@inject NavigationManager NavigationManager

<div class="login-container">
    <div class="login-card">
        <h1 class="text-center mb-4">Esqueceu a sua palavra-passe?</h1>

        @if (!string.IsNullOrEmpty(Message))
        {
            <div class="alert alert-info">@Message</div>
        }

        <EditForm Model="model" OnValidSubmit="SendReset" FormName="ForgotPasswordForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <InputText id="email" class="form-control" @bind-Value="model.Email" placeholder="Inserir email..." />
                <ValidationMessage For="() => model.Email" class="text-danger" />
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-primary-purple">Enviar email de recuperação</button>
            </div>
            <div class="text-center mt-3">
                <a href="/login">Voltar ao Login</a>
            </div>
        </EditForm>
    </div>
</div>


@code {
    [SupplyParameterFromForm]
    private InputModel model { get; set; } = new();
    private string? Message;

    public class InputModel
    {
        [Required(ErrorMessage = "O email é obrigatório")]
        [EmailAddress(ErrorMessage = "Por favor, introduza um email válido")]
        public string Email { get; set; } = string.Empty;
    }

    private async Task SendReset()
    {
        var user = await UserManager.FindByEmailAsync(model.Email);
        if (user == null || !(await UserManager.IsEmailConfirmedAsync(user)))
        {
            // Do not reveal that the user does not exist or is not confirmed
            Message = "Se existir uma conta para este email, foi enviado um link de recuperação de palavra-passe.";
            return;
        }
        var token = await UserManager.GeneratePasswordResetTokenAsync(user);
        var encodedToken = System.Net.WebUtility.UrlEncode(token);
        var encodedEmail = System.Net.WebUtility.UrlEncode(model.Email);
        var callbackUrl = $"{NavigationManager.BaseUri.TrimEnd('/')}/reset-password?code={encodedToken}&email={encodedEmail}";
        await EmailSender.SendEmailAsync(model.Email, "Recuperação de palavra-passe", $"Por favor, redefina a sua palavra-passe clicando aqui: <a href='{callbackUrl}'>link</a>");
        Message = "Se existir uma conta para este email, foi enviado um link de recuperação de palavra-passe.";
    }
}