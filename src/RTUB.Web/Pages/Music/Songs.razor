@page "/music/songs/{AlbumId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Extensions.Logging
@using RTUB.Application.Interfaces
@using RTUB.Shared
@inject IAlbumService AlbumService
@inject ISongService SongService
@inject IAudioStorageService AudioStorageService
@inject ILyricStorageService LyricStorageService
@inject ILogger<Songs> Logger
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (album == null)
{
    <p>A carregar...</p>
}
else
{
    <div class="mb-4">
        <button class="btn btn-outline-light btn-sm mb-3" @onclick="GoBack">
            <i class="bi bi-arrow-left"></i>
        </button>

        <div class="text-center">
            @if (!string.IsNullOrEmpty(album.CoverImageSrc))
            {
                <img src="@GetAlbumImageUrl(album.CoverImageSrc)" class="img-fluid rounded shadow music-album-image" alt="@album.Title" >
            }
            else
            {
                <div class="album-cover-small mx-auto">
                    <i class="bi bi-disc music-icon-medium"></i>
                </div>
            }
            <h1 class="mt-3 music-text-light">@album.Title</h1>
            <p class="lead music-text-secondary">@album.Year</p>
            @if (!string.IsNullOrEmpty(album.Description))
            {
                <p class="music-text-secondary">@album.Description</p>
            }
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Faixas</h3>
        <AuthorizeView Roles="Owner">
            <Authorized>
                <button class="btn btn-success btn-sm" @onclick="OpenCreateSongModal" title="Criar Nova Música">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </Authorized>
        </AuthorizeView>
    </div>

    @if (songs == null)
    {
        <div class="song-grid">
            @for (int i = 0; i < 6; i++)
            {
                <SongCardSkeleton />
            }
        </div>
    }
    else if (!songs.Any())
    {
        <EmptyTableState Message="Nenhuma música neste álbum."
                        IconClass="bi-music-note-list"
                        SubMessage="Adicione músicas para começar." />
    }
    else
    {
        <div class="song-grid">
            @foreach (var song in songs.OrderBy(s => s.TrackNumber))
            {
                <SongCard Song="@song" 
                         IsOwner="@isOwner"
                         OnPlay="@(() => PlaySong(song))"
                         OnViewLyric="@(() => OpenViewLyricsModal(song))"
                         OnViewLinks="@(() => OpenLinksModal(song))"
                         OnEdit="@(() => OpenEditModal(song))"
                         OnDelete="@(() => OpenDeleteSongModal(song))" />
            }
        </div>
    }
}

<!-- Fixed Audio Player -->
@if (!string.IsNullOrEmpty(currentAudioUrl))
{
    <div class="fixed-audio-player">
        <div class="audio-player-content">
            <div class="audio-info">
                <i class="bi bi-music-note-beamed me-2"></i>
                <span class="audio-title">@currentSongTitle</span>
            </div>
            <audio controls autoplay @key="currentAudioUrl" class="audio-element">
                <source src="@currentAudioUrl" type="audio/mpeg">
                Seu navegador não suporta o elemento de áudio.
            </audio>
            <button class="btn btn-sm btn-outline-light" @onclick="StopAudio" title="Fechar">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
}

<!-- View Lyrics Modal -->
<Modal Show="@showViewLyricsModal" 
       ShowChanged="@((value) => showViewLyricsModal = value)"
       Title="@($"Letra - {viewingSong?.Title}")" 
       Size="Modal.ModalSize.Large" 
       Centered="true"
       OnClose="@CloseViewLyricsModal">
    <BodyContent>
        <div class="lyrics-display">
            @viewingSong?.Lyrics
        </div>
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseViewLyricsModal">Fechar</button>
    </FooterContent>
</Modal>

<!-- View Lyrics PDF Modal -->
<Modal Show="@showViewLyricsPdfModal" 
       ShowChanged="@((value) => showViewLyricsPdfModal = value)"
       Title="@($"Letra - {viewingSong?.Title}")" 
       Size="Modal.ModalSize.ExtraLarge" 
       Centered="true"
       OnClose="@CloseViewLyricsPdfModal">
    <BodyContent>
        @if (isLoadingPdf)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">A carregar...</span>
                </div>
                <p class="mt-3">A carregar PDF...</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(currentPdfUrl))
        {
            <div class="pdf-viewer-container" style="height: 80vh;">
                <iframe src="@(currentPdfUrl + "#toolbar=0&navpanes=0&scrollbar=0")" 
                        style="width: 100%; height: 100%; border: none;"
                        title="@($"Letra - {viewingSong?.Title}")">
                </iframe>
            </div>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseViewLyricsPdfModal">Fechar</button>
    </FooterContent>
</Modal>


<!-- Links Modal -->
<Modal Show="@showLinksModal" 
       ShowChanged="@((value) => showLinksModal = value)"
       Title="@($"Links - {viewingSong?.Title}")" 
       Centered="true"
       OnClose="@CloseLinksModal">
    <BodyContent>
        <div class="d-grid gap-3">
            @if (viewingSong != null)
            {
                @if (!string.IsNullOrEmpty(viewingSong.SpotifyUrl))
                {
                    <a href="@viewingSong.SpotifyUrl" target="_blank" class="btn btn-success d-flex align-items-center justify-content-center gap-2">
                        <i class="bi bi-spotify music-icon-social"></i>
                        <span>Abrir no Spotify</span>
                    </a>
                }
                @if (viewingSong.YouTubeUrls != null && viewingSong.YouTubeUrls.Any())
                {
                    foreach (var youtubeUrl in viewingSong.YouTubeUrls)
                    {
                        <a href="@youtubeUrl.Url" target="_blank" class="btn btn-danger d-flex align-items-center justify-content-center gap-2">
                            <i class="bi bi-youtube music-icon-social"></i>
                            <span>Abrir no YouTube</span>
                        </a>
                    }
                }
                @if (string.IsNullOrEmpty(viewingSong.SpotifyUrl) && (viewingSong.YouTubeUrls == null || !viewingSong.YouTubeUrls.Any()))
                {
                    <EmptyTableState Message="Nenhum link disponível para esta música."
                                    IconClass="bi-link-45deg" />
                }
            }
        </div>
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseLinksModal">Fechar</button>
    </FooterContent>
</Modal>

<!-- Create Song Modal -->
<Modal Show="@showCreateModal" 
       ShowChanged="@((value) => showCreateModal = value)"
       Title="Criar Nova Música" 
       Size="Modal.ModalSize.Large" 
       Centered="true"
       ShowCloseButton="false">
    <BodyContent>
        <EditForm Model="editingSong" OnValidSubmit="CreateSong">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="row">
                <div class="col-md-8 mb-3">
                    <label class="form-label">Título <span class="text-danger">*</span></label>
                    <InputText class="form-control" @bind-Value="editingSong!.Title" placeholder="Inserir título da música..." />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Número da Faixa</label>
                    <InputNumber class="form-control" @bind-Value="editingSong!.TrackNumber" placeholder="Ex: 1" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Autor (Letra)</label>
                    <InputText class="form-control" @bind-Value="editingSong!.LyricAuthor" placeholder="Inserir autor da letra..." />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Autor (Música)</label>
                    <InputText class="form-control" @bind-Value="editingSong!.MusicAuthor" placeholder="Inserir autor da música..." />
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Adaptação</label>
                <InputText class="form-control" @bind-Value="editingSong!.Adaptation" placeholder="Inserir adaptação..." />
            </div>

            <div class="mb-3">
                <label class="form-label">Spotify URL</label>
                <InputText class="form-control" @bind-Value="editingSong!.SpotifyUrl" placeholder="Inserir URL do Spotify..." />
            </div>

            <div class="mb-3">
                <div class="form-check">
                    <InputCheckbox class="form-check-input" id="createHasMusic" @bind-Value="editingSong!.HasMusic" />
                    <label class="form-check-label" for="createHasMusic">
                        Tem ficheiro de música disponível
                    </label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">YouTube URLs</label>
                @if (editingYouTubeUrls != null)
                {
                    @for (int i = 0; i < editingYouTubeUrls.Count; i++)
                    {
                        var index = i;
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" @bind="editingYouTubeUrls[index]" placeholder="Inserir URL do YouTube..." />
                            <button type="button" class="btn btn-danger" @onclick="() => RemoveYouTubeUrl(index)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    }
                }
                <button type="button" class="btn btn-secondary btn-sm" @onclick="AddYouTubeUrl">
                    <i class="bi bi-plus-circle"></i> Adicionar YouTube URL
                </button>
            </div>

            <div class="mb-3">
                <label class="form-label">Letra</label>
                <InputTextArea class="form-control" rows="15" @bind-Value="editingSong!.Lyrics" placeholder="Inserir letra da música..." />
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" @onclick="CloseCreateModal">Cancelar</button>
                <button type="submit" class="btn btn-success">Criar</button>
            </div>
        </EditForm>
    </BodyContent>
</Modal>

<!-- Edit Song Modal -->
<Modal Show="@showEditModal" 
       ShowChanged="@((value) => showEditModal = value)"
       Title="Editar Música" 
       Size="Modal.ModalSize.Large" 
       Centered="true"
       ShowCloseButton="false">
    <BodyContent>
        <EditForm Model="editingSong" OnValidSubmit="SaveSong">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Título</label>
                    <InputText class="form-control" @bind-Value="editingSong!.Title" readonly />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Autor (Letra)</label>
                    <InputText class="form-control" @bind-Value="editingSong!.LyricAuthor" placeholder="Inserir autor da letra..." />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Autor (Música)</label>
                    <InputText class="form-control" @bind-Value="editingSong!.MusicAuthor" placeholder="Inserir autor da música..." />
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Adaptação</label>
                <InputText class="form-control" @bind-Value="editingSong!.Adaptation" placeholder="Inserir adaptação..." />
            </div>

            <div class="mb-3">
                <label class="form-label">Spotify URL</label>
                <InputText class="form-control" @bind-Value="editingSong!.SpotifyUrl" placeholder="Inserir URL do Spotify..." />
            </div>

            <div class="mb-3">
                <div class="form-check">
                    <InputCheckbox class="form-check-input" id="editHasMusic" @bind-Value="editingSong!.HasMusic" />
                    <label class="form-check-label" for="editHasMusic">
                        Tem ficheiro de música disponível
                    </label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">YouTube URLs</label>
                @if (editingYouTubeUrls != null)
                {
                    @for (int i = 0; i < editingYouTubeUrls.Count; i++)
                    {
                        var index = i;
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" @bind="editingYouTubeUrls[index]" placeholder="Inserir URL do YouTube..." />
                            <button type="button" class="btn btn-danger" @onclick="() => RemoveYouTubeUrl(index)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    }
                }
                <button type="button" class="btn btn-secondary btn-sm" @onclick="AddYouTubeUrl">
                    <i class="bi bi-plus-circle"></i> Adicionar YouTube URL
                </button>
            </div>

            <div class="mb-3">
                <label class="form-label">Letra</label>
                <InputTextArea class="form-control" rows="15" @bind-Value="editingSong!.Lyrics" placeholder="Inserir letra da música..." />
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancelar</button>
                <button type="submit" class="btn btn-success">Guardar</button>
            </div>
        </EditForm>
    </BodyContent>
</Modal>

<!-- Delete Song Confirmation Modal -->
<Modal Show="@showDeleteModal" 
       ShowChanged="@((value) => showDeleteModal = value)"
       Title="Confirmar Eliminação" 
       Centered="true"
       OnClose="@CloseDeleteModal">
    <BodyContent>
        <p>Tem certeza que deseja eliminar a música <strong>@deletingSong?.Title</strong>?</p>
        <p class="text-warning"><i class="bi bi-exclamation-triangle"></i> Esta ação não pode ser revertida.</p>
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal">Cancelar</button>
        <button type="button" class="btn btn-danger" @onclick="DeleteSong">Eliminar</button>
    </FooterContent>
</Modal>

@code {
    [Parameter]
    public int AlbumId { get; set; }

    private Album? album;
    private List<Song>? songs;
    private long albumImageVersion = DateTime.UtcNow.Ticks;

    private bool showCreateModal = false;
    private bool showEditModal = false;
    private bool showViewLyricsModal = false;
    private bool showViewLyricsPdfModal = false;
    private bool showLinksModal = false;
    private bool showDeleteModal = false;
    private Song? editingSong;
    private Song? viewingSong;
    private Song? deletingSong;
    private List<string> editingYouTubeUrls = new();
    private bool isOwner = false;
    
    // Audio player state
    private string? currentAudioUrl;
    private string? currentSongTitle;
    
    // PDF viewer state
    private bool isLoadingPdf = false;
    private string? currentPdfUrl;
    
    // URL cache for performance (session-based)
    private Dictionary<string, string> urlCache = new();

    protected override async Task OnInitializedAsync()
    {
        album = await AlbumService.GetAlbumByIdAsync(AlbumId);
        albumImageVersion = DateTime.UtcNow.Ticks;
        await LoadSongs();
        
        // Check if user is Owner
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isOwner = user.IsInRole("Owner");
    }

    private async Task LoadSongs()
    {
        songs = (await SongService.GetSongsByAlbumIdAsync(AlbumId))
            .OrderBy(s => s.TrackNumber)
            .ToList();
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/music");
    }

    private async Task OpenEditModal(Song song)
    {
        var fullSong = await SongService.GetSongByIdAsync(song.Id);

        if (fullSong != null)
        {
            editingSong = new Song
            {
                Id = fullSong.Id,
                AlbumId = fullSong.AlbumId,
                TrackNumber = fullSong.TrackNumber,
                Title = fullSong.Title,
                LyricAuthor = fullSong.LyricAuthor,
                MusicAuthor = fullSong.MusicAuthor,
                Adaptation = fullSong.Adaptation,
                SpotifyUrl = fullSong.SpotifyUrl,
                Lyrics = fullSong.Lyrics,
                Duration = fullSong.Duration,
                HasMusic = fullSong.HasMusic
            };

            editingYouTubeUrls = fullSong.YouTubeUrls?.Select(y => y.Url).ToList() ?? new List<string>();
            if (!editingYouTubeUrls.Any())
            {
                editingYouTubeUrls.Add(string.Empty);
            }

            showEditModal = true;
        }
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingSong = null;
        editingYouTubeUrls.Clear();
    }

    private async Task OpenViewLyricsModal(Song song)
    {
        viewingSong = song;
        
        // First, try to load PDF from S3 with caching
        try
        {
            if (album != null && !string.IsNullOrEmpty(album.Title))
            {
                isLoadingPdf = true;
                showViewLyricsPdfModal = true;
                StateHasChanged();
                
                // Check cache first
                string cacheKey = $"lyric_{album.Title}_{song.Title}";
                string? pdfUrl = null;
                
                if (urlCache.TryGetValue(cacheKey, out var cachedUrl))
                {
                    pdfUrl = cachedUrl;
                }
                else
                {
                    pdfUrl = await LyricStorageService.GetLyricPdfUrlAsync(album.Title, song.Title);
                    
                    // Cache the URL for session
                    if (!string.IsNullOrEmpty(pdfUrl))
                    {
                        urlCache[cacheKey] = pdfUrl;
                    }
                }
                
                if (!string.IsNullOrEmpty(pdfUrl))
                {
                    currentPdfUrl = pdfUrl;
                    isLoadingPdf = false;
                    StateHasChanged();
                    return;
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading PDF from S3 for song: {SongTitle} in album: {AlbumTitle}", 
                song.Title, album?.Title ?? "Unknown");
        }
        
        // Fallback to DB text modal if PDF not found or error occurred
        // Fetch full song details (including lyrics) from database
        viewingSong = await SongService.GetSongByIdAsync(song.Id);
        
        // Don't clear viewingSong - just hide the PDF modal
        showViewLyricsPdfModal = false;
        isLoadingPdf = false;
        currentPdfUrl = null;
        
        showViewLyricsModal = true;
    }

    private void CloseViewLyricsModal()
    {
        showViewLyricsModal = false;
        viewingSong = null;
    }
    
    private void CloseViewLyricsPdfModal()
    {
        showViewLyricsPdfModal = false;
        isLoadingPdf = false;
        currentPdfUrl = null;
        viewingSong = null;
    }

    private async Task OpenLinksModal(Song song)
    {
        viewingSong = await SongService.GetSongByIdAsync(song.Id);
        showLinksModal = true;
    }

    private void CloseLinksModal()
    {
        showLinksModal = false;
        viewingSong = null;
    }

    private void AddYouTubeUrl()
    {
        editingYouTubeUrls.Add(string.Empty);
    }

    private void RemoveYouTubeUrl(int index)
    {
        if (editingYouTubeUrls.Count > index)
        {
            editingYouTubeUrls.RemoveAt(index);
        }
    }

    private async Task SaveSong()
    {
        if (editingSong == null) return;

        // Check if user has Owner role
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (!user.IsInRole("Owner"))
        {
            return; // Unauthorized
        }

        var existing = await SongService.GetSongByIdAsync(editingSong.Id);

        if (existing != null)
        {
            // Update basic song properties
            await SongService.UpdateSongAsync(
                editingSong.Id,
                editingSong.Title,
                editingSong.TrackNumber,
                editingSong.LyricAuthor,
                editingSong.MusicAuthor,
                editingSong.Adaptation,
                editingSong.Duration
            );

            // Update Spotify URL
            await SongService.SetSongSpotifyUrlAsync(editingSong.Id, editingSong.SpotifyUrl);

            // Update HasMusic
            await SongService.SetSongHasMusicAsync(editingSong.Id, editingSong.HasMusic);

            // Update lyrics
            await SongService.SetSongLyricsAsync(editingSong.Id, editingSong.Lyrics);

            // Update YouTube URLs - remove old ones and add new ones
            var oldUrls = existing.YouTubeUrls?.Select(y => y.Url).ToList() ?? new List<string>();
            var newUrls = editingYouTubeUrls.Where(u => !string.IsNullOrWhiteSpace(u)).Select(u => u.Trim()).ToList();

            // Remove URLs that are no longer in the list
            foreach (var oldUrl in oldUrls)
            {
                if (!newUrls.Contains(oldUrl))
                {
                    await SongService.RemoveYouTubeUrlAsync(editingSong.Id, oldUrl);
                }
            }

            // Add new URLs that weren't in the old list
            foreach (var newUrl in newUrls)
            {
                if (!oldUrls.Contains(newUrl))
                {
                    await SongService.AddYouTubeUrlAsync(editingSong.Id, newUrl);
                }
            }
        }

        await LoadSongs();
        CloseEditModal();
    }

    private void OpenCreateSongModal()
    {
        editingSong = new Song
        {
            AlbumId = AlbumId,
            Title = "",
            TrackNumber = null,
            LyricAuthor = "",
            MusicAuthor = "",
            Adaptation = "",
            SpotifyUrl = "",
            Lyrics = "",
            HasMusic = false
        };

        editingYouTubeUrls = new List<string> { string.Empty };
        showCreateModal = true;
    }

    private void CloseCreateModal()
    {
        showCreateModal = false;
        editingSong = null;
        editingYouTubeUrls.Clear();
    }

    private async Task CreateSong()
    {
        if (editingSong == null || string.IsNullOrWhiteSpace(editingSong.Title)) return;

        // Check if user has Owner role
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (!user.IsInRole("Owner"))
        {
            return; // Unauthorized
        }

        // Create new song
        var newSong = await SongService.CreateSongAsync(
            editingSong.Title.Trim(),
            AlbumId,
            editingSong.TrackNumber
        );

        // Update additional properties
        await SongService.UpdateSongAsync(
            newSong.Id,
            newSong.Title,
            newSong.TrackNumber,
            editingSong.LyricAuthor,
            editingSong.MusicAuthor,
            editingSong.Adaptation,
            editingSong.Duration
        );

        // Set Spotify URL
        if (!string.IsNullOrWhiteSpace(editingSong.SpotifyUrl))
        {
            await SongService.SetSongSpotifyUrlAsync(newSong.Id, editingSong.SpotifyUrl);
        }

        // Set HasMusic
        await SongService.SetSongHasMusicAsync(newSong.Id, editingSong.HasMusic);

        // Set lyrics
        if (!string.IsNullOrWhiteSpace(editingSong.Lyrics))
        {
            await SongService.SetSongLyricsAsync(newSong.Id, editingSong.Lyrics);
        }

        // Add YouTube URLs
        foreach (var url in editingYouTubeUrls.Where(u => !string.IsNullOrWhiteSpace(u)))
        {
            await SongService.AddYouTubeUrlAsync(newSong.Id, url.Trim());
        }

        await LoadSongs();
        CloseCreateModal();
    }

    private void OpenDeleteSongModal(Song song)
    {
        deletingSong = song;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        deletingSong = null;
    }

    private async Task DeleteSong()
    {
        if (deletingSong == null) return;

        // Check if user has Owner role
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (!user.IsInRole("Owner"))
        {
            return; // Unauthorized
        }

        await SongService.DeleteSongAsync(deletingSong.Id);
        await LoadSongs();

        CloseDeleteModal();
    }

    private string GetAlbumImageUrl(string imageSrc)
    {
        // Add cache-busting parameter to force reload after image update
        if (!string.IsNullOrEmpty(imageSrc) && imageSrc.StartsWith("/api/images/"))
        {
            return $"{imageSrc}?v={albumImageVersion}";
        }
        return imageSrc ?? string.Empty;
    }
    
    private async Task PlaySong(Song song)
    {
        try
        {
            // Get album information
            if (album == null)
            {
                Logger.LogWarning("Cannot play song - album information not available");
                return;
            }
            
            // Check cache first for performance
            string cacheKey = $"audio_{album.Title}_{song.TrackNumber}_{song.Title}";
            
            string? audioUrl = null;
            if (urlCache.TryGetValue(cacheKey, out var cachedUrl))
            {
                audioUrl = cachedUrl;
            }
            else
            {
                // Generate pre-signed URL for the audio file (lazy loading - only on play)
                audioUrl = await AudioStorageService.GetAudioUrlAsync(album.Title, song.TrackNumber, song.Title);
                
                // Cache the URL for session
                if (!string.IsNullOrEmpty(audioUrl))
                {
                    urlCache[cacheKey] = audioUrl;
                }
            }
            
            if (!string.IsNullOrEmpty(audioUrl))
            {
                currentAudioUrl = audioUrl;
                currentSongTitle = song.Title;
                StateHasChanged();
            }
            else
            {
                // File not found or error
                Logger.LogWarning("Audio file not found for song: {SongTitle} in album: {AlbumTitle}", 
                    song.Title, album.Title);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error playing song: {SongTitle} in album: {AlbumTitle}", 
                song.Title, album?.Title ?? "Unknown");
        }
    }
    
    private void StopAudio()
    {
        currentAudioUrl = null;
        currentSongTitle = null;
        StateHasChanged();
    }
}

