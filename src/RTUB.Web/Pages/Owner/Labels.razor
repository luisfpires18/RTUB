@page "/owner/labels"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using RTUB.Application.Interfaces
@using RTUB.Shared
@attribute [Authorize(Roles = "Owner")]
@inherits CrudTablePageBase<Label>
@inject ILabelService LabelService

<h1>Gestão de Etiquetas</h1>
<p class="lead mb-4 text-white-full">Gerir etiquetas de texto e conteúdo para o website.</p>

<div class="mb-3">
    <button class="btn btn-success mb-2" @onclick="OpenCreateModal" title="Adicionar Nova Etiqueta">
        <i class="bi bi-plus-lg"></i>
    </button>
</div>

<!-- Search Box -->
<div class="row mb-3">
    <div class="col-md-6">
        <TableSearchBar 
            SearchTerm="@SearchTerm"
            OnSearchChanged="UpdateSearch"
            Placeholder="Pesquisar por referência, título ou conteúdo..." />
    </div>
</div>

@if (AllItems == null)
{
    <p class="text-white-full">A carregar...</p>
}
else if (!PaginatedItems.Any())
{
    <EmptyTableState 
        Message="Nenhuma etiqueta encontrada." 
        IconClass="bi-info-circle" />
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <SortableTableHeader 
                        HeaderText="Referência" 
                        SortColumn="@nameof(Label.Reference)" 
                        CurrentSortColumn="@SortHelper.SortColumn"
                        IsSortAscending="@SortHelper.SortAscending"
                        OnSortChanged="SortBy" />
                    <SortableTableHeader 
                        HeaderText="Título" 
                        SortColumn="@nameof(Label.Title)" 
                        CurrentSortColumn="@SortHelper.SortColumn"
                        IsSortAscending="@SortHelper.SortAscending"
                        OnSortChanged="SortBy" />
                    <SortableTableHeader 
                        HeaderText="Estado" 
                        SortColumn="@nameof(Label.IsActive)" 
                        CurrentSortColumn="@SortHelper.SortColumn"
                        IsSortAscending="@SortHelper.SortAscending"
                        OnSortChanged="SortBy" />
                    <SortableTableHeader 
                        HeaderText="Última Atualização" 
                        SortColumn="@nameof(Label.UpdatedAt)" 
                        CurrentSortColumn="@SortHelper.SortColumn"
                        IsSortAscending="@SortHelper.SortAscending"
                        OnSortChanged="SortBy" />
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var label in PaginatedItems)
                {
                    <tr>
                        <td><code>@label.Reference</code></td>
                        <td>@label.Title</td>
                        <td>
                            @if (label.IsActive)
                            {
                                <span class="badge bg-success">Ativo</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inativo</span>
                            }
                        </td>
                        <td>@(label.UpdatedAt?.ToString("dd/MM/yyyy HH:mm") ?? label.CreatedAt.ToString("dd/MM/yyyy HH:mm"))</td>
                        <td>
                            <button class="btn btn-sm btn-light me-1" @onclick="() => OpenEditModal(label)">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" @onclick="() => OpenDeleteModal(label)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <TablePagination 
        CurrentPage="@PaginationHelper.CurrentPage"
        PageSize="@PaginationHelper.PageSize"
        TotalItems="@FilteredItems.Count"
        ItemLabel="etiquetas"
        OnPageChanged="ChangePage"
        OnPageSizeChanged="ChangePageSize" />
}

<!-- CRUD Modals -->
<CrudModalManager TEntity="Label"
                  ShowEditModal="@showEditModal"
                  ShowEditModalChanged="@((value) => showEditModal = value)"
                  IsCreateMode="@isCreateMode"
                  EditingEntity="@editingLabel"
                  CreateTitle="Nova Etiqueta"
                  EditTitle="Editar Etiqueta"
                  ModalSize="Modal.ModalSize.Large"
                  OnSave="SaveLabel"
                  OnEditModalClosed="() => editingLabel = null"
                  ShowDeleteModal="@showDeleteModal"
                  ShowDeleteModalChanged="@((value) => showDeleteModal = value)"
                  DeletingEntity="@deletingLabel"
                  DeleteTitle="Confirmar Eliminação"
                  OnDelete="DeleteLabel"
                  OnDeleteModalClosed="() => deletingLabel = null">
    <EditFormContent Context="label">
        <EditForm Model="label" OnValidSubmit="SaveLabel">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="mb-3">
                <label class="form-label text-white-full">Referência</label>
                <InputText class="form-control" @bind-Value="label!.Reference" placeholder="Inserir referência..." />
                <small class="text-light-theme">Identificador único para esta etiqueta (minúsculas, sem espaços)</small>
            </div>

            <div class="mb-3">
                <label class="form-label text-white-full">Título</label>
                <InputText class="form-control" @bind-Value="label!.Title" placeholder="Inserir título..." />
            </div>

            <div class="mb-3">
                <label class="form-label text-white-full">Conteúdo</label>
                <InputTextArea class="form-control" rows="15" @bind-Value="label!.Content" placeholder="Inserir conteúdo..." />
                <small class="text-light-theme">Dica: Use quebras de linha para parágrafos</small>
            </div>

            <div class="mb-3 form-check">
                <InputCheckbox class="form-check-input" @bind-Value="label!.IsActive" id="activeCheck" />
                <label class="form-check-label text-white-full" for="activeCheck">
                    Ativo
                </label>
            </div>
        </EditForm>
    </EditFormContent>
    <DeleteConfirmationContent Context="label">
        <p>Tem a certeza que quer eliminar a etiqueta <strong>@label?.Reference</strong>?</p>
        <p class="text-muted">Esta ação não pode ser revertida.</p>
    </DeleteConfirmationContent>
</CrudModalManager>

@code {
    private bool showEditModal = false;
    private bool showDeleteModal = false;
    private bool isCreateMode = false;
    private Label? editingLabel;
    private Label? deletingLabel;

    protected override async Task OnInitializedAsync()
    {
        SortHelper.SortColumn = nameof(Label.Reference);
        await LoadItemsAsync();
        ApplyFiltersAndPagination();
    }

    protected override async Task LoadItemsAsync()
    {
        AllItems = (await LabelService.GetAllLabelsAsync()).ToList();
    }

    protected override Dictionary<string, Func<Label, IComparable>> GetSortColumnSelectors()
    {
        return new Dictionary<string, Func<Label, IComparable>>
        {
            [nameof(Label.Reference)] = l => l.Reference ?? "",
            [nameof(Label.Title)] = l => l.Title ?? "",
            [nameof(Label.IsActive)] = l => l.IsActive ? 1 : 0,
            [nameof(Label.UpdatedAt)] = l => l.UpdatedAt ?? l.CreatedAt
        };
    }

    protected override List<Func<Label, string>> GetSearchSelectors()
    {
        return new List<Func<Label, string>>
        {
            l => l.Reference ?? "",
            l => l.Title ?? "",
            l => l.Content ?? ""
        };
    }

    private void OpenCreateModal()
    {
        isCreateMode = true;
        editingLabel = new Label
        {
            Reference = string.Empty,
            Title = string.Empty,
            Content = string.Empty,
            IsActive = true
        };
        showEditModal = true;
    }

    private void OpenEditModal(Label label)
    {
        isCreateMode = false;
        editingLabel = new Label
        {
            Id = label.Id,
            Reference = label.Reference,
            Title = label.Title,
            Content = label.Content,
            IsActive = label.IsActive,
            UpdatedAt = label.UpdatedAt
        };
        showEditModal = true;
    }

    private async Task SaveLabel()
    {
        if (editingLabel == null) return;

        if (isCreateMode)
        {
            var newLabel = await LabelService.CreateLabelAsync(
                editingLabel.Reference,
                editingLabel.Title,
                editingLabel.Content
            );

            if (editingLabel.IsActive)
            {
                await LabelService.ActivateLabelAsync(newLabel.Id);
            }
        }
        else
        {
            await LabelService.UpdateLabelContentAsync(
                editingLabel.Id,
                editingLabel.Title,
                editingLabel.Content
            );

            if (editingLabel.IsActive)
            {
                await LabelService.ActivateLabelAsync(editingLabel.Id);
            }
            else
            {
                await LabelService.DeactivateLabelAsync(editingLabel.Id);
            }
        }

        await RefreshDataAsync();
        showEditModal = false;
        editingLabel = null;
    }

    private void OpenDeleteModal(Label label)
    {
        deletingLabel = label;
        showDeleteModal = true;
    }

    private async Task DeleteLabel()
    {
        if (deletingLabel == null) return;

        await LabelService.DeleteLabelAsync(deletingLabel.Id);
        await RefreshDataAsync();

        showDeleteModal = false;
        deletingLabel = null;
    }
}
