@page "/owner/labels"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using RTUB.Application.Interfaces
@using RTUB.Shared
@attribute [Authorize(Roles = "Owner")]
@inherits CrudTablePageBase<Label>
@inject ILabelService LabelService

<h1 class="mb-2"><i class="bi bi-tags"></i> Gestão de Etiquetas</h1>
<p class="lead mb-4 text-white-full">Gerir etiquetas de texto e conteúdo para o website.</p>

<div class="mb-3">
    <button class="btn btn-success mb-2" @onclick="OpenCreateModal" title="Adicionar Nova Etiqueta">
        <i class="bi bi-plus-lg"></i>
    </button>
</div>

<!-- Search Box -->
<div class="row mb-3">
    <div class="col-md-6">
        <TableSearchBar 
            SearchTerm="@SearchTerm"
            OnSearchChanged="UpdateSearch"
            Placeholder="Pesquisar por referência, título ou conteúdo..." />
    </div>
</div>

@if (AllItems == null)
{
    <p class="text-white-full">A carregar...</p>
}
else if (!PaginatedItems.Any())
{
    <EmptyState 
        Title="Nenhuma etiqueta encontrada." 
        Icon="bi-info-circle" />
}
else
{
    <div class="label-grid">
        @foreach (var label in PaginatedItems)
        {
            <LabelCard Label="@label"
                      OnViewDetails="@(() => OpenViewDetailsModal(label))"
                      OnEdit="@(() => OpenEditModal(label))"
                      OnDelete="@(() => OpenDeleteModal(label))" />
        }
    </div>

    <!-- Pagination -->
    <TablePagination 
        CurrentPage="@PaginationHelper.CurrentPage"
        PageSize="@PaginationHelper.PageSize"
        TotalItems="@FilteredItems.Count"
        ItemLabel="etiquetas"
        PageSizeOptions="@(new[] { 5, 10, 15, 20, 25 })"
        OnPageChanged="ChangePage"
        OnPageSizeChanged="ChangePageSize" />
}

<!-- View Details Modal using DetailsModal -->
<DetailsModal Show="@showViewDetailsModal" 
              ShowChanged="@((bool show) => showViewDetailsModal = show)" 
              Title="Detalhes da Etiqueta"
              HeaderTitle="@(viewingLabel?.Title ?? "")"
              IconClass="bi-tag-fill"
              OnClose="CloseViewDetailsModal">
    <BadgesContent>
        @if (viewingLabel != null)
        {
            @if (viewingLabel.IsActive)
            {
                <span class="badge bg-success">Ativo</span>
            }
            else
            {
                <span class="badge bg-secondary">Inativo</span>
            }
        }
    </BadgesContent>
    <Sections>
        @if (viewingLabel != null)
        {
            <!-- Label Information Section -->
            <InfoSection SectionTitle="Informação da Etiqueta" 
                        IconClass="bi-info-circle-fill" 
                        CssClass="mb-4">
                <ProfileField Label="Referência">
                    <ValueContent>
                        <code class="bg-dark px-2 py-1 rounded">@viewingLabel.Reference</code>
                    </ValueContent>
                </ProfileField>
                <ProfileField Label="Título" Value="@viewingLabel.Title" />
                <ProfileField Label="Última Atualização" Value="@(viewingLabel.UpdatedAt?.ToString("dd/MM/yyyy HH:mm") ?? viewingLabel.CreatedAt.ToString("dd/MM/yyyy HH:mm"))" />
            </InfoSection>

            <!-- Content Section -->
            <InfoSection SectionTitle="Conteúdo" 
                        IconClass="bi-file-text" 
                        CssClass="mb-3">
                <p class="text-white-full mb-0" style="white-space: pre-line;">@viewingLabel.Content</p>
            </InfoSection>
        }
    </Sections>
</DetailsModal>

<!-- CRUD Modals -->
<CrudModalManager TEntity="Label"
                  ShowEditModal="@showEditModal"
                  ShowEditModalChanged="@((value) => showEditModal = value)"
                  IsCreateMode="@isCreateMode"
                  EditingEntity="@editingLabel"
                  CreateTitle="Nova Etiqueta"
                  EditTitle="Editar Etiqueta"
                  ModalSize="Modal.ModalSize.Large"
                  OnSave="SaveLabel"
                  OnEditModalClosed="() => editingLabel = null"
                  ShowDeleteModal="@showDeleteModal"
                  ShowDeleteModalChanged="@((value) => showDeleteModal = value)"
                  DeletingEntity="@deletingLabel"
                  DeleteTitle="Confirmar Eliminação"
                  OnDelete="DeleteLabel"
                  OnDeleteModalClosed="() => deletingLabel = null">
    <EditFormContent Context="label">
        <EditForm Model="label" @ref="labelEditForm" OnValidSubmit="SaveLabel">
            <DataAnnotationsValidator />
            <ErrorDisplay />

            <div class="mb-3">
                <label class="form-label text-white-full fw-semibold">
                    <i class="bi bi-tag text-primary me-2"></i>Referência
                </label>
                <InputText class="form-control" @bind-Value="label!.Reference" placeholder="Inserir referência..." />
                <small class="text-light-theme">Identificador único para esta etiqueta (minúsculas, sem espaços)</small>
            </div>

            <div class="mb-3">
                <label class="form-label text-white-full fw-semibold">
                    <i class="bi bi-card-text text-primary me-2"></i>Título
                </label>
                <InputText class="form-control" @bind-Value="label!.Title" placeholder="Inserir título..." />
            </div>

            <div class="mb-3">
                <label class="form-label text-white-full fw-semibold">
                    <i class="bi bi-file-text text-primary me-2"></i>Conteúdo
                </label>
                <InputTextArea class="form-control" rows="15" @bind-Value="label!.Content" placeholder="Inserir conteúdo..." />
                <small class="text-light-theme">Dica: Use quebras de linha para parágrafos</small>
            </div>

            <div class="mb-3 form-check">
                <InputCheckbox class="form-check-input" @bind-Value="label!.IsActive" id="activeCheck" />
                <label class="form-check-label text-white-full" for="activeCheck">
                    <i class="bi bi-check-circle text-primary me-2"></i>Ativo
                </label>
            </div>
        </EditForm>
    </EditFormContent>
    <DeleteConfirmationContent Context="label">
        <p>Tem a certeza que quer eliminar a etiqueta <strong>@label?.Reference</strong>?</p>
        <p class="text-muted">Esta ação não pode ser revertida.</p>
    </DeleteConfirmationContent>
</CrudModalManager>

@code {
    private bool showEditModal = false;
    private bool showDeleteModal = false;
    private bool showViewDetailsModal = false;
    private bool isCreateMode = false;
    private Label? editingLabel;
    private Label? deletingLabel;
    private Label? viewingLabel;
    private EditForm? labelEditForm;

    protected override async Task OnInitializedAsync()
    {
        SortHelper.SortColumn = nameof(Label.Reference);
        PaginationHelper.PageSize = 10; // Set default page size to 10
        await LoadItemsAsync();
        ApplyFiltersAndPagination();
    }

    protected override async Task LoadItemsAsync()
    {
        AllItems = (await LabelService.GetAllLabelsAsync()).ToList();
    }

    protected override Dictionary<string, Func<Label, IComparable>> GetSortColumnSelectors()
    {
        return new Dictionary<string, Func<Label, IComparable>>
        {
            [nameof(Label.Reference)] = l => l.Reference ?? "",
            [nameof(Label.Title)] = l => l.Title ?? "",
            [nameof(Label.IsActive)] = l => l.IsActive ? 1 : 0,
            [nameof(Label.UpdatedAt)] = l => l.UpdatedAt ?? l.CreatedAt
        };
    }

    protected override List<Func<Label, string>> GetSearchSelectors()
    {
        return new List<Func<Label, string>>
        {
            l => l.Reference ?? "",
            l => l.Title ?? "",
            l => l.Content ?? ""
        };
    }

    private void OpenViewDetailsModal(Label label)
    {
        viewingLabel = new Label
        {
            Id = label.Id,
            Reference = label.Reference,
            Title = label.Title,
            Content = label.Content,
            IsActive = label.IsActive,
            CreatedAt = label.CreatedAt,
            UpdatedAt = label.UpdatedAt
        };
        showViewDetailsModal = true;
    }

    private void CloseViewDetailsModal()
    {
        showViewDetailsModal = false;
        viewingLabel = null;
    }

    private void OpenCreateModal()
    {
        isCreateMode = true;
        editingLabel = new Label
        {
            Reference = string.Empty,
            Title = string.Empty,
            Content = string.Empty,
            IsActive = true
        };
        showEditModal = true;
    }

    private void OpenEditModal(Label label)
    {
        isCreateMode = false;
        editingLabel = new Label
        {
            Id = label.Id,
            Reference = label.Reference,
            Title = label.Title,
            Content = label.Content,
            IsActive = label.IsActive,
            UpdatedAt = label.UpdatedAt
        };
        showEditModal = true;
    }

    private async Task SaveLabel()
    {
        if (editingLabel == null || labelEditForm?.EditContext == null) return;

        var editContext = labelEditForm.EditContext;
        var messageStore = new ValidationMessageStore(editContext);
        messageStore.Clear();

        // Additional validation
        if (string.IsNullOrWhiteSpace(editingLabel.Reference))
        {
            messageStore.Add(() => editingLabel.Reference, "A referência é obrigatória.");
            editContext.NotifyValidationStateChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(editingLabel.Title))
        {
            messageStore.Add(() => editingLabel.Title, "O título é obrigatório.");
            editContext.NotifyValidationStateChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(editingLabel.Content))
        {
            messageStore.Add(() => editingLabel.Content, "O conteúdo é obrigatório.");
            editContext.NotifyValidationStateChanged();
            return;
        }

        if (isCreateMode)
        {
            var newLabel = await LabelService.CreateLabelAsync(
                editingLabel.Reference,
                editingLabel.Title,
                editingLabel.Content
            );

            if (editingLabel.IsActive)
            {
                await LabelService.ActivateLabelAsync(newLabel.Id);
            }
        }
        else
        {
            await LabelService.UpdateLabelContentAsync(
                editingLabel.Id,
                editingLabel.Title,
                editingLabel.Content
            );

            if (editingLabel.IsActive)
            {
                await LabelService.ActivateLabelAsync(editingLabel.Id);
            }
            else
            {
                await LabelService.DeactivateLabelAsync(editingLabel.Id);
            }
        }

        await RefreshDataAsync();
        showEditModal = false;
        editingLabel = null;
    }

    private void OpenDeleteModal(Label label)
    {
        deletingLabel = label;
        showDeleteModal = true;
    }

    private async Task DeleteLabel()
    {
        if (deletingLabel == null) return;

        await LabelService.DeleteLabelAsync(deletingLabel.Id);
        await RefreshDataAsync();

        showDeleteModal = false;
        deletingLabel = null;
    }
}
