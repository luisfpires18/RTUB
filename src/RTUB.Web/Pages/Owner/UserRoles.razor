@page "/owner/user-roles"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Identity
@using RTUB.Application.Interfaces
@using RTUB.Shared
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IEmailNotificationService EmailNotificationService
@attribute [Authorize(Roles = "Owner")]
@inherits CrudTablePageBase<ApplicationUser>

<h1 class="mb-2"><i class="bi bi-person-gear"></i> Gestão de Funções de Utilizadores</h1>
<p>Gerir funções dos utilizadores entre Member, Admin e Owner.</p>

<!-- Success/Error Message -->
@if (!string.IsNullOrEmpty(message))
{
    <Alert Type="@(isError ? Alert.AlertType.Error : Alert.AlertType.Success)" 
           Message="@message" 
           Dismissible="true"
           OnDismiss="@(() => message = string.Empty)" />
}

<!-- Search Bar -->
<TableSearchBar SearchTerm="@SearchTerm" 
                Placeholder="Pesquisar por nome, username, email ou nickname..." 
                OnSearchChanged="UpdateSearch" />

@if (AllItems == null)
{
    <div class="d-flex justify-content-center my-5">
        <LoadingSpinner />
    </div>
}
else if (!PaginatedItems.Any())
{
    <EmptyState Title="Nenhum utilizador encontrado"
                Message="Tente ajustar os critérios de pesquisa."
                Icon="bi-people" />
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <SortableTableHeader HeaderText="Utilizador" 
                                        SortColumn="Name"
                                        CurrentSortColumn="@SortHelper.SortColumn"
                                        IsSortAscending="@SortHelper.SortAscending"
                                        OnSortChanged="SortBy" />
                    <SortableTableHeader HeaderText="Username" 
                                        SortColumn="UserName"
                                        CurrentSortColumn="@SortHelper.SortColumn"
                                        IsSortAscending="@SortHelper.SortAscending"
                                        OnSortChanged="SortBy" />
                    <SortableTableHeader HeaderText="Email" 
                                        SortColumn="Email"
                                        CurrentSortColumn="@SortHelper.SortColumn"
                                        IsSortAscending="@SortHelper.SortAscending"
                                        OnSortChanged="SortBy" />
                    <SortableTableHeader HeaderText="Aniversário" 
                                        SortColumn="Birthday"
                                        CurrentSortColumn="@SortHelper.SortColumn"
                                        IsSortAscending="@SortHelper.SortAscending"
                                        OnSortChanged="SortBy" />
                    <SortableTableHeader HeaderText="Função Atual" 
                                        SortColumn="Role"
                                        CurrentSortColumn="@SortHelper.SortColumn"
                                        IsSortAscending="@SortHelper.SortAscending"
                                        OnSortChanged="SortBy" />
                    <SortableTableHeader HeaderText="Estado de Login" 
                                        SortColumn="LastLogin"
                                        CurrentSortColumn="@SortHelper.SortColumn"
                                        IsSortAscending="@SortHelper.SortAscending"
                                        OnSortChanged="SortBy" />
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in PaginatedItems)
                {
                    var userRoles = userRolesDict.ContainsKey(user.Id) ? userRolesDict[user.Id] : new List<string>();
                    var currentRole = GetPrimaryRole(userRoles);

                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="@user.ProfilePictureSrc" alt="@user.Nickname"
                                     class="member-avatar-small me-2" />
                                <div>
                                    <div><strong>@user.Nickname </strong></div>
                                    <div class="text-muted small">@user.FirstName @user.LastName</div>
                                </div>
                            </div>
                        </td>
                        <td><code>@user.UserName</code></td>
                        <td>@user.Email</td>
                        <td>
                            @if (user.DateOfBirth.HasValue)
                            {
                                <text>@user.DateOfBirth.Value.ToString("dd/MM/yyyy")</text>
                            }
                            else
                            {
                                <span class="text-muted">N/A</span>
                            }
                        </td>
                        <td>
                            <RoleBadge Role="@currentRole" />
                        </td>
                        <td>
                            <LoginStatusBadge LastLoginDate="@user.LastLoginDate" />
                        </td>
                        <td>
                            <button class="btn btn-sm btn-purple me-1" 
                                    @onclick="@(() => OpenUserDetailsModal(user))"
                                    title="Ver Detalhes">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-light me-1" 
                                    @onclick="@(() => OpenEditRoleModal(user, currentRole))"
                                    title="Editar Função">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm @(IsBirthdayToday(user) ? "btn-success" : "btn-secondary")" 
                                    @onclick="@(() => SendBirthdayEmail(user))"
                                    disabled="@(!IsBirthdayToday(user))"
                                    title="@(IsBirthdayToday(user) ? "Enviar email de aniversário" : "Não é aniversário hoje")">
                                <i class="bi bi-envelope-heart"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <TablePagination CurrentPage="@PaginationHelper.CurrentPage"
                    PageSize="@PaginationHelper.PageSize"
                    TotalItems="@FilteredItems.Count"
                    ItemLabel="utilizadores"
                    OnPageChanged="ChangePage"
                    OnPageSizeChanged="ChangePageSize" />
}

<!-- Edit Role Modal -->
<Modal Show="@showEditRoleModal"
       ShowChanged="@((value) => showEditRoleModal = value)"
       Title="Editar Função de Utilizador"
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        @if (selectedUser != null)
        {
            <div class="mb-3">
                <div class="d-flex align-items-center mb-3">
                    <img src="@selectedUser.ProfilePictureSrc" alt="@selectedUser.Nickname"
                         class="member-avatar-small me-2" />
                    <div>
                        <div><strong>@selectedUser.Nickname</strong></div>
                        <div class="text-muted small">@selectedUser.FirstName @selectedUser.LastName</div>
                    </div>
                </div>
                
                <label class="form-label">Selecionar Função</label>
                <select class="form-select" @bind="selectedRoleInModal">
                    <option value="Member">Member</option>
                    <option value="Admin">Admin</option>
                    <option value="Owner">Owner</option>
                </select>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Member:</strong> Acesso básico aos recursos da aplicação.<br/>
                        <strong>Admin:</strong> Acesso a funcionalidades administrativas.<br/>
                        <strong>Owner:</strong> Acesso total incluindo gestão de utilizadores.
                    </small>
                </div>
            </div>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseEditRoleModal">Cancelar</button>
        <button type="button" class="btn btn-primary" @onclick="SaveRoleChange">Guardar</button>
    </FooterContent>
</Modal>

<!-- User Details Modal -->
<Modal Show="@showUserDetailsModal"
       ShowChanged="@((value) => showUserDetailsModal = value)"
       Title="Detalhes do Utilizador"
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        @if (selectedUserForDetails != null)
        {
            <div class="mb-3">
                <div class="d-flex align-items-center mb-3">
                    <img src="@selectedUserForDetails.ProfilePictureSrc" alt="@selectedUserForDetails.Nickname"
                         class="member-avatar-small me-2" />
                    <div>
                        <div><strong>@selectedUserForDetails.Nickname</strong></div>
                        <div class="text-muted small">@selectedUserForDetails.FirstName @selectedUserForDetails.LastName</div>
                        <div class="text-muted small"><code>@selectedUserForDetails.UserName</code></div>
                    </div>
                </div>
                
                <h6 class="mb-3">Estado da Conta</h6>
                
                <div class="d-flex flex-column gap-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Bloqueado:</span>
                        @if (IsAccountLocked(selectedUserForDetails))
                        {
                            <span class="badge bg-danger">
                                <i class="bi bi-lock-fill"></i> Sim
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-success">
                                <i class="bi bi-unlock-fill"></i> Não
                            </span>
                        }
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Necessita Alterar Password:</span>
                        @if (selectedUserForDetails.RequirePasswordChange)
                        {
                            <span class="badge bg-warning">
                                <i class="bi bi-key-fill"></i> Sim
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle-fill"></i> Não
                            </span>
                        }
                    </div>
                </div>
                
                @if (IsAccountLocked(selectedUserForDetails))
                {
                    <div class="alert alert-danger mt-3 mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i> 
                            Conta bloqueada até @selectedUserForDetails.LockoutEnd?.DateTime.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                        </small>
                    </div>
                }
            </div>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseUserDetailsModal">Fechar</button>
    </FooterContent>
</Modal>

<!-- Confirmation Dialog -->
<ConfirmDialog Show="@showConfirmDialog"
               ShowChanged="@((value) => showConfirmDialog = value)"
               Title="Confirmar Alteração de Função"
               Message="@confirmMessage"
               ConfirmText="Confirmar"
               CancelText="Cancelar"
               ConfirmButtonClass="btn-primary"
               OnConfirm="ConfirmRoleChange"
               OnCancel="CancelRoleChange" />

<!-- Birthday Notification Confirmation Modal -->
<ConfirmDialog Show="@showBirthdayEmailModal"
               ShowChanged="@((bool show) => showBirthdayEmailModal = show)"
               Title="Enviar notificação de aniversário?"
               ConfirmText="Sim"
               CancelText="Não"
               ConfirmButtonClass="btn-primary"
               OnConfirm="@SendBirthdayNotification"
               OnCancel="@CloseBirthdayEmailModal"
               Size="Modal.ModalSize.Large">
    <BodyContent>
        @if (selectedUserForBirthday != null)
        {
            <div class="mb-3">
                <h6 class="text-white-full">Detalhes do Aniversariante:</h6>
                <div class="event-summary p-3 rounded bg-dark">
                    <div><strong>Nome:</strong> @selectedUserForBirthday.Nickname (@selectedUserForBirthday.FirstName @selectedUserForBirthday.LastName)</div>
                    @if (selectedUserForBirthday.DateOfBirth.HasValue)
                    {
                        <div><strong>Data de Nascimento:</strong> @selectedUserForBirthday.DateOfBirth.Value.ToString("dd/MM/yyyy")</div>
                    }
                </div>
            </div>

            @if (birthdayEmailLoadingSubscribers)
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">A carregar...</span>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(birthdayEmailErrorMessage))
            {
                <Alert Message="@birthdayEmailErrorMessage" 
                       Type="Alert.AlertType.Error" 
                       Dismissible="true"
                       OnDismiss="@(() => birthdayEmailErrorMessage = null)" />
            }
            else
            {
                <div class="mb-3">
                    <span class="badge bg-purple text-white p-2">
                        @($"{birthdaySubscribedUsersCount} membros têm 'Notificações por email' ativas e irão receber esta mensagem.")
                    </span>
                </div>

                @if (birthdaySubscribedUsers != null && birthdaySubscribedUsers.Any())
                {
                    <div class="mb-3">
                        <h6 class="text-white-full mb-2">Membros que irão receber:</h6>
                        <div class="subscriber-list" style="max-height: 300px; overflow-y: auto;">
                            @foreach (var user in birthdaySubscribedUsers)
                            {
                                <div class="subscriber-item p-2 mb-1 rounded bg-dark text-white-full">
                                    @(user.Nickname ?? $"{user.FirstName} {user.LastName}")
                                </div>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <Alert Message="Nenhum membro subscrito às notificações por email." 
                           Type="Alert.AlertType.Warning" />
                }
            }
        }
    </BodyContent>
</ConfirmDialog>

@code {
    private Dictionary<string, List<string>> userRolesDict = new();
    private string message = "";
    private bool isError = false;
    
    // Edit role modal
    private bool showEditRoleModal = false;
    private string selectedRoleInModal = "";
    private string currentRoleBeforeEdit = "";
    
    // User details modal
    private bool showUserDetailsModal = false;
    private ApplicationUser? selectedUserForDetails = null;
    
    // Confirmation dialog
    private bool showConfirmDialog = false;
    private ApplicationUser? selectedUser = null;
    private string selectedRole = "";
    private string confirmMessage = "";
    
    // Birthday notification modal
    private bool showBirthdayEmailModal = false;
    private ApplicationUser? selectedUserForBirthday = null;
    private List<ApplicationUser>? birthdaySubscribedUsers = null;
    private int birthdaySubscribedUsersCount = 0;
    private bool birthdayEmailLoadingSubscribers = false;
    private string? birthdayEmailErrorMessage = null;

    protected override async Task OnInitializedAsync()
    {
        SortHelper.SortColumn = "Role"; // Sort by role priority by default
        SortHelper.SortAscending = true; // Ascending (Owner=1, Admin=2, Member=3)
        await LoadItemsAsync();
        ApplyFiltersAndPagination();
    }

    protected override async Task LoadItemsAsync()
    {
        // Load users efficiently
        AllItems = await Task.Run(() => UserManager.Users.ToList());

        // Load roles for all users efficiently using parallel tasks
        userRolesDict.Clear();
        var roleTasks = AllItems.Select(async user =>
        {
            var roles = await UserManager.GetRolesAsync(user);
            return (user.Id, roles.ToList());
        });

        var roleResults = await Task.WhenAll(roleTasks);
        foreach (var (userId, roles) in roleResults)
        {
            userRolesDict[userId] = roles;
        }
        
        // Sort by role priority: Owner > Admin > Member, then by name
        AllItems = AllItems.OrderBy(u => GetRolePriority(userRolesDict.ContainsKey(u.Id) ? userRolesDict[u.Id] : new List<string>()))
                          .ThenBy(u => u.FirstName)
                          .ThenBy(u => u.LastName)
                          .ToList();
    }
    
    private int GetRolePriority(List<string> roles)
    {
        // Lower number = higher priority
        if (roles.Contains("Owner")) return 1;
        if (roles.Contains("Admin")) return 2;
        if (roles.Contains("Member")) return 3;
        return 4; // No role
    }

    protected override Dictionary<string, Func<ApplicationUser, IComparable>> GetSortColumnSelectors()
    {
        return new Dictionary<string, Func<ApplicationUser, IComparable>>
        {
            ["Name"] = u => $"{u.FirstName} {u.LastName}",
            ["UserName"] = u => u.UserName ?? "",
            ["Email"] = u => u.Email ?? "",
            ["Birthday"] = u => u.DateOfBirth ?? DateTime.MinValue,
            ["Role"] = u => GetRolePriority(userRolesDict.ContainsKey(u.Id) ? userRolesDict[u.Id] : new List<string>()),
            ["LastLogin"] = u => u.LastLoginDate ?? DateTime.MinValue
        };
    }

    protected override List<Func<ApplicationUser, string>> GetSearchSelectors()
    {
        return new List<Func<ApplicationUser, string>>
        {
            u => u.FirstName ?? "",
            u => u.LastName ?? "",
            u => u.Nickname ?? "",
            u => u.UserName ?? "",
            u => u.Email ?? ""
        };
    }

    private string GetPrimaryRole(List<string> roles)
    {
        // Priority: Owner > Admin > Member
        if (roles.Contains("Owner")) return "Owner";
        if (roles.Contains("Admin")) return "Admin";
        if (roles.Contains("Member")) return "Member";
        return "Sem Função";
    }
    
    private void OpenEditRoleModal(ApplicationUser user, string currentRole)
    {
        selectedUser = user;
        currentRoleBeforeEdit = currentRole;
        selectedRoleInModal = currentRole;
        showEditRoleModal = true;
    }
    
    private void CloseEditRoleModal()
    {
        showEditRoleModal = false;
        selectedUser = null;
        selectedRoleInModal = "";
        currentRoleBeforeEdit = "";
    }
    
    private async Task OpenUserDetailsModal(ApplicationUser user)
    {
        // Fetch fresh data from the database to ensure we have the latest values
        var freshUser = await UserManager.FindByIdAsync(user.Id);
        if (freshUser != null)
        {
            selectedUserForDetails = freshUser;
            showUserDetailsModal = true;
        }
    }
    
    private void CloseUserDetailsModal()
    {
        showUserDetailsModal = false;
        selectedUserForDetails = null;
    }
    
    private bool IsAccountLocked(ApplicationUser user)
    {
        // Account is locked if LockoutEnd is set and is in the future
        return user.LockoutEnd.HasValue && user.LockoutEnd.Value > DateTimeOffset.UtcNow;
    }
    
    private async Task SaveRoleChange()
    {
        if (selectedUser != null && !string.IsNullOrEmpty(selectedRoleInModal))
        {
            // Only change if different from current
            if (selectedRoleInModal != currentRoleBeforeEdit)
            {
                await ChangeUserRole(selectedUser.Id, selectedRoleInModal);
            }
        }
        CloseEditRoleModal();
    }

    private void ShowConfirmDialog(ApplicationUser user, string newRole)
    {
        selectedUser = user;
        selectedRole = newRole;
        confirmMessage = $"Tem a certeza que deseja alterar a função de {user.FirstName} {user.LastName} para {newRole}?";
        showConfirmDialog = true;
    }

    private async Task ConfirmRoleChange()
    {
        if (selectedUser != null && !string.IsNullOrEmpty(selectedRole))
        {
            await ChangeUserRole(selectedUser.Id, selectedRole);
        }
        showConfirmDialog = false;
        selectedUser = null;
        selectedRole = "";
    }

    private void CancelRoleChange()
    {
        showConfirmDialog = false;
        selectedUser = null;
        selectedRole = "";
    }

    private async Task ChangeUserRole(string userId, string newRole)
    {
        try
        {
            var user = await UserManager.FindByIdAsync(userId);
            if (user == null)
            {
                message = "Utilizador não encontrado.";
                isError = true;
                return;
            }

            var currentRoles = await UserManager.GetRolesAsync(user);

            // Remove all existing roles
            if (currentRoles.Any())
            {
                var removeResult = await UserManager.RemoveFromRolesAsync(user, currentRoles);
                if (!removeResult.Succeeded)
                {
                    message = $"Erro ao remover funções antigas: {string.Join(", ", removeResult.Errors.Select(e => e.Description))}";
                    isError = true;
                    return;
                }
            }

            // Add new role
            // Note: Role hierarchy is Owner > Admin > Member
            // Owner gets Admin role for access to admin features (following pattern from SeedData)
            // Admin and Member roles are mutually exclusive
            var addResult = await UserManager.AddToRoleAsync(user, newRole);
            if (addResult.Succeeded)
            {
                // If promoting to Owner, also add Admin role for access to admin features
                if (newRole == "Owner")
                {
                    await UserManager.AddToRoleAsync(user, "Admin");
                }

                // Invalidate security stamp to force fresh cookies and token refresh
                // This ensures role changes take effect immediately on next sign-in
                await UserManager.UpdateSecurityStampAsync(user);

                message = $"Função de {user.FirstName} {user.LastName} alterada para {newRole} com sucesso.";
                isError = false;
                await RefreshDataAsync();
            }
            else
            {
                message = $"Erro ao adicionar nova função: {string.Join(", ", addResult.Errors.Select(e => e.Description))}";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            message = $"Erro inesperado: {ex.Message}";
            isError = true;
        }
    }
    
    private bool IsBirthdayToday(ApplicationUser user)
    {
        if (!user.DateOfBirth.HasValue)
            return false;
        
        var today = DateTime.Now;
        return user.DateOfBirth.Value.Month == today.Month && 
               user.DateOfBirth.Value.Day == today.Day;
    }
    
    // Birthday notification modal methods
    private async Task SendBirthdayEmail(ApplicationUser user)
    {
        if (!IsBirthdayToday(user))
        {
            message = "Não é aniversário deste utilizador hoje.";
            isError = true;
            return;
        }
        
        selectedUserForBirthday = user;
        birthdayEmailLoadingSubscribers = true;
        birthdayEmailErrorMessage = null;
        showBirthdayEmailModal = true;
        StateHasChanged();

        try
        {
            // Get all subscribed users with confirmed emails (excluding the birthday person)
            var subscribedUsers = await Task.Run(() => 
                UserManager.Users
                    .Where(u => u.Subscribed && u.EmailConfirmed && u.Id != user.Id && !string.IsNullOrEmpty(u.Email))
                    .OrderBy(u => u.Nickname ?? u.FirstName)
                    .ToList());
            
            birthdaySubscribedUsers = subscribedUsers;
            birthdaySubscribedUsersCount = subscribedUsers.Count;
        }
        catch (Exception ex)
        {
            birthdayEmailErrorMessage = $"Erro ao carregar membros: {ex.Message}";
        }
        finally
        {
            birthdayEmailLoadingSubscribers = false;
            StateHasChanged();
        }
    }

    private void CloseBirthdayEmailModal()
    {
        showBirthdayEmailModal = false;
        selectedUserForBirthday = null;
        birthdaySubscribedUsers = null;
        birthdaySubscribedUsersCount = 0;
        birthdayEmailErrorMessage = null;
    }

    private async Task SendBirthdayNotification()
    {
        if (selectedUserForBirthday == null || birthdaySubscribedUsers == null || !birthdaySubscribedUsers.Any())
        {
            CloseBirthdayEmailModal();
            return;
        }

        StateHasChanged();

        try
        {
            var recipientEmails = birthdaySubscribedUsers
                .Where(u => !string.IsNullOrWhiteSpace(u.Email))
                .Select(u => u.Email!)
                .ToList();

            var recipientData = birthdaySubscribedUsers
                .Where(u => !string.IsNullOrWhiteSpace(u.Email))
                .ToDictionary(
                    u => u.Email!,
                    u => (u.Nickname ?? u.FirstName ?? "", $"{u.FirstName} {u.LastName}")
                );
            
            var (success, count, errorMessage) = await EmailNotificationService.SendBirthdayNotificationAsync(
                selectedUserForBirthday.Id,
                selectedUserForBirthday.Nickname ?? selectedUserForBirthday.FirstName ?? "",
                $"{selectedUserForBirthday.FirstName} {selectedUserForBirthday.LastName}",
                recipientEmails,
                recipientData
            );
            
            CloseBirthdayEmailModal();
            
            if (success)
            {
                message = $"Email de aniversário enviado com sucesso para {count} utilizadores subscritos.";
                isError = false;
            }
            else
            {
                message = errorMessage ?? "Erro ao enviar email de aniversário.";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            CloseBirthdayEmailModal();
            message = $"Erro inesperado: {ex.Message}";
            isError = true;
        }
    }
}
