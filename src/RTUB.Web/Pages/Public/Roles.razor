@page "/roles"
@rendermode InteractiveServer
@using RTUB.Application.Interfaces
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Core.Enums
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@using RTUB.Shared
@inject IRoleAssignmentService RoleAssignmentService
@inject IFiscalYearService FiscalYearService
@inject UserManager<ApplicationUser> UserManager
@inject IDocumentStorageService DocumentStorageService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject RTUB.Application.Services.AuditContext AuditContext

<h1 class="portal-title">Órgãos Sociais</h1>

@* Admin Add button (top-left, green) *@
<AuthorizeView Roles="Admin">
    <Authorized>
        <div class="mb-3">
            <button class="btn btn-success mb-2" @onclick="OpenCreateFiscalYearModal" title="Adicionar Ano Fiscal">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    </Authorized>
</AuthorizeView>

@* FY Dropdown without icon *@
@if (!fiscalYears.Any())
{
    <EmptyState Title="Nenhum ano fiscal criado ainda"
                Message="Não existem anos fiscais para mostrar."
                Icon="bi-calendar-x" />
}
else
{
    <div class="row mb-4">
        <div class="col-md-6">
            <select class="form-select" @bind="selectedFiscalYear" @bind:after="OnFiscalYearChanged">
                <option value="" disabled>Selecionar Ano Lectivo</option>
                @foreach (var year in fiscalYears)
                {
                    var isCurrent = year == currentFiscalYearString;
                    <option value="@year">@year@(isCurrent ? " (Ano ativo)" : "")</option>
                }
            </select>
        </div>
    </div>

    @* RGI Section - Visible only to MEMBER and ADMIN *@
    <AuthorizeView Roles="Member,Admin">
        <section class="mb-4">
            <div class="text-center">
                <h4 class="mb-3">Verifica os regulamentos gerais internos</h4>
                <button class="btn btn-primary btn-lg" @onclick="OpenRgiModal">
                    Abrir RGI
                </button>
            </div>
        </section>
    </AuthorizeView>

    @if (isLoading)
    {
        <p>A carregar...</p>
    }
    else
    {
    <!-- Direção -->
    <section class="mb-4">
        <div class="card shadow-sm portal-governing-body-card">
            <div class="card-header gov-body-card-header">
                <h3 class="mb-0">DIREÇÃO</h3>
            </div>
            <div class="card-body">
                @{
                    var magister = GetRoleAssignment(Position.Magister);
                    var viceMagister = GetRoleAssignment(Position.ViceMagister);
                    var secretario = GetRoleAssignment(Position.Secretario);
                    var tesoureiro1 = GetRoleAssignment(Position.PrimeiroTesoureiro);
                    var tesoureiro2 = GetRoleAssignment(Position.SegundoTesoureiro);
                }
                
                @* Magister *@
                <div class="text-center mb-4 position-relative">
                    <div class="position-title mb-2">MAGISTER</div>
                    @if (magister != null)
                    {
                        <div class="d-flex flex-column align-items-center">
                            <img src="@magister.User!.ProfilePictureSrc" alt="@magister.User.GetDisplayName()" class="member-avatar-large mb-2" />
                            @if (!string.IsNullOrEmpty(magister.User.Nickname))
                            {
                                <div class="text-light-theme">@magister.User.Nickname</div>
                                <div class="member-nickname">@magister.User.FirstName @magister.User.LastName</div>
                            }
                            else
                            {
                                <div class="text-light-theme">@magister.User.FirstName @magister.User.LastName</div>
                            }
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveAssignment(magister.Id)" title="Remover">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        </div>
                    }
                    else
                    {
                        <div class="not-available-text">N/D</div>
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <div class="admin-action-chips mt-2">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.Magister, "Magister"))" title="Adicionar">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </Authorized>
                        </AuthorizeView>
                    }
                </div>

                @* Vice-Magister *@
                <div class="text-center mb-4 position-relative">
                    <div class="position-title mb-2">VICE-MAGISTER</div>
                    @if (viceMagister != null)
                    {
                        <div class="d-flex flex-column align-items-center">
                            <img src="@viceMagister.User!.ProfilePictureSrc" alt="@viceMagister.User.GetDisplayName()" class="member-avatar-large mb-2" />
                            @if (!string.IsNullOrEmpty(viceMagister.User.Nickname))
                            {
                                <div class="text-light-theme">@viceMagister.User.Nickname</div>
                                <div class="member-nickname">@viceMagister.User.FirstName @viceMagister.User.LastName</div>
                            }
                            else
                            {
                                <div class="text-light-theme">@viceMagister.User.FirstName @viceMagister.User.LastName</div>
                            }
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(viceMagister.Id))" title="Remover">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        </div>
                    }
                    else
                    {
                        <div class="not-available-text">N/D</div>
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <div class="admin-action-chips mt-2">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.ViceMagister, "Vice-Magister"))" title="Adicionar">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </Authorized>
                        </AuthorizeView>
                    }
                </div>

                @* Horizontal row: Secretário, 1º Tesoureiro, 2º Tesoureiro *@
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <div class="position-title mb-2">SECRETÁRIO</div>
                        @if (secretario != null)
                        {
                            <div class="d-flex flex-column align-items-center">
                                <img src="@secretario.User!.ProfilePictureSrc" alt="@secretario.User.GetDisplayName()" class="member-avatar-large mb-2" />
                                @if (!string.IsNullOrEmpty(secretario.User.Nickname))
                                {
                                    <div class="text-light-theme">@secretario.User.Nickname</div>
                                    <div class="member-nickname">@secretario.User.FirstName @secretario.User.LastName</div>
                                }
                                else
                                {
                                    <div class="text-light-theme">@secretario.User.FirstName @secretario.User.LastName</div>
                                }
                                <AuthorizeView Roles="Admin">
                                    <Authorized>
                                        <div class="admin-action-chips mt-2">
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(secretario.Id))" title="Remover">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        }
                        else
                        {
                            <div class="not-available-text">N/D</div>
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.Secretario, "Secretário"))" title="Adicionar">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        }
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="position-title mb-2">1º TESOUREIRO</div>
                        @if (tesoureiro1 != null)
                        {
                            <div class="d-flex flex-column align-items-center">
                                <img src="@tesoureiro1.User!.ProfilePictureSrc" alt="@tesoureiro1.User.GetDisplayName()" class="member-avatar-large mb-2" />
                                @if (!string.IsNullOrEmpty(tesoureiro1.User.Nickname))
                                {
                                    <div class="text-light-theme">@tesoureiro1.User.Nickname</div>
                                    <div class="member-nickname">@tesoureiro1.User.FirstName @tesoureiro1.User.LastName</div>
                                }
                                else
                                {
                                    <div class="text-light-theme">@tesoureiro1.User.FirstName @tesoureiro1.User.LastName</div>
                                }
                                <AuthorizeView Roles="Admin">
                                    <Authorized>
                                        <div class="admin-action-chips mt-2">
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(tesoureiro1.Id))" title="Remover">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        }
                        else
                        {
                            <div class="not-available-text">N/D</div>
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.PrimeiroTesoureiro, "1º Tesoureiro"))" title="Adicionar">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        }
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="position-title mb-2">2º TESOUREIRO</div>
                        @if (tesoureiro2 != null)
                        {
                            <div class="d-flex flex-column align-items-center">
                                <img src="@tesoureiro2.User!.ProfilePictureSrc" alt="@tesoureiro2.User.GetDisplayName()" class="member-avatar-large mb-2" />
                                @if (!string.IsNullOrEmpty(tesoureiro2.User.Nickname))
                                {
                                    <div class="text-light-theme">@tesoureiro2.User.Nickname</div>
                                    <div class="member-nickname">@tesoureiro2.User.FirstName @tesoureiro2.User.LastName</div>
                                }
                                else
                                {
                                    <div class="text-light-theme">@tesoureiro2.User.FirstName @tesoureiro2.User.LastName</div>
                                }
                                <AuthorizeView Roles="Admin">
                                    <Authorized>
                                        <div class="admin-action-chips mt-2">
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(tesoureiro2.Id))" title="Remover">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        }
                        else
                        {
                            <div class="not-available-text">N/D</div>
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.SegundoTesoureiro, "2º Tesoureiro"))" title="Adicionar">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Mesa de Assembleia -->
    <section class="mb-4">
        <div class="card shadow-sm portal-governing-body-card">
            <div class="card-header gov-body-card-header">
                <h3 class="mb-0">MESA DE ASSEMBLEIA</h3>
            </div>
            <div class="card-body">
                @{
                    var presidenteMA = GetRoleAssignment(Position.PresidenteMesaAssembleia);
                    var secretario1MA = GetRoleAssignment(Position.PrimeiroSecretarioMesaAssembleia);
                    var secretario2MA = GetRoleAssignment(Position.SegundoSecretarioMesaAssembleia);
                }
                
                @* Presidente *@
                <div class="text-center mb-4 position-relative">
                    <div class="position-title mb-2">PRESIDENTE</div>
                    @if (presidenteMA != null)
                    {
                        <div class="d-flex flex-column align-items-center">
                            <img src="@presidenteMA.User!.ProfilePictureSrc" alt="@presidenteMA.User.GetDisplayName()" class="member-avatar-large mb-2" />
                            @if (!string.IsNullOrEmpty(presidenteMA.User.Nickname))
                            {
                                <div class="text-light-theme">@presidenteMA.User.Nickname</div>
                                <div class="member-nickname">@presidenteMA.User.FirstName @presidenteMA.User.LastName</div>
                            }
                            else
                            {
                                <div class="text-light-theme">@presidenteMA.User.FirstName @presidenteMA.User.LastName</div>
                            }
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(presidenteMA.Id))" title="Remover">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        </div>
                    }
                    else
                    {
                        <div class="not-available-text">N/D</div>
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <div class="admin-action-chips mt-2">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.PresidenteMesaAssembleia, "Presidente Mesa Assembleia"))" title="Adicionar">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </Authorized>
                        </AuthorizeView>
                    }
                </div>

                @* Horizontal row: 1º Secretário, 2º Secretário *@
                <div class="row justify-content-center">
                    <div class="col-md-4 text-center mb-3">
                        <div class="position-title mb-2">1º SECRETÁRIO</div>
                        @if (secretario1MA != null)
                        {
                            <div class="d-flex flex-column align-items-center">
                                <img src="@secretario1MA.User!.ProfilePictureSrc" alt="@secretario1MA.User.GetDisplayName()" class="member-avatar-large mb-2" />
                                @if (!string.IsNullOrEmpty(secretario1MA.User.Nickname))
                                {
                                    <div class="text-light-theme">@secretario1MA.User.Nickname</div>
                                    <div class="member-nickname">@secretario1MA.User.FirstName @secretario1MA.User.LastName</div>
                                }
                                else
                                {
                                    <div class="text-light-theme">@secretario1MA.User.FirstName @secretario1MA.User.LastName</div>
                                }
                                <AuthorizeView Roles="Admin">
                                    <Authorized>
                                        <div class="admin-action-chips mt-2">
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(secretario1MA.Id))" title="Remover">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        }
                        else
                        {
                            <div class="not-available-text">N/D</div>
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.PrimeiroSecretarioMesaAssembleia, "1º Secretário Mesa Assembleia"))" title="Adicionar">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        }
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="position-title mb-2">2º SECRETÁRIO</div>
                        @if (secretario2MA != null)
                        {
                            <div class="d-flex flex-column align-items-center">
                                <img src="@secretario2MA.User!.ProfilePictureSrc" alt="@secretario2MA.User.GetDisplayName()" class="member-avatar-large mb-2" />
                                @if (!string.IsNullOrEmpty(secretario2MA.User.Nickname))
                                {
                                    <div class="text-light-theme">@secretario2MA.User.Nickname</div>
                                    <div class="member-nickname">@secretario2MA.User.FirstName @secretario2MA.User.LastName</div>
                                }
                                else
                                {
                                    <div class="text-light-theme">@secretario2MA.User.FirstName @secretario2MA.User.LastName</div>
                                }
                                <AuthorizeView Roles="Admin">
                                    <Authorized>
                                        <div class="admin-action-chips mt-2">
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(secretario2MA.Id))" title="Remover">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        }
                        else
                        {
                            <div class="not-available-text">N/D</div>
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.SegundoSecretarioMesaAssembleia, "2º Secretário Mesa Assembleia"))" title="Adicionar">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Conselho Fiscal -->
    <section class="mb-4">
        <div class="card shadow-sm portal-governing-body-card">
            <div class="card-header gov-body-card-header">
                <h3 class="mb-0">CONSELHO FISCAL</h3>
            </div>
            <div class="card-body">
                @{
                    var presidenteCF = GetRoleAssignment(Position.PresidenteConselhoFiscal);
                    var relator1CF = GetRoleAssignment(Position.PrimeiroRelatorConselhoFiscal);
                    var relator2CF = GetRoleAssignment(Position.SegundoRelatorConselhoFiscal);
                }
                
                @* Presidente *@
                <div class="text-center mb-4 position-relative">
                    <div class="position-title mb-2">PRESIDENTE</div>
                    @if (presidenteCF != null)
                    {
                        <div class="d-flex flex-column align-items-center">
                            <img src="@presidenteCF.User!.ProfilePictureSrc" alt="@presidenteCF.User.GetDisplayName()" class="member-avatar-large mb-2" />
                            @if (!string.IsNullOrEmpty(presidenteCF.User.Nickname))
                            {
                                <div class="text-light-theme">@presidenteCF.User.Nickname</div>
                                <div class="member-nickname">@presidenteCF.User.FirstName @presidenteCF.User.LastName</div>
                            }
                            else
                            {
                                <div class="text-light-theme">@presidenteCF.User.FirstName @presidenteCF.User.LastName</div>
                            }
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(presidenteCF.Id))" title="Remover">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        </div>
                    }
                    else
                    {
                        <div class="not-available-text">N/D</div>
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <div class="admin-action-chips mt-2">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.PresidenteConselhoFiscal, "Presidente Conselho Fiscal"))" title="Adicionar">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </Authorized>
                        </AuthorizeView>
                    }
                </div>

                @* Horizontal row: 1º Relator, 2º Relator *@
                <div class="row justify-content-center">
                    <div class="col-md-4 text-center mb-3">
                        <div class="position-title mb-2">1º RELATOR</div>
                        @if (relator1CF != null)
                        {
                            <div class="d-flex flex-column align-items-center">
                                <img src="@relator1CF.User!.ProfilePictureSrc" alt="@relator1CF.User.GetDisplayName()" class="member-avatar-large mb-2" />
                                @if (!string.IsNullOrEmpty(relator1CF.User.Nickname))
                                {
                                    <div class="text-light-theme">@relator1CF.User.Nickname</div>
                                    <div class="member-nickname">@relator1CF.User.FirstName @relator1CF.User.LastName</div>
                                }
                                else
                                {
                                    <div class="text-light-theme">@relator1CF.User.FirstName @relator1CF.User.LastName</div>
                                }
                                <AuthorizeView Roles="Admin">
                                    <Authorized>
                                        <div class="admin-action-chips mt-2">
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(relator1CF.Id))" title="Remover">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        }
                        else
                        {
                            <div class="not-available-text">N/D</div>
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.PrimeiroRelatorConselhoFiscal, "1º Relator Conselho Fiscal"))" title="Adicionar">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        }
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="position-title mb-2">2º RELATOR</div>
                        @if (relator2CF != null)
                        {
                            <div class="d-flex flex-column align-items-center">
                                <img src="@relator2CF.User!.ProfilePictureSrc" alt="@relator2CF.User.GetDisplayName()" class="member-avatar-large mb-2" />
                                @if (!string.IsNullOrEmpty(relator2CF.User.Nickname))
                                {
                                    <div class="text-light-theme">@relator2CF.User.Nickname</div>
                                    <div class="member-nickname">@relator2CF.User.FirstName @relator2CF.User.LastName</div>
                                }
                                else
                                {
                                    <div class="text-light-theme">@relator2CF.User.FirstName @relator2CF.User.LastName</div>
                                }
                                <AuthorizeView Roles="Admin">
                                    <Authorized>
                                        <div class="admin-action-chips mt-2">
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(relator2CF.Id))" title="Remover">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        }
                        else
                        {
                            <div class="not-available-text">N/D</div>
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.SegundoRelatorConselhoFiscal, "2º Relator Conselho Fiscal"))" title="Adicionar">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Conselho de Veteranos -->
    <section class="mb-4">
        <div class="card shadow-sm portal-governing-body-card">
            <div class="card-header gov-body-card-header">
                <h3 class="mb-0">CONSELHO DE VETERANOS</h3>
            </div>
            <div class="card-body">
                @{
                    var presidenteCV = GetRoleAssignment(Position.PresidenteConselhoVeteranos);
                }
                
                @* Presidente *@
                <div class="text-center position-relative">
                    <div class="position-title mb-2">PRESIDENTE</div>
                    @if (presidenteCV != null)
                    {
                        <div class="d-flex flex-column align-items-center">
                            <img src="@presidenteCV.User!.ProfilePictureSrc" alt="@presidenteCV.User.GetDisplayName()" class="member-avatar-large mb-2" />
                            @if (!string.IsNullOrEmpty(presidenteCV.User.Nickname))
                            {
                                <div class="text-light-theme">@presidenteCV.User.Nickname</div>
                                <div class="member-nickname">@presidenteCV.User.FirstName @presidenteCV.User.LastName</div>
                            }
                            else
                            {
                                <div class="text-light-theme">@presidenteCV.User.FirstName @presidenteCV.User.LastName</div>
                            }
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(presidenteCV.Id))" title="Remover">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        </div>
                    }
                    else
                    {
                        <div class="not-available-text">N/D</div>
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <div class="admin-action-chips mt-2">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.PresidenteConselhoVeteranos, "Presidente Conselho de Veteranos"))" title="Adicionar">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </Authorized>
                        </AuthorizeView>
                    }
                </div>
            </div>
        </div>
    </section>

    <!-- Outros Cargos -->
    <section class="mb-4">
        <div class="card shadow-sm portal-governing-body-card">
            <div class="card-header gov-body-card-header">
                <h3 class="mb-0">OUTROS CARGOS</h3>
            </div>
            <div class="card-body">
                @{
                    var ensaiador = GetRoleAssignment(Position.Ensaiador);
                }
                
                @* Ensaiador *@
                <div class="text-center position-relative">
                    <div class="position-title mb-2">ENSAIADOR</div>
                    @if (ensaiador != null)
                    {
                        <div class="d-flex flex-column align-items-center">
                            <img src="@ensaiador.User!.ProfilePictureSrc" alt="@ensaiador.User.GetDisplayName()" class="member-avatar-large mb-2" />
                            @if (!string.IsNullOrEmpty(ensaiador.User.Nickname))
                            {
                                <div class="text-light-theme">@ensaiador.User.Nickname</div>
                                <div class="member-nickname">@ensaiador.User.FirstName @ensaiador.User.LastName</div>
                            }
                            else
                            {
                                <div class="text-light-theme">@ensaiador.User.FirstName @ensaiador.User.LastName</div>
                            }
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <div class="admin-action-chips mt-2">
                                        <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveAssignment(ensaiador.Id))" title="Remover">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        </div>
                    }
                    else
                    {
                        <div class="not-available-text">N/D</div>
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <div class="admin-action-chips mt-2">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenAssignMemberModal(Position.Ensaiador, "Ensaiador"))" title="Adicionar">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </Authorized>
                        </AuthorizeView>
                    }
                </div>
            </div>
        </div>
    </section>
    }
}

<!-- RGI PDF Modal -->
<Modal Show="@showRgiModal" 
       ShowChanged="@((value) => showRgiModal = value)"
       Title="Regulamentos Gerais Internos (RGI)" 
       Size="Modal.ModalSize.ExtraLarge" 
       Centered="true"
       OnClose="@CloseRgiModal">
    <BodyContent>
        @if (isLoadingRgi)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">A carregar...</span>
                </div>
                <p class="mt-3">A carregar RGI...</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(rgiPdfUrl))
        {
            <div class="pdf-viewer-container" style="height: 80vh;">
                <iframe src="@(rgiPdfUrl + "#toolbar=0&navpanes=0&scrollbar=0")" 
                        style="width: 100%; height: 100%; border: none;"
                        title="Regulamentos Gerais Internos">
                </iframe>
            </div>
        }
        else
        {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> 
                O documento RGI não está disponível no momento.
            </div>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseRgiModal">Fechar</button>
    </FooterContent>
</Modal>

<!-- Create Fiscal Year Modal (Admin only) -->
<Modal Show="@showCreateFiscalYearModal" 
       ShowChanged="@((bool show) => showCreateFiscalYearModal = show)"
       Title="Criar Novo Ano Fiscal" 
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        <div class="mb-3">
            <label class="form-label">Ano de Início</label>
            <input type="number" class="form-control" @bind="newStartYear" min="1900" max="2100" />
            <small class="text-muted">O ano fiscal será criado automaticamente como @newStartYear-@(newStartYear + 1)</small>
        </div>
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseCreateFiscalYearModal">Cancelar</button>
        <button type="button" class="btn btn-primary" @onclick="CreateFiscalYear">Criar</button>
    </FooterContent>
</Modal>

<!-- Assign Member Modal (Admin only) -->
<Modal Show="@showAssignMemberModal" 
       ShowChanged="@((bool show) => showAssignMemberModal = show)"
       Title="@("Atribuir Membro ao Cargo: " + selectedPositionName)" 
       Size="Modal.ModalSize.Large"
       Centered="true">
    <BodyContent>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        <div class="mb-3">
            <label class="form-label">Pesquisar Membro</label>
            <input type="text" class="form-control" placeholder="Inserir nome, email ou tuna name..."
                   @bind="memberSearchTerm" @bind:event="oninput" @onkeyup="FilterMembers" />
        </div>
        @if (filteredMembers.Any())
        {
            <div class="member-list member-list-scrollable">
                @foreach (var member in filteredMembers.Take(20))
                {
                    <div class="member-item p-2 mb-2 border rounded clickable-row"
                         @onclick="() => SelectMember(member)">
                        <div class="d-flex align-items-center">
                            <img src="@member.ProfilePictureSrc" alt="@member.GetDisplayName()"
                                 class="member-avatar-small me-2" />
                            <div>
                                @if (!string.IsNullOrEmpty(member.Nickname))
                                {
                                    <div><strong>@member.Nickname</strong></div>
                                    <div class="text-muted small">@member.FirstName @member.LastName</div>
                                }
                                else
                                {
                                    <div><strong>@member.FirstName @member.LastName</strong></div>
                                }
                                <div class="text-muted small">@member.Email</div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else if (!string.IsNullOrEmpty(memberSearchTerm))
        {
            <Alert Type="Alert.AlertType.Purple" Message="Nenhum membro encontrado." />
        }

        @if (selectedMember != null)
        {
            <Alert Type="Alert.AlertType.Purple" Message="@($"Membro Selecionado: {selectedMember.GetDisplayName()}")" AdditionalClasses="mt-3" />
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseAssignMemberModal">Cancelar</button>
        <button type="button" class="btn btn-primary" @onclick="SaveAssignment"
                disabled="@(selectedMember == null)">Atribuir</button>
    </FooterContent>
</Modal>

@code {
    private int currentFiscalYearStartYear;
    private string currentFiscalYearString = "";
    private List<RoleAssignment> roleAssignments = new();
    private List<string> fiscalYears = new();
    private string selectedFiscalYear = "";
    private bool isLoading = true;
    private bool isAdmin = false;
    
    // RGI PDF state
    private bool showRgiModal = false;
    private bool isLoadingRgi = false;
    private string? rgiPdfUrl;
    
    // Admin modal state
    private bool showCreateFiscalYearModal = false;
    private bool showAssignMemberModal = false;
    private int newStartYear = DateTime.Now.Year;
    private string errorMessage = "";
    
    private Position? selectedPosition;
    private string selectedPositionName = "";
    private string memberSearchTerm = "";
    private ApplicationUser? selectedMember;
    private List<ApplicationUser> allMembers = new();
    private List<ApplicationUser> filteredMembers = new();
    
    // Helper for multi-word search
    private SearchHelper<ApplicationUser> searchHelper = new();

    protected override async Task OnInitializedAsync()
    {
        currentFiscalYearStartYear = FiscalYearHelper.GetCurrentFiscalYearStartYear();
        currentFiscalYearString = FiscalYearHelper.GetCurrentFiscalYearString();
        
        // Check if user is admin
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        isAdmin = authState.User.IsInRole("Admin");
        
        // Load fiscal years
        await LoadFiscalYears();
        
        // Load all members for admin
        if (isAdmin)
        {
            LoadAllMembers();
        }
        
        // Handle URL query parameter ?fy=
        var uri = new Uri(NavigationManager.Uri);
        var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var fyParam = queryParams["fy"];
        
        if (!string.IsNullOrEmpty(fyParam) && fiscalYears.Contains(fyParam))
        {
            selectedFiscalYear = fyParam;
        }
        else if (fiscalYears.Contains(currentFiscalYearString))
        {
            selectedFiscalYear = currentFiscalYearString;
        }
        else if (fiscalYears.Any())
        {
            selectedFiscalYear = fiscalYears.First();
        }
        
        await LoadRoleAssignments();
        
        // Handle ?manage=1 query parameter (redirect from /admin/roles)
        var manageParam = queryParams["manage"];
        if (manageParam == "1" && isAdmin)
        {
            OpenCreateFiscalYearModal();
        }
    }
    
    private async Task LoadFiscalYears()
    {
        var years = (await FiscalYearService.GetAllFiscalYearsAsync())
            .OrderByDescending(y => y.StartYear)
            .ToList();

        fiscalYears = years.Select(y => y.FiscalYearString).ToList();
    }
    
    private void LoadAllMembers()
    {
        allMembers = UserManager.Users
            .OrderBy(u => u.FirstName)
            .ThenBy(u => u.LastName)
            .ToList()  // Materialize query first
            .Where(u => !u.IsLeitao())  // Then filter in memory
            .ToList();
    }
    
    private async Task LoadRoleAssignments()
    {
        if (string.IsNullOrEmpty(selectedFiscalYear))
        {
            roleAssignments = new();
            isLoading = false;
            return;
        }
        
        isLoading = true;
        StateHasChanged();
        
        var parts = selectedFiscalYear.Split('-');
        if (parts.Length != 2 || !int.TryParse(parts[0], out var startYear) || !int.TryParse(parts[1], out var endYear))
        {
            roleAssignments = new();
            isLoading = false;
            return;
        }
        
        // Get all role assignments
        var allAssignments = await RoleAssignmentService.GetAllRoleAssignmentsAsync();
        
        // Filter to selected fiscal year
        roleAssignments = allAssignments
            .Where(ra => ra.StartYear == startYear && ra.EndYear == endYear)
            .ToList();

        // Load all user data at once to avoid N+1 queries
        var userIds = roleAssignments.Select(ra => ra.UserId).Distinct().ToList();
        var users = new Dictionary<string, ApplicationUser>();
        
        foreach (var userId in userIds)
        {
            var user = await UserManager.FindByIdAsync(userId);
            if (user != null)
            {
                users[userId] = user;
            }
        }

        // Assign users to assignments
        foreach (var assignment in roleAssignments)
        {
            if (users.TryGetValue(assignment.UserId, out var user))
            {
                assignment.User = user;
            }
        }

        isLoading = false;
    }
    
    private async Task OnFiscalYearChanged()
    {
        // Update URL with query parameter
        NavigationManager.NavigateTo($"/roles?fy={selectedFiscalYear}", forceLoad: false);
        await LoadRoleAssignments();
    }

    private RoleAssignment? GetRoleAssignment(Position position)
    {
        return roleAssignments.FirstOrDefault(r => r.Position == position);
    }
    
    private async Task OpenRgiModal()
    {
        isLoadingRgi = true;
        showRgiModal = true;
        StateHasChanged();
        
        try
        {
            // Generate presigned URL for RGI PDF (docs/rtub_rgi.pdf)
            rgiPdfUrl = await DocumentStorageService.GetDocumentUrlAsync("docs/rtub_rgi.pdf");
            
            isLoadingRgi = false;
            StateHasChanged();
        }
        catch (Exception)
        {
            isLoadingRgi = false;
            rgiPdfUrl = null;
            StateHasChanged();
        }
    }
    
    private void CloseRgiModal()
    {
        showRgiModal = false;
        isLoadingRgi = false;
        rgiPdfUrl = null;
    }
    
    // Admin modal methods
    private void OpenCreateFiscalYearModal()
    {
        newStartYear = DateTime.Now.Year;
        errorMessage = "";
        showCreateFiscalYearModal = true;
    }

    private void CloseCreateFiscalYearModal()
    {
        showCreateFiscalYearModal = false;
        errorMessage = "";
    }

    private async Task CreateFiscalYear()
    {
        errorMessage = "";

        try
        {
            // Create fiscal year via service (validation is done in the service)
            var newFiscalYear = await FiscalYearService.CreateFiscalYearAsync(newStartYear);

            // Reload fiscal years and select the new one
            await LoadFiscalYears();
            selectedFiscalYear = newFiscalYear.FiscalYearString;
            await LoadRoleAssignments();
            CloseCreateFiscalYearModal();
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
    }

    private void OpenAssignMemberModal(Position position, string displayName)
    {
        selectedPosition = position;
        selectedPositionName = displayName;
        memberSearchTerm = "";
        selectedMember = null;
        filteredMembers.Clear();
        errorMessage = "";
        showAssignMemberModal = true;
    }

    private void CloseAssignMemberModal()
    {
        showAssignMemberModal = false;
        selectedPosition = null;
        selectedPositionName = "";
        memberSearchTerm = "";
        selectedMember = null;
        filteredMembers.Clear();
        errorMessage = "";
    }

    private void FilterMembers()
    {
        if (string.IsNullOrEmpty(memberSearchTerm))
        {
            filteredMembers.Clear();
            return;
        }

        // Use SearchHelper for multi-word search support
        searchHelper.SearchTerm = memberSearchTerm;
        filteredMembers = searchHelper.FilterMultiple(allMembers, new List<Func<ApplicationUser, string>>
        {
            u => u.FirstName ?? "",
            u => u.LastName ?? "",
            u => u.Nickname ?? "",
            u => u.Email ?? ""
        });
    }

    private void SelectMember(ApplicationUser member)
    {
        selectedMember = member;
    }

    private async Task SaveAssignment()
    {
        if (selectedMember == null || selectedPosition == null || string.IsNullOrEmpty(selectedFiscalYear))
            return;

        errorMessage = "";

        // Check if member is LEITAO
        if (selectedMember.IsLeitao())
        {
            errorMessage = "Não é possível atribuir cargos a membros LEITÃO.";
            return;
        }

        // President positions that Caloiro cannot hold
        var presidentPositions = new[]
        {
            Position.Magister,
            Position.PresidenteMesaAssembleia,
            Position.PresidenteConselhoFiscal,
            Position.PresidenteConselhoVeteranos
        };

        // Check if member is CALOIRO and trying to assign a President position
        if (selectedMember.IsCaloiro() &&
            presidentPositions.Contains(selectedPosition.Value))
        {
            errorMessage = "CALOIRO não pode ser atribuído a cargos de Presidente.";
            return;
        }

        // Check if position is Presidente do Conselho de Veteranos and member is not Tuno Veterano
        if (selectedPosition.Value == Position.PresidenteConselhoVeteranos)
        {
            var isTunoVeterano = selectedMember.IsTuno() && selectedMember.QualifiesForVeterano();

            if (!isTunoVeterano)
            {
                errorMessage = "Presidente do Conselho de Veteranos deve ser TUNO VETERANO (mínimo 2 anos como Tuno).";
                return;
            }
        }

        var parts = selectedFiscalYear.Split('-');
        if (parts.Length != 2 || !int.TryParse(parts[0], out var startYear) || !int.TryParse(parts[1], out var endYear))
        {
            errorMessage = "Ano fiscal inválido.";
            return;
        }

        // Check if this position is already assigned for this fiscal year
        var existing = (await RoleAssignmentService.GetAllRoleAssignmentsAsync())
            .FirstOrDefault(r => r.Position == selectedPosition.Value &&
                                 r.StartYear == startYear &&
                                 r.EndYear == endYear);

        if (existing != null)
        {
            errorMessage = "Este cargo já está atribuído para este ano fiscal.";
            return;
        }

        // Check if member already has a position assigned in this fiscal year
        var memberHasAssignment = (await RoleAssignmentService.GetRoleAssignmentsByUserIdAsync(selectedMember.Id))
            .Any(r => r.StartYear == startYear && r.EndYear == endYear);

        if (memberHasAssignment)
        {
            errorMessage = "Este membro já tem um cargo atribuído para este ano fiscal.";
            return;
        }

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserId = UserManager.GetUserId(authState.User);

        await RoleAssignmentService.CreateRoleAssignmentAsync(
            selectedMember.Id,
            selectedPosition.Value,
            startYear,
            endYear,
            null,
            currentUserId
        );

        // Update user's current Positions property and promote to Admin ONLY if fiscal year is current
        int currentFiscalStartYear = FiscalYearHelper.GetCurrentFiscalYearStartYear();

        bool isFiscalYearCurrent = (startYear == currentFiscalStartYear);

        var user = await UserManager.FindByIdAsync(selectedMember.Id);
        if (user != null && isFiscalYearCurrent)
        {
            var positions = user.Positions.ToList();
            if (!positions.Contains(selectedPosition.Value))
            {
                positions.Add(selectedPosition.Value);
                user.Positions = positions;
                await SetAuditContextToCurrentUser();
                await UserManager.UpdateAsync(user);
            }

            // Promote user from Member to Admin role
            var currentRoles = await UserManager.GetRolesAsync(user);
            if (!currentRoles.Contains("Admin"))
            {
                // Remove Member role if present
                if (currentRoles.Contains("Member"))
                {
                    await UserManager.RemoveFromRoleAsync(user, "Member");
                }
                // Add Admin role
                await UserManager.AddToRoleAsync(user, "Admin");
            }
        }

        await LoadRoleAssignments();
        CloseAssignMemberModal();
    }

    private async Task RemoveAssignment(int assignmentId)
    {
        // Get assignment details before deleting
        var assignment = await RoleAssignmentService.GetRoleAssignmentByIdAsync(assignmentId);
        if (assignment == null) return;

        await RoleAssignmentService.DeleteRoleAssignmentAsync(assignmentId);

        // Remove from user's current Positions property ONLY if fiscal year is current
        int currentFiscalStartYear = FiscalYearHelper.GetCurrentFiscalYearStartYear();
        bool isFiscalYearCurrent = (assignment.StartYear == currentFiscalStartYear);

        var user = await UserManager.FindByIdAsync(assignment.UserId);
        if (user != null && isFiscalYearCurrent)
        {
            var positions = user.Positions.ToList();
            if (positions.Contains(assignment.Position))
            {
                positions.Remove(assignment.Position);
                user.Positions = positions;
                await SetAuditContextToCurrentUser();
                await UserManager.UpdateAsync(user);
            }

            // Check if user has no more positions - if so, demote from Admin to Member
            var userRoles = await UserManager.GetRolesAsync(user);
            if (!positions.Any() && userRoles.Contains("Admin") && !userRoles.Contains("Owner"))
            {
                // Remove Admin role
                await UserManager.RemoveFromRoleAsync(user, "Admin");
                
                // Add Member role
                await UserManager.AddToRoleAsync(user, "Member");
                
                // Invalidate security stamp to force fresh cookies and token refresh
                await UserManager.UpdateSecurityStampAsync(user);
            }
        }

        await LoadRoleAssignments();
    }

    private async Task SetAuditContextToCurrentUser()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.Name;
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        AuditContext.SetUser(userName, userId);
    }
}

