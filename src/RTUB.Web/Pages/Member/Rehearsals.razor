@page "/rehearsals"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using RTUB.Application.Interfaces
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Shared
@using RTUB.Core.Enums
@attribute [Authorize]
@inject IRehearsalService RehearsalService
@inject IRehearsalAttendanceService AttendanceService
@inject IFiscalYearService FiscalYearService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1>Ensaios</h1>
        <p class="mb-0">Ensaios regulares da tuna (Terças e Quintas, 21:00-00:00).</p>
    </div>
    @if (isAdmin)
    {
        <div class="d-flex gap-2">
            <button class="btn btn-success" @onclick="OpenCreateSingleModal" title="Adicionar Ensaio">
                <i class="bi bi-plus-lg"></i> Adicionar
            </button>
            <button class="btn btn-outline-primary" @onclick="OpenStatsModal" title="Ver Estatísticas">
                <i class="bi bi-bar-chart"></i> Estatísticas
            </button>
        </div>
    }
</div>

<!-- Filter Controls -->
<div class="row mb-3">
    <div class="col-md-4">
        <label class="form-label">Ano Fiscal</label>
        <select class="form-select" @bind="selectedFiscalYear" @bind:after="FilterRehearsals">
            <option value="">Todos os anos</option>
            @foreach (var year in fiscalYears)
            {
                var isCurrent = year == currentFiscalYear;
                <option value="@year">@year@(isCurrent ? " (ATUAL)" : "")</option>
            }
        </select>
    </div>
    <div class="col-md-8">
        <label class="form-label">Pesquisar</label>
        <TableSearchBar SearchTerm="@searchTerm"
                        Placeholder="Pesquisar por tema ou localização..."
                        OnSearchChanged="@HandleSearchChanged" />
    </div>
</div>

@if (loading)
{
    <p>A carregar ensaios...</p>
}
else
{
    <!-- Upcoming Rehearsals Section -->
    <h3 class="mt-4 mb-3">Próximos Ensaios</h3>

    @if (filteredUpcomingRehearsals == null || !filteredUpcomingRehearsals.Any())
    {
        <div class="card shadow-sm card-purple-no-border">
            <h5 class="card-title text-white"><i class="bi bi-info-circle"></i> Nenhum ensaio agendado</h5>
        </div>
    }
    else
    {
        <div class="rehearsal-grid">
            @foreach (var rehearsal in filteredUpcomingRehearsals)
            {
                var userAttendance = GetUserAttendance(rehearsal.Id);
                var attendanceCount = rehearsal.Attendances.Count();

                <RehearsalCard Rehearsal="@rehearsal"
                               UserAttendance="@userAttendance"
                               AttendanceCount="@attendanceCount"
                               IsAdmin="@isAdmin"
                               IsPastRehearsal="false"
                               OnEdit="@(() => OpenEditModal(rehearsal))"
                               OnDelete="@(() => OpenDeleteModal(rehearsal))"
                               OnMarkAttendance="@(() => MarkAttendance(rehearsal))"
                               OnViewAttendances="@(() => ViewAttendances(rehearsal))"
                               OnEditAttendance="@(() => EditAttendance(rehearsal))"
                               OnRemoveAttendance="@(() => RemoveAttendance(rehearsal))" />
            }
        </div>
    }

    <!-- My Recent Attendance Section -->
    <h3 class="mt-5 mb-3">Minhas Presenças Recentes</h3>

    @if (myAttendances == null || !myAttendances.Any())
    {
        <div class="card shadow-sm card-purple-no-border">
            <h5 class="card-title text-white"><i class="bi bi-info-circle"></i> Sem presenças registadas</h5>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <p class="mb-3">
                    <strong>Taxa de Presença (últimos 10 ensaios):</strong>
                    <span class="badge bg-primary">@attendanceCount / @totalRecentRehearsals ensaios</span>
                    @if (totalRecentRehearsals > 0)
                    {
                        <span class="ms-2">(@(Math.Round((double)attendanceCount / totalRecentRehearsals * 100, 1))%)</span>
                    }
                </p>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Instrumento</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var attendance in myAttendances.Where(a => a.Rehearsal != null && a.Rehearsal.Date < DateTime.Today).OrderByDescending(a => a.Rehearsal!.Date).Take(10))
                            {
                                <tr>
                                    <td>@attendance.Rehearsal?.Date.ToString("dd MMM yyyy")</td>
                                    <td>@(attendance.Instrument?.ToString() ?? "-")</td>
                                    <td>
                                        @if (attendance.Attended)
                                        {
                                            <span class="badge bg-success">Aprovado</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning">Pendente</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    
    <!-- Previous Rehearsals Section (Admin Only) -->
    @if (isAdmin)
    {
        <h3 class="mt-5 mb-3">Ensaios Anteriores</h3>
        
        <!-- Search for previous rehearsals -->
        <div class="mb-3">
            <TableSearchBar SearchTerm="@previousRehearsalsSearch"
                           Placeholder="Pesquisar ensaio anterior..."
                           OnSearchChanged="@HandlePreviousRehearsalsSearchChanged" />
        </div>
        
        @if (filteredPreviousRehearsals == null || !filteredPreviousRehearsals.Any())
        {
            <div class="card shadow-sm card-purple-no-border">
                <h5 class="card-title text-white"><i class="bi bi-info-circle"></i> Nenhum ensaio anterior encontrado</h5>
            </div>
        }
        else
        {
            <div class="rehearsal-grid">
                @foreach (var rehearsal in paginatedPreviousRehearsals)
                {
                    var attendanceCount = rehearsal.Attendances.Count();
                    
                    <RehearsalCard Rehearsal="@rehearsal"
                                   UserAttendance="null"
                                   AttendanceCount="@attendanceCount"
                                   IsAdmin="@isAdmin"
                                   IsPastRehearsal="true"
                                   OnEdit="@(() => OpenEditModal(rehearsal))"
                                   OnDelete="@(() => OpenDeleteModal(rehearsal))"
                                   OnMarkAttendance="@(() => {})"
                                   OnViewAttendances="@(() => ViewAttendances(rehearsal))"
                                   OnEditAttendance="@(() => {})"
                                   OnRemoveAttendance="@(() => {})" />
                }
            </div>
            
            <!-- Pagination for previous rehearsals -->
            <TablePagination CurrentPage="@previousRehearsalsPagination.CurrentPage"
                            PageSize="@previousRehearsalsPagination.PageSize"
                            TotalItems="@filteredPreviousRehearsals.Count"
                            ItemLabel="ensaios"
                            OnPageChanged="@HandlePreviousRehearsalsPageChange"
                            OnPageSizeChanged="@HandlePreviousRehearsalsPageSizeChange" />
        }
    }
}

<!-- Mark Attendance Modal -->
@if (showAttendanceModal && selectedRehearsal != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Marcar Presença</h5>
                    <button type="button" class="btn-close" @onclick="CloseAttendanceModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Instrumento (Opcional)</label>
                        <select class="form-select" @bind="selectedInstrument">
                            <option value="">-- Selecionar --</option>
                            @foreach (var instrument in Enum.GetValues<InstrumentType>())
                            {
                                <option value="@instrument">@instrument</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas (Opcional)</label>
                        <textarea class="form-control" rows="3" @bind="selectedNotes" placeholder="Adicione alguma nota..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAttendanceModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="ConfirmMarkAttendance">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- View Attendances Modal -->
@if (showAttendancesModal && selectedRehearsal != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Presenças - @selectedRehearsal.Date.ToString("dd MMM yyyy")</h5>
                    <button type="button" class="btn-close" @onclick="CloseAttendancesModal"></button>
                </div>
                <div class="modal-body">
                    @if (selectedRehearsalAttendances != null && selectedRehearsalAttendances.Any())
                    {
                        <div class="enrollment-card-grid">
                            @foreach (var attendance in selectedRehearsalAttendances.OrderByDescending(a => a.Attended).ThenBy(a => a.User?.FirstName))
                            {
                                var instrumentDisplay = attendance.Instrument?.ToString() ?? "—";
                                <EnrollmentCard 
                                    AvatarUrl="@attendance.User?.ProfilePictureSrc"
                                    TunaName="@attendance.User?.Nickname"
                                    FullName="@($"{attendance.User?.FirstName} {attendance.User?.LastName}")"
                                    InstrumentText="@instrumentDisplay"
                                    Notes=""
                                    AltText="@attendance.User?.GetDisplayName()"
                                    ShowEditButton="false"
                                    ShowDeleteButton="@(isAdmin && attendance.Attended)"
                                    ShowApproveButton="@(isAdmin && !attendance.Attended)"
                                    OnDelete="@(() => OpenDeleteAttendanceModal(attendance))"
                                    OnApprove="@(() => ApproveAttendance(attendance))"
                                    DeleteTooltip="Eliminar Presença"
                                    ApproveTooltip="Aprovar">
                                    <BadgeContent>
                                        <div class="enrollment-card-badges-row">
                                            @if (attendance.Attended)
                                            {
                                                <span class="badge bg-success">Aprovado</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">Pendente</span>
                                            }
                                        </div>
                                    </BadgeContent>
                                </EnrollmentCard>
                            }
                        </div>
                    }
                    else
                    {
                        <p>Nenhuma presença registada ainda.</p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAttendancesModal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Edit/Delete Modals -->
@if (showEditModal && editingRehearsal != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Ensaio</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Localização</label>
                        <input type="text" class="form-control" @bind="editLocation" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tema (opcional)</label>
                        <input type="text" class="form-control" @bind="editTheme" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas (opcional)</label>
                        <textarea class="form-control" rows="3" @bind="editNotes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveEdit">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showDeleteModal && deletingRehearsal != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Eliminar Ensaio</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteModal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem a certeza que deseja eliminar o ensaio de <strong>@deletingRehearsal.Date.ToString("dd MMM yyyy")</strong>?</p>
                    <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> Esta ação não pode ser revertida.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal">Cancelar</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Attendance Confirmation Modal (Owner Only) -->
@if (showDeleteAttendanceModal && deletingAttendance != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Eliminação de Presença</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteAttendanceModal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem a certeza que deseja eliminar a presença de <strong>@(deletingAttendance.User?.FirstName ?? "") "@(deletingAttendance.User?.Nickname ?? deletingAttendance.UserId)"</strong> neste ensaio?</p>
                    <p class="text-muted small">Esta ação não pode ser revertida.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteAttendanceModal">Cancelar</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteAttendance">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Create Single Rehearsal Modal (Admin Only) -->
@if (showCreateModal && isAdmin)
{
    <Modal Show="@showCreateModal"
           ShowChanged="@((bool show) => showCreateModal = show)"
           Title="Criar Ensaio"
           Size="Modal.ModalSize.Default"
           Centered="true">
        <BodyContent>
            <div class="mb-3">
                <label class="form-label">Data <span class="text-danger">*</span></label>
                <input type="date" class="form-control" @bind="createDate" />
            </div>
            <div class="mb-3">
                <label class="form-label">Localização <span class="text-danger">*</span></label>
                <input type="text" class="form-control" @bind="createLocation" />
            </div>
            <div class="mb-3">
                <label class="form-label">Tema (Opcional)</label>
                <input type="text" class="form-control" @bind="createTheme" />
            </div>
            <div class="mb-3">
                <label class="form-label">Notas (Opcional)</label>
                <textarea class="form-control" rows="3" @bind="createNotes"></textarea>
            </div>
        </BodyContent>
        <FooterContent>
            <button type="button" class="btn btn-secondary" @onclick="CloseCreateModal">Cancelar</button>
            <button type="button" class="btn btn-primary" @onclick="SaveNewRehearsal">Criar</button>
        </FooterContent>
    </Modal>
}

<!-- Statistics Modal (Admin Only) -->
@if (showStatsModal && isAdmin)
{
    <Modal Show="@showStatsModal"
           ShowChanged="@((bool show) => showStatsModal = show)"
           Title="Estatísticas de Presenças"
           Size="Modal.ModalSize.Large"
           Centered="true">
        <BodyContent>
            <div class="mb-3">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Data Início</label>
                        <input type="date" class="form-control" @bind="statsStartDate" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Data Fim</label>
                        <input type="date" class="form-control" @bind="statsEndDate" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100 d-block" @onclick="LoadStats">Carregar Estatísticas</button>
                    </div>
                </div>
            </div>

            @if (attendanceStatsUsers != null && attendanceStatsUsers.Any())
            {
                <!-- Search Bar -->
                <div class="mb-3">
                    <TableSearchBar SearchTerm="@statsSearchTerm"
                                   Placeholder="Pesquisar por nome..."
                                   OnSearchChanged="@HandleStatsSearchChanged" />
                </div>

                @if (!filteredStatsUsers.Any())
                {
                    <EmptyTableState 
                        Message="Nenhum membro encontrado com os critérios de pesquisa." 
                        IconClass="bi-search" />
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th @onclick="() => SortStatsBy(nameof(UserAttendanceStats.UserName))" class="clickable-row">
                                        Membro
                                        @if (statsSortHelper.IsActiveSortColumn(nameof(UserAttendanceStats.UserName)))
                                        {
                                            <i class="bi @statsSortHelper.GetSortIcon(nameof(UserAttendanceStats.UserName))"></i>
                                        }
                                    </th>
                                    <th @onclick="() => SortStatsBy(nameof(UserAttendanceStats.Count))" class="clickable-row">
                                        Total de Presenças
                                        @if (statsSortHelper.IsActiveSortColumn(nameof(UserAttendanceStats.Count)))
                                        {
                                            <i class="bi @statsSortHelper.GetSortIcon(nameof(UserAttendanceStats.Count))"></i>
                                        }
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var stat in paginatedStatsUsers)
                                {
                                    <tr>
                                        <td>@stat.UserName</td>
                                        <td>@stat.Count</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <TablePagination CurrentPage="@statsPaginationHelper.CurrentPage"
                                    PageSize="@statsPaginationHelper.PageSize"
                                    TotalItems="@filteredStatsUsers.Count"
                                    ItemLabel="membros"
                                    OnPageChanged="@HandleStatsPageChange"
                                    OnPageSizeChanged="@HandleStatsPageSizeChange" />
                }
            }
            else if (attendanceStatsUsers != null)
            {
                <EmptyTableState 
                    Message="Sem dados para o período selecionado." 
                    IconClass="bi-info-circle" />
            }
        </BodyContent>
        <FooterContent>
            <button type="button" class="btn btn-secondary" @onclick="CloseStatsModal">Fechar</button>
        </FooterContent>
    </Modal>
}

@code {
    private bool loading = true;
    private bool isAdmin = false;
    private bool isOwner = false;
    private string? currentUserId;

    private List<Rehearsal> upcomingRehearsals = new();
    private List<Rehearsal> filteredUpcomingRehearsals = new();
    private List<RehearsalAttendance> myAttendances = new();
    private int attendanceCount = 0;
    private int totalRecentRehearsals = 0;

    // Previous rehearsals (admin only)
    private List<Rehearsal> previousRehearsals = new();
    private List<Rehearsal> filteredPreviousRehearsals = new();
    private List<Rehearsal> paginatedPreviousRehearsals = new();
    private string previousRehearsalsSearch = "";
    private SearchHelper<Rehearsal> previousSearchHelper = new();
    private PaginationHelper<Rehearsal> previousRehearsalsPagination = new() { PageSize = 12 };

    // Fiscal year filtering
    private List<string> fiscalYears = new();
    private string currentFiscalYear = "";
    private string selectedFiscalYear = "";
    private string searchTerm = "";
    private SearchHelper<Rehearsal> searchHelper = new();

    // Modals
    private bool showAttendanceModal = false;
    private bool showAttendancesModal = false;
    private bool showEditModal = false;
    private bool showDeleteModal = false;
    private bool showDeleteAttendanceModal = false;
    private bool showCreateModal = false;
    private bool showStatsModal = false;
    
    private Rehearsal? selectedRehearsal;
    private Rehearsal? editingRehearsal;
    private Rehearsal? deletingRehearsal;
    private RehearsalAttendance? deletingAttendance;
    private string? selectedInstrument;
    private string? selectedNotes;
    private string editLocation = "";
    private string? editTheme;
    private string? editNotes;
    private List<RehearsalAttendance>? selectedRehearsalAttendances;

    // Create rehearsal
    private DateTime createDate = DateTime.Today.AddDays(1);
    private string createLocation = "Centro Académico";
    private string? createTheme;
    private string? createNotes;

    // Stats data
    private DateTime statsStartDate = DateTime.Today.AddDays(-30);
    private DateTime statsEndDate = DateTime.Today;
    private List<UserAttendanceStats>? attendanceStatsUsers;
    private List<UserAttendanceStats> filteredStatsUsers = new();
    private List<UserAttendanceStats> paginatedStatsUsers = new();
    private string statsSearchTerm = string.Empty;
    private SortableTableHelper<UserAttendanceStats> statsSortHelper = new() { SortColumn = nameof(UserAttendanceStats.Count), SortAscending = false };
    private PaginationHelper<UserAttendanceStats> statsPaginationHelper = new() { PageSize = 20 };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await UserManager.GetUserAsync(user);
            if (appUser != null)
            {
                currentUserId = appUser.Id;
                isAdmin = user.IsInRole("Admin") || user.IsInRole("Owner");
                isOwner = user.IsInRole("Owner");
            }
        }

        // Load fiscal years
        var allFiscalYears = await FiscalYearService.GetAllFiscalYearsAsync();
        fiscalYears = allFiscalYears.Select(fy => fy.GetFiscalYearString()).OrderByDescending(y => y).ToList();
        currentFiscalYear = FiscalYearHelper.GetCurrentFiscalYearString();

        // Set default to current fiscal year
        selectedFiscalYear = currentFiscalYear;

        await LoadData();
        loading = false;
    }

    private async Task LoadData()
    {
        // Load upcoming rehearsals (next 30 days)
        var startDate = DateTime.Today;
        var endDate = DateTime.Today.AddDays(30);
        var allRehearsals = await RehearsalService.GetRehearsalsAsync(startDate, endDate);
        upcomingRehearsals = allRehearsals.Where(r => !r.IsCanceled).OrderBy(r => r.Date).ToList();

        // Load previous rehearsals for admins (past 6 months)
        if (isAdmin)
        {
            var pastStart = DateTime.Today.AddMonths(-6);
            var pastEnd = DateTime.Today;
            var allPastRehearsals = await RehearsalService.GetRehearsalsAsync(pastStart, pastEnd);
            previousRehearsals = allPastRehearsals
                .Where(r => r.Date < DateTime.Today)
                .OrderByDescending(r => r.Date)
                .ToList();
        }

        // Load user's recent attendances
        if (currentUserId != null)
        {
            myAttendances = (await AttendanceService.GetAttendancesByUserIdAsync(currentUserId)).ToList();

            // Calculate attendance stats for last 10 past rehearsals
            var recentEnd = DateTime.Today;
            var recentStart = DateTime.Today.AddDays(-90); // Look back 90 days (3 months)

            // Get all past rehearsals in the period
            var recentRehearsals = await RehearsalService.GetRehearsalsAsync(recentStart, recentEnd);
            var pastRehearsals = recentRehearsals
                .Where(r => !r.IsCanceled && r.Date < DateTime.Today)
                .OrderByDescending(r => r.Date)
                .Take(10)
                .ToList();

            totalRecentRehearsals = pastRehearsals.Count;

            // Count only approved attendances for these specific rehearsals
            var pastRehearsalIds = pastRehearsals.Select(r => r.Id).ToHashSet();
            attendanceCount = myAttendances.Count(a =>
                a.Attended &&
                pastRehearsalIds.Contains(a.RehearsalId));
        }

        FilterRehearsals();
        if (isAdmin)
        {
            FilterPreviousRehearsals();
        }
    }

    private void FilterRehearsals()
    {
        var filtered = upcomingRehearsals.AsEnumerable();

        // Apply fiscal year filter
        if (!string.IsNullOrEmpty(selectedFiscalYear))
        {
            // Parse fiscal year (e.g., "2024-2025" -> start: 2024, end: 2025)
            var parts = selectedFiscalYear.Split('-');
            if (parts.Length == 2 && int.TryParse(parts[0], out int startYear))
            {
                var fiscalStart = new DateTime(startYear, 9, 1); // September 1st
                var fiscalEnd = new DateTime(startYear + 1, 8, 31); // August 31st next year

                filtered = filtered.Where(r => r.Date >= fiscalStart && r.Date <= fiscalEnd);
            }
        }

        // Apply search filter
        searchHelper.SearchTerm = searchTerm;
        filteredUpcomingRehearsals = searchHelper.FilterMultiple(filtered.ToList(), new List<Func<Rehearsal, string>>
        {
            r => r.Theme ?? "",
            r => r.Location ?? "",
            r => r.Notes ?? ""
        });
    }

    private async Task HandleSearchChanged(string search)
    {
        searchTerm = search;
        FilterRehearsals();
        await Task.CompletedTask;
    }

    private RehearsalAttendance? GetUserAttendance(int rehearsalId)
    {
        return myAttendances?.FirstOrDefault(a => a.RehearsalId == rehearsalId);
    }

    private void MarkAttendance(Rehearsal rehearsal)
    {
        selectedRehearsal = rehearsal;
        selectedInstrument = null;
        selectedNotes = null;
        showAttendanceModal = true;
        StateHasChanged();
    }

    private async Task ConfirmMarkAttendance()
    {
        if (selectedRehearsal != null && currentUserId != null)
        {
            try
            {
                InstrumentType? instrument = null;
                if (!string.IsNullOrEmpty(selectedInstrument))
                {
                    instrument = Enum.Parse<InstrumentType>(selectedInstrument);
                }

                await AttendanceService.MarkAttendanceAsync(selectedRehearsal.Id, currentUserId, instrument, selectedNotes);

                await LoadData();
                CloseAttendanceModal();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                // Log error or show message to user
                Console.WriteLine($"Error marking attendance: {ex.Message}");
            }
        }
    }

    private void CloseAttendanceModal()
    {
        showAttendanceModal = false;
        selectedRehearsal = null;
        selectedInstrument = null;
        selectedNotes = null;
        StateHasChanged();
    }

    private async Task ViewAttendances(Rehearsal rehearsal)
    {
        selectedRehearsal = rehearsal;
        selectedRehearsalAttendances = (await AttendanceService.GetAttendancesByRehearsalIdAsync(rehearsal.Id)).ToList();

        // Load user details for display
        foreach (var attendance in selectedRehearsalAttendances)
        {
            if (attendance.User == null)
            {
                attendance.User = await UserManager.FindByIdAsync(attendance.UserId);
            }
        }

        showAttendancesModal = true;
        StateHasChanged();
    }

    private void CloseAttendancesModal()
    {
        showAttendancesModal = false;
        selectedRehearsal = null;
        selectedRehearsalAttendances = null;
        StateHasChanged();
    }

    private void EditAttendance(Rehearsal rehearsal)
    {
        // Similar to mark attendance, but pre-fill with existing data
        var existingAttendance = GetUserAttendance(rehearsal.Id);
        selectedRehearsal = rehearsal;
        selectedInstrument = existingAttendance?.Instrument?.ToString();
        showAttendanceModal = true;
        StateHasChanged();
    }

    private async Task RemoveAttendance(Rehearsal rehearsal)
    {
        var attendance = GetUserAttendance(rehearsal.Id);
        if (attendance != null)
        {
            await AttendanceService.DeleteAttendanceAsync(attendance.Id);
            await LoadData();
            StateHasChanged();
        }
    }

    // Admin methods for edit/delete
    private void OpenEditModal(Rehearsal rehearsal)
    {
        editingRehearsal = rehearsal;
        editLocation = rehearsal.Location;
        editTheme = rehearsal.Theme;
        editNotes = rehearsal.Notes;
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingRehearsal = null;
    }

    private async Task SaveEdit()
    {
        if (editingRehearsal != null)
        {
            await RehearsalService.UpdateRehearsalAsync(editingRehearsal.Id, editLocation, editTheme, editNotes);
            await LoadData();
            CloseEditModal();
        }
    }

    private void OpenDeleteModal(Rehearsal rehearsal)
    {
        deletingRehearsal = rehearsal;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        deletingRehearsal = null;
    }

    private async Task ConfirmDelete()
    {
        if (deletingRehearsal != null)
        {
            await RehearsalService.DeleteRehearsalAsync(deletingRehearsal.Id);
            await LoadData();
            CloseDeleteModal();
        }
    }

    // Owner-only attendance deletion methods
    private void OpenDeleteAttendanceModal(RehearsalAttendance attendance)
    {
        deletingAttendance = attendance;
        showDeleteAttendanceModal = true;
    }

    private void CloseDeleteAttendanceModal()
    {
        showDeleteAttendanceModal = false;
        deletingAttendance = null;
    }

    private async Task ApproveAttendance(RehearsalAttendance attendance)
    {
        try
        {
            await AttendanceService.UpdateAttendanceAsync(attendance.Id, true, attendance.Instrument);
            
            // Refresh the attendance list for the selected rehearsal
            if (selectedRehearsal != null)
            {
                selectedRehearsalAttendances = (await AttendanceService.GetAttendancesByRehearsalIdAsync(selectedRehearsal.Id)).ToList();

                // Load user details for display
                foreach (var att in selectedRehearsalAttendances)
                {
                    if (att.User == null)
                    {
                        att.User = await UserManager.FindByIdAsync(att.UserId);
                    }
                }
            }

            // Refresh data
            await LoadData();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error approving attendance: {ex.Message}");
        }
    }

    private async Task ConfirmDeleteAttendance()
    {
        if (deletingAttendance == null) return;

        try
        {
            await AttendanceService.DeleteAttendanceAsync(deletingAttendance.Id);

            // Refresh the attendance list for the selected rehearsal
            if (selectedRehearsal != null)
            {
                selectedRehearsalAttendances = (await AttendanceService.GetAttendancesByRehearsalIdAsync(selectedRehearsal.Id)).ToList();

                // Load user details for display
                foreach (var attendance in selectedRehearsalAttendances)
                {
                    if (attendance.User == null)
                    {
                        attendance.User = await UserManager.FindByIdAsync(attendance.UserId);
                    }
                }
            }

            // Refresh my attendances
            await LoadData();

            CloseDeleteAttendanceModal();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting attendance: {ex.Message}");
        }
    }

    private void EditRehearsal(Rehearsal rehearsal)
    {
        // Admin function - navigate to admin page
        Navigation.NavigateTo("/admin/rehearsals");
    }

    private void DeleteRehearsal(Rehearsal rehearsal)
    {
        // Admin function - navigate to admin page
        Navigation.NavigateTo("/admin/rehearsals");
    }

    // Previous rehearsals filtering and pagination
    private void FilterPreviousRehearsals()
    {
        previousSearchHelper.SearchTerm = previousRehearsalsSearch;
        filteredPreviousRehearsals = previousSearchHelper.FilterMultiple(
            previousRehearsals,
            new List<Func<Rehearsal, string>>
            {
                r => r.Theme ?? "",
                r => r.Location ?? ""
            }
        );

        paginatedPreviousRehearsals = previousRehearsalsPagination.GetPageData(filteredPreviousRehearsals);
    }

    private async Task HandlePreviousRehearsalsSearchChanged(string searchTerm)
    {
        previousRehearsalsSearch = searchTerm;
        FilterPreviousRehearsals();
        await Task.CompletedTask;
    }

    private async Task HandlePreviousRehearsalsPageChange(int newPage)
    {
        previousRehearsalsPagination.GoToPage(newPage);
        paginatedPreviousRehearsals = previousRehearsalsPagination.GetPageData(filteredPreviousRehearsals);
        await Task.CompletedTask;
    }

    private async Task HandlePreviousRehearsalsPageSizeChange(int newPageSize)
    {
        previousRehearsalsPagination.PageSize = newPageSize;
        previousRehearsalsPagination.Reset();
        paginatedPreviousRehearsals = previousRehearsalsPagination.GetPageData(filteredPreviousRehearsals);
        await Task.CompletedTask;
    }

    // Create modal methods
    private void OpenCreateSingleModal()
    {
        createDate = DateTime.Today.AddDays(1);
        createLocation = "Centro Académico";
        createTheme = null;
        createNotes = null;
        showCreateModal = true;
    }

    private void CloseCreateModal()
    {
        showCreateModal = false;
    }

    private async Task SaveNewRehearsal()
    {
        try
        {
            await RehearsalService.CreateRehearsalAsync(createDate, createLocation, createTheme);
            await LoadData();
            CloseCreateModal();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating rehearsal: {ex.Message}");
        }
    }

    // Statistics modal methods
    private void OpenStatsModal()
    {
        showStatsModal = true;
    }

    private void CloseStatsModal()
    {
        showStatsModal = false;
    }

    private async Task LoadStats()
    {
        try
        {
            var stats = await AttendanceService.GetAttendanceStatsAsync(statsStartDate, statsEndDate);
            attendanceStatsUsers = new List<UserAttendanceStats>();
            
            foreach (var stat in stats)
            {
                var user = await UserManager.FindByIdAsync(stat.Key);
                if (user != null)
                {
                    attendanceStatsUsers.Add(new UserAttendanceStats
                    {
                        UserId = stat.Key,
                        UserName = $"{user.FirstName} \"{user.Nickname}\"",
                        Count = stat.Value
                    });
                }
            }
            
            FilterStats();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading stats: {ex.Message}");
            attendanceStatsUsers = new List<UserAttendanceStats>();
        }
    }

    private void FilterStats()
    {
        if (attendanceStatsUsers == null)
        {
            filteredStatsUsers = new List<UserAttendanceStats>();
            paginatedStatsUsers = new List<UserAttendanceStats>();
            return;
        }

        // Apply search
        if (string.IsNullOrWhiteSpace(statsSearchTerm))
        {
            filteredStatsUsers = attendanceStatsUsers.ToList();
        }
        else
        {
            var search = statsSearchTerm.ToLower();
            filteredStatsUsers = attendanceStatsUsers
                .Where(s => s.UserName.ToLower().Contains(search))
                .ToList();
        }

        // Apply sorting
        var columnSelectors = new Dictionary<string, Func<UserAttendanceStats, IComparable>>
        {
            { nameof(UserAttendanceStats.UserName), s => s.UserName },
            { nameof(UserAttendanceStats.Count), s => s.Count }
        };
        filteredStatsUsers = statsSortHelper.ApplySort(filteredStatsUsers, columnSelectors);

        // Apply pagination
        paginatedStatsUsers = statsPaginationHelper.GetPageData(filteredStatsUsers);
    }

    private async Task HandleStatsSearchChanged(string searchTerm)
    {
        statsSearchTerm = searchTerm;
        FilterStats();
        await Task.CompletedTask;
    }

    private void SortStatsBy(string columnName)
    {
        statsSortHelper.ChangeSortColumn(columnName);
        FilterStats();
    }

    private async Task HandleStatsPageChange(int newPage)
    {
        statsPaginationHelper.GoToPage(newPage);
        paginatedStatsUsers = statsPaginationHelper.GetPageData(filteredStatsUsers);
        await Task.CompletedTask;
    }

    private async Task HandleStatsPageSizeChange(int newPageSize)
    {
        statsPaginationHelper.PageSize = newPageSize;
        statsPaginationHelper.Reset();
        paginatedStatsUsers = statsPaginationHelper.GetPageData(filteredStatsUsers);
        await Task.CompletedTask;
    }

    private class UserAttendanceStats
    {
        public string UserId { get; set; } = string.Empty;
        public string UserName { get; set; } = string.Empty;
        public int Count { get; set; }
    }
}
