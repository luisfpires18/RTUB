@page "/finance"
@namespace RTUB.Pages.Member
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using RTUB.Application.Interfaces
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Shared
@using RTUB.Core.Constants
@using RTUB.Core.Extensions
@using ReportEntity = RTUB.Core.Entities.Report
@attribute [Authorize]
@inherits CrudTablePageBase<ReportEntity>
@inject IReportService ReportService
@inject IActivityService ActivityService
@inject ITransactionService TransactionService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject RTUB.Application.Services.ReportPdfService PdfService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager

<h1 class="mb-2"><i class="bi bi-currency-euro"></i> Finanças</h1>
<p class="lead mb-4 text-light-theme">Relatórios financeiros anuais.</p>

    <AuthorizeView Roles="Admin">
        <Authorized>
            <div class="mb-3">
                <button class="btn btn-success mb-2" @onclick="OpenCreateModal" title="Adicionar Relatório">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </Authorized>
    </AuthorizeView>

    <div class="row mb-3">
        <div class="col-md-6">
            <TableSearchBar 
                SearchTerm="@SearchTerm"
                OnSearchChanged="UpdateSearch"
                Placeholder="Pesquisar por título ou ano..." />
        </div>
    </div>

    @if (AllItems == null)
    {
        <p>A carregar relatórios...</p>
    }
    else if (!FilteredItems.Any())
    {
        <AuthorizeView Roles="Admin">
            <Authorized>
                <EmptyState 
                    Title="Sem relatórios financeiros" 
                    Icon="bi-info-circle" />
            </Authorized>
            <NotAuthorized>
                <EmptyState 
                    Title="Sem relatórios financeiros" 
                    Icon="bi-info-circle" />
            </NotAuthorized>
        </AuthorizeView>
    }
    else
    {
        <div class="finance-report-grid">
            @foreach (var report in PaginatedItems)
            {
                <div>
                    <ReportCard 
                        Report="@report"
                        IsAdmin="@isAdmin"
                        IsOwner="@isOwner"
                        OnCardClick="@(() => ViewReport(report.Id))"
                        OnDownload="@(() => DownloadReport(report))"
                        OnPublish="@(() => OpenPublishModal(report))"
                        OnDelete="@(() => OpenDeleteModal(report))" />
                </div>
            }
        </div>

        <!-- Pagination -->
        <TablePagination 
            CurrentPage="@PaginationHelper.CurrentPage"
            PageSize="@PaginationHelper.PageSize"
            TotalItems="@FilteredItems.Count"
            ItemLabel="relatórios"
            PageSizeOptions="@(new[] { 3, 6, 9, 12, 15 })"
            OnPageChanged="ChangePage"
            OnPageSizeChanged="ChangePageSize" />
    }

<!-- Create/Edit ReportEntity Modal -->
<Modal Show="@showEditModal" 
       ShowChanged="@((value) => showEditModal = value)"
       Title="@(isCreateMode ? "Novo Relatório" : "Editar Relatório")" 
       Centered="true"
       ShowCloseButton="false">
    <BodyContent>
        <EditForm Model="editingReport" OnValidSubmit="SaveReport">
            <DataAnnotationsValidator />
            <ErrorDisplay />

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            @if (isCreateMode)
            {
                @if (!availableFiscalYearStartYears.Any())
                {
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Todos os anos letivos até ao ano atual já têm relatórios criados.
                    </div>
                }
                else
                {
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-calendar3 text-primary me-2"></i>Ano Letivo
                        </label>
                        <select class="form-select" @bind="fiscalYearInput">
                            @foreach (var year in availableFiscalYearStartYears)
                            {
                                <option value="@year">@year-@(year + 1)</option>
                            }
                        </select>
                    </div>
                }
            }

            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancelar</button>
                <button type="submit" class="btn btn-success" disabled="@(isCreateMode && !availableFiscalYearStartYears.Any())">Guardar</button>
            </div>
        </EditForm>
    </BodyContent>
</Modal>

<!-- Delete Confirmation Modal -->
<ConfirmDialog Show="@showDeleteModal"
               ShowChanged="@((value) => showDeleteModal = value)"
               Title="Confirmar Eliminação"
               Message="@($"Eliminar relatório {deletingReport?.Title}?")"
               WarningMessage="Esta ação é irreversível."
               ConfirmText="Eliminar"
               CancelText="Cancelar"
               ConfirmButtonClass="btn-danger"
               OnConfirm="DeleteReport"
               OnCancel="CloseDeleteModal" />

<!-- Publish Confirmation Modal -->
<Modal Show="@showPublishModal" 
       ShowChanged="@((value) => showPublishModal = value)"
       Title="Confirmar Publicação" 
       Centered="true"
       OnClose="@ClosePublishModal">
    <BodyContent>
        @if (publishingReport != null)
        {
            <p>Publicar relatório <strong>@publishingReport.Title</strong> do ano <strong>@($"{publishingReport.Year}-{publishingReport.Year + 1}")</strong>?</p>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="ClosePublishModal">Cancelar</button>
        <button type="button" class="btn btn-success" @onclick="PublishReport">
            <i class="bi bi-check-circle"></i> Publicar
        </button>
    </FooterContent>
</Modal>

@code {
    private bool showEditModal = false;
    private bool showDeleteModal = false;
    private bool showPublishModal = false;
    private bool isCreateMode = false;
    private ReportEntity? editingReport;
    private ReportEntity? deletingReport;
    private ReportEntity? publishingReport;

    private string currentFiscalYear = "";
    private List<string> availableFiscalYears = new();
    private List<int> availableFiscalYearStartYears = new();
    private int fiscalYearInput = DateTime.Now.Year;
    private string errorMessage = "";
    
    private bool isAdmin = false;
    private bool isOwner = false;
    private bool isLeitao = false;
    private string currentUserId = "";
    private System.Security.Claims.ClaimsPrincipal? userPrincipal;

    protected override async Task OnInitializedAsync()
    {
        // Set custom page size for finance reports
        PaginationHelper.PageSize = 3;
        
        SortHelper.SortColumn = nameof(ReportEntity.Year);
        SortHelper.SortAscending = false;
        CalculateCurrentFiscalYear();
        GenerateAvailableFiscalYears();
        
        // Get current user and roles
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userPrincipal = user; // Store ClaimsPrincipal for use
        
        if (user.Identity?.IsAuthenticated == true)
        {
            isAdmin = user.IsInRole("Admin");
            isOwner = user.IsInRole("Owner");
            
            // Check if user is Leitao using claims-based check
            isLeitao = userPrincipal.IsOnlyLeitao();
            
            var appUser = await UserManager.GetUserAsync(user);
            if (appUser != null)
            {
                currentUserId = appUser.Id;
            }
        }
        
        // Only load data if not Leitao
        if (!isLeitao)
        {
            await LoadItemsAsync();
            ApplyFiltersAndPagination();
        }
    }

    protected override async Task LoadItemsAsync()
    {
        // Simply load reports - financial values are computed from transactions
        AllItems = (await ReportService.GetAllReportsAsync()).ToList();
    }

    protected override Dictionary<string, Func<ReportEntity, IComparable>> GetSortColumnSelectors()
    {
        return new Dictionary<string, Func<ReportEntity, IComparable>>
        {
            [nameof(ReportEntity.Title)] = r => r.Title ?? "",
            [nameof(ReportEntity.Year)] = r => r.Year,
            [nameof(ReportEntity.TotalIncome)] = r => r.TotalIncome,
            [nameof(ReportEntity.TotalExpenses)] = r => r.TotalExpenses,
            [nameof(ReportEntity.FinalBalance)] = r => r.FinalBalance,
            [nameof(ReportEntity.IsPublished)] = r => r.IsPublished ? 1 : 0
        };
    }

    protected override List<Func<ReportEntity, string>> GetSearchSelectors()
    {
        return new List<Func<ReportEntity, string>>
        {
            r => r.Title ?? "",
            r => r.Year.ToString(),
            r => $"{r.Year}-{r.Year + 1}"
        };
    }

    private void CalculateCurrentFiscalYear()
    {
        var today = DateTime.Today;
        var currentMonth = today.Month;
        var currentYear = today.Year;

        // Determine current fiscal year (Sept-Aug cycle)
        int currentFiscalStartYear;
        if (currentMonth >= 9) // September or later
        {
            currentFiscalStartYear = currentYear;
        }
        else // January to August
        {
            currentFiscalStartYear = currentYear - 1;
        }

        var currentFiscalEndYear = currentFiscalStartYear + 1;
        currentFiscalYear = $"{currentFiscalStartYear}-{currentFiscalEndYear}";
    }

    private void GenerateAvailableFiscalYears()
    {
        var today = DateTime.Today;
        var currentMonth = today.Month;
        var currentYear = today.Year;

        // Get current fiscal start year
        int currentFiscalStartYear = currentMonth >= 9 ? currentYear : currentYear - 1;

        // Generate fiscal years from 2015 to current fiscal year
        availableFiscalYears.Clear();
        for (int year = currentFiscalStartYear; year >= 1991; year--)
        {
            availableFiscalYears.Add($"{year}-{year + 1}");
        }
    }

    private async Task GenerateAvailableFiscalYearStartYears()
    {
        var today = DateTime.Today;
        var currentMonth = today.Month;
        var currentYear = today.Year;

        // Get current fiscal start year
        int currentFiscalStartYear = currentMonth >= 9 ? currentYear : currentYear - 1;

        // Get all existing reports
        var existingReports = await ReportService.GetAllReportsAsync();
        var existingYears = new HashSet<int>(existingReports.Select(r => r.Year));

        // Generate list of available years from 1991 to current fiscal year
        availableFiscalYearStartYears.Clear();
        for (int year = currentFiscalStartYear; year >= 1991; year--)
        {
            if (!existingYears.Contains(year))
            {
                availableFiscalYearStartYears.Add(year);
            }
        }
    }

    private void ViewReport(int reportId)
    {
        NavigationManager.NavigateTo($"/finance/report/{reportId}");
    }

    private async Task OpenCreateModal()
    {
        isCreateMode = true;
        errorMessage = "";

        // Get available fiscal year start years (years without reports)
        await GenerateAvailableFiscalYearStartYears();
        
        // Default to current fiscal year start year if available
        fiscalYearInput = availableFiscalYearStartYears.Any() 
            ? availableFiscalYearStartYears.First() 
            : FiscalYearHelper.GetCurrentFiscalYearStartYear();

        editingReport = new ReportEntity
        {
            Title = "Placeholder" // Temporary title to pass validation, will be auto-generated in SaveReport
        };
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingReport = null;
        fiscalYearInput = DateTime.Now.Year;
        errorMessage = "";
    }

    private async Task SaveReport()
    {
        if (editingReport == null) return;

        errorMessage = "";

        // Validate fiscal year input
        if (fiscalYearInput < 1991 || fiscalYearInput > DateTime.Now.Year)
        {
            errorMessage = "Por favor, insira um ano letivo válido (entre 1991 e o ano atual).";
            return;
        }

        var startYear = fiscalYearInput;
        var endYear = fiscalYearInput + 1;
        var selectedFiscalYearForReport = $"{startYear}-{endYear}";

        if (isCreateMode)
        {
            // Check for duplicate fiscal year
            var existingReports = await ReportService.GetAllReportsAsync();
            var existingReport = existingReports.FirstOrDefault(r => r.Year == startYear);

            if (existingReport != null)
            {
                errorMessage = $"Já existe um relatório para o ano letivo {selectedFiscalYearForReport}.";
                return;
            }

            // Generate automatic title and create report
            var title = $"Relatório de Contas {startYear} - {endYear}";
            await ReportService.CreateReportAsync(title, startYear, editingReport.Summary);
        }
        else
        {
            var existing = await ReportService.GetReportByIdAsync(editingReport.Id);
            if (existing != null)
            {
                // Check if year changed and if new year is duplicate
                if (existing.Year != startYear)
                {
                    var allReports = await ReportService.GetAllReportsAsync();
                    var duplicateReport = allReports.FirstOrDefault(r => r.Year == startYear && r.Id != existing.Id);

                    if (duplicateReport != null)
                    {
                        errorMessage = $"Já existe um relatório para o ano letivo {selectedFiscalYearForReport}.";
                        return;
                    }
                }

                await ReportService.UpdateReportAsync(editingReport.Id, editingReport.Summary);
            }
        }

        await RefreshDataAsync();
        CloseEditModal();
    }

    private void OpenDeleteModal(ReportEntity report)
    {
        deletingReport = report;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        deletingReport = null;
    }

    private async Task DeleteReport()
    {
        if (deletingReport == null) return;

        try
        {
            await ReportService.DeleteReportAsync(deletingReport.Id);
            await RefreshDataAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao eliminar relatório: {ex.Message}";
        }

        CloseDeleteModal();
    }

    private void OpenPublishModal(ReportEntity report)
    {
        publishingReport = report;
        showPublishModal = true;
    }

    private void ClosePublishModal()
    {
        showPublishModal = false;
        publishingReport = null;
    }

    private async Task PublishReport()
    {
        if (publishingReport == null) return;

        try
        {
            await ReportService.PublishReportAsync(publishingReport.Id);
            await RefreshDataAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao publicar relatório: {ex.Message}";
        }

        ClosePublishModal();
    }

    private async Task DownloadReport(ReportEntity report)
    {
        try
        {
            // Get all activities and transactions for this report
            var activities = (await ActivityService.GetActivitiesByReportIdAsync(report.Id)).OrderBy(a => a.Name).ToList();

            var allTransactions = new List<(Activity activity, List<Transaction> transactions)>();
            foreach (var activity in activities)
            {
                var transactions = (await TransactionService.GetTransactionsByActivityIdAsync(activity.Id))
                    .OrderByDescending(t => t.Date)
                    .ToList();
                allTransactions.Add((activity, transactions));
            }

            // Generate PDF using service
            var pdfBytes = PdfService.GenerateReportPdf(report, activities, allTransactions);

            // Convert to base64 and trigger download
            var base64 = Convert.ToBase64String(pdfBytes);
            var fileName = $"Relatorio_{report.Year}_{DateTime.Now:yyyyMMdd}.pdf";

            // Trigger download using JavaScript
            try
            {
                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64, "application/pdf");
            }
            catch (TaskCanceledException) { /* User navigated away - benign */ }
            catch (Microsoft.JSInterop.JSDisconnectedException) { /* Circuit disconnected - benign */ }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error generating PDF: {ex.Message}");
        }
    }
}
