@page "/shop"
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using RTUB.Application.Interfaces
@using RTUB.Application.Utilities
@using RTUB.Core.Entities
@using RTUB.Shared
@using RTUB.Shared.Components.Cards
@inject IProductService ProductService
@inject IProductReservationService ProductReservationService
@inject IImageStorageService ImageStorageService
@inject AuthenticationStateProvider AuthenticationStateProvider

<h1 class="mb-2"><i class="bi bi-cart"></i> Loja RTUB</h1>
<p class="lead mb-4 text-light-theme">Produtos oficiais da Real Tuna Universitária de Bragança</p>

<AuthorizeView Roles="Admin,Owner">
    <Authorized>
        <div class="mb-3">
            <button class="btn btn-success" @onclick="OpenCreateProductModal" title="Adicionar Novo Produto">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    </Authorized>
</AuthorizeView>

@if (loading)
{
    <p>A carregar produtos...</p>
}
else if (!filteredProducts.Any())
{
    <EmptyState Title="Sem produtos disponíveis"
                Message="@($"Neste momento não temos produtos disponíveis na loja{(string.IsNullOrEmpty(selectedType) ? "." : " deste tipo.")}")"
                Icon="bi-bag-x" />
}
else
{
    <!-- Filter -->
    <div class="row mb-4">
        <div class="col-md-6">
            <FilterDropdown ShowIcon="false"
                          AllItemsLabel="Todos os tipos"
                          Items="@productTypes"
                          @bind-SelectedValue="selectedType"
                          OnChange="FilterProducts" />
        </div>
    </div>

    <!-- Products Grid -->
    <div class="row">
        @foreach (var product in filteredProducts)
        {
            <div class="col-md-4 col-lg-2 mb-4">
                <div class="card album-card h-100">
                    <div class="position-relative">
                        @if (!string.IsNullOrEmpty(product.ImageUrl))
                        {
                            <img src="@GetProductImageUrl(product.ImageUrl)" class="card-img-top shop-square-image" alt="@product.Name">
                        }
                        else
                        {
                            <div class="card-img-top shop-square-placeholder">
                                <i class="bi bi-bag-fill music-icon-large"></i>
                            </div>
                        }
                        <AuthorizeView Roles="Admin,Owner">
                            <Authorized>
                                <div class="admin-overlay">
                                    <button class="btn btn-sm music-btn-edit" @onclick="() => OpenEditProductModal(product)" title="Editar">
                                        <i class="bi bi-pencil music-icon-edit"></i>
                                    </button>
                                    <button class="btn btn-sm music-btn-delete" @onclick="() => OpenDeleteProductModal(product)" title="Eliminar">
                                        <i class="bi bi-trash music-icon-delete"></i>
                                    </button>
                                </div>
                                @if (!product.IsPublic)
                                {
                                    <div class="position-absolute bottom-0 end-0 m-2">
                                        <button class="btn btn-sm btn-light text-dark" @onclick="() => OpenViewReservationsModal(product)" title="Ver Reservas">
                                            <i class="bi bi-list-check"></i> Ver Reservas
                                        </button>
                                    </div>
                                }
                            </Authorized>
                        </AuthorizeView>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title music-text-light mb-2">@product.Name</h5>
                        <!-- Compact badge row -->
                        <div class="mb-2">
                            <span class="badge bg-primary me-1">@product.Type</span>
                            @if (product.Stock > 0)
                            {
                                <span class="badge bg-light text-dark me-1">
                                    <i class="bi bi-box-seam"></i> @product.Stock em stock
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-danger me-1">
                                    <i class="bi bi-x-circle"></i> Esgotado
                                </span>
                            }
                            @if (!product.IsPublic)
                            {
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-lock-fill"></i> Apenas Membros
                                </span>
                            }
                        </div>
                        <div class="mt-auto">
                            <p class="card-text mb-2">
                                <strong class="fs-5 text-white">@product.Price.ToString("0.00") €</strong>
                            </p>
                            <!-- Single-line button row -->
                            @if (!product.IsPublic)
                            {
                                <AuthorizeView>
                                    <Authorized>
                                        @{
                                            var hasReservation = userReservations.ContainsKey(product.Id) && userReservations[product.Id] != null;
                                            var outOfStock = product.Stock == 0;
                                        }
                                        <div class="d-flex gap-1 flex-wrap">
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenProductDetailsModal(product)" title="Ver Detalhes">
                                                <i class="bi bi-eye"></i> Ver Detalhes
                                            </button>
                                            @if (!outOfStock)
                                            {
                                                @if (hasReservation)
                                                {
                                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => OpenUserReservationModal(product)" title="Ver Reserva">
                                                        <i class="bi bi-eye"></i> Ver Reserva
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" @onclick="() => OpenDeleteReservationModal(userReservations[product.Id]!, product)" title="Anular">
                                                        <i class="bi bi-x-circle"></i> Anular
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-sm btn-primary" @onclick="() => OpenReservationModal(product)" title="Reservar">
                                                        <i class="bi bi-calendar-check"></i> Reservar
                                                    </button>
                                                }
                                            }
                                        </div>
                                    </Authorized>
                                    <NotAuthorized>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenProductDetailsModal(product)" title="Ver Detalhes">
                                                <i class="bi bi-eye"></i> Ver Detalhes
                                            </button>
                                        </div>
                                    </NotAuthorized>
                                </AuthorizeView>
                            }
                            else
                            {
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenProductDetailsModal(product)" title="Ver Detalhes">
                                        <i class="bi bi-eye"></i> Ver Detalhes
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

<!-- CRUD Modal for Products -->
<CrudModalManager TEntity="Product"
                  ShowEditModal="@showProductEditModal"
                  ShowEditModalChanged="@((value) => showProductEditModal = value)"
                  IsCreateMode="@isProductCreateMode"
                  EditingEntity="@editingProduct"
                  CreateTitle="Novo Produto"
                  EditTitle="Editar Produto"
                  ModalSize="Modal.ModalSize.Large"
                  OnSave="SaveProduct"
                  OnEditModalClosed="CloseProductEditModal"
                  ShowDeleteModal="@showProductDeleteModal"
                  ShowDeleteModalChanged="@((value) => showProductDeleteModal = value)"
                  DeletingEntity="@deletingProduct"
                  DeleteTitle="Confirmar Eliminação"
                  OnDelete="DeleteProduct"
                  OnDeleteModalClosed="CloseProductDeleteModal">
    <EditFormContent Context="product">
        <EditForm Model="product" OnValidSubmit="SaveProduct">
            <DataAnnotationsValidator />
            <ErrorDisplay />

            <div class="row mb-3">
                <div class="col-md-8">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-box text-primary me-2"></i>Nome *
                    </label>
                    <InputText class="form-control" @bind-Value="product.Name" />
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-tag text-primary me-2"></i>Tipo *
                    </label>
                    <InputText class="form-control" @bind-Value="product.Type" placeholder="Álbum, Pin, T-shirt..." />
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-currency-euro text-primary me-2"></i>Preço (€) *
                    </label>
                    <InputNumber class="form-control" @bind-Value="product.Price" min="0.01" step="0.01" />
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-boxes text-primary me-2"></i>Stock
                    </label>
                    <InputNumber class="form-control" @bind-Value="product.Stock" min="0" />
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-check">
                        <InputCheckbox class="form-check-input" id="isPublic" @bind-Value="product.IsPublic" />
                        <label class="form-check-label" for="isPublic">
                            Público (não membros)
                        </label>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-text-paragraph text-primary me-2"></i>Descrição
                    </label>
                    <InputTextArea class="form-control" @bind-Value="product.Description" rows="3" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">
                    <i class="bi bi-image text-primary me-2"></i>Imagem do Produto
                </label>
                <InputFile class="form-control file-input-dark" OnChange="HandleImageUpload" accept="image/*" />
                @if (!string.IsNullOrEmpty(editingProduct?.ImageUrl) && uploadedImagePath == null)
                {
                    <div class="mt-2">
                        <small class="text-muted">Imagem atual</small>
                        <br />
                        <img src="@GetProductImageUrl(editingProduct.ImageUrl)" alt="Preview" class="img-thumbnail mt-1 slideshow-preview" />
                    </div>
                }
                @if (uploadedImagePath != null)
                {
                    <div class="mt-2">
                        <small class="text-success">Nova imagem carregada com sucesso!</small>
                    </div>
                }
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" @onclick="() => showProductEditModal = false">Cancelar</button>
                <button type="submit" class="btn btn-success">Guardar</button>
            </div>
        </EditForm>
    </EditFormContent>
    <EditFormFooterContent>
        <!-- Footer is now inside the form -->
    </EditFormFooterContent>
    <DeleteConfirmationContent Context="product">
        <p>Tem a certeza que deseja eliminar o produto <strong>@product.Name</strong>?</p>
        <p class="text-muted small">Esta ação não pode ser revertida.</p>
    </DeleteConfirmationContent>
</CrudModalManager>

<!-- Image Cropper Component -->
<ImageCropper @ref="imageCropper"
              ShowModal="showCropperModal"
              ShowModalChanged="OnCropperModalChanged"
              OnImageCropped="OnImageCropped"
              AspectRatio="1.0"
              AspectRatioHelp="Product images are displayed in 1:1 aspect ratio (square) for consistent presentation"
              ImageFormat="image/webp"
              ImageQuality="0.85" />

<!-- Reservation Modal -->
<Modal Title="Reservar Produto" 
       @bind-Show="showReservationModal"
       Size="Modal.ModalSize.Default">
    <BodyContent>
        @if (selectedProduct != null)
        {
            <!-- Product Information -->
            <div class="mb-3 pb-3 border-bottom">
                <h5 class="mb-1">@selectedProduct.Name</h5>
                <p class="text-muted mb-1">@selectedProduct.Type</p>
                <p class="text-success fw-bold mb-1">@selectedProduct.Price.ToString("0.00") €</p>
                @if (selectedProduct.Stock > 0)
                {
                    <p class="text-muted mb-0 small">
                        <i class="bi bi-box-seam"></i> @selectedProduct.Stock unidades disponíveis
                    </p>
                }
            </div>
            
            <EditForm Model="reservationModel" OnValidSubmit="SaveReservation">
                <DataAnnotationsValidator />
                
                <div class="mb-3">
                    <label class="form-label">Nome para Apresentação (opcional)</label>
                    <InputText class="form-control" @bind-Value="reservationModel.DisplayName" 
                               placeholder="Como quer que o nome apareça no produto" />
                    <small class="form-text text-muted">Deixe em branco para usar o seu nome de membro</small>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <InputCheckbox class="form-check-input" id="hasSizes" @bind-Value="reservationModel.HasSizes" />
                    <label class="form-check-label" for="hasSizes">
                        Este produto tem tamanhos
                    </label>
                </div>
                
                @if (reservationModel.HasSizes)
                {
                    <div class="mb-3">
                        <label class="form-label">Tamanho *</label>
                        <InputSelect class="form-select" @bind-Value="reservationModel.Size">
                            <option value="">Selecione o tamanho</option>
                            <option value="XS">XS - Extra Small</option>
                            <option value="S">S - Small</option>
                            <option value="M">M - Medium</option>
                            <option value="L">L - Large</option>
                            <option value="XL">XL - Extra Large</option>
                            <option value="XXL">XXL - 2X Large</option>
                            <option value="XXXL">XXXL - 3X Large</option>
                        </InputSelect>
                        @if (reservationModel.HasSizes && string.IsNullOrWhiteSpace(reservationModel.Size))
                        {
                            <div class="text-danger small mt-1">O tamanho é obrigatório quando o produto tem tamanhos</div>
                        }
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(reservationError))
                {
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> @reservationError
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(reservationSuccess))
                {
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> @reservationSuccess
                    </div>
                }
                
                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" @onclick="CloseReservationModal" disabled="@savingReservation">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" disabled="@savingReservation">
                        @if (savingReservation)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Reservar
                    </button>
                </div>
            </EditForm>
        }
    </BodyContent>
</Modal>

<!-- View Reservations Modal (Admin/Owner) -->
<Modal Title="Reservas do Produto" 
       @bind-Show="showViewReservationsModal"
       Size="Modal.ModalSize.Large">
    <BodyContent>
        @if (selectedProduct != null)
        {
            @if (loadingReservations)
            {
                <p>A carregar reservas...</p>
            }
            else if (!productReservations.Any())
            {
                <EmptyState Title="Não existem reservas"
                            Message="Não existem reservas para este produto."
                            Icon="bi-info-circle" />
            }
            else
            {
                <div class="row">
                    @foreach (var reservation in productReservations)
                    {
                        <div class="col-md-6 col-lg-4">
                            <AuthorizeView Roles="Owner">
                                <Authorized>
                                    <ReservationCard 
                                        ProductName="@selectedProduct.Name"
                                        ProductType="@selectedProduct.Type"
                                        ProductPrice="@selectedProduct.Price.ToString("0.00")"
                                        Username="@reservation.UserNickname"
                                        DisplayName="@reservation.DisplayName"
                                        Size="@reservation.Size"
                                        ReservationDate="@reservation.CreatedAt.ToString("dd/MM/yyyy HH:mm")"
                                        ShowDeleteButton="true"
                                        OnDelete="@(() => OpenAdminDeleteReservationModal(reservation))" />
                                </Authorized>
                                <NotAuthorized>
                                    <ReservationCard 
                                        ProductName="@selectedProduct.Name"
                                        ProductType="@selectedProduct.Type"
                                        ProductPrice="@selectedProduct.Price.ToString("0.00")"
                                        Username="@reservation.UserNickname"
                                        DisplayName="@reservation.DisplayName"
                                        Size="@reservation.Size"
                                        ReservationDate="@reservation.CreatedAt.ToString("dd/MM/yyyy HH:mm")"
                                        ShowDeleteButton="false" />
                                </NotAuthorized>
                            </AuthorizeView>
                        </div>
                    }
                </div>
            }
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseViewReservationsModal">Fechar</button>
    </FooterContent>
</Modal>

<!-- View User Reservation Modal -->
<DetailsModal Show="@showUserReservationModal" 
              ShowChanged="@((bool show) => showUserReservationModal = show)"
              Title="Minha Reserva" 
              HeaderTitle="@(selectedProduct?.Name ?? "")"
              IconClass="bi-bag-fill"
              OnClose="CloseUserReservationModal">
    <BadgesContent>
        @if (selectedProduct != null)
        {
            <span class="badge bg-primary">@selectedProduct.Type</span>
            <span class="badge bg-success">@selectedProduct.Price.ToString("0.00") €</span>
        }
    </BadgesContent>
    <Sections>
        @if (userReservation != null)
        {
            <InfoSection SectionTitle="Informação da Reserva" 
                        IconClass="bi-info-circle-fill" 
                        CssClass="mb-3">
                <ProfileField Label="Reservado por" Value="@userReservation.UserNickname" />
                @if (!string.IsNullOrEmpty(userReservation.DisplayName))
                {
                    <ProfileField Label="Nome para apresentação" Value="@userReservation.DisplayName" />
                }
                @if (!string.IsNullOrEmpty(userReservation.Size))
                {
                    <ProfileField Label="Tamanho" Value="@userReservation.Size" />
                }
                <ProfileField Label="Data da reserva" Value="@userReservation.CreatedAt.ToString("dd/MM/yyyy HH:mm")" />
            </InfoSection>
        }
    </Sections>
</DetailsModal>

<!-- Product Details Modal -->
<DetailsModal Show="@showProductDetailsModal" 
              ShowChanged="@((bool show) => showProductDetailsModal = show)"
              Title="Detalhes do Produto" 
              HeaderTitle="@(viewingProduct?.Name ?? "")"
              ImageUrl="@(viewingProduct != null && !string.IsNullOrEmpty(viewingProduct.ImageUrl) ? GetProductImageUrl(viewingProduct.ImageUrl) : null)"
              IconClass="@(viewingProduct != null && string.IsNullOrEmpty(viewingProduct.ImageUrl) ? "bi-bag-fill" : null)"
              OnClose="CloseProductDetailsModal">
    <BadgesContent>
        @if (viewingProduct != null)
        {
            <span class="badge bg-primary">@viewingProduct.Type</span>
            <span class="badge bg-success">@viewingProduct.Price.ToString("0.00") €</span>
            @if (viewingProduct.Stock > 0)
            {
                <span class="badge bg-light text-dark">
                    <i class="bi bi-box-seam"></i> @viewingProduct.Stock em stock
                </span>
            }
            else
            {
                <span class="badge bg-danger">
                    <i class="bi bi-x-circle"></i> Esgotado
                </span>
            }
        }
    </BadgesContent>
    <Sections>
        @if (viewingProduct != null)
        {
            <InfoSection SectionTitle="Informação do Produto" 
                        IconClass="bi-info-circle-fill" 
                        CssClass="mb-4">
                <ProfileField Label="Nome" Value="@viewingProduct.Name" />
                <ProfileField Label="Tipo" Value="@viewingProduct.Type" />
                <ProfileField Label="Preço" Value="@($"{viewingProduct.Price:0.00} €")" />
                <ProfileField Label="Stock" Value="@viewingProduct.Stock.ToString()" />
                <ProfileField Label="Disponível" Value="@(viewingProduct.IsAvailable ? "Sim" : "Não")" />
                @if (!viewingProduct.IsPublic)
                {
                    <ProfileField Label="Visibilidade" Value="Apenas Membros" />
                }
            </InfoSection>

            @if (!string.IsNullOrEmpty(viewingProduct.Description))
            {
                <InfoSection SectionTitle="Descrição" 
                            IconClass="bi-file-text" 
                            CssClass="mb-3">
                    <p class="text-white-full mb-0" style="white-space: pre-line;">@viewingProduct.Description</p>
                </InfoSection>
            }
        }
    </Sections>
</DetailsModal>

<!-- Delete Reservation Confirmation Modal -->
<ConfirmDialog Show="@showDeleteReservationModal"
               ShowChanged="@((bool show) => showDeleteReservationModal = show)"
               Title="Anular Reserva"
               ConfirmText="Anular Reserva"
               ConfirmButtonClass="btn-danger"
               CancelText="Cancelar"
               OnConfirm="ConfirmDeleteReservation"
               OnCancel="CloseDeleteReservationModal">
    <BodyContent>
        @if (deletingReservation != null && selectedProduct != null)
        {
            <p>Tem a certeza que deseja anular esta reserva?</p>
            <div class="mb-3">
                <p class="mb-1"><strong>Produto:</strong> @selectedProduct.Name</p>
                <p class="mb-1"><strong>Tipo:</strong> @selectedProduct.Type</p>
                <p class="mb-0"><strong>Data da Reserva:</strong> @deletingReservation.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
            </div>
            <p class="text-muted small">Esta ação não pode ser revertida.</p>
        }
    </BodyContent>
</ConfirmDialog>

<!-- Admin Delete Reservation Confirmation Modal -->
<ConfirmDialog Show="@showAdminDeleteReservationModal"
               ShowChanged="@((bool show) => showAdminDeleteReservationModal = show)"
               Title="Eliminar Reserva"
               ConfirmText="Eliminar Reserva"
               ConfirmButtonClass="btn-danger"
               CancelText="Cancelar"
               OnConfirm="ConfirmAdminDeleteReservation"
               OnCancel="CloseAdminDeleteReservationModal">
    <BodyContent>
        @if (deletingAdminReservation != null && selectedProduct != null)
        {
            <p>Tem a certeza que deseja eliminar esta reserva?</p>
            <div class="mb-3">
                <p class="mb-1"><strong>Produto:</strong> @selectedProduct.Name</p>
                <p class="mb-1"><strong>Utilizador:</strong> @deletingAdminReservation.UserNickname</p>
                <p class="mb-0"><strong>Data da Reserva:</strong> @deletingAdminReservation.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
            </div>
            <p class="text-muted small">Esta ação não pode ser revertida.</p>
        }
    </BodyContent>
</ConfirmDialog>

@code {
    private List<Product> products = new();
    private List<Product> filteredProducts = new();
    private List<string> productTypes = new();
    private string selectedType = "";
    private bool loading = true;
    private bool isMember = false;

    // Product Modal State
    private bool showProductEditModal = false;
    private bool showProductDeleteModal = false;
    private bool isProductCreateMode = false;
    private Product? editingProduct;
    private Product? deletingProduct;

    // Image Cropper
    private bool showCropperModal = false;
    private ImageCropper? imageCropper;
    private IBrowserFile? selectedFile;
    private string? uploadedImagePath;
    private int imageRefreshTrigger = 0;
    private byte[]? croppedProductImageBytes;
    private string? croppedProductImageFileName = "product-image.webp";

    // Reservation Modal State
    private bool showReservationModal = false;
    private bool savingReservation = false;
    private Product? selectedProduct;
    private ReservationModel reservationModel = new();
    private string? reservationError;
    private string? reservationSuccess;
    
    // View Reservations Modal State (Admin)
    private bool showViewReservationsModal = false;
    private bool loadingReservations = false;
    private List<ProductReservation> productReservations = new();
    
    // View User Reservation Detail Modal
    private bool showUserReservationModal = false;
    private ProductReservation? userReservation;
    
    // Product Details Modal
    private bool showProductDetailsModal = false;
    private Product? viewingProduct;
    
    // Delete Reservation Confirmation Modal
    private bool showDeleteReservationModal = false;
    private ProductReservation? deletingReservation;
    
    // Admin Delete Reservation Confirmation Modal
    private bool showAdminDeleteReservationModal = false;
    private ProductReservation? deletingAdminReservation;
    
    // Track user's reservations for each product
    private Dictionary<int, ProductReservation?> userReservations = new();
    private string? currentUserId;
    
    // Model for reservation form
    private class ReservationModel
    {
        public string? DisplayName { get; set; }
        public bool HasSizes { get; set; }
        public string? Size { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        loading = true;
        
        // Check if user is authenticated (member)
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        isMember = authState.User.Identity?.IsAuthenticated ?? false;
        currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        
        // Load products based on membership - show all products regardless of stock
        var allProducts = isMember 
            ? await ProductService.GetAllAsync() 
            : (await ProductService.GetAllAsync()).Where(p => p.IsPublic);
            
        products = allProducts.OrderBy(p => p.Type).ThenBy(p => p.Name).ToList();
        productTypes = products.Select(p => p.Type).Distinct().OrderBy(t => t).ToList();
        FilterProducts();
        
        // Load user's reservations for all products
        if (isMember && !string.IsNullOrEmpty(currentUserId))
        {
            try
            {
                var userReservationsList = await ProductReservationService.GetByUserIdAsync(currentUserId);
                userReservations = userReservationsList.ToDictionary(r => r.ProductId, r => (ProductReservation?)r);
            }
            catch
            {
                userReservations = new Dictionary<int, ProductReservation?>();
            }
        }
        
        loading = false;
    }

    private void FilterProducts()
    {
        if (string.IsNullOrEmpty(selectedType))
        {
            filteredProducts = products;
        }
        else
        {
            filteredProducts = products.Where(p => p.Type == selectedType).ToList();
        }
    }

    // Product Modal Methods
    private void OpenCreateProductModal()
    {
        editingProduct = Product.CreateEmpty();
        isProductCreateMode = true;
        uploadedImagePath = null;
        showProductEditModal = true;
    }

    private void OpenEditProductModal(Product product)
    {
        editingProduct = product;
        isProductCreateMode = false;
        uploadedImagePath = null;
        showProductEditModal = true;
    }

    private void OpenDeleteProductModal(Product product)
    {
        deletingProduct = product;
        showProductDeleteModal = true;
    }

    private async Task SaveProduct()
    {
        if (editingProduct == null) return;

        try
        {
            // Auto-set availability based on stock
            editingProduct.SetAvailability(editingProduct.Stock > 0);
            
            if (isProductCreateMode)
            {
                // If image was cropped, upload it BEFORE creating entity
                if (croppedProductImageBytes != null && croppedProductImageBytes.Length > 0)
                {
                    using var stream = new MemoryStream(croppedProductImageBytes);
                    var normalizedName = S3KeyNormalizer.NormalizeForS3Key(editingProduct.Name);
                    var imageUrl = await ImageStorageService.UploadImageAsync(stream, croppedProductImageFileName!, "image/webp", "products", normalizedName);
                    editingProduct.ImageUrl = imageUrl;
                }
                
                // Create entity with imageUrl already set (single audit log)
                await ProductService.CreateAsync(editingProduct);
            }
            else
            {
                // Upload image to R2 if one was cropped
                if (croppedProductImageBytes != null && croppedProductImageBytes.Length > 0)
                {
                    // Delete old image if it exists
                    if (!string.IsNullOrEmpty(editingProduct.ImageUrl))
                    {
                        await ImageStorageService.DeleteImageAsync(editingProduct.ImageUrl);
                    }
                    
                    using var stream = new MemoryStream(croppedProductImageBytes);
                    var normalizedName = S3KeyNormalizer.NormalizeForS3Key(editingProduct.Name);
                    var imageUrl = await ImageStorageService.UploadImageAsync(stream, croppedProductImageFileName!, "image/webp", "products", normalizedName);
                    editingProduct.ImageUrl = imageUrl;
                }
                
                await ProductService.UpdateAsync(editingProduct);
                
                // Invalidate server-side cache if image was updated
                if (!string.IsNullOrEmpty(editingProduct.ImageUrl) && uploadedImagePath != null)
                {
                    // Increment trigger to force browser to re-fetch the image
                    imageRefreshTrigger++;
                }
            }
            
            await LoadProducts();
            showProductEditModal = false;
            uploadedImagePath = null;
            croppedProductImageBytes = null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving product: {ex.Message}");
        }
    }

    private async Task DeleteProduct()
    {
        if (deletingProduct == null) return;

        try
        {
            await ProductService.DeleteAsync(deletingProduct.Id);
            await LoadProducts();
            showProductDeleteModal = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting product: {ex.Message}");
        }
    }

    private void CloseProductEditModal()
    {
        showProductEditModal = false;
        editingProduct = null;
        uploadedImagePath = null;
    }

    private void CloseProductDeleteModal()
    {
        showProductDeleteModal = false;
        deletingProduct = null;
    }

    // Image Upload Methods
    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        try
        {
            var imageFile = e.File;
            if (imageFile != null)
            {
                var maxFileSize = 10 * 1024 * 1024;
                if (imageFile.Size > maxFileSize)
                {
                    return;
                }

                selectedFile = imageFile;

                if (imageCropper != null)
                {
                    await imageCropper.LoadImageAsync(selectedFile);
                }
            }
        }
        catch (Exception)
        {
            // Handle error silently or show message
        }
    }

    private void OnImageCropped(byte[] croppedImageData)
    {
        try
        {
            if (editingProduct != null && croppedImageData != null && croppedImageData.Length > 0)
            {
                // Store the cropped image bytes for upload when saving
                croppedProductImageBytes = croppedImageData;
                uploadedImagePath = "uploaded";
                
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            // Handle error
        }
    }

    private void OnCropperModalChanged(bool isOpen)
    {
        showCropperModal = isOpen;
        StateHasChanged();
    }
    
    private string GetProductImageUrl(string imageSrc)
    {
        if (string.IsNullOrEmpty(imageSrc)) return string.Empty;
        
        // Add refresh trigger only when an image has been updated
        // This forces browser to re-fetch after edits while maintaining ETag caching
        if (imageRefreshTrigger > 0 && imageSrc.StartsWith("/api/images/"))
        {
            return $"{imageSrc}?r={imageRefreshTrigger}";
        }
        
        return imageSrc;
    }
    
    // Reservation Methods
    private void OpenReservationModal(Product product)
    {
        selectedProduct = product;
        reservationModel = new ReservationModel();
        reservationError = null;
        reservationSuccess = null;
        showReservationModal = true;
    }
    
    private void CloseReservationModal()
    {
        showReservationModal = false;
        selectedProduct = null;
        reservationModel = new ReservationModel();
        reservationError = null;
        reservationSuccess = null;
    }
    
    private async Task SaveReservation()
    {
        if (selectedProduct == null) return;
        
        // Validate size if HasSizes is true
        if (reservationModel.HasSizes && string.IsNullOrWhiteSpace(reservationModel.Size))
        {
            reservationError = "O tamanho é obrigatório quando o produto tem tamanhos";
            return;
        }
        
        savingReservation = true;
        reservationError = null;
        reservationSuccess = null;
        
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var userNickname = authState.User.Identity?.Name ?? "Unknown";
            
            if (string.IsNullOrEmpty(userId))
            {
                reservationError = "Não foi possível obter o utilizador atual";
                return;
            }
            
            var reservation = ProductReservation.Create(
                selectedProduct.Id,
                userId,
                userNickname,
                reservationModel.HasSizes,
                reservationModel.Size,
                reservationModel.DisplayName
            );
            
            await ProductReservationService.CreateAsync(reservation);
            
            reservationSuccess = "Reserva criada com sucesso!";
            
            // Update local cache
            userReservations[selectedProduct.Id] = reservation;
            
            // Close modal after a short delay
            await Task.Delay(1500);
            CloseReservationModal();
        }
        catch (InvalidOperationException ex)
        {
            reservationError = ex.Message;
        }
        catch (Exception ex)
        {
            reservationError = "Erro ao criar reserva. Por favor, tente novamente.";
            Console.WriteLine($"Error creating reservation: {ex.Message}");
        }
        finally
        {
            savingReservation = false;
        }
    }
    
    private async Task OpenViewReservationsModal(Product product)
    {
        selectedProduct = product;
        loadingReservations = true;
        showViewReservationsModal = true;
        
        try
        {
            var reservations = await ProductReservationService.GetByProductIdAsync(product.Id);
            productReservations = reservations.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading reservations: {ex.Message}");
            productReservations = new List<ProductReservation>();
        }
        finally
        {
            loadingReservations = false;
        }
    }
    
    private void CloseViewReservationsModal()
    {
        showViewReservationsModal = false;
        selectedProduct = null;
        productReservations = new List<ProductReservation>();
    }
    
    // Product Details Modal Methods
    private void OpenProductDetailsModal(Product product)
    {
        viewingProduct = product;
        showProductDetailsModal = true;
    }
    
    private void CloseProductDetailsModal()
    {
        showProductDetailsModal = false;
        viewingProduct = null;
    }
    
    // User Reservation View Methods
    private void OpenUserReservationModal(Product product)
    {
        selectedProduct = product;
        if (userReservations.ContainsKey(product.Id))
        {
            userReservation = userReservations[product.Id];
            showUserReservationModal = true;
        }
    }
    
    private void CloseUserReservationModal()
    {
        showUserReservationModal = false;
        selectedProduct = null;
        userReservation = null;
    }
    
    // Delete Reservation Methods
    private void OpenDeleteReservationModal(ProductReservation reservation, Product product)
    {
        deletingReservation = reservation;
        selectedProduct = product;
        showDeleteReservationModal = true;
    }
    
    private void CloseDeleteReservationModal()
    {
        showDeleteReservationModal = false;
        deletingReservation = null;
    }
    
    private async Task ConfirmDeleteReservation()
    {
        if (deletingReservation == null) return;
        
        try
        {
            await ProductReservationService.DeleteAsync(deletingReservation.Id);
            
            // Update local cache to reflect the deletion immediately
            if (selectedProduct != null && userReservations.ContainsKey(selectedProduct.Id))
            {
                userReservations[selectedProduct.Id] = null;
            }
            
            CloseDeleteReservationModal();
            
            // Force UI refresh
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting reservation: {ex.Message}");
        }
    }
    
    // Admin Delete Reservation Methods
    private void OpenAdminDeleteReservationModal(ProductReservation reservation)
    {
        deletingAdminReservation = reservation;
        showAdminDeleteReservationModal = true;
    }
    
    private void CloseAdminDeleteReservationModal()
    {
        showAdminDeleteReservationModal = false;
        deletingAdminReservation = null;
    }
    
    private async Task ConfirmAdminDeleteReservation()
    {
        if (deletingAdminReservation == null) return;
        
        try
        {
            await ProductReservationService.DeleteAsync(deletingAdminReservation.Id);
            
            // Reload reservations for the product
            if (selectedProduct != null)
            {
                var reservations = await ProductReservationService.GetByProductIdAsync(selectedProduct.Id);
                productReservations = reservations.ToList();
                
                // Update user cache if it's the current user's reservation
                if (deletingAdminReservation.UserId == currentUserId && userReservations.ContainsKey(selectedProduct.Id))
                {
                    userReservations[selectedProduct.Id] = null;
                }
            }
            
            CloseAdminDeleteReservationModal();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting reservation: {ex.Message}");
        }
    }
}
