@page "/logistics/{BoardId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using RTUB.Application.Interfaces
@using RTUB.Core.Entities
@using RTUB.Core.Enums
@inject ILogisticsBoardService BoardService
@inject ILogisticsListService ListService
@inject ILogisticsCardService CardService
@inject IEventService EventService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>@(board?.Name ?? "Logística") - RTUB</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (board == null)
        {
            <p>A carregar quadro...</p>
        }
        else
        {
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <a href="/logistics" class="btn btn-sm btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                    <h1 class="d-inline"><i class="bi bi-kanban"></i> @board.Name</h1>
                </div>
                <button class="btn btn-success" @onclick="OpenCreateListModal">
                    <i class="bi bi-plus-lg"></i> Adicionar Lista
                </button>
            </div>

            @if (!lists.Any())
            {
                <div class="text-center py-5">
                    <i class="bi bi-kanban" style="font-size: 4rem; opacity: 0.3;"></i>
                    <h3>Nenhuma lista criada ainda</h3>
                    <p class="text-muted">Crie sua primeira lista para começar a organizar tarefas.</p>
                </div>
            }
            else
            {
                <div class="kanban-board">
                    @foreach (var list in lists.OrderBy(l => l.Position))
                    {
                        <div class="kanban-list" data-list-id="@list.Id">
                            <div class="kanban-list-header">
                                <h5>@list.Name</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-link text-light p-0" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" @onclick="() => OpenEditListModal(list)" @onclick:preventDefault>
                                            <i class="bi bi-pencil"></i> Editar
                                        </a></li>
                                        <li><a class="dropdown-item text-danger" href="#" @onclick="() => OpenDeleteListModal(list)" @onclick:preventDefault>
                                            <i class="bi bi-trash"></i> Eliminar
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="kanban-cards" data-list-id="@list.Id">
                                @foreach (var card in list.Cards.OrderBy(c => c.Position))
                                {
                                    <div class="kanban-card @(card.Status == CardStatus.Done ? "card-done" : "card-todo")" 
                                         data-card-id="@card.Id" 
                                         draggable="true"
                                         @onclick="() => OpenCardDetailsModal(card)">
                                        <div class="card-status-bar @(card.Status == CardStatus.Done ? "bg-success" : "bg-danger")">
                                            <i class="bi bi-@(card.Status == CardStatus.Done ? "check" : "x")-circle-fill"></i>
                                        </div>
                                        <div class="card-separator"></div>
                                        <div class="card-content">
                                            <h6 class="mb-1">@card.Title</h6>
                                            @if (!string.IsNullOrWhiteSpace(card.Description))
                                            {
                                                <p class="small text-muted mb-2">@card.Description</p>
                                            }
                                            <div class="card-footer-section">
                                                @if (!string.IsNullOrEmpty(card.Labels))
                                                {
                                                    @foreach (var label in card.Labels.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                                    {
                                                        <span class="badge badge-label">@label.Trim()</span>
                                                    }
                                                }
                                                @if (card.Event != null)
                                                {
                                                    <div class="badge bg-primary mt-1">
                                                        <i class="bi bi-calendar-event"></i> @card.Event.Name
                                                    </div>
                                                }
                                                @if (card.AssignedToUser != null)
                                                {
                                                    <div class="badge bg-secondary mt-1">
                                                        <i class="bi bi-person"></i> @card.AssignedToUser.UserName
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            <button class="btn btn-sm btn-link w-100 text-start" @onclick="() => OpenCreateCardModal(list.Id)">
                                <i class="bi bi-plus"></i> Adicionar cartão
                            </button>
                        </div>
                    }
                </div>
            }
        }
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-warning">
            <i class="bi bi-lock"></i> Precisa estar autenticado para aceder ao quadro de logística.
        </div>
    </NotAuthorized>
</AuthorizeView>

@* List Modal - Create/Edit *@
@if (showListModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingList == null ? "Criar Lista" : "Editar Lista")</h5>
                    <button type="button" class="btn-close" @onclick="CloseListModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome da Lista</label>
                        <input type="text" class="form-control" @bind="listName" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseListModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveList">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

@* Card Modal - Create/Edit *@
@if (showCardModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingCard == null ? "Criar Cartão" : "Editar Cartão")</h5>
                    <button type="button" class="btn-close" @onclick="CloseCardModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Título</label>
                        <input type="text" class="form-control" @bind="cardTitle" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" rows="3" @bind="cardDescription"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Evento (opcional)</label>
                        <select class="form-select" @bind="selectedEventId">
                            <option value="">Nenhum</option>
                            @if (events != null)
                            {
                                @foreach (var evt in events)
                                {
                                    <option value="@evt.Id">@evt.Name - @evt.Date.ToString("dd/MM/yyyy")</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Atribuir a (opcional)</label>
                        <select class="form-select" @bind="selectedUserId">
                            <option value="">Ninguém</option>
                            @if (users != null)
                            {
                                @foreach (var user in users)
                                {
                                    <option value="@user.Id">@user.UserName</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCardModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveCard">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

@* Card Details Modal *@
@if (showCardDetailsModal && selectedCard != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@selectedCard.Title</h5>
                    <button type="button" class="btn-close" @onclick="CloseCardDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Estado</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn @(selectedCard.Status == CardStatus.Todo ? "btn-danger" : "btn-outline-danger")" 
                                    @onclick="() => UpdateCardStatus(CardStatus.Todo)">
                                <i class="bi bi-x-circle"></i> TODO
                            </button>
                            <button type="button" class="btn @(selectedCard.Status == CardStatus.Done ? "btn-success" : "btn-outline-success")" 
                                    @onclick="() => UpdateCardStatus(CardStatus.Done)">
                                <i class="bi bi-check-circle"></i> DONE
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Etiquetas</label>
                        <input type="text" class="form-control" placeholder="Separado por vírgulas (ex: Urgente, Importante)" 
                               @bind="selectedCardLabels" @onblur="UpdateCardLabels" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Datas</label>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label small">Início</label>
                                <input type="date" class="form-control form-control-sm" @bind="cardStartDate" @onblur="UpdateCardDates" />
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Prazo</label>
                                <input type="date" class="form-control form-control-sm" @bind="cardDueDate" @onblur="UpdateCardDates" />
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Lembrete</label>
                                <input type="date" class="form-control form-control-sm" @bind="cardReminderDate" @onblur="UpdateCardDates" />
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Checklist (JSON)</label>
                        <textarea class="form-control" rows="3" placeholder='[{"task":"Tarefa 1","done":false}]' 
                                  @bind="selectedCardChecklist" @onblur="UpdateCardChecklist"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Anexos (JSON)</label>
                        <textarea class="form-control" rows="2" placeholder='[{"name":"Link 1","url":"https://..."}]' 
                                  @bind="selectedCardAttachments" @onblur="UpdateCardAttachments"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCardDetailsModal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Modals *@
@if (showDeleteListModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Eliminação</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteListModal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem a certeza que deseja eliminar a lista "<strong>@deletingList?.Name</strong>"?</p>
                    <p class="text-danger"><small>Todos os cartões desta lista também serão eliminados.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteListModal">Cancelar</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteList">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int BoardId { get; set; }

    private LogisticsBoard? board;
    private List<LogisticsList> lists = new();
    private List<Event>? events;
    private List<ApplicationUser>? users;

    // List modal state
    private bool showListModal = false;
    private LogisticsList? editingList = null;
    private string listName = string.Empty;

    // Card modal state
    private bool showCardModal = false;
    private LogisticsCard? editingCard = null;
    private int currentListId = 0;
    private string cardTitle = string.Empty;
    private string cardDescription = string.Empty;
    private string selectedEventId = string.Empty;
    private string selectedUserId = string.Empty;

    // Card details modal state
    private bool showCardDetailsModal = false;
    private LogisticsCard? selectedCard = null;
    private string selectedCardLabels = string.Empty;
    private string? cardStartDate = null;
    private string? cardDueDate = null;
    private string? cardReminderDate = null;
    private string selectedCardChecklist = string.Empty;
    private string selectedCardAttachments = string.Empty;

    // Delete modal state
    private bool showDeleteListModal = false;
    private LogisticsList? deletingList = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && lists.Any())
        {
            await JSRuntime.InvokeVoidAsync("initializeKanbanDragDrop", DotNetObjectReference.Create(this));
        }
    }

    private async Task LoadData()
    {
        board = await BoardService.GetBoardWithListsAndCardsAsync(BoardId);
        if (board != null)
        {
            lists = board.Lists.ToList();
        }
        events = (await EventService.GetAllEventsAsync()).ToList();
        users = await UserManager.Users.ToListAsync();
    }

    // List operations
    private void OpenCreateListModal()
    {
        editingList = null;
        listName = string.Empty;
        showListModal = true;
    }

    private void OpenEditListModal(LogisticsList list)
    {
        editingList = list;
        listName = list.Name;
        showListModal = true;
    }

    private void CloseListModal()
    {
        showListModal = false;
        editingList = null;
        listName = string.Empty;
    }

    private async Task SaveList()
    {
        if (string.IsNullOrWhiteSpace(listName))
            return;

        try
        {
            if (editingList == null)
            {
                var maxPosition = lists.Any() ? lists.Max(l => l.Position) : -1;
                await ListService.CreateListAsync(listName, BoardId, maxPosition + 1);
            }
            else
            {
                await ListService.UpdateListAsync(editingList.Id, listName);
            }

            await LoadData();
            CloseListModal();
        }
        catch (Exception)
        {
            // Handle error
        }
    }

    private void OpenDeleteListModal(LogisticsList list)
    {
        deletingList = list;
        showDeleteListModal = true;
    }

    private void CloseDeleteListModal()
    {
        showDeleteListModal = false;
        deletingList = null;
    }

    private async Task ConfirmDeleteList()
    {
        if (deletingList == null)
            return;

        try
        {
            await ListService.DeleteListAsync(deletingList.Id);
            await LoadData();
            CloseDeleteListModal();
        }
        catch (Exception)
        {
            // Handle error
        }
    }

    // Card operations
    private void OpenCreateCardModal(int listId)
    {
        editingCard = null;
        currentListId = listId;
        cardTitle = string.Empty;
        cardDescription = string.Empty;
        selectedEventId = string.Empty;
        selectedUserId = string.Empty;
        showCardModal = true;
    }

    private void OpenEditCardModal(LogisticsCard card)
    {
        editingCard = card;
        currentListId = card.ListId;
        cardTitle = card.Title;
        cardDescription = card.Description;
        selectedEventId = card.EventId?.ToString() ?? string.Empty;
        selectedUserId = card.AssignedToUserId ?? string.Empty;
        showCardModal = true;
    }

    private void CloseCardModal()
    {
        showCardModal = false;
        editingCard = null;
        currentListId = 0;
    }

    private async Task SaveCard()
    {
        if (string.IsNullOrWhiteSpace(cardTitle))
            return;

        try
        {
            int? eventId = string.IsNullOrEmpty(selectedEventId) ? null : int.Parse(selectedEventId);
            string? userId = string.IsNullOrEmpty(selectedUserId) ? null : selectedUserId;

            if (editingCard == null)
            {
                var list = lists.FirstOrDefault(l => l.Id == currentListId);
                var maxPosition = list?.Cards?.Any() == true ? list.Cards.Max(c => c.Position) : -1;
                var card = await CardService.CreateCardAsync(cardTitle, currentListId, maxPosition + 1, cardDescription);
                
                if (eventId.HasValue)
                    await CardService.AssociateCardWithEventAsync(card.Id, eventId);
                
                if (!string.IsNullOrEmpty(userId))
                    await CardService.AssignCardToUserAsync(card.Id, userId);
            }
            else
            {
                await CardService.UpdateCardAsync(editingCard.Id, cardTitle, cardDescription);
                await CardService.AssociateCardWithEventAsync(editingCard.Id, eventId);
                await CardService.AssignCardToUserAsync(editingCard.Id, userId);
            }

            await LoadData();
            CloseCardModal();
        }
        catch (Exception)
        {
            // Handle error
        }
    }

    // Card details modal
    private void OpenCardDetailsModal(LogisticsCard card)
    {
        selectedCard = card;
        selectedCardLabels = card.Labels ?? string.Empty;
        cardStartDate = card.StartDate?.ToString("yyyy-MM-dd");
        cardDueDate = card.DueDate?.ToString("yyyy-MM-dd");
        cardReminderDate = card.ReminderDate?.ToString("yyyy-MM-dd");
        selectedCardChecklist = card.ChecklistJson ?? string.Empty;
        selectedCardAttachments = card.AttachmentsJson ?? string.Empty;
        showCardDetailsModal = true;
    }

    private void CloseCardDetailsModal()
    {
        showCardDetailsModal = false;
        selectedCard = null;
    }

    private async Task UpdateCardStatus(CardStatus status)
    {
        if (selectedCard == null) return;
        await CardService.SetCardStatusAsync(selectedCard.Id, status);
        selectedCard.Status = status;
        StateHasChanged();
    }

    private async Task UpdateCardLabels()
    {
        if (selectedCard == null) return;
        await CardService.SetCardLabelsAsync(selectedCard.Id, selectedCardLabels);
        await LoadData();
    }

    private async Task UpdateCardDates()
    {
        if (selectedCard == null) return;
        DateTime? start = string.IsNullOrEmpty(cardStartDate) ? null : DateTime.Parse(cardStartDate);
        DateTime? due = string.IsNullOrEmpty(cardDueDate) ? null : DateTime.Parse(cardDueDate);
        DateTime? reminder = string.IsNullOrEmpty(cardReminderDate) ? null : DateTime.Parse(cardReminderDate);
        await CardService.SetCardDatesAsync(selectedCard.Id, start, due, reminder);
    }

    private async Task UpdateCardChecklist()
    {
        if (selectedCard == null) return;
        await CardService.SetCardChecklistAsync(selectedCard.Id, selectedCardChecklist);
    }

    private async Task UpdateCardAttachments()
    {
        if (selectedCard == null) return;
        await CardService.SetCardAttachmentsAsync(selectedCard.Id, selectedCardAttachments);
    }

    [JSInvokable]
    public async Task OnCardMoved(int cardId, int newListId, int newPosition)
    {
        try
        {
            await CardService.MoveCardAsync(cardId, newListId, newPosition);
            await LoadData();
        }
        catch (Exception)
        {
            // Handle error
        }
    }
}
