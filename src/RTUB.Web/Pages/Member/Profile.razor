@page "/profile"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Shared
@using RTUB.Application.Services
@using RTUB.Application.Interfaces
@using Microsoft.JSInterop
@attribute [Authorize]
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IImageService ImageService
@inject IJSRuntime JSRuntime
@inject RTUB.Application.Services.AuditContext AuditContext
@inject IRoleAssignmentService RoleAssignmentService
@inject RTUB.Web.Services.ProfilePictureUpdateService ProfilePictureUpdateService

<h1 class="text-center mb-4">Meu Perfil</h1>

@if (user == null)
{
    <p class="text-white-full">A carregar...</p>
}
else
{
    @* Display password change warning if required *@
    @if (user.RequirePasswordChange)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-exclamation-triangle-fill"></i> Ação Necessária
            </h5>
            <p class="mb-2">
                Por favor, altere a sua palavra-passe assim que possível. Está a usar uma palavra-passe temporária.
            </p>
            <button class="btn btn-sm btn-warning" @onclick="OpenChangePasswordModal">
                <i class="bi bi-key-fill"></i> Alterar Palavra-passe Agora
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Profile Header Card -->
    <ProfileHeader User="@user" 
                   ProfilePictureVersion="@profilePictureVersion"
                   OnChangePassword="@OpenChangePasswordModal"
                   OnUploadPhoto="@OpenUploadModal" />

    <!-- Profile Content -->
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
            
            <!-- Section 1: Pessoal (Personal Information) -->
            <ProfileSection Title="Informações Pessoais"
                          Icon="bi-person-fill"
                          IsCollapsible="true"
                          IsExpanded="@sectionsExpanded["personal"]"
                          IsEditing="@(editingSection == "personal")"
                          ShowEditButton="true"
                          OnEdit="@(() => OpenEditSectionModal("personal"))"
                          OnSave="@SavePersonalSection"
                          OnCancel="@CancelEdit">
                <ChildContent>
                    <ProfileField Label="Nome Completo" Value="@($"{user.FirstName} {user.LastName}")" />
                    <ProfileField Label="Nome de Tuna" Value="@user.Nickname" />
                    <ProfileField Label="Email" Value="@user.Email" />
                    <ProfileField Label="Data de Nascimento" 
                                Value="@(user.DateOfBirth?.ToString("dd/MM/yyyy"))" />
                    @if (user.DateOfBirth.HasValue)
                    {
                        <ProfileField Label="Idade" 
                                    Value="@(user.Age?.ToString() + " anos")" />
                    }
                    <ProfileField Label="Contacto" Value="@user.PhoneContact" />
                    <ProfileField Label="Cidade" Value="@user.City" />
                </ChildContent>
                <EditContent>
                    @if (editUser != null)
                    {
                        <EditForm Model="editUser" OnValidSubmit="SavePersonalSection">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label text-white-full">Primeiro Nome</label>
                                    <InputText class="form-control" @bind-Value="editUser.FirstName" placeholder="Inserir primeiro nome..." />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-white-full">Último Nome</label>
                                    <InputText class="form-control" @bind-Value="editUser.LastName" placeholder="Inserir último nome..." />
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-white-full">Nome de Tuna (Alcunha)</label>
                                <InputText class="form-control" @bind-Value="editUser.Nickname" placeholder="Inserir nome de tuna..." />
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-white-full">Email</label>
                                <InputText class="form-control" @bind-Value="editUser.Email" type="email" placeholder="Inserir email..." />
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label text-white-full">Data de Nascimento</label>
                                    <InputDate class="form-control" @bind-Value="editUser.DateOfBirth" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-white-full">Contacto</label>
                                    <InputText class="form-control" @bind-Value="editUser.PhoneContact" placeholder="Inserir contacto..." />
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-white-full">Cidade</label>
                                <InputText class="form-control" @bind-Value="editUser.City" placeholder="Inserir cidade..." />
                            </div>
                        </EditForm>
                    }
                </EditContent>
            </ProfileSection>

            <!-- Section 2: Tuna (Tuna Information) -->
            <ProfileSection Title="Informação da Tuna"
                          Icon="bi-music-note-list"
                          IsCollapsible="true"
                          IsExpanded="@sectionsExpanded["tuna"]"
                          IsEditing="@(editingSection == "tuna")"
                          ShowEditButton="true"
                          OnEdit="@(() => OpenEditSectionModal("tuna"))"
                          OnSave="@SaveTunaSection"
                          OnCancel="@CancelEdit">
                <ChildContent>
                    
                    <ProfileField Label="Instrumento Principal" 
                                Value="@(user.MainInstrument.HasValue ? StatusHelper.GetInstrumentDisplay(user.MainInstrument.Value) : null)" />
                    
                    @if (!user.IsLeitao() || user.IsCaloiro() || user.IsTuno())
                    {
                        <ProfileField Label="Padrinho" 
                                    Value="@GetMentorDisplayName()" />
                    }

                    <div class="profile-field">
                        <div class="row">
                            <div class="col-12 col-md-4 profile-field-label">
                                <strong class="text-white-full">Percurso na Tuna:</strong>
                            </div>
                            <div class="col-12 col-md-8 profile-field-value">
                                <UnifiedTimeline User="@user" RoleAssignments="@roleAssignments" />
                            </div>
                        </div>
                    </div>

                    <ProfileField Label="Curso" Value="@user.Degree" />

                </ChildContent>
                <EditContent>
                    @if (editUser != null)
                    {
                        <EditForm Model="editUser" OnValidSubmit="SaveTunaSection">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            <div class="mb-3">
                                <label class="form-label text-white-full">Instrumento Principal</label>
                                <select class="form-select" @bind="editUser.MainInstrument">
                                    <option value="">Sem instrumento</option>
                                    @foreach (var instrument in Enum.GetValues<InstrumentType>())
                                    {
                                        <option value="@instrument">@StatusHelper.GetInstrumentDisplay(instrument)</option>
                                    }
                                </select>
                            </div>

                            @if (user != null && (!user.IsLeitao() || user.IsCaloiro() || user.IsTuno()))
                            {
                                <div class="mb-3">
                                    <label class="form-label text-white-full">Padrinho</label>
                                    <div class="mentor-search-container">
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">
                                                <i class="bi bi-search"></i>
                                            </span>
                                            <input type="text" 
                                                   class="form-control" 
                                                   placeholder="Pesquisar padrinho por nome ou alcunha..."
                                                   @bind="mentorSearchTerm" 
                                                   @bind:event="oninput" 
                                                   @onkeyup="FilterMentors" />
                                            @if (!string.IsNullOrEmpty(mentorSearchTerm))
                                            {
                                                <button class="btn btn-outline-secondary" type="button" @onclick="ClearMentorSelection" title="Limpar seleção">
                                                    <i class="bi bi-x-circle-fill"></i>
                                                </button>
                                            }
                                        </div>
                                    </div>
                                    
                                    @if (filteredMentors.Any())
                                    {
                                        <div class="member-list member-list-scrollable">
                                            @foreach (var mentorItem in filteredMentors.Take(20))
                                            {
                                                <div class="member-item p-2 mb-2 border rounded clickable-row"
                                                     @onclick="() => SelectMentor(mentorItem)">
                                                    <div class="d-flex align-items-center">
                                                        <img src="@mentorItem.ProfilePictureSrc" alt="@mentorItem.GetDisplayName()"
                                                             class="member-avatar-small me-2" />
                                                        <div>
                                                            @if (!string.IsNullOrEmpty(mentorItem.Nickname))
                                                            {
                                                                <div><strong>@mentorItem.Nickname</strong></div>
                                                                <div class="text-muted small">@mentorItem.FirstName @mentorItem.LastName</div>
                                                            }
                                                            else
                                                            {
                                                                <div><strong>@mentorItem.FirstName @mentorItem.LastName</strong></div>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (!string.IsNullOrEmpty(mentorSearchTerm) && string.IsNullOrEmpty(editUser.MentorId))
                                    {
                                        <div class="alert alert-purple mt-2">Nenhum padrinho encontrado.</div>
                                    }

                                    @if (!string.IsNullOrEmpty(editUser.MentorId))
                                    {
                                        var displayMentor = selectedMentorCache ?? eligibleMentors.FirstOrDefault(m => m.Id == editUser.MentorId);
                                        if (displayMentor != null)
                                        {
                                            <div class="alert alert-purple mt-2 d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Padrinho Selecionado:</strong> @displayMentor.GetDisplayName()
                                                </div>
                                                <button type="button" class="btn btn-sm text-danger" style="background: none; border: none; padding: 0.25rem 0.5rem;" @onclick="ClearMentorSelection" title="Remover padrinho">
                                                    <i class="bi bi-x-circle-fill" style="font-size: 1.25rem; color: white;"></i>
                                                </button>
                                            </div>
                                        }
                                    }
                                </div>
                            }

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label text-white-full">Ano LEITÃO</label>
                                    <InputNumber class="form-control" @bind-Value="editUser.YearLeitao" placeholder="Inserir ano..." />
                                </div>
                                @if (user != null && !user.IsOnlyLeitao())
                                {
                                    <div class="col-md-4">
                                        <label class="form-label text-white-full">Ano CALOIRO</label>
                                        <InputNumber class="form-control" @bind-Value="editUser.YearCaloiro" placeholder="Inserir ano..." />
                                    </div>
                                }
                                @if (user != null && user.IsTunoOrHigher())
                                {
                                    <div class="col-md-4">
                                        <label class="form-label text-white-full">Ano TUNO</label>
                                        <InputNumber class="form-control" @bind-Value="editUser.YearTuno" placeholder="Inserir ano..." />
                                    </div>
                                }
                            </div>
                        </EditForm>

                        <div class="mb-3">
                            <label class="form-label text-white-full">Curso</label>
                            <InputText class="form-control" @bind-Value="editUser.Degree" placeholder="Inserir curso..." />
                        </div>
                    }
                </EditContent>
            </ProfileSection>

            <!-- Section 3: Notifications (Email Preferences) -->
            <ProfileSection Title="Notificações"
                          Icon="bi-envelope-fill"
                          IsCollapsible="true"
                          IsExpanded="@sectionsExpanded["notifications"]"
                          IsEditing="false"
                          ShowEditButton="false">
                <ChildContent>
                    @if (!string.IsNullOrEmpty(subscriptionMessage))
                    {
                        <Alert Message="@subscriptionMessage" 
                               Type="@(subscriptionSuccess ? Alert.AlertType.Success : Alert.AlertType.Error)" 
                               Dismissible="true"
                               OnDismiss="@(() => subscriptionMessage = null)" 
                               AdditionalClasses="mb-3" />
                    }
                    <div class="profile-field">
                        <div class="row">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="emailNotificationCheckbox"
                                           checked="@user.Subscribed" 
                                           @onchange="OnSubscribedChanged" />
                                    <label class="form-check-label text-white-full" for="emailNotificationCheckbox">
                                        Pretendo ser notificado por email de novas atuações.
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </ChildContent>
            </ProfileSection>

        </div>
    </div>
}

<!-- Upload Photo Modal -->
<Modal Show="@showUploadModal" 
       ShowChanged="@((bool show) => showUploadModal = show)"
       Title="Carregar Foto de Perfil" 
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        <InputFile class="form-control file-input-dark" OnChange="HandleImageUpload" accept="image/*" />
        @if (!string.IsNullOrEmpty(uploadMessage))
        {
            <div class="alert alert-success mt-3">@uploadMessage</div>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseUploadModal">Fechar</button>
    </FooterContent>
</Modal>

<!-- Image Cropper Component -->
<ImageCropper @ref="imageCropper"
              ShowModal="showCropperModal"
              ShowModalChanged="OnCropperModalChanged"
              OnImageCropped="OnImageCropped"
              AspectRatio="1"
              AspectRatioHelp="As fotos de perfil são exibidas como avatares circulares (proporção 1:1 recomendada)"
              ImageFormat="image/jpeg"
              ImageQuality="0.9" />

<!-- Change Password Modal -->
<Modal Show="@showPasswordModal" 
       ShowChanged="@((bool show) => showPasswordModal = show)"
       Title="Alterar Palavra-passe" 
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        @if (!string.IsNullOrEmpty(ChangePasswordMessage))
        {
            <div class="alert @(ChangePasswordSucceeded ? "alert-success" : "alert-danger")">@ChangePasswordMessage</div>
        }
        <EditForm Model="passwordModel" OnValidSubmit="ChangePassword">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="mb-3">
                <label class="form-label text-white-full">Palavra-passe Atual</label>
                <InputText type="password" class="form-control" @bind-Value="passwordModel.OldPassword" />
            </div>

            <div class="mb-3">
                <label class="form-label text-white-full">Nova Palavra-passe</label>
                <InputText type="password" class="form-control" @bind-Value="passwordModel.NewPassword" />
            </div>

            <div class="mb-3">
                <label class="form-label text-white-full">Confirmar Nova Palavra-passe</label>
                <InputText type="password" class="form-control" @bind-Value="passwordModel.ConfirmPassword" />
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" @onclick="ClosePasswordModal">Cancelar</button>
                <button type="submit" class="btn btn-primary btn-primary-purple">Alterar Palavra-passe</button>
            </div>
        </EditForm>
    </BodyContent>
</Modal>

@code {
    private ApplicationUser? user;
    private ApplicationUser? editUser;
    private ApplicationUser? mentor;
    private List<ApplicationUser> eligibleMentors = new();
    private List<RoleAssignment> roleAssignments = new();
    private bool showUploadModal = false;
    private bool showCropperModal = false;
    private bool showPasswordModal = false;
    private string? uploadMessage;
    private ImageCropper? imageCropper;
    private IBrowserFile? selectedFile;
    private ChangePasswordModel passwordModel = new();
    private string? ChangePasswordMessage;
    private bool ChangePasswordSucceeded;
    private long profilePictureVersion = DateTime.UtcNow.Ticks;
    
    // Section editing state
    private string? editingSection = null;
    private Dictionary<string, bool> sectionsExpanded = new()
    {
        { "personal", true },
        { "tuna", true },
        { "notifications", true }
    };
    
    // Mentor search variables
    private string mentorSearchTerm = "";
    private List<ApplicationUser> filteredMentors = new();
    private SearchHelper<ApplicationUser> mentorSearchHelper = new();
    private ApplicationUser? selectedMentorCache = null;
    
    // Notification subscription state
    private string? subscriptionMessage;
    private bool subscriptionSuccess;

    public class ChangePasswordModel
    {
        [Required(ErrorMessage = "A palavra-passe atual é obrigatória")]
        [DataType(DataType.Password)]
        public string OldPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "A nova palavra-passe é obrigatória")]
        [StringLength(100, MinimumLength = 8, ErrorMessage = "A palavra-passe deve ter pelo menos 8 caracteres")]
        [DataType(DataType.Password)]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "A confirmação da palavra-passe é obrigatória")]
        [DataType(DataType.Password)]
        [Compare("NewPassword", ErrorMessage = "A nova palavra-passe e a confirmação não coincidem.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var claimsPrincipal = authState.User;

        if (claimsPrincipal?.Identity?.IsAuthenticated == true)
        {
            // Try multiple ways to get the user identifier
            var userName = claimsPrincipal.Identity.Name;
            var nameIdentifierClaim = claimsPrincipal.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var nameClaim = claimsPrincipal.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value;
            
            // Try to find by username first
            if (!string.IsNullOrEmpty(userName))
            {
                user = await UserManager.FindByNameAsync(userName);
            }
            
            // Try by name claim
            if (user == null && !string.IsNullOrEmpty(nameClaim))
            {
                user = await UserManager.FindByNameAsync(nameClaim);
                if (user == null)
                {
                    user = await UserManager.FindByEmailAsync(nameClaim);
                }
            }
            
            // Try by user ID from NameIdentifier claim
            if (user == null && !string.IsNullOrEmpty(nameIdentifierClaim))
            {
                user = await UserManager.FindByIdAsync(nameIdentifierClaim);
            }
            
            if (user != null)
            {
                // Load mentor if exists
                if (!string.IsNullOrEmpty(user.MentorId))
                {
                    mentor = await UserManager.FindByIdAsync(user.MentorId);
                }
                
                // Load eligible mentors (only Tuno category)
                eligibleMentors = UserManager.Users
                    .Where(u => u.Id != user.Id && u.Categories.Contains(MemberCategory.Tuno))
                    .OrderBy(u => u.FirstName)
                    .ThenBy(u => u.LastName)
                    .ToList();
                    
                // Load role assignments for this user
                var allAssignments = await RoleAssignmentService.GetAllRoleAssignmentsAsync();
                roleAssignments = allAssignments.Where(a => a.UserId == user.Id).ToList();
            }
        }
    }

    private void OpenUploadModal()
    {
        uploadMessage = null;
        showUploadModal = true;
    }

    private void CloseUploadModal()
    {
        showUploadModal = false;
        uploadMessage = null;
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        try
        {
            var imageFile = e.File;
            if (imageFile != null && user != null)
            {
                var maxFileSize = 10 * 1024 * 1024;
                if (imageFile.Size > maxFileSize)
                {
                    uploadMessage = "O tamanho do ficheiro deve ser inferior a 10MB.";
                    return;
                }

                selectedFile = imageFile;

                // Close upload modal and open cropper
                CloseUploadModal();

                if (imageCropper != null)
                {
                    await imageCropper.LoadImageAsync(selectedFile);
                }
            }
        }
        catch (Exception)
        {
            uploadMessage = "Erro ao carregar imagem. Por favor tente novamente.";
        }
    }

    private async Task OnImageCropped(byte[] croppedImageData)
    {
        try
        {
            if (user != null && croppedImageData != null && croppedImageData.Length > 0)
            {
                user.ProfilePictureData = croppedImageData;
                user.ProfilePictureContentType = "image/jpeg";

                await SetAuditContextToCurrentUser();
                await UserManager.UpdateAsync(user);
                
                // CRITICAL: Clear server-side image cache to ensure fresh image is served
                ImageService.InvalidateProfileImageCache(user.Id);
                
                // Update cache-bust parameter to force image reload
                profilePictureVersion = DateTime.UtcNow.Ticks;
                
                uploadMessage = "Foto de perfil atualizada com sucesso!";
                StateHasChanged();
                
                // Wait a moment to ensure database and cache updates are complete
                await Task.Delay(100);
                
                // Notify MainLayout and other components that profile picture has been updated
                ProfilePictureUpdateService.NotifyProfilePictureUpdated();
                
                // Wait for Blazor to update the DOM with new ?v= parameter.
                // The @key attribute should force element recreation, but we wait
                // to ensure DOM updates are complete before JS manipulation.
                // Using 150ms to account for varying server load and rendering time.
                await Task.Delay(150);
                
                
                await Task.Delay(1500);
                uploadMessage = null;
            }
        }
        catch (Exception)
        {
            uploadMessage = "Erro ao guardar imagem. Por favor tente novamente.";
        }
    }

    private string GetProfilePictureUrl()
    {
        if (user == null) return "/images/default-avatar.png";
        
        // Add cache-busting parameter to force reload after image update
        if (!string.IsNullOrEmpty(user.ProfilePictureSrc) && user.ProfilePictureSrc.StartsWith("/api/images/"))
        {
            return $"{user.ProfilePictureSrc}?v={profilePictureVersion}";
        }
        return user.ProfilePictureSrc ?? "/images/default-avatar.png";
    }

    private void OnCropperModalChanged(bool isOpen)
    {
        showCropperModal = isOpen;
        StateHasChanged();
    }

    private void OpenEditSectionModal(string section)
    {
        if (user == null) return;

        editingSection = section;
        editUser = new ApplicationUser
        {
            Id = user.Id,
            FirstName = user.FirstName,
            LastName = user.LastName,
            Nickname = user.Nickname,
            Email = user.Email,
            PhoneContact = user.PhoneContact,
            City = user.City,
            DateOfBirth = user.DateOfBirth,
            Degree = user.Degree,
            YearLeitao = user.YearLeitao,
            YearCaloiro = user.YearCaloiro,
            YearTuno = user.YearTuno,
            MainInstrument = user.MainInstrument,
            MentorId = user.MentorId
        };
        
        // Initialize mentor search term if user has a mentor (for tuna section)
        if (section == "tuna" && !string.IsNullOrEmpty(user.MentorId))
        {
            var existingMentor = eligibleMentors.FirstOrDefault(m => m.Id == user.MentorId);
            if (existingMentor != null)
            {
                selectedMentorCache = existingMentor;
                mentorSearchTerm = $"{existingMentor.FirstName} {existingMentor.LastName}";
            }
        }
        else
        {
            selectedMentorCache = null;
            mentorSearchTerm = "";
        }
        
        filteredMentors.Clear();
    }

    private void CancelEdit()
    {
        editingSection = null;
        editUser = null;
        mentorSearchTerm = "";
        filteredMentors.Clear();
        selectedMentorCache = null;
    }

    private async Task SavePersonalSection()
    {
        if (editUser == null || user == null) return;

        user.FirstName = editUser.FirstName;
        user.LastName = editUser.LastName;
        user.Nickname = editUser.Nickname;
        user.Email = editUser.Email;
        user.PhoneContact = editUser.PhoneContact;
        user.City = editUser.City;
        user.DateOfBirth = editUser.DateOfBirth;

        await SetAuditContextToCurrentUser();
        await UserManager.UpdateAsync(user);
        
        CancelEdit();
        StateHasChanged();
    }

    private async Task SaveTunaSection()
    {
        if (editUser == null || user == null) return;

        // Server-side guard: prevent user from being their own padrinho
        if (!string.IsNullOrEmpty(editUser.MentorId) && editUser.MentorId == user.Id)
        {
            // This should never happen due to client-side filtering, but guard against it
            editUser.MentorId = null;
        }

        user.Degree = editUser.Degree;
        user.MainInstrument = editUser.MainInstrument;
        user.MentorId = editUser.MentorId;
        user.YearLeitao = editUser.YearLeitao;
        user.YearCaloiro = editUser.YearCaloiro;
        user.YearTuno = editUser.YearTuno;

        await SetAuditContextToCurrentUser();
        await UserManager.UpdateAsync(user);
        
        // Reload mentor if changed
        if (!string.IsNullOrEmpty(user.MentorId))
        {
            mentor = await UserManager.FindByIdAsync(user.MentorId);
        }
        else
        {
            mentor = null;
        }
        
        CancelEdit();
        StateHasChanged();
    }

    private void OpenChangePasswordModal()
    {
        ChangePasswordMessage = null;
        ChangePasswordSucceeded = false;
        passwordModel = new ChangePasswordModel();
        showPasswordModal = true;
    }

    private void ClosePasswordModal()
    {
        showPasswordModal = false;
        ChangePasswordMessage = null;
        ChangePasswordSucceeded = false;
        passwordModel = new ChangePasswordModel();
    }

    private async Task ChangePassword()
    {
        ChangePasswordMessage = null;
        ChangePasswordSucceeded = false;
        if (user == null)
        {
            ChangePasswordMessage = "Utilizador não encontrado.";
            return;
        }
        var result = await UserManager.ChangePasswordAsync(user, passwordModel.OldPassword, passwordModel.NewPassword);
        if (result.Succeeded)
        {
            ChangePasswordSucceeded = true;
            ChangePasswordMessage = "A sua palavra-passe foi alterada com sucesso.";
            passwordModel = new ChangePasswordModel();

            // Clear the password change requirement flag
            if (user.RequirePasswordChange)
            {
                user.RequirePasswordChange = false;
                await SetAuditContextToCurrentUser();
                await UserManager.UpdateAsync(user);
            }

            // Close modal after delay if successful
            await Task.Delay(1500);
            ClosePasswordModal();
        }
        else
        {
            ChangePasswordMessage = string.Join("; ", result.Errors.Select(e => e.Description));
        }
    }

    private void FilterMentors()
    {
        if (string.IsNullOrEmpty(mentorSearchTerm))
        {
            filteredMentors.Clear();
            return;
        }

        // Use SearchHelper for multi-word search support
        // Only search by FirstName, LastName, and Nickname (NOT Email)
        // Use accent-insensitive search
        mentorSearchHelper.SearchTerm = mentorSearchTerm;
        
        // eligibleMentors already excludes the current user (filtered at load time)
        // but we explicitly filter here as well for consistency and safety
        var availableMentors = eligibleMentors;
        if (user != null && !string.IsNullOrEmpty(user.Id))
        {
            availableMentors = eligibleMentors.Where(u => u.Id != user.Id).ToList();
        }
        
        filteredMentors = mentorSearchHelper.FilterMultiple(availableMentors, new List<Func<ApplicationUser, string>>
        {
            u => u.FirstName ?? "",
            u => u.LastName ?? "",
            u => $"{u.FirstName} {u.LastName}",
            u => u.Nickname ?? ""
        }, caseSensitive: false, accentSensitive: false);
    }

    private void SelectMentor(ApplicationUser mentor)
    {
        if (editUser != null)
        {
            // Prevent accidental clear: if clicking the already selected mentor, don't clear it
            if (editUser.MentorId == mentor.Id)
            {
                // Keep the selection and just close the dropdown
                filteredMentors.Clear();
                return;
            }
            
            editUser.MentorId = mentor.Id;
        }
        selectedMentorCache = mentor;
        mentorSearchTerm = $"{mentor.FirstName} {mentor.LastName}";
        filteredMentors.Clear();
    }

    private void ClearMentorSelection()
    {
        if (editUser != null)
        {
            editUser.MentorId = null;
        }
        selectedMentorCache = null;
        mentorSearchTerm = "";
        filteredMentors.Clear();
    }
    
    private string? GetMentorDisplayName()
    {
        // Try to get mentor from the loaded mentor object or by looking up the ID
        if (mentor != null)
        {
            var displayName = $"{mentor.FirstName} {mentor.LastName}";
            if (!string.IsNullOrEmpty(mentor.Nickname))
            {
                displayName += $" \"{mentor.Nickname}\"";
            }
            return displayName;
        }
        
        // If mentor is null but user has a MentorId, the mentor might not have loaded
        // Return null to show "Não definido"
        return null;
    }

    private async Task OnSubscribedChanged(ChangeEventArgs e)
    {
        if (user == null) return;

        subscriptionMessage = null;
        subscriptionSuccess = false;

        try
        {
            var newValue = e.Value is bool boolValue ? boolValue : false;
            user.Subscribed = newValue;

            await SetAuditContextToCurrentUser();
            var result = await UserManager.UpdateAsync(user);

            if (result.Succeeded)
            {
                subscriptionSuccess = true;
                subscriptionMessage = newValue 
                    ? "Notificações por email ativadas com sucesso."
                    : "Notificações por email desativadas com sucesso.";
                
                // Clear message after 3 seconds
                StateHasChanged();
                await Task.Delay(3000);
                subscriptionMessage = null;
                StateHasChanged();
            }
            else
            {
                subscriptionSuccess = false;
                subscriptionMessage = "Erro ao atualizar preferências de notificação.";
                // Revert the change
                user.Subscribed = !newValue;
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            subscriptionSuccess = false;
            subscriptionMessage = "Erro ao atualizar preferências de notificação.";
            StateHasChanged();
        }
    }

    private async Task SetAuditContextToCurrentUser()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.Name;
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        AuditContext.SetUser(userName, userId);
    }

}


