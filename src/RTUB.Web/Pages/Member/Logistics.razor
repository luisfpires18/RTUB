@page "/logistics"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using RTUB.Application.Interfaces
@using BoardEntity = RTUB.Core.Entities.LogisticsBoard
@using RTUB.Core.Entities
@using RTUB.Shared
@inject ILogisticsBoardService BoardService
@inject IEventService EventService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>Quadros de Logística - RTUB</PageTitle>

<h1><i class="bi bi-kanban"></i> Quadros de Logística</h1>
<p>Gerencie os seus quadros de tarefas e atuações.</p>

<AuthorizeView>
    <Authorized>
        <div class="mb-3">
            <button class="btn btn-success" @onclick="OpenCreateBoardModal">
                <i class="bi bi-plus-lg"></i> Criar Quadro
            </button>
        </div>

        <TableSearchBar SearchTerm="@searchTerm"
                        Placeholder="Pesquisar quadros..."
                        OnSearchChanged="HandleSearch" />

        @if (boards == null)
        {
            <p>A carregar quadros...</p>
        }
        else if (!boards.Any())
        {
            <div class="text-center py-5">
                <i class="bi bi-kanban" style="font-size: 4rem; opacity: 0.3;"></i>
                <h3>Nenhum quadro criado ainda</h3>
                <p class="text-muted">Crie o seu primeiro quadro para começar a organizar tarefas.</p>
            </div>
        }
        else
        {
            <div class="row">
                @foreach (var board in boards)
                {
                    <div class="col-md-4 mb-4">
                        <BoardCard Board="@board"
                                   OnView="@(() => Navigation.NavigateTo($"/logistics/{board.Id}"))"
                                   OnEdit="@(() => OpenEditBoardModal(board))"
                                   OnDelete="@(() => OpenDeleteBoardModal(board))" />
                    </div>
                }
            </div>

            <TablePagination CurrentPage="@currentPage"
                             PageSize="@pageSize"
                             TotalItems="@totalCount"
                             ItemLabel="quadros"
                             OnPageChanged="@HandlePageChanged"
                             OnPageSizeChanged="@HandlePageSizeChanged" />
        }
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-warning">
            <i class="bi bi-lock"></i> Precisa estar autenticado para aceder aos quadros de logística.
        </div>
    </NotAuthorized>
</AuthorizeView>

@* Create/Edit Board Modal *@
@if (showBoardModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingBoard == null ? "Criar Quadro" : "Editar Quadro")</h5>
                    <button type="button" class="btn-close" @onclick="CloseBoardModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome do Quadro</label>
                        <input type="text" class="form-control" @bind="boardName" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" rows="3" @bind="boardDescription"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Evento Associado (opcional)</label>
                        <select class="form-select" @bind="selectedEventId">
                            <option value="">Nenhum</option>
                            @if (events != null)
                            {
                                @foreach (var evt in events)
                                {
                                    <option value="@evt.Id">@evt.Name - @evt.Date.ToString("dd/MM/yyyy")</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseBoardModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveBoard">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Confirmation Modal *@
@if (showDeleteBoardModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Eliminação</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteBoardModal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem a certeza que deseja eliminar o quadro "<strong>@deletingBoard?.Name</strong>"?</p>
                    <p class="text-danger"><small>Todas as listas e cartões deste quadro também serão eliminados.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteBoardModal">Cancelar</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteBoard">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<BoardEntity>? boards;
    private List<Event>? events;
    private int currentPage = 1;
    private int pageSize = 12;
    private int totalCount = 0;
    private string searchTerm = string.Empty;

    // Board modal state
    private bool showBoardModal = false;
    private BoardEntity? editingBoard = null;
    private string boardName = string.Empty;
    private string boardDescription = string.Empty;
    private string selectedEventId = string.Empty;

    // Delete modal state
    private bool showDeleteBoardModal = false;
    private BoardEntity? deletingBoard = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var result = await BoardService.GetBoardsPagedAsync(currentPage, pageSize, searchTerm);
        boards = result.Boards.ToList();
        totalCount = result.TotalCount;
        events = (await EventService.GetAllEventsAsync()).ToList();
    }

    private async Task HandleSearch(string search)
    {
        searchTerm = search;
        currentPage = 1;
        await LoadData();
    }

    private async Task HandlePageChanged(int page)
    {
        currentPage = page;
        await LoadData();
    }

    private async Task HandlePageSizeChanged(int size)
    {
        pageSize = size;
        currentPage = 1;
        await LoadData();
    }

    private void OpenCreateBoardModal()
    {
        editingBoard = null;
        boardName = string.Empty;
        boardDescription = string.Empty;
        selectedEventId = string.Empty;
        showBoardModal = true;
    }

    private void OpenEditBoardModal(BoardEntity board)
    {
        editingBoard = board;
        boardName = board.Name;
        boardDescription = board.Description;
        selectedEventId = board.EventId?.ToString() ?? string.Empty;
        showBoardModal = true;
    }

    private void CloseBoardModal()
    {
        showBoardModal = false;
        editingBoard = null;
    }

    private async Task SaveBoard()
    {
        if (string.IsNullOrWhiteSpace(boardName))
            return;

        try
        {
            int? eventId = string.IsNullOrEmpty(selectedEventId) ? null : int.Parse(selectedEventId);

            if (editingBoard == null)
            {
                var board = await BoardService.CreateBoardAsync(boardName, boardDescription);
                if (eventId.HasValue)
                    await BoardService.AssociateBoardWithEventAsync(board.Id, eventId);
            }
            else
            {
                await BoardService.UpdateBoardAsync(editingBoard.Id, boardName, boardDescription);
                await BoardService.AssociateBoardWithEventAsync(editingBoard.Id, eventId);
            }

            await LoadData();
            CloseBoardModal();
        }
        catch (Exception)
        {
            // Handle error
        }
    }

    private void OpenDeleteBoardModal(BoardEntity board)
    {
        deletingBoard = board;
        showDeleteBoardModal = true;
    }

    private void CloseDeleteBoardModal()
    {
        showDeleteBoardModal = false;
        deletingBoard = null;
    }

    private async Task ConfirmDeleteBoard()
    {
        if (deletingBoard == null)
            return;

        try
        {
            await BoardService.DeleteBoardAsync(deletingBoard.Id);
            await LoadData();
            CloseDeleteBoardModal();
        }
        catch (Exception)
        {
            // Handle error
        }
    }
}
