@page "/members"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Application.Interfaces
@using RTUB.Shared
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject IRoleAssignmentService RoleAssignmentService
@inject IEnrollmentService EnrollmentService
@inject IEmailNotificationService EmailNotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject RTUB.Application.Services.AuditContext AuditContext
@attribute [Authorize]

<h1 class="mb-2"><i class="bi bi-people"></i> Membros</h1>
<p class="lead mb-4 text-light-theme">Lista de todos os membros da RTUB.</p>

<AuthorizeView Roles="Admin">
    <Authorized>
        <div class="mb-3">
            <button class="btn btn-success" @onclick="OpenCreateModal" title="Adicionar Novo Membro">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    </Authorized>
</AuthorizeView>

<!-- Search and Controls -->
<div class="d-flex gap-2 mb-3 align-items-center">
    <div style="flex: 2;">
        <TableSearchBar SearchTerm="@searchTerm"
                       Placeholder="Pesquisar membros..."
                       OnSearchChanged="@HandleSearchChanged" />
    </div>
    <div style="flex: 1;">
        <select class="form-select" @bind="selectedCategoryFilter" @bind:after="ApplyFilters">
            <option value="">Categoria</option>
            <option value="Caloiro">Caloiro</option>
            <option value="Tuno">Tuno</option>
        </select>
    </div>
    <div style="flex: 1;">
        <select class="form-select" @bind="selectedInstrumentFilter" @bind:after="ApplyFilters">
            <option value="">Instrumento</option>
            @foreach (var instrument in Enum.GetValues<InstrumentType>())
            {
                <option value="@instrument">@StatusHelper.GetInstrumentDisplay(instrument)</option>
            }
        </select>
    </div>
</div>

@if (users == null)
{
    <!-- Loading skeleton cards -->
    <div class="avatar-card-grid">
        @for (int i = 0; i < 8; i++)
        {
            <div class="avatar-card-skeleton-card">
                <div class="avatar-card-image-wrapper">
                    <div class="avatar-card-skeleton"></div>
                </div>
            </div>
        }
    </div>
}
else if (!filteredUsers.Any())
{
    <EmptyState Title="Nenhum membro criado ainda"
                    Icon="bi-people"
                    Message="Adicione membros para começar." />
}
else
{
    <!-- Regular Members Grid -->
    @if (filteredRegularMembers.Any())
    {
        <h3 class="mb-3">Membros</h3>
        <div class="avatar-card-grid">
            @foreach (var user in paginatedRegularMembers)
            {
                <AvatarCard AvatarUrl="@user.ProfilePictureSrc"
                           TunaName="@user.Nickname"
                           FullName="@($"{user.FirstName} {user.LastName}")"
                           InstrumentText="@(user.MainInstrument.HasValue ? StatusHelper.GetInstrumentDisplay(user.MainInstrument.Value) : "")"
                           AltText="@user.GetDisplayName()"
                           OnView="@(async () => await OpenViewDetailsModal(user))"
                           OnEdit="@(() => OpenEditModal(user))"
                           OnDelete="@(() => OpenDeleteModal(user))"
                           ShowEditButton="@isAdmin"
                           ShowDeleteButton="@isOwner"
                           ViewTooltip="Ver Detalhes"
                           EditTooltip="Editar"
                           DeleteTooltip="Eliminar"
                           LazyLoad="true">
                    <BadgeContent>
                        @{
                            // Get current fiscal year position for this user
                            var currentPosition = GetCurrentFiscalYearPosition(user.Id);
                        }
                        <!-- Category badges row -->
                        <div class="avatar-card-badges-row">
                            @foreach (var category in user.Categories.Where(c =>
                                c == MemberCategory.Caloiro || c == MemberCategory.Tuno))
                            {
                                <CategoryBadge Category="category" />
                            }
                        </div>
                        <!-- Role/Position badges row -->
                        @if (currentPosition != null)
                        {
                            <div class="avatar-card-badges-row">
                                <PositionBadge Position="currentPosition.Value" />
                            </div>
                        }
                        @if (!user.Positions.Any() && !user.Categories.Any())
                        {
                            <div class="avatar-card-badges-row">
                                <span class="badge bg-secondary avatar-card-role-badge" 
                                      title="Sem Cargos"
                                      aria-label="Sem Cargos">Sem Cargos</span>
                            </div>
                        }
                    </BadgeContent>
                </AvatarCard>
            }
        </div>

        <TablePagination CurrentPage="@paginationHelper.CurrentPage"
                        PageSize="@paginationHelper.PageSize"
                        TotalItems="@filteredRegularMembers.Count"
                        ItemLabel="membros"
                        PageSizeOptions="@(new[] { 12, 24, 36, 48, 60 })"
                        OnPageChanged="@HandleRegularMembersPageChange"
                        OnPageSizeChanged="@HandleRegularMembersPageSizeChange" />
    }

    <!-- Leitões Grid -->
    @if (filteredLeitoes.Any())
    {
        <hr class="my-5 hr-divider" />
        <h3 class="mb-3">Leitões</h3>
        <div class="avatar-card-grid">
            @foreach (var user in paginatedLeitoes)
            {
                <AvatarCard AvatarUrl="@user.ProfilePictureSrc"
                           TunaName="@user.Nickname"
                           FullName="@($"{user.FirstName} {user.LastName}")"
                           InstrumentText="@(user.MainInstrument.HasValue ? StatusHelper.GetInstrumentDisplay(user.MainInstrument.Value) : "")"
                           AltText="@user.GetDisplayName()"
                           OnView="@(async () => await OpenViewDetailsModal(user))"
                           OnEdit="@(() => OpenEditModal(user))"
                           OnDelete="@(() => OpenDeleteModal(user))"
                           ShowEditButton="@isAdmin"
                           ShowDeleteButton="@isAdmin"
                           ViewTooltip="Ver Detalhes"
                           EditTooltip="Editar"
                           DeleteTooltip="Eliminar"
                           LazyLoad="true">
                    <BadgeContent>
                        <div class="avatar-card-badges-row">
                            <CategoryBadge Category="@MemberCategory.Leitao" />
                        </div>
                    </BadgeContent>
                </AvatarCard>
            }
        </div>

        <TablePagination CurrentPage="@paginationHelperLeitoes.CurrentPage"
                        PageSize="@paginationHelperLeitoes.PageSize"
                        TotalItems="@filteredLeitoes.Count"
                        ItemLabel="leitões"
                        PageSizeOptions="@(new[] { 12, 24, 36, 48, 60 })"
                        OnPageChanged="@HandleLeitoesPageChange"
                        OnPageSizeChanged="@HandleLeitoesPageSizeChange" />
    }
}

<!-- Create/Edit Modal -->
<Modal Show="@showEditModal" 
       ShowChanged="@((bool show) => showEditModal = show)"
       Title="@(isCreateMode ? "Adicionar Novo Membro" : "Editar Membro")" 
       Size="Modal.ModalSize.Large"
       Centered="true">
    <BodyContent>
        <EditForm Model="@editingUser" OnValidSubmit="SaveMember" @ref="memberEditForm">
            <DataAnnotationsValidator />
            <ErrorDisplay />

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-person text-primary me-2"></i>Primeiro Nome <span class="text-danger">*</span>
                    </label>
                    <InputText class="form-control" @bind-Value="editingUser.FirstName" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-person text-primary me-2"></i>Último Nome <span class="text-danger">*</span>
                    </label>
                    <InputText class="form-control" @bind-Value="editingUser.LastName" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-star text-primary me-2"></i>Nome de Tuna / Nickname <span class="text-danger">*</span>
                    </label>
                    <InputText class="form-control" @bind-Value="editingUser.Nickname" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-telephone text-primary me-2"></i>Contacto <span class="text-danger">*</span>
                    </label>
                    <InputText class="form-control" @bind-Value="editingUser.PhoneContact" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-envelope text-primary me-2"></i>Email <span class="text-danger">*</span>
                    </label>
                    <InputText type="email" class="form-control" @bind-Value="editingUser.Email" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-calendar3 text-primary me-2"></i>Data de Nascimento
                    </label>
                    <InputDate class="form-control" @bind-Value="editingUser.DateOfBirth" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-book text-primary me-2"></i>Curso
                    </label>
                    <InputText class="form-control" @bind-Value="editingUser.Degree" placeholder="Inserir curso..." />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-geo-alt text-primary me-2"></i>Cidade
                    </label>
                    <InputText class="form-control" @bind-Value="editingUser.City" placeholder="Inserir cidade..." />
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label fw-semibold">
                    <i class="bi bi-tag text-primary me-2"></i>Categoria <span class="text-danger">*</span>
                </label>
                <InputSelect class="form-select" @bind-Value="editingUser.SelectedCategory" @bind-Value:after="OnCategoryChanged">
                    <option value="">Selecionar Categoria</option>
                    <option value="Leitão">Leitão</option>
                    <option value="Caloiro">Caloiro</option>
                    <option value="Tuno">Tuno</option>
                </InputSelect>
            </div>
            @* Fundador checkbox - only show for Tuno category *@
            @if (editingUser.SelectedCategory == "Tuno")
            {
                <div class="mb-3">
                    <div class="form-check">
                        <InputCheckbox class="form-check-input" id="fundadorCheckbox" @bind-Value="isFundador" @bind-Value:after="OnFundadorChanged" />
                        <label class="form-check-label" for="fundadorCheckbox">
                            Fundador
                        </label>
                    </div>
                </div>
            }
            <div class="row">
                @if (showYearLeitao && !isFundador)
                {
                    <div class="col-md-4 mb-3">
                        <MonthYearPicker Label="Entrada a Leitão"
                                         Icon="calendar-plus"
                                         @bind-Year="@editingUser.YearLeitao"
                                         @bind-Month="@editingUser.MonthLeitao"
                                         @bind-Value="LeitaoDate" />
                    </div>
                }

                @if (showYearCaloiro && !isFundador)
                {
                    <div class="col-md-4 mb-3">
                        <MonthYearPicker Label="Passagem a Caloiro"
                                         Icon="calendar-event"
                                         @bind-Year="@editingUser.YearCaloiro"
                                         @bind-Month="@editingUser.MonthCaloiro"
                                         @bind-Value="CaloiroDate" />
                    </div>
                }

                @if (showYearTuno && !isFundador)
                {
                    <div class="col-md-4 mb-3">
                        <MonthYearPicker Label="Passagem a Tuno"
                                         Icon="calendar-check"
                                         @bind-Year="@editingUser.YearTuno"
                                         @bind-Month="@editingUser.MonthTuno"
                                         @bind-Value="TunoDate" />
                    </div>
                }
            </div>
            <div class="mb-3">
                <label class="form-label fw-semibold">
                    <i class="bi bi-music-note-beamed text-primary me-2"></i>Instrumento Principal
                </label>
                <InputSelect class="form-select" @bind-Value="editingUser.MainInstrument">
                    <option value="">Sem instrumento</option>
                    @foreach (var instrument in Enum.GetValues<InstrumentType>())
                    {
                        <option value="@instrument">@StatusHelper.GetInstrumentDisplay(instrument)</option>
                    }
                </InputSelect>
            </div>
            @* Only show Padrinho field for Caloiro or Tuno (not for Leitão or Fundador) *@
            @if ((editingUser.SelectedCategory == "Caloiro" || editingUser.SelectedCategory == "Tuno") && !isFundador)
            {
                <div class="mb-3">
                    <label class="form-label">Padrinho @(editingUser.SelectedCategory == "Caloiro" ? "(Obrigatório quando passa a Caloiro)" : "")</label>
                    <div class="mentor-search-container">
                        <div class="input-group mb-2">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="Pesquisar padrinho por nome ou alcunha..."
                                   @bind="mentorSearchTerm" 
                                   @bind:event="oninput" 
                                   @onkeyup="FilterMentors" />
                            @if (!string.IsNullOrEmpty(mentorSearchTerm))
                            {
                                <button class="btn btn-outline-secondary" type="button" @onclick="ClearMentorSelection" title="Limpar seleção">
                                    <i class="bi bi-x-circle-fill"></i>
                                </button>
                            }
                        </div>
                    </div>
                    
                    @if (filteredMentors.Any())
                    {
                        <div class="member-list member-list-scrollable">
                            @foreach (var mentor in filteredMentors.Take(20))
                            {
                                <div class="member-item p-2 mb-2 border rounded clickable-row"
                                     @onclick="() => SelectMentor(mentor)">
                                    <div class="d-flex align-items-center">
                                        <img src="@mentor.ProfilePictureSrc" alt="@mentor.GetDisplayName()"
                                             class="member-avatar-small me-2" />
                                        <div>
                                            @if (!string.IsNullOrEmpty(mentor.Nickname))
                                            {
                                                <div><strong>@mentor.Nickname</strong></div>
                                                <div class="text-muted small">@mentor.FirstName @mentor.LastName</div>
                                            }
                                            else
                                            {
                                                <div><strong>@mentor.FirstName @mentor.LastName</strong></div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(mentorSearchTerm) && string.IsNullOrEmpty(editingUser.MentorId))
                    {
                        <div class="alert alert-purple mt-2">Nenhum padrinho encontrado.</div>
                    }

                    @if (!string.IsNullOrEmpty(editingUser.MentorId))
                    {
                        // Use cached mentor to avoid repeated lookups on every render
                        var displayMentor = selectedMentorCache ?? eligibleMentors.FirstOrDefault(m => m.Id == editingUser.MentorId);
                        if (displayMentor != null)
                        {
                            <div class="alert alert-purple mt-2">
                                <strong>Padrinho Selecionado:</strong> @displayMentor.GetDisplayName()
                            </div>
                        }
                    }
                </div>
            }
        </EditForm>
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseEditModal" disabled="@isSaving">Cancelar</button>
        <button type="button" class="btn btn-primary btn-primary-purple" @onclick="HandleSaveClick" disabled="@isSaving">
            @if (isSaving)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            }
            Guardar
        </button>
    </FooterContent>
</Modal>

<!-- Delete Confirmation Modal -->
<ConfirmDialog Show="@showDeleteModal"
               ShowChanged="@((bool show) => showDeleteModal = show)"
               Title="Confirmar Eliminação"
               Message="@($"Tem certeza que deseja eliminar {deletingUser?.GetDisplayName()}?")"
               WarningMessage="Esta ação não pode ser desfeita."
               ConfirmText="Eliminar"
               CancelText="Cancelar"
               ConfirmButtonClass="btn-danger"
               OnConfirm="DeleteMember"
               OnCancel="CloseDeleteModal" />

<!-- View Details Modal -->
@if (viewingUser != null)
{
    <Modal Show="@showViewDetailsModal" 
           ShowChanged="@((bool show) => showViewDetailsModal = show)"
           Title="Detalhes do Membro" 
           Size="Modal.ModalSize.Large"
           Centered="true">
        <BodyContent>
            <!-- Centered Header Section -->
            <div class="text-center mb-4">
                <img src="@viewingUser.ProfilePictureSrc" alt="@viewingUser.GetDisplayName()"
                     class="member-avatar-large mb-3" style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--bs-primary);" />
                
                @if (!string.IsNullOrEmpty(viewingUser.Nickname))
                {
                    <h4 class="mb-1">@viewingUser.Nickname</h4>
                    <p class="text-muted mb-2">@viewingUser.FirstName @viewingUser.LastName</p>
                }
                else
                {
                    <h4 class="mb-2">@viewingUser.FirstName @viewingUser.LastName</h4>
                }
                
                <!-- Badges centered below name -->
                <div class="d-flex justify-content-center flex-wrap gap-1 mb-2">
                    @{
                        var displayCategories = StatusHelper.GetDisplayCategories(viewingUser);
                    }
                    @foreach (var category in displayCategories)
                    {
                        <CategoryBadge Category="category" />
                    }
                    @if (viewingUser.Positions.Any())
                    {
                        @foreach (var position in viewingUser.Positions)
                        {
                            <PositionBadge Position="position" />
                        }
                    }
                </div>
            </div>

            <div class="mb-3"></div>

            <!-- Personal Information Section -->
            <div class="modal-info-section mb-4">
                <div class="modal-section-header">
                    <h6 class="modal-section-title">
                        <i class="bi bi-person-fill me-2 text-primary"></i>
                        Informações Pessoais
                    </h6>
                </div>
                <div class="modal-section-body">
                    <ProfileField Label="Email" Value="@viewingUser.Email" />
                    <ProfileField Label="Contacto" Value="@viewingUser.PhoneContact" />
                    <ProfileField Label="Cidade" Value="@viewingUser.City" />
                    <ProfileField Label="Data de Nascimento" 
                                Value="@(viewingUser.DateOfBirth.HasValue ? viewingUser.DateOfBirth.Value.ToString("dd/MM/yyyy") + (viewingUser.Age.HasValue ? $" ({viewingUser.Age} anos)" : "") : null)" />
                    <ProfileField Label="Curso" Value="@viewingUser.Degree" />
                </div>
            </div>

            <!-- Tuna Information Section -->
            <div class="modal-info-section mb-3">
                <div class="modal-section-header">
                    <h6 class="modal-section-title">
                        <i class="bi bi-music-note-list me-2 text-primary"></i>
                        Informação da Tuna
                    </h6>
                </div>
                <div class="modal-section-body">
                    <ProfileField Label="Instrumento Principal" 
                                Value="@(viewingUser.MainInstrument.HasValue ? StatusHelper.GetInstrumentDisplay(viewingUser.MainInstrument.Value) : null)" />
                    @if (!viewingUser.IsFundador())
                    {
                        <ProfileField Label="Padrinho" 
                                    Value="@(viewingUserMentor != null ? viewingUserMentor.GetDisplayName() : null)" />
                    }
                    
                    <!-- Unified Timeline -->
                    <div class="profile-field">
                        <div class="row">
                            <div class="col-12 col-md-4 profile-field-label">
                                <strong class="text-white-full">Percurso na Tuna:</strong>
                            </div>
                            <div class="col-12 col-md-8 profile-field-value">
                                @if (userRoleAssignments.ContainsKey(viewingUser.Id))
                                {
                                    <UnifiedTimeline User="@viewingUser" RoleAssignments="@userRoleAssignments[viewingUser.Id]" />
                                }
                                else
                                {
                                    <UnifiedTimeline User="@viewingUser" RoleAssignments="@(new List<RoleAssignment>())" />
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </BodyContent>
        <FooterContent>
            <button type="button" class="btn btn-secondary" @onclick="CloseViewDetailsModal">Fechar</button>
        </FooterContent>
    </Modal>
}

@code {
    private List<ApplicationUser>? users;
    private List<ApplicationUser> filteredUsers = new();
    private List<ApplicationUser> filteredRegularMembers = new();
    private List<ApplicationUser> filteredLeitoes = new();
    private List<ApplicationUser> paginatedUsers = new();
    private List<ApplicationUser> paginatedRegularMembers = new();
    private List<ApplicationUser> paginatedLeitoes = new();
    private Dictionary<string, List<string>> userRoles = new Dictionary<string, List<string>>();
    private Dictionary<string, List<RoleAssignment>> userRoleAssignments = new Dictionary<string, List<RoleAssignment>>();
    private List<ApplicationUser> eligibleMentors = new();
    private ApplicationUser? viewingUserMentor;

    // Helper instances
    private SearchHelper<ApplicationUser> searchHelper = new();
    private SortableTableHelper<ApplicationUser> sortHelper = new() { SortColumn = nameof(ApplicationUser.FirstName) };
    private PaginationHelper<ApplicationUser> paginationHelper = new() { PageSize = 48 };
    private PaginationHelper<ApplicationUser> paginationHelperLeitoes = new() { PageSize = 48 };

    private string searchTerm = "";
    private int totalUsers = 0;
    
    // Filter variables
    private string selectedCategoryFilter = "";
    private string selectedInstrumentFilter = "";

    private bool showEditModal = false;
    private bool showDeleteModal = false;
    private bool showViewDetailsModal = false;
    private bool isCreateMode = false;
    private bool isSaving = false;
    private ApplicationUser editingUser = new();
    private ApplicationUser? deletingUser;
    private ApplicationUser? viewingUser;
    private EditForm? memberEditForm;
    private bool isFundador = false; // Track if user is a founder
    
    // Helper properties for month/year date pickers
    private DateTime? LeitaoDate
    {
        get => GetDateFromYearMonth(editingUser.YearLeitao, editingUser.MonthLeitao);
        set
        {
            var (year, month) = GetYearMonthFromDate(value);
            editingUser.YearLeitao = year;
            editingUser.MonthLeitao = month;
        }
    }
    
    private DateTime? CaloiroDate
    {
        get => GetDateFromYearMonth(editingUser.YearCaloiro, editingUser.MonthCaloiro);
        set
        {
            var (year, month) = GetYearMonthFromDate(value);
            editingUser.YearCaloiro = year;
            editingUser.MonthCaloiro = month;
        }
    }
    
    private DateTime? TunoDate
    {
        get => GetDateFromYearMonth(editingUser.YearTuno, editingUser.MonthTuno);
        set
        {
            var (year, month) = GetYearMonthFromDate(value);
            editingUser.YearTuno = year;
            editingUser.MonthTuno = month;
        }
    }
    
    // Mentor search variables
    private string mentorSearchTerm = "";
    private List<ApplicationUser> filteredMentors = new();
    private SearchHelper<ApplicationUser> mentorSearchHelper = new();
    private ApplicationUser? selectedMentorCache = null;

    // Authorization flags
    private bool isAdmin = false;
    private bool isOwner = false;

    protected override async Task OnInitializedAsync()
    {
        await CheckUserRoles();
        await LoadMembers();
    }

    private async Task CheckUserRoles()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAdmin = user.IsInRole("Admin");
        isOwner = user.IsInRole("Owner");
    }

    private async Task LoadMembers()
    {
        users = UserManager.Users.ToList();
        totalUsers = users.Count;

        foreach (var user in users)
        {
            var roles = await UserManager.GetRolesAsync(user);
            userRoles[user.Id] = roles.ToList();
        }

        // Load role assignments
        var allAssignments = (await RoleAssignmentService.GetAllRoleAssignmentsAsync())
            .Where(ra => users.Select(u => u.Id).Contains(ra.UserId))
            .ToList();

        userRoleAssignments.Clear();
        foreach (var user in users)
        {
            userRoleAssignments[user.Id] = allAssignments
                .Where(ra => ra.UserId == user.Id)
                .OrderByDescending(ra => ra.StartYear)
                .ToList();
        }

        // Load eligible mentors (Only Tuno, Veterano, Tunossauro - excluding Leitões and Caloiros)
        // Also exclude the user being edited if in edit mode
        eligibleMentors = users
            .Where(u => u.CanBeMentor())
            .OrderBy(u => u.FirstName)
            .ThenBy(u => u.LastName)
            .ToList();

        FilterMembers();
    }

    private void FilterMembers()
    {
        if (users == null) return;

        // Use SearchHelper for filtering
        searchHelper.SearchTerm = searchTerm;
        var allFilteredUsers = searchHelper.FilterMultiple(users, new List<Func<ApplicationUser, string>>
        {
            u => u.FirstName ?? "",
            u => u.LastName ?? "",
            u => u.Nickname ?? "",
            u => u.Email ?? "",
            u => u.PhoneContact ?? ""
        });

        // Separate Leitões from regular members
        filteredLeitoes = allFilteredUsers.Where(u => u.IsLeitao()).ToList();
        filteredRegularMembers = allFilteredUsers.Where(u => !u.IsLeitao()).ToList();
        
        // Apply category filter (only for regular members, not Leitões)
        if (!string.IsNullOrEmpty(selectedCategoryFilter))
        {
            var categoryEnum = Enum.Parse<MemberCategory>(selectedCategoryFilter);
            filteredRegularMembers = filteredRegularMembers
                .Where(u => u.Categories.Contains(categoryEnum))
                .ToList();
        }
        
        // Apply instrument filter (only for regular members, not Leitões)
        if (!string.IsNullOrEmpty(selectedInstrumentFilter))
        {
            var instrumentEnum = Enum.Parse<InstrumentType>(selectedInstrumentFilter);
            filteredRegularMembers = filteredRegularMembers
                .Where(u => u.MainInstrument.HasValue && u.MainInstrument.Value == instrumentEnum)
                .ToList();
        }
        
        filteredUsers = filteredRegularMembers.Concat(filteredLeitoes).ToList(); // Keep for backwards compatibility

        ApplySort();
        UpdatePagination();
    }
    
    private void ApplyFilters()
    {
        FilterMembers();
    }

    private async Task HandleSearchChanged(string search)
    {
        searchTerm = search;
        FilterMembers();
        await Task.CompletedTask;
    }

    private async Task HandleSortChanged(string column)
    {
        SortBy(column);
        await Task.CompletedTask;
    }

    private async Task HandleRegularMembersPageChange(int newPage)
    {
        ChangePage(newPage);
        await Task.CompletedTask;
    }

    private async Task HandleRegularMembersPageSizeChange(int newPageSize)
    {
        paginationHelper.PageSize = newPageSize;
        paginationHelper.Reset();
        UpdatePagination();
        await Task.CompletedTask;
    }

    private async Task HandleLeitoesPageChange(int newPage)
    {
        ChangePageLeitoes(newPage);
        await Task.CompletedTask;
    }

    private async Task HandleLeitoesPageSizeChange(int newPageSize)
    {
        paginationHelperLeitoes.PageSize = newPageSize;
        paginationHelperLeitoes.Reset();
        UpdatePagination();
        await Task.CompletedTask;
    }

    private void SortBy(string column)
    {
        sortHelper.ChangeSortColumn(column);
        ApplySort();
        UpdatePagination();
    }

    private void ApplySort()
    {
        var columnSelectors = new Dictionary<string, Func<ApplicationUser, IComparable>>
        {
            [nameof(ApplicationUser.FirstName)] = u => u.FirstName ?? "",
            [nameof(ApplicationUser.Nickname)] = u => u.Nickname ?? "",
            [nameof(ApplicationUser.Email)] = u => u.Email ?? "",
            ["Category"] = u => u.Categories.FirstOrDefault().ToString(),
            ["Instrument"] = u => u.MainInstrument?.ToString() ?? "ZZZ"
        };

        // Sort regular members and Leitões using SortableTableHelper
        filteredRegularMembers = sortHelper.ApplySort(filteredRegularMembers, columnSelectors);
        filteredLeitoes = sortHelper.ApplySort(filteredLeitoes, columnSelectors);

        // Keep for backwards compatibility
        filteredUsers = filteredRegularMembers.Concat(filteredLeitoes).ToList();
    }

    private void UpdatePagination()
    {
        // Use PaginationHelper for regular members
        paginatedRegularMembers = paginationHelper.GetPageData(filteredRegularMembers);

        // Use PaginationHelper for Leitões
        paginatedLeitoes = paginationHelperLeitoes.GetPageData(filteredLeitoes);

        // Keep for backwards compatibility
        paginatedUsers = paginatedRegularMembers.Concat(paginatedLeitoes).ToList();
    }

    private void ChangePage(int page)
    {
        if (paginationHelper.GoToPage(page))
        {
            UpdatePagination();
        }
    }

    private void ChangePageLeitoes(int page)
    {
        if (paginationHelperLeitoes.GoToPage(page))
        {
            UpdatePagination();
        }
    }

    private void FilterMentors()
    {
        if (string.IsNullOrEmpty(mentorSearchTerm))
        {
            filteredMentors.Clear();
            return;
        }

        // Use SearchHelper for multi-word search support
        // Only search by FirstName, LastName, and Nickname (NOT Email)
        // Use accent-insensitive search
        mentorSearchHelper.SearchTerm = mentorSearchTerm;
        
        // Exclude the user being edited from mentor candidates
        var availableMentors = eligibleMentors;
        if (!isCreateMode && !string.IsNullOrEmpty(editingUser?.Id))
        {
            availableMentors = eligibleMentors.Where(u => u.Id != editingUser.Id).ToList();
        }
        
        filteredMentors = mentorSearchHelper.FilterMultiple(availableMentors, new List<Func<ApplicationUser, string>>
        {
            u => u.FirstName ?? "",
            u => u.LastName ?? "",
            u => $"{u.FirstName} {u.LastName}",
            u => u.Nickname ?? ""
        }, caseSensitive: false, accentSensitive: false);
    }

    private void SelectMentor(ApplicationUser mentor)
    {
        // Prevent accidental clear: if clicking the already selected mentor, don't clear it
        if (editingUser.MentorId == mentor.Id)
        {
            // Keep the selection and just close the dropdown
            filteredMentors.Clear();
            return;
        }
        
        editingUser.MentorId = mentor.Id;
        selectedMentorCache = mentor;
        mentorSearchTerm = $"{mentor.FirstName} {mentor.LastName}";
        filteredMentors.Clear();
    }

    private void ClearMentorSelection()
    {
        if (editingUser != null)
        {
            editingUser.MentorId = null;
        }
        selectedMentorCache = null;
        mentorSearchTerm = "";
        filteredMentors.Clear();
    }

    private void OpenCreateModal()
    {
        isCreateMode = true;
        editingUser = new ApplicationUser();
        isFundador = false;
        mentorSearchTerm = "";
        filteredMentors.Clear();
        selectedMentorCache = null;
        showEditModal = true;
    }

    private void OpenEditModal(ApplicationUser user)
    {
        isCreateMode = false;
        editingUser = new ApplicationUser
        {
            Id = user.Id,
            UserName = user.UserName,
            Email = user.Email,
            FirstName = user.FirstName,
            LastName = user.LastName,
            Nickname = user.Nickname,
            PhoneContact = user.PhoneContact,
            City = user.City,
            DateOfBirth = user.DateOfBirth,
            Degree = user.Degree,
            YearLeitao = user.YearLeitao,
            MonthLeitao = user.MonthLeitao,
            YearCaloiro = user.YearCaloiro,
            MonthCaloiro = user.MonthCaloiro,
            YearTuno = user.YearTuno,
            MonthTuno = user.MonthTuno,
            MainInstrument = user.MainInstrument,
            EmailConfirmed = user.EmailConfirmed,
            MentorId = user.MentorId,
        };

        // Set SelectedCategory based on user's primary category
        var primaryCategory = user.Categories.FirstOrDefault();
        
        // Check if user has Fundador in their categories (as a subcategory)
        isFundador = user.Categories.Contains(MemberCategory.Fundador);
        
        // Map categories to dropdown - if user has Fundador, they must also have Tuno
        editingUser.SelectedCategory = primaryCategory switch
        {
            MemberCategory.Leitao => "Leitão",
            MemberCategory.Caloiro => "Caloiro",
            MemberCategory.Tuno => "Tuno",
            _ => ""
        };
        
        // Initialize mentor search term if user has a mentor
        if (!string.IsNullOrEmpty(user.MentorId))
        {
            var mentor = eligibleMentors.FirstOrDefault(m => m.Id == user.MentorId);
            if (mentor != null)
            {
                selectedMentorCache = mentor;
                mentorSearchTerm = $"{mentor.FirstName} {mentor.LastName}";
            }
        }
        else
        {
            selectedMentorCache = null;
            mentorSearchTerm = "";
        }
        
        filteredMentors.Clear();
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingUser = new();
        mentorSearchTerm = "";
        filteredMentors.Clear();
        selectedMentorCache = null;
        isSaving = false;
    }

    private ValidationMessageStore? memberValidationStore;

    private async Task HandleSaveClick()
    {
        if (memberEditForm?.EditContext == null) return;

        var editContext = memberEditForm.EditContext;
        
        // Initialize or reuse the validation store
        if (memberValidationStore == null)
        {
            memberValidationStore = new ValidationMessageStore(editContext);
        }
        
        // Clear any previous custom validation errors
        memberValidationStore.Clear();
        
        // First, add custom Categoria validation before DataAnnotations
        if (string.IsNullOrEmpty(editingUser.SelectedCategory))
        {
            memberValidationStore.Add(() => editingUser.SelectedCategory!, "Categoria é obrigatória.");
        }
        
        // Now validate the form to show all errors including DataAnnotations and custom
        var isValid = editContext.Validate();
        
        if (!isValid)
        {
            // Validation failed, errors are already displayed
            return;
        }
        
        // If all validation passes, proceed with SaveMember
        await SaveMember();
    }

    private async Task SaveMember()
    {
        // Prevent double-submission
        if (isSaving || memberEditForm?.EditContext == null)
        {
            return;
        }

        isSaving = true;

        try
        {
            var editContext = memberEditForm.EditContext;
            
            // Note: Basic validation (DataAnnotations + Categoria) is already done in HandleSaveClick
            // This method only does additional database-level validations
            
            // Initialize or reuse the validation store
            if (memberValidationStore == null)
            {
                memberValidationStore = new ValidationMessageStore(editContext);
            }

            if (isCreateMode)
            {
                // These null checks should not be needed since DataAnnotations validation passed,
                // but we keep them for safety
                if (string.IsNullOrEmpty(editingUser.Nickname))
                {
                    memberValidationStore.Add(() => editingUser.Nickname!, "O nome de tuna / username é obrigatório.");
                    editContext.NotifyValidationStateChanged();
                    return;
                }

                if (string.IsNullOrEmpty(editingUser.Email))
                {
                    memberValidationStore.Add(() => editingUser.Email!, "O email é obrigatório.");
                    editContext.NotifyValidationStateChanged();
                    return;
                }

                // Set UserName to normalized version of Nickname (tuna name)
                // Keep Nickname as display name, but use normalized version for username
                editingUser.UserName = UsernameHelper.NormalizeUsername(editingUser.Nickname!);
                editingUser.EmailConfirmed = true;

                // Check if username already exists
                var existingUser = await UserManager.FindByNameAsync(editingUser.UserName);
                if (existingUser != null)
                {
                    // Clear previous validation errors for this field before adding new one
                    memberValidationStore.Clear(() => editingUser.Nickname);
                    memberValidationStore.Add(() => editingUser.Nickname, $"Já existe um utilizador com o nome de tuna '{editingUser.Nickname}' (username: {editingUser.UserName}).");
                    editContext.NotifyValidationStateChanged();
                    return;
                }

                // Check if email already exists
                var existingEmail = await UserManager.FindByEmailAsync(editingUser.Email);
                if (existingEmail != null)
                {
                    // Clear previous validation errors for this field before adding new one
                    memberValidationStore.Clear(() => editingUser.Email);
                    memberValidationStore.Add(() => editingUser.Email, $"Já existe um utilizador com o email '{editingUser.Email}'.");
                    editContext.NotifyValidationStateChanged();
                    return;
                }

                // Generate a secure random password
                var generatedPassword = PasswordGenerator.GeneratePassword();
                
                // Special handling for Fundador: set YearTuno to 1991, clear YearLeitao and YearCaloiro
                if (isFundador)
                {
                    editingUser.YearTuno = 1991;
                    editingUser.MonthTuno = 12; // December 1991
                    editingUser.YearLeitao = null;
                    editingUser.MonthLeitao = null;
                    editingUser.YearCaloiro = null;
                    editingUser.MonthCaloiro = null;
                    editingUser.MentorId = null; // Fundadores don't have mentors
                }
            
                // Create user with generated password
                var result = await UserManager.CreateAsync(editingUser, generatedPassword);
            if (!result.Succeeded)
            {
                foreach (var error in result.Errors)
                {
                    memberValidationStore.Add(() => editingUser.Email, error.Description);
                }
                editContext.NotifyValidationStateChanged();
                return;
            }

            // Always assign MEMBER role only
            await UserManager.AddToRoleAsync(editingUser, "Member");

            // Set category as user property (not a role)
            var createdUser = await UserManager.FindByEmailAsync(editingUser.Email);
            if (createdUser != null)
            {
                // Determine base category
                var category = editingUser.SelectedCategory switch
                {
                    "Leitão" => MemberCategory.Leitao,
                    "Caloiro" => MemberCategory.Caloiro,
                    "Tuno" => MemberCategory.Tuno,
                    _ => MemberCategory.Leitao
                };
                
                // Start with the base category
                var categories = new List<MemberCategory> { category };
                
                // If Fundador checkbox is checked, add Fundador as additional category (like Veterano/Tunossauro)
                if (isFundador && category == MemberCategory.Tuno)
                {
                    categories.Add(MemberCategory.Fundador);
                }
                
                createdUser.Categories = categories;
                createdUser.RequirePasswordChange = true;
                await SetAuditContextToCurrentUser();
                await UserManager.UpdateAsync(createdUser);

                // Send welcome email with credentials
                await EmailNotificationService.SendWelcomeEmailAsync(
                    createdUser.UserName ?? "",
                    createdUser.Email ?? "",
                    $"{createdUser.FirstName} {createdUser.LastName}" ?? "",
                    createdUser.Nickname ?? "",
                    generatedPassword
                );
            }
        }
        else
        {
            // Edit mode - add null checks
            if (string.IsNullOrEmpty(editingUser.Nickname))
            {
                memberValidationStore.Add(() => editingUser.Nickname!, "O nome de tuna / username é obrigatório.");
                editContext.NotifyValidationStateChanged();
                return;
            }

            if (string.IsNullOrEmpty(editingUser.Email))
            {
                memberValidationStore.Add(() => editingUser.Email!, "O email é obrigatório.");
                editContext.NotifyValidationStateChanged();
                return;
            }

            var existingUser = await UserManager.FindByIdAsync(editingUser.Id!);
            if (existingUser != null)
            {
                // Server-side guard: prevent user from being their own padrinho
                if (!string.IsNullOrEmpty(editingUser.MentorId) && editingUser.MentorId == editingUser.Id)
                {
                    memberValidationStore.Add(() => editingUser.MentorId, "Um utilizador não pode ser o seu próprio padrinho.");
                    editContext.NotifyValidationStateChanged();
                    return;
                }
                
                existingUser.FirstName = editingUser.FirstName;
                existingUser.LastName = editingUser.LastName;
                existingUser.Nickname = editingUser.Nickname;
                existingUser.PhoneContact = editingUser.PhoneContact;
                // Username is set only on creation and should not be changed on edit
                existingUser.Email = editingUser.Email;
                existingUser.City = editingUser.City;
                existingUser.DateOfBirth = editingUser.DateOfBirth;
                existingUser.Degree = editingUser.Degree;
                existingUser.YearLeitao = editingUser.YearLeitao;
                existingUser.MonthLeitao = editingUser.MonthLeitao;
                existingUser.YearCaloiro = editingUser.YearCaloiro;
                existingUser.MonthCaloiro = editingUser.MonthCaloiro;
                existingUser.YearTuno = editingUser.YearTuno;
                existingUser.MonthTuno = editingUser.MonthTuno;
                existingUser.MainInstrument = editingUser.MainInstrument;
                existingUser.MentorId = editingUser.MentorId;
                
                // Special handling for Fundador: set YearTuno to 1991, clear YearLeitao and YearCaloiro
                if (isFundador)
                {
                    existingUser.YearTuno = 1991;
                    existingUser.MonthTuno = 12; // December 1991
                    existingUser.YearLeitao = null;
                    existingUser.MonthLeitao = null;
                    existingUser.YearCaloiro = null;
                    existingUser.MonthCaloiro = null;
                    existingUser.MentorId = null; // Fundadores don't have mentors
                }

                // Update category (not role)
                var category = editingUser.SelectedCategory switch
                {
                    "Leitão" => MemberCategory.Leitao,
                    "Caloiro" => MemberCategory.Caloiro,
                    "Tuno" => MemberCategory.Tuno,
                    _ => MemberCategory.Leitao
                };

                // Update categories - always start fresh with base category
                var categories = new List<MemberCategory> { category };
                
                // If Fundador checkbox is checked, add Fundador as additional category (like Veterano/Tunossauro)
                if (isFundador && category == MemberCategory.Tuno)
                {
                    categories.Add(MemberCategory.Fundador);
                }
                
                existingUser.Categories = categories;

                await SetAuditContextToCurrentUser();
                var result = await UserManager.UpdateAsync(existingUser);
                if (!result.Succeeded)
                {
                    foreach (var error in result.Errors)
                    {
                        memberValidationStore.Add(() => editingUser.Email, error.Description);
                    }
                    editContext.NotifyValidationStateChanged();
                    return;
                }
            }
        }

        await LoadMembers();
        CloseEditModal();
        }
        finally
        {
            isSaving = false;
        }
    }

    private void OpenDeleteModal(ApplicationUser user)
    {
        deletingUser = user;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        deletingUser = null;
    }

    private async Task DeleteMember()
    {
        if (deletingUser == null) return;

        var user = await UserManager.FindByIdAsync(deletingUser.Id);
        if (user != null)
        {
            await UserManager.DeleteAsync(user);
            await LoadMembers();
        }

        CloseDeleteModal();
    }

    private async Task OpenViewDetailsModal(ApplicationUser user)
    {
        viewingUser = user;
        
        // Load mentor if exists
        if (!string.IsNullOrEmpty(user.MentorId))
        {
            viewingUserMentor = await UserManager.FindByIdAsync(user.MentorId);
        }
        else
        {
            viewingUserMentor = null;
        }
        
        showViewDetailsModal = true;
    }

    private void CloseViewDetailsModal()
    {
        showViewDetailsModal = false;
        viewingUser = null;
        viewingUserMentor = null;
    }

    private Position? GetCurrentFiscalYearPosition(string userId)
    {
        int currentFiscalStartYear = FiscalYearHelper.GetCurrentFiscalYearStartYear();

        // Check if user has a role assignment for current fiscal year
        if (userRoleAssignments.ContainsKey(userId))
        {
            var currentAssignment = userRoleAssignments[userId]
                .FirstOrDefault(ra => ra.StartYear == currentFiscalStartYear);

            return currentAssignment?.Position;
        }

        return null;
    }

    // Dynamic field visibility based on selected category
    private bool showYearLeitao => !string.IsNullOrEmpty(editingUser?.SelectedCategory);
    private bool showYearCaloiro => editingUser?.SelectedCategory == "Caloiro" || editingUser?.SelectedCategory == "Tuno";
    private bool showYearTuno => editingUser?.SelectedCategory == "Tuno";

    private void OnCategoryChanged()
    {
        // Clear Fundador flag when changing category away from Tuno
        if (editingUser?.SelectedCategory != "Tuno")
        {
            isFundador = false;
        }
        
        // Clear category validation error when a category is selected
        if (memberEditForm?.EditContext != null && memberValidationStore != null && !string.IsNullOrEmpty(editingUser?.SelectedCategory))
        {
            memberValidationStore.Clear(() => editingUser.SelectedCategory);
            memberEditForm.EditContext.NotifyValidationStateChanged();
        }
        StateHasChanged();
    }
    
    private void OnFundadorChanged()
    {
        // When Fundador is toggled, update YearTuno automatically
        if (isFundador)
        {
            editingUser.YearTuno = 1991;
            editingUser.MonthTuno = 12; // December 1991
            editingUser.YearLeitao = null;
            editingUser.MonthLeitao = null;
            editingUser.YearCaloiro = null;
            editingUser.MonthCaloiro = null;
            editingUser.MentorId = null;
        }
        else
        {
            // When deselecting Fundador, clear the YearTuno field
            editingUser.YearTuno = null;
            editingUser.MonthTuno = null;
        }
        StateHasChanged();
    }

    private async Task SetAuditContextToCurrentUser()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.Name;
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        AuditContext.SetUser(userName, userId);
    }
    
    // Helper methods for converting between DateTime and Year+Month
    private DateTime? GetDateFromYearMonth(int? year, int? month)
    {
        if (!year.HasValue || !month.HasValue) return null;
        return new DateTime(year.Value, month.Value, 1);
    }
    
    private (int? year, int? month) GetYearMonthFromDate(DateTime? date)
    {
        if (date.HasValue)
        {
            return (date.Value.Year, date.Value.Month);
        }
        else
        {
            return (null, null);
        }
    }
}

