@page "/members"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Application.Interfaces
@using RTUB.Shared
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject IRoleAssignmentService RoleAssignmentService
@inject IEnrollmentService EnrollmentService
@inject IEmailNotificationService EmailNotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject RTUB.Application.Services.AuditContext AuditContext
@attribute [Authorize]

<h1>Membros</h1>
<p>Lista de todos os membros da RTUB.</p>

<AuthorizeView Roles="Admin">
    <Authorized>
        <div class="mb-3">
            <button class="btn btn-success" @onclick="OpenCreateModal" title="Adicionar Novo Membro">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    </Authorized>
</AuthorizeView>

<!-- Search and Controls -->
<div class="d-flex gap-2 mb-3">
    <div style="flex: 2;">
        <TableSearchBar SearchTerm="@searchTerm"
                       Placeholder="Pesquisar membros..."
                       OnSearchChanged="@HandleSearchChanged" />
    </div>
    <div style="flex: 1;">
        <select class="form-select" @bind="selectedCategoryFilter" @bind:after="ApplyFilters">
            <option value="">Categoria</option>
            <option value="Caloiro">Caloiro</option>
            <option value="Tuno">Tuno</option>
        </select>
    </div>
    <div style="flex: 1;">
        <select class="form-select" @bind="selectedInstrumentFilter" @bind:after="ApplyFilters">
            <option value="">Instrumento</option>
            @foreach (var instrument in Enum.GetValues<InstrumentType>())
            {
                <option value="@instrument">@StatusHelper.GetInstrumentDisplay(instrument)</option>
            }
        </select>
    </div>
</div>

@if (users == null)
{
    <!-- Loading skeleton cards -->
    <div class="avatar-card-grid">
        @for (int i = 0; i < 8; i++)
        {
            <div class="avatar-card-skeleton-card">
                <div class="avatar-card-image-wrapper">
                    <div class="avatar-card-skeleton"></div>
                </div>
            </div>
        }
    </div>
}
else if (!filteredUsers.Any())
{
    <EmptyTableState Message="Nenhum membro criado ainda"
                    IconClass="bi-people"
                    SubMessage="Adicione membros para começar." />
}
else
{
    <!-- Regular Members Grid -->
    @if (filteredRegularMembers.Any())
    {
        <h3 class="mb-3">Membros</h3>
        <div class="avatar-card-grid">
            @foreach (var user in paginatedRegularMembers)
            {
                <AvatarCard AvatarUrl="@user.ProfilePictureSrc"
                           TunaName="@user.Nickname"
                           FullName="@($"{user.FirstName} {user.LastName}")"
                           InstrumentText="@(user.MainInstrument.HasValue ? StatusHelper.GetInstrumentDisplay(user.MainInstrument.Value) : "")"
                           AltText="@user.GetDisplayName()"
                           OnView="@(async () => await OpenViewDetailsModal(user))"
                           OnEdit="@(() => OpenEditModal(user))"
                           OnDelete="@(() => OpenDeleteModal(user))"
                           ShowEditButton="@isAdmin"
                           ShowDeleteButton="@isOwner"
                           ViewTooltip="Ver Detalhes"
                           EditTooltip="Editar"
                           DeleteTooltip="Eliminar"
                           LazyLoad="true">
                    <BadgeContent>
                        @{
                            // Get current fiscal year position for this user
                            var currentPosition = GetCurrentFiscalYearPosition(user.Id);
                        }
                        <!-- Category badges row -->
                        <div class="avatar-card-badges-row">
                            @foreach (var category in user.Categories.Where(c =>
                                c == MemberCategory.Caloiro || c == MemberCategory.Tuno))
                            {
                                <CategoryBadge Category="category" />
                            }
                        </div>
                        <!-- Role/Position badges row -->
                        @if (currentPosition != null)
                        {
                            <div class="avatar-card-badges-row">
                                <PositionBadge Position="currentPosition.Value" />
                            </div>
                        }
                        @if (!user.Positions.Any() && !user.Categories.Any())
                        {
                            <div class="avatar-card-badges-row">
                                <span class="badge bg-secondary avatar-card-role-badge" 
                                      title="Sem Cargos"
                                      aria-label="Sem Cargos">Sem Cargos</span>
                            </div>
                        }
                    </BadgeContent>
                </AvatarCard>
            }
        </div>

        <TablePagination CurrentPage="@paginationHelper.CurrentPage"
                        PageSize="@paginationHelper.PageSize"
                        TotalItems="@filteredRegularMembers.Count"
                        ItemLabel="membros"
                        PageSizeOptions="@(new[] { 12, 24, 36, 48, 60 })"
                        OnPageChanged="@HandleRegularMembersPageChange"
                        OnPageSizeChanged="@HandleRegularMembersPageSizeChange" />
    }

    <!-- Leitões Grid -->
    @if (filteredLeitoes.Any())
    {
        <hr class="my-5 hr-divider" />
        <h3 class="mb-3">Leitões</h3>
        <div class="avatar-card-grid">
            @foreach (var user in paginatedLeitoes)
            {
                <AvatarCard AvatarUrl="@user.ProfilePictureSrc"
                           TunaName="@user.Nickname"
                           FullName="@($"{user.FirstName} {user.LastName}")"
                           InstrumentText="@(user.MainInstrument.HasValue ? StatusHelper.GetInstrumentDisplay(user.MainInstrument.Value) : "")"
                           AltText="@user.GetDisplayName()"
                           OnView="@(async () => await OpenViewDetailsModal(user))"
                           OnEdit="@(() => OpenEditModal(user))"
                           OnDelete="@(() => OpenDeleteModal(user))"
                           ShowEditButton="@isAdmin"
                           ShowDeleteButton="@isAdmin"
                           ViewTooltip="Ver Detalhes"
                           EditTooltip="Editar"
                           DeleteTooltip="Eliminar"
                           LazyLoad="true">
                    <BadgeContent>
                        <div class="avatar-card-badges-row">
                            <CategoryBadge Category="@MemberCategory.Leitao" />
                        </div>
                    </BadgeContent>
                </AvatarCard>
            }
        </div>

        <TablePagination CurrentPage="@paginationHelperLeitoes.CurrentPage"
                        PageSize="@paginationHelperLeitoes.PageSize"
                        TotalItems="@filteredLeitoes.Count"
                        ItemLabel="leitões"
                        PageSizeOptions="@(new[] { 12, 24, 36, 48, 60 })"
                        OnPageChanged="@HandleLeitoesPageChange"
                        OnPageSizeChanged="@HandleLeitoesPageSizeChange" />
    }
}

<!-- Create/Edit Modal -->
<Modal Show="@showEditModal" 
       ShowChanged="@((bool show) => showEditModal = show)"
       Title="@(isCreateMode ? "Adicionar Novo Membro" : "Editar Membro")" 
       Size="Modal.ModalSize.Large"
       Centered="true">
    <BodyContent>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Primeiro Nome <span class="text-danger">*</span></label>
                <input type="text" class="form-control" @bind="editingUser.FirstName" required />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Último Nome <span class="text-danger">*</span></label>
                <input type="text" class="form-control" @bind="editingUser.LastName" required />
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Nome de Tuna / Username <span class="text-danger">*</span></label>
                <input type="text" class="form-control" @bind="editingUser.Nickname" required />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Contacto <span class="text-danger">*</span></label>
                <input type="text" class="form-control" @bind="editingUser.PhoneContact" required />
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Email <span class="text-danger">*</span></label>
                <input type="email" class="form-control" @bind="editingUser.Email" required />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Data de Nascimento</label>
                <input type="date" class="form-control" @bind="editingUser.DateOfBirth" />
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Curso</label>
                <input type="text" class="form-control" @bind="editingUser.Degree" placeholder="Inserir curso..." />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Cidade</label>
                <input type="text" class="form-control" @bind="editingUser.City" placeholder="Inserir cidade..." />
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Categoria <span class="text-danger">*</span></label>
            <select class="form-select" @bind="selectedRole" @bind:after="OnCategoryChanged" required>
                <option value="">Selecionar Categoria</option>
                <option value="Leitão">Leitão</option>
                <option value="Caloiro">Caloiro</option>
                <option value="Tuno">Tuno</option>
            </select>
        </div>
        <div class="row">
            @if (showYearLeitao)
            {
                <div class="col-md-4 mb-3">
                    <label class="form-label">Ano de entrada Leitão</label>
                    <input type="number" class="form-control" @bind="editingUser.YearLeitao" placeholder="Inserir ano..." min="1991" max="@DateTime.Now.Year" />
                </div>
            }

            @if (showYearCaloiro)
            {
                <div class="col-md-4 mb-3">
                    <label class="form-label">Ano de passagem a Caloiro</label>
                    <input type="number" class="form-control" @bind="editingUser.YearCaloiro" placeholder="Inserir ano..." min="1991" max="@DateTime.Now.Year" />
                </div>
            }

            @if (showYearTuno)
            {
                <div class="col-md-4 mb-3">
                    <label class="form-label">Ano de passagem a Tuno</label>
                    <input type="number" class="form-control" @bind="editingUser.YearTuno" placeholder="Inserir ano..." min="1991" max="@DateTime.Now.Year" />
                </div>
            }
        </div>
        <div class="mb-3">
            <label class="form-label">Instrumento Principal</label>
            <select class="form-select" @bind="editingUser.MainInstrument">
                <option value="">Sem instrumento</option>
                @foreach (var instrument in Enum.GetValues<InstrumentType>())
                {
                    <option value="@instrument">@StatusHelper.GetInstrumentDisplay(instrument)</option>
                }
            </select>
        </div>
        @* Only show Padrinho field for Caloiro or Tuno (not for Leitão) *@
        @if (selectedRole == "Caloiro" || selectedRole == "Tuno")
        {
            <div class="mb-3">
                <label class="form-label">Padrinho @(selectedRole == "Caloiro" ? "(Obrigatório quando passa a Caloiro)" : "")</label>
                <div class="mentor-search-container">
                    <div class="input-group mb-2">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               placeholder="Pesquisar padrinho por nome ou alcunha..."
                               @bind="mentorSearchTerm" 
                               @bind:event="oninput" 
                               @onkeyup="FilterMentors" />
                        @if (!string.IsNullOrEmpty(mentorSearchTerm))
                        {
                            <button class="btn btn-outline-secondary" type="button" @onclick="ClearMentorSelection" title="Limpar seleção">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        }
                    </div>
                </div>
                
                @if (filteredMentors.Any())
                {
                    <div class="member-list member-list-scrollable">
                        @foreach (var mentor in filteredMentors.Take(20))
                        {
                            <div class="member-item p-2 mb-2 border rounded clickable-row"
                                 @onclick="() => SelectMentor(mentor)">
                                <div class="d-flex align-items-center">
                                    <img src="@mentor.ProfilePictureSrc" alt="@mentor.GetDisplayName()"
                                         class="member-avatar-small me-2" />
                                    <div>
                                        @if (!string.IsNullOrEmpty(mentor.Nickname))
                                        {
                                            <div><strong>@mentor.Nickname</strong></div>
                                            <div class="text-muted small">@mentor.FirstName @mentor.LastName</div>
                                        }
                                        else
                                        {
                                            <div><strong>@mentor.FirstName @mentor.LastName</strong></div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (!string.IsNullOrEmpty(mentorSearchTerm) && string.IsNullOrEmpty(editingUser.MentorId))
                {
                    <div class="alert alert-purple mt-2">Nenhum padrinho encontrado.</div>
                }

                @if (!string.IsNullOrEmpty(editingUser.MentorId))
                {
                    // Use cached mentor to avoid repeated lookups on every render
                    var displayMentor = selectedMentorCache ?? eligibleMentors.FirstOrDefault(m => m.Id == editingUser.MentorId);
                    if (displayMentor != null)
                    {
                        <div class="alert alert-purple mt-2">
                            <strong>Padrinho Selecionado:</strong> @displayMentor.GetDisplayName()
                        </div>
                    }
                }
            </div>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseEditModal" disabled="@isSaving">Cancelar</button>
        <button type="button" class="btn btn-primary btn-primary-purple" @onclick="SaveMember" disabled="@isSaving">
            @if (isSaving)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            }
            Guardar
        </button>
    </FooterContent>
</Modal>

<!-- Delete Confirmation Modal -->
<Modal Show="@showDeleteModal" 
       ShowChanged="@((bool show) => showDeleteModal = show)"
       Title="Confirmar Eliminação" 
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        <p>Tem certeza que deseja eliminar <strong>@deletingUser?.GetDisplayName()</strong>?</p>
        <p class="text-muted">Esta ação não pode ser desfeita.</p>
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal">Cancelar</button>
        <button type="button" class="btn btn-danger" @onclick="DeleteMember">Eliminar</button>
    </FooterContent>
</Modal>

<!-- View Details Modal -->
@if (viewingUser != null)
{
    <Modal Show="@showViewDetailsModal" 
           ShowChanged="@((bool show) => showViewDetailsModal = show)"
           Title="Detalhes do Membro" 
           Size="Modal.ModalSize.Large"
           Centered="true">
        <BodyContent>
            <!-- Centered Header Section -->
            <div class="text-center mb-4">
                <img src="@viewingUser.ProfilePictureSrc" alt="@viewingUser.GetDisplayName()"
                     class="member-avatar-large mb-3" style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--bs-primary);" />
                
                @if (!string.IsNullOrEmpty(viewingUser.Nickname))
                {
                    <h4 class="mb-1">@viewingUser.Nickname</h4>
                    <p class="text-muted mb-2">@viewingUser.FirstName @viewingUser.LastName</p>
                }
                else
                {
                    <h4 class="mb-2">@viewingUser.FirstName @viewingUser.LastName</h4>
                }
                
                <!-- Badges centered below name -->
                <div class="d-flex justify-content-center flex-wrap gap-1 mb-2">
                    @{
                        var displayCategories = StatusHelper.GetDisplayCategories(viewingUser);
                    }
                    @foreach (var category in displayCategories)
                    {
                        <CategoryBadge Category="category" />
                    }
                    @if (viewingUser.Positions.Any())
                    {
                        @foreach (var position in viewingUser.Positions)
                        {
                            <PositionBadge Position="position" />
                        }
                    }
                </div>
            </div>

            <div class="mb-3"></div>

            <!-- Personal Information Section -->
            <div class="modal-info-section mb-4">
                <div class="modal-section-header">
                    <h6 class="modal-section-title">
                        <i class="bi bi-person-fill me-2 text-primary"></i>
                        Informações Pessoais
                    </h6>
                </div>
                <div class="modal-section-body">
                    <ProfileField Label="Email" Value="@viewingUser.Email" />
                    <ProfileField Label="Contacto" Value="@viewingUser.PhoneContact" />
                    <ProfileField Label="Cidade" Value="@viewingUser.City" />
                    <ProfileField Label="Data de Nascimento" 
                                Value="@(viewingUser.DateOfBirth.HasValue ? viewingUser.DateOfBirth.Value.ToString("dd/MM/yyyy") + (viewingUser.Age.HasValue ? $" ({viewingUser.Age} anos)" : "") : null)" />
                    <ProfileField Label="Curso" Value="@viewingUser.Degree" />
                </div>
            </div>

            <!-- Tuna Information Section -->
            <div class="modal-info-section mb-3">
                <div class="modal-section-header">
                    <h6 class="modal-section-title">
                        <i class="bi bi-music-note-list me-2 text-primary"></i>
                        Informação da Tuna
                    </h6>
                </div>
                <div class="modal-section-body">
                    <ProfileField Label="Instrumento Principal" 
                                Value="@(viewingUser.MainInstrument.HasValue ? StatusHelper.GetInstrumentDisplay(viewingUser.MainInstrument.Value) : null)" />
                    <ProfileField Label="Padrinho" 
                                Value="@(viewingUserMentor != null ? viewingUserMentor.GetDisplayName() : null)" />
                    
                    <!-- Unified Timeline -->
                    <div class="profile-field">
                        <div class="row">
                            <div class="col-12 col-md-4 profile-field-label">
                                <strong class="text-white-full">Percurso na Tuna:</strong>
                            </div>
                            <div class="col-12 col-md-8 profile-field-value">
                                @if (userRoleAssignments.ContainsKey(viewingUser.Id))
                                {
                                    <UnifiedTimeline User="@viewingUser" RoleAssignments="@userRoleAssignments[viewingUser.Id]" />
                                }
                                else
                                {
                                    <UnifiedTimeline User="@viewingUser" RoleAssignments="@(new List<RoleAssignment>())" />
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </BodyContent>
        <FooterContent>
            <button type="button" class="btn btn-secondary" @onclick="CloseViewDetailsModal">Fechar</button>
        </FooterContent>
    </Modal>
}

@code {
    private List<ApplicationUser>? users;
    private List<ApplicationUser> filteredUsers = new();
    private List<ApplicationUser> filteredRegularMembers = new();
    private List<ApplicationUser> filteredLeitoes = new();
    private List<ApplicationUser> paginatedUsers = new();
    private List<ApplicationUser> paginatedRegularMembers = new();
    private List<ApplicationUser> paginatedLeitoes = new();
    private Dictionary<string, List<string>> userRoles = new Dictionary<string, List<string>>();
    private Dictionary<string, List<RoleAssignment>> userRoleAssignments = new Dictionary<string, List<RoleAssignment>>();
    private List<ApplicationUser> eligibleMentors = new();
    private ApplicationUser? viewingUserMentor;

    // Helper instances
    private SearchHelper<ApplicationUser> searchHelper = new();
    private SortableTableHelper<ApplicationUser> sortHelper = new() { SortColumn = nameof(ApplicationUser.FirstName) };
    private PaginationHelper<ApplicationUser> paginationHelper = new() { PageSize = 48 };
    private PaginationHelper<ApplicationUser> paginationHelperLeitoes = new() { PageSize = 48 };

    private string searchTerm = "";
    private int totalUsers = 0;
    
    // Filter variables
    private string selectedCategoryFilter = "";
    private string selectedInstrumentFilter = "";

    private bool showEditModal = false;
    private bool showDeleteModal = false;
    private bool showViewDetailsModal = false;
    private bool isCreateMode = false;
    private bool isSaving = false;
    private ApplicationUser editingUser = new();
    private ApplicationUser? deletingUser;
    private ApplicationUser? viewingUser;
    private string selectedRole = "";
    private string errorMessage = "";
    
    // Mentor search variables
    private string mentorSearchTerm = "";
    private List<ApplicationUser> filteredMentors = new();
    private SearchHelper<ApplicationUser> mentorSearchHelper = new();
    private ApplicationUser? selectedMentorCache = null;

    // Authorization flags
    private bool isAdmin = false;
    private bool isOwner = false;

    protected override async Task OnInitializedAsync()
    {
        await CheckUserRoles();
        await LoadMembers();
    }

    private async Task CheckUserRoles()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAdmin = user.IsInRole("Admin");
        isOwner = user.IsInRole("Owner");
    }

    private async Task LoadMembers()
    {
        users = UserManager.Users.ToList();
        totalUsers = users.Count;

        foreach (var user in users)
        {
            var roles = await UserManager.GetRolesAsync(user);
            userRoles[user.Id] = roles.ToList();
        }

        // Load role assignments
        var allAssignments = (await RoleAssignmentService.GetAllRoleAssignmentsAsync())
            .Where(ra => users.Select(u => u.Id).Contains(ra.UserId))
            .ToList();

        userRoleAssignments.Clear();
        foreach (var user in users)
        {
            userRoleAssignments[user.Id] = allAssignments
                .Where(ra => ra.UserId == user.Id)
                .OrderByDescending(ra => ra.StartYear)
                .ToList();
        }

        // Load eligible mentors (Only Tuno, Veterano, Tunossauro - excluding Leitões and Caloiros)
        // Also exclude the user being edited if in edit mode
        eligibleMentors = users
            .Where(u => u.CanBeMentor())
            .OrderBy(u => u.FirstName)
            .ThenBy(u => u.LastName)
            .ToList();

        FilterMembers();
    }

    private void FilterMembers()
    {
        if (users == null) return;

        // Use SearchHelper for filtering
        searchHelper.SearchTerm = searchTerm;
        var allFilteredUsers = searchHelper.FilterMultiple(users, new List<Func<ApplicationUser, string>>
        {
            u => u.FirstName ?? "",
            u => u.LastName ?? "",
            u => u.Nickname ?? "",
            u => u.Email ?? "",
            u => u.PhoneContact ?? ""
        });

        // Separate Leitões from regular members
        filteredLeitoes = allFilteredUsers.Where(u => u.IsLeitao()).ToList();
        filteredRegularMembers = allFilteredUsers.Where(u => !u.IsLeitao()).ToList();
        
        // Apply category filter (only for regular members, not Leitões)
        if (!string.IsNullOrEmpty(selectedCategoryFilter))
        {
            var categoryEnum = Enum.Parse<MemberCategory>(selectedCategoryFilter);
            filteredRegularMembers = filteredRegularMembers
                .Where(u => u.Categories.Contains(categoryEnum))
                .ToList();
        }
        
        // Apply instrument filter (only for regular members, not Leitões)
        if (!string.IsNullOrEmpty(selectedInstrumentFilter))
        {
            var instrumentEnum = Enum.Parse<InstrumentType>(selectedInstrumentFilter);
            filteredRegularMembers = filteredRegularMembers
                .Where(u => u.MainInstrument.HasValue && u.MainInstrument.Value == instrumentEnum)
                .ToList();
        }
        
        filteredUsers = filteredRegularMembers.Concat(filteredLeitoes).ToList(); // Keep for backwards compatibility

        ApplySort();
        UpdatePagination();
    }
    
    private void ApplyFilters()
    {
        FilterMembers();
    }

    private async Task HandleSearchChanged(string search)
    {
        searchTerm = search;
        FilterMembers();
        await Task.CompletedTask;
    }

    private async Task HandleSortChanged(string column)
    {
        SortBy(column);
        await Task.CompletedTask;
    }

    private async Task HandleRegularMembersPageChange(int newPage)
    {
        ChangePage(newPage);
        await Task.CompletedTask;
    }

    private async Task HandleRegularMembersPageSizeChange(int newPageSize)
    {
        paginationHelper.PageSize = newPageSize;
        paginationHelper.Reset();
        UpdatePagination();
        await Task.CompletedTask;
    }

    private async Task HandleLeitoesPageChange(int newPage)
    {
        ChangePageLeitoes(newPage);
        await Task.CompletedTask;
    }

    private async Task HandleLeitoesPageSizeChange(int newPageSize)
    {
        paginationHelperLeitoes.PageSize = newPageSize;
        paginationHelperLeitoes.Reset();
        UpdatePagination();
        await Task.CompletedTask;
    }

    private void SortBy(string column)
    {
        sortHelper.ChangeSortColumn(column);
        ApplySort();
        UpdatePagination();
    }

    private void ApplySort()
    {
        var columnSelectors = new Dictionary<string, Func<ApplicationUser, IComparable>>
        {
            [nameof(ApplicationUser.FirstName)] = u => u.FirstName ?? "",
            [nameof(ApplicationUser.Nickname)] = u => u.Nickname ?? "",
            [nameof(ApplicationUser.Email)] = u => u.Email ?? "",
            ["Category"] = u => u.Categories.FirstOrDefault().ToString(),
            ["Instrument"] = u => u.MainInstrument?.ToString() ?? "ZZZ"
        };

        // Sort regular members and Leitões using SortableTableHelper
        filteredRegularMembers = sortHelper.ApplySort(filteredRegularMembers, columnSelectors);
        filteredLeitoes = sortHelper.ApplySort(filteredLeitoes, columnSelectors);

        // Keep for backwards compatibility
        filteredUsers = filteredRegularMembers.Concat(filteredLeitoes).ToList();
    }

    private void UpdatePagination()
    {
        // Use PaginationHelper for regular members
        paginatedRegularMembers = paginationHelper.GetPageData(filteredRegularMembers);

        // Use PaginationHelper for Leitões
        paginatedLeitoes = paginationHelperLeitoes.GetPageData(filteredLeitoes);

        // Keep for backwards compatibility
        paginatedUsers = paginatedRegularMembers.Concat(paginatedLeitoes).ToList();
    }

    private void ChangePage(int page)
    {
        if (paginationHelper.GoToPage(page))
        {
            UpdatePagination();
        }
    }

    private void ChangePageLeitoes(int page)
    {
        if (paginationHelperLeitoes.GoToPage(page))
        {
            UpdatePagination();
        }
    }

    private void FilterMentors()
    {
        if (string.IsNullOrEmpty(mentorSearchTerm))
        {
            filteredMentors.Clear();
            return;
        }

        // Use SearchHelper for multi-word search support
        // Only search by FirstName, LastName, and Nickname (NOT Email)
        // Use accent-insensitive search
        mentorSearchHelper.SearchTerm = mentorSearchTerm;
        
        // Exclude the user being edited from mentor candidates
        var availableMentors = eligibleMentors;
        if (!isCreateMode && !string.IsNullOrEmpty(editingUser?.Id))
        {
            availableMentors = eligibleMentors.Where(u => u.Id != editingUser.Id).ToList();
        }
        
        filteredMentors = mentorSearchHelper.FilterMultiple(availableMentors, new List<Func<ApplicationUser, string>>
        {
            u => u.FirstName ?? "",
            u => u.LastName ?? "",
            u => $"{u.FirstName} {u.LastName}",
            u => u.Nickname ?? ""
        }, caseSensitive: false, accentSensitive: false);
    }

    private void SelectMentor(ApplicationUser mentor)
    {
        // Prevent accidental clear: if clicking the already selected mentor, don't clear it
        if (editingUser.MentorId == mentor.Id)
        {
            // Keep the selection and just close the dropdown
            filteredMentors.Clear();
            return;
        }
        
        editingUser.MentorId = mentor.Id;
        selectedMentorCache = mentor;
        mentorSearchTerm = $"{mentor.FirstName} {mentor.LastName}";
        filteredMentors.Clear();
    }

    private void ClearMentorSelection()
    {
        if (editingUser != null)
        {
            editingUser.MentorId = null;
        }
        selectedMentorCache = null;
        mentorSearchTerm = "";
        filteredMentors.Clear();
    }

    private void OpenCreateModal()
    {
        isCreateMode = true;
        editingUser = new ApplicationUser();
        selectedRole = "";
        errorMessage = "";
        mentorSearchTerm = "";
        filteredMentors.Clear();
        selectedMentorCache = null;
        showEditModal = true;
    }

    private void OpenEditModal(ApplicationUser user)
    {
        isCreateMode = false;
        editingUser = new ApplicationUser
        {
            Id = user.Id,
            UserName = user.UserName,
            Email = user.Email,
            FirstName = user.FirstName,
            LastName = user.LastName,
            Nickname = user.Nickname,
            PhoneContact = user.PhoneContact,
            City = user.City,
            DateOfBirth = user.DateOfBirth,
            Degree = user.Degree,
            YearLeitao = user.YearLeitao,
            YearCaloiro = user.YearCaloiro,
            YearTuno = user.YearTuno,
            MainInstrument = user.MainInstrument,
            EmailConfirmed = user.EmailConfirmed,
            MentorId = user.MentorId
        };

        // Set selectedRole based on user's primary category
        var primaryCategory = user.Categories.FirstOrDefault();
        selectedRole = primaryCategory switch
        {
            MemberCategory.Leitao => "Leitão",
            MemberCategory.Caloiro => "Caloiro",
            MemberCategory.Tuno => "Tuno",
            _ => ""
        };
        
        // Initialize mentor search term if user has a mentor
        if (!string.IsNullOrEmpty(user.MentorId))
        {
            var mentor = eligibleMentors.FirstOrDefault(m => m.Id == user.MentorId);
            if (mentor != null)
            {
                selectedMentorCache = mentor;
                mentorSearchTerm = $"{mentor.FirstName} {mentor.LastName}";
            }
        }
        else
        {
            selectedMentorCache = null;
            mentorSearchTerm = "";
        }
        
        filteredMentors.Clear();
        errorMessage = "";
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingUser = new();
        errorMessage = "";
        mentorSearchTerm = "";
        filteredMentors.Clear();
        selectedMentorCache = null;
        isSaving = false;
    }

    private async Task SaveMember()
    {
        // Prevent double-submission
        if (isSaving)
        {
            return;
        }

        isSaving = true;
        errorMessage = "";

        try
        {
            if (string.IsNullOrWhiteSpace(editingUser.FirstName))
            {
                errorMessage = "Primeiro nome é obrigatório.";
                return;
            }

            if (string.IsNullOrWhiteSpace(editingUser.LastName))
            {
                errorMessage = "Último nome é obrigatório.";
                return;
            }

            if (string.IsNullOrWhiteSpace(editingUser.PhoneContact))
            {
                errorMessage = "Contacto é obrigatório.";
                return;
            }

            if (string.IsNullOrWhiteSpace(editingUser.Nickname))
            {
                errorMessage = "Nome de Tuna / Username é obrigatório.";
                return;
            }

            if (string.IsNullOrWhiteSpace(editingUser.Email))
            {
                errorMessage = "Email é obrigatório.";
                return;
            }

            if (string.IsNullOrEmpty(selectedRole))
            {
                errorMessage = "Categoria é obrigatória.";
                return;
            }

            if (isCreateMode)
            {
                // Set UserName to normalized version of Nickname (tuna name)
                // Keep Nickname as display name, but use normalized version for username
                editingUser.UserName = UsernameHelper.NormalizeUsername(editingUser.Nickname);
                editingUser.EmailConfirmed = true;

                // Check if username already exists
                var existingUser = await UserManager.FindByNameAsync(editingUser.UserName);
                if (existingUser != null)
                {
                    errorMessage = $"Já existe um utilizador com o nome de tuna '{editingUser.Nickname}' (username: {editingUser.UserName}).";
                    return;
                }

                // Check if email already exists
                var existingEmail = await UserManager.FindByEmailAsync(editingUser.Email);
                if (existingEmail != null)
                {
                    errorMessage = $"Já existe um utilizador com o email '{editingUser.Email}'.";
                    return;
                }

                // Generate a secure random password
                var generatedPassword = PasswordGenerator.GeneratePassword();
            
                // Create user with generated password
                var result = await UserManager.CreateAsync(editingUser, generatedPassword);
            if (!result.Succeeded)
            {
                errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
                return;
            }

            // Always assign MEMBER role only
            await UserManager.AddToRoleAsync(editingUser, "Member");

            // Set category as user property (not a role)
            var createdUser = await UserManager.FindByEmailAsync(editingUser.Email);
            if (createdUser != null)
            {
                var category = selectedRole switch
                {
                    "Leitão" => MemberCategory.Leitao,
                    "Caloiro" => MemberCategory.Caloiro,
                    "Tuno" => MemberCategory.Tuno,
                    _ => MemberCategory.Leitao
                };
                createdUser.Categories = new List<MemberCategory> { category };
                createdUser.RequirePasswordChange = true;
                await SetAuditContextToCurrentUser();
                await UserManager.UpdateAsync(createdUser);

                // Send welcome email with credentials
                await EmailNotificationService.SendWelcomeEmailAsync(
                    createdUser.UserName ?? "",
                    createdUser.Email ?? "",
                    $"{createdUser.FirstName} {createdUser.LastName}" ?? "",
                    createdUser.Nickname ?? "",
                    generatedPassword
                );
            }
        }
        else
        {
            var existingUser = await UserManager.FindByIdAsync(editingUser.Id);
            if (existingUser != null)
            {
                // Server-side guard: prevent user from being their own padrinho
                if (!string.IsNullOrEmpty(editingUser.MentorId) && editingUser.MentorId == editingUser.Id)
                {
                    errorMessage = "Um utilizador não pode ser o seu próprio padrinho.";
                    return;
                }
                
                existingUser.FirstName = editingUser.FirstName;
                existingUser.LastName = editingUser.LastName;
                existingUser.Nickname = editingUser.Nickname;
                existingUser.PhoneContact = editingUser.PhoneContact;
                // Set UserName to normalized version of Nickname (tuna name)
                existingUser.UserName = UsernameHelper.NormalizeUsername(editingUser.Nickname);
                existingUser.Email = editingUser.Email;
                existingUser.City = editingUser.City;
                existingUser.DateOfBirth = editingUser.DateOfBirth;
                existingUser.Degree = editingUser.Degree;
                existingUser.YearLeitao = editingUser.YearLeitao;
                existingUser.YearCaloiro = editingUser.YearCaloiro;
                existingUser.YearTuno = editingUser.YearTuno;
                existingUser.MainInstrument = editingUser.MainInstrument;
                existingUser.MentorId = editingUser.MentorId;

                // Update category (not role)
                var category = selectedRole switch
                {
                    "Leitão" => MemberCategory.Leitao,
                    "Caloiro" => MemberCategory.Caloiro,
                    "Tuno" => MemberCategory.Tuno,
                    _ => MemberCategory.Leitao
                };

                // Keep existing categories if they have multiple, or replace with new one
                if (existingUser.Categories.Count <= 1)
                {
                    existingUser.Categories = new List<MemberCategory> { category };
                }
                else
                {
                    // Remove old primary category and add new one
                    existingUser.Categories.RemoveAll(c => c == MemberCategory.Leitao || c == MemberCategory.Caloiro || c == MemberCategory.Tuno);
                    existingUser.Categories.Add(category);
                }

                await SetAuditContextToCurrentUser();
                var result = await UserManager.UpdateAsync(existingUser);
                if (!result.Succeeded)
                {
                    errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
                    return;
                }
            }
        }

        await LoadMembers();
        CloseEditModal();
        }
        finally
        {
            isSaving = false;
        }
    }

    private void OpenDeleteModal(ApplicationUser user)
    {
        deletingUser = user;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        deletingUser = null;
    }

    private async Task DeleteMember()
    {
        if (deletingUser == null) return;

        var user = await UserManager.FindByIdAsync(deletingUser.Id);
        if (user != null)
        {
            await UserManager.DeleteAsync(user);
            await LoadMembers();
        }

        CloseDeleteModal();
    }

    private async Task OpenViewDetailsModal(ApplicationUser user)
    {
        viewingUser = user;
        
        // Load mentor if exists
        if (!string.IsNullOrEmpty(user.MentorId))
        {
            viewingUserMentor = await UserManager.FindByIdAsync(user.MentorId);
        }
        else
        {
            viewingUserMentor = null;
        }
        
        showViewDetailsModal = true;
    }

    private void CloseViewDetailsModal()
    {
        showViewDetailsModal = false;
        viewingUser = null;
        viewingUserMentor = null;
    }

    private Position? GetCurrentFiscalYearPosition(string userId)
    {
        int currentFiscalStartYear = FiscalYearHelper.GetCurrentFiscalYearStartYear();

        // Check if user has a role assignment for current fiscal year
        if (userRoleAssignments.ContainsKey(userId))
        {
            var currentAssignment = userRoleAssignments[userId]
                .FirstOrDefault(ra => ra.StartYear == currentFiscalStartYear);

            return currentAssignment?.Position;
        }

        return null;
    }

    // Dynamic field visibility based on selected category
    private bool showYearLeitao => !string.IsNullOrEmpty(selectedRole);
    private bool showYearCaloiro => selectedRole == "Caloiro" || selectedRole == "Tuno";
    private bool showYearTuno => selectedRole == "Tuno";

    private void OnCategoryChanged()
    {
        StateHasChanged();
    }

    private async Task SetAuditContextToCurrentUser()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.Name;
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        AuditContext.SetUser(userName, userId);
    }
}

