@page "/leaderboard"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Application.Interfaces
@using RTUB.Application.Data
@using RTUB.Application.Configuration
@using RTUB.Core.Enums
@using RTUB.Shared
@using RTUB.Shared.Components.Ranking
@inject UserManager<ApplicationUser> UserManager
@inject IRankingService RankingService
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Microsoft.Extensions.Options.IOptions<RankingConfiguration> RankingConfig
@attribute [Authorize]

@if (!showLeaderboard)
{
    <div class="alert alert-warning">
        <i class="bi bi-lock-fill"></i> A tabela de classificação não está disponível no momento.
    </div>
}
else if (leaderboardUsers == null)
{
    <!-- Loading state -->
    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h2><i class="bi bi-trophy-fill"></i> Tabela de Classificação</h2>
        </div>
        <div class="leaderboard-body">
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">A carregar...</span>
                </div>
            </div>
        </div>
    </div>
}
else if (!leaderboardUsers.Any())
{
    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h2><i class="bi bi-trophy-fill"></i> Tabela de Classificação</h2>
        </div>
        <div class="leaderboard-body">
            <EmptyState Title="Nenhum membro encontrado"
                        Icon="bi-trophy"
                        Message="Não há membros classificados no momento." />
        </div>
    </div>
}
else
{
    <!-- Ranks Timeline Section - Collapsible -->
    <div class="ranks-timeline-container mb-4">
        <div class="ranks-timeline-header" @onclick="ToggleClassificationLevels" style="cursor: pointer;">
            <h3>
                <i class="bi bi-trophy"></i> Níveis de Classificação
                <i class="bi @(isClassificationExpanded ? "bi-chevron-up" : "bi-chevron-down") ms-2"></i>
            </h3>
        </div>
        @if (isClassificationExpanded)
        {
            <div class="ranks-grid">
                @{
                    var allLevels = RankingConfig.Value.Levels.OrderBy(l => l.Level).ToList();
                }
                @for (int i = 0; i < allLevels.Count; i++)
                {
                    var levelDef = allLevels[i];
                    var isLastLevel = levelDef.Level == 10;
                    var rowIndex = (i / 3);
                    var colIndex = (i % 3);
                    
                    <div class="rank-grid-item @(isLastLevel ? "rank-final" : "")">
                        <div class="rank-card">
                            @if (isLastLevel)
                            {
                                <i class="bi bi-trophy-fill rank-trophy-icon"></i>
                            }
                            <span class="rank-level">LEVEL @levelDef.Level</span>
                            <span class="rank-name">@levelDef.Name.ToUpper()</span>
                        </div>
                        
                        @* Horizontal connector to the right (if not last in row and not level 10) *@
                        @if (colIndex < 2 && i < allLevels.Count - 1 && !isLastLevel)
                        {
                            <div class="rank-connector-horizontal"></div>
                        }
                        
                        @* Vertical connector down (if not in last row) *@
                        @if (i + 3 < allLevels.Count)
                        {
                            <div class="rank-connector-vertical"></div>
                        }
                    </div>
                }
            </div>
        }
    </div>

    <!-- Leaderboard Panel -->
    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h2><i class="bi bi-trophy-fill"></i> Tabela de Classificação</h2>
        </div>
        <div class="leaderboard-body">
            @{
                int position = (currentPage - 1) * pageSize;
            }
            @foreach (var item in paginatedLeaderboardUsers)
            {
                position++;
                <LeaderboardCard 
                    Position="@position"
                    AvatarUrl="@item.User.ProfilePictureSrc"
                    Nickname="@item.User.Nickname"
                    FullName="@($"{item.User.FirstName} {item.User.LastName}")"
                    Instrument="@(item.User.MainInstrument.HasValue ? StatusHelper.GetInstrumentDisplay(item.User.MainInstrument.Value) : "")"
                    Level="@item.RankProgress.CurrentLevel"
                    RankName="@item.RankProgress.CurrentRankName"
                    Xp="@item.RankProgress.CurrentXp"
                    RehearsalsAttended="@item.TotalRehearsals"
                    EventsAttended="@item.TotalEvents"
                    OnClick="@(() => OpenDetailsModal(item))" />
            }
            
            <!-- Pagination Component -->
            <TablePagination CurrentPage="@currentPage"
                             PageSize="@pageSize"
                             TotalItems="@leaderboardUsers.Count"
                             ItemLabel="membros"
                             PageSizeOptions="@(new[] { 10, 20, 30, 40, 50 })"
                             OnPageChanged="@HandlePageChanged"
                             OnPageSizeChanged="@HandlePageSizeChanged" />
        </div>
    </div>
}

<!-- Details Modal -->
@if (viewingItem != null)
{
    <Modal Show="@showDetailsModal" 
           ShowChanged="@((bool show) => showDetailsModal = show)"
           Title="Detalhes da Classificação" 
           Size="Modal.ModalSize.Large"
           Centered="true">
        <BodyContent>
            <!-- Centered Header Section -->
            <div class="text-center mb-4">
                <img src="@viewingItem.User.ProfilePictureSrc" alt="@viewingItem.User.GetDisplayName()"
                     class="member-avatar-large mb-3" style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--bs-primary);" />
                
                @if (!string.IsNullOrEmpty(viewingItem.User.Nickname))
                {
                    <h4 class="mb-1">@viewingItem.User.Nickname</h4>
                    <p class="text-muted mb-2">@viewingItem.User.FirstName @viewingItem.User.LastName</p>
                }
                else
                {
                    <h4 class="mb-2">@viewingItem.User.FirstName @viewingItem.User.LastName</h4>
                }
                
                <!-- Badges -->
                <div class="d-flex justify-content-center flex-wrap gap-1 mb-2">
                    <span class="badge" style="background-color: #8a2be2;">
                        <i class="bi bi-star-fill"></i> Nível @viewingItem.RankProgress.CurrentLevel
                    </span>
                    <span class="badge bg-info">
                        @viewingItem.RankProgress.CurrentRankName
                    </span>
                </div>
            </div>

            <div class="mb-3"></div>

            <!-- Statistics Section -->
            <div class="modal-info-section mb-4">
                <div class="modal-section-header">
                    <h6 class="modal-section-title">
                        <i class="bi bi-graph-up me-2 text-primary"></i>
                        Estatísticas
                    </h6>
                </div>
                <div class="modal-section-body">
                    <ProfileField Label="XP Total" Value="@viewingItem.RankProgress.CurrentXp.ToString()" />
                    <ProfileField Label="Ensaios Frequentados" Value="@viewingItem.TotalRehearsals.ToString()" />
                    
                    <!-- Events by Type -->
                    <div class="mb-2">
                        <strong>Atuações Participadas por Tipo:</strong>
                    </div>
                    @if (viewingItem.EventsByType.Any())
                    {
                        @foreach (var eventTypeGroup in viewingItem.EventsByType.OrderByDescending(kvp => kvp.Value))
                        {
                            <ProfileField Label="@StatusHelper.GetEventTypeDisplay(eventTypeGroup.Key)" 
                                          Value="@eventTypeGroup.Value.ToString()" />
                        }
                    }
                    else
                    {
                        <p class="text-muted">Nenhuma atuação registrada</p>
                    }
                </div>
            </div>

            <!-- Rank Card Section -->
            <div class="modal-info-section mb-3">
                <RankCard RankProgress="@viewingItem.RankProgress" 
                          IsCollapsible="true" 
                          InitiallyCollapsed="true" />
            </div>
        </BodyContent>
        <FooterContent>
            <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Fechar</button>
        </FooterContent>
    </Modal>
}

@code {
    private List<LeaderboardEntry>? leaderboardUsers;
    private List<LeaderboardEntry> paginatedLeaderboardUsers = new();
    private LeaderboardEntry? viewingItem;
    private bool showDetailsModal = false;
    private bool showLeaderboard = false;
    
    // Classification levels collapsible state
    private bool isClassificationExpanded = false;
    
    // Pagination state
    private int currentPage = 1;
    private int pageSize = 10;



    protected override async Task OnInitializedAsync()
    {
        await CheckLeaderboardVisibility();
        
        if (showLeaderboard)
        {
            await LoadLeaderboard();
        }
    }

    private async Task CheckLeaderboardVisibility()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserId = UserManager.GetUserId(authState.User);
        
        if (!string.IsNullOrEmpty(currentUserId))
        {
            showLeaderboard = await RankingService.IsRankingVisibleAsync(currentUserId);
        }
    }

    private async Task LoadLeaderboard()
    {
        var users = await UserManager.Users.ToListAsync();
        
        // Batch load all attendance and enrollment data in two queries to avoid N+1
        var allRehearsalAttendances = await DbContext.RehearsalAttendances
            .Where(a => a.Attended)
            .GroupBy(a => a.UserId)
            .Select(g => new { UserId = g.Key, Count = g.Count() })
            .ToDictionaryAsync(x => x.UserId, x => x.Count);
        
        // Load enrollments with event types
        var allEnrollmentsWithTypes = await DbContext.Enrollments
            .Include(e => e.Event)
            .Where(e => e.WillAttend && e.Event != null)
            .Select(e => new { e.UserId, EventType = e.Event!.Type })
            .ToListAsync();
        
        // Group by user, then by event type
        var userEventsByType = allEnrollmentsWithTypes
            .GroupBy(e => e.UserId)
            .ToDictionary(
                g => g.Key,
                g => g.GroupBy(x => x.EventType)
                     .ToDictionary(eg => eg.Key, eg => eg.Count())
            );
        
        // Now build entries with cached data
        var entries = new List<LeaderboardEntry>();
        foreach (var user in users)
        {
            var rankProgress = await RankingService.GetRankProgressAsync(user.Id);
            
            var eventsByType = userEventsByType.GetValueOrDefault(user.Id, new Dictionary<EventType, int>());
            var totalEvents = eventsByType.Values.Sum();
            
            entries.Add(new LeaderboardEntry
            {
                User = user,
                RankProgress = rankProgress,
                TotalRehearsals = allRehearsalAttendances.GetValueOrDefault(user.Id, 0),
                TotalEvents = totalEvents,
                EventsByType = eventsByType
            });
        }

        // Sort by Level DESC, then by XP DESC
        leaderboardUsers = entries
            .OrderByDescending(e => e.RankProgress.CurrentLevel)
            .ThenByDescending(e => e.RankProgress.CurrentXp)
            .ToList();
        
        // Apply initial pagination
        ApplyPagination();
    }
    
    private void ToggleClassificationLevels()
    {
        isClassificationExpanded = !isClassificationExpanded;
    }
    
    private void ApplyPagination()
    {
        if (leaderboardUsers == null)
        {
            paginatedLeaderboardUsers = new();
            return;
        }
        
        var skip = (currentPage - 1) * pageSize;
        paginatedLeaderboardUsers = leaderboardUsers.Skip(skip).Take(pageSize).ToList();
    }
    
    private Task HandlePageChanged(int newPage)
    {
        currentPage = newPage;
        ApplyPagination();
        return Task.CompletedTask;
    }
    
    private Task HandlePageSizeChanged(int newPageSize)
    {
        pageSize = newPageSize;
        currentPage = 1; // Reset to first page when page size changes
        ApplyPagination();
        return Task.CompletedTask;
    }

    private void OpenDetailsModal(LeaderboardEntry item)
    {
        viewingItem = item;
        showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        viewingItem = null;
    }

    private class LeaderboardEntry
    {
        public ApplicationUser User { get; set; } = null!;
        public RankProgressInfo RankProgress { get; set; } = null!;
        public int TotalRehearsals { get; set; }
        public int TotalEvents { get; set; }
        public Dictionary<EventType, int> EventsByType { get; set; } = new();
    }
}
