@page "/leaderboard"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Application.Interfaces
@using RTUB.Application.Data
@using RTUB.Shared
@using RTUB.Shared.Components.Ranking
@inject UserManager<ApplicationUser> UserManager
@inject IRankingService RankingService
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

@if (!showLeaderboard)
{
    <div class="alert alert-warning">
        <i class="bi bi-lock-fill"></i> A tabela de classificação não está disponível no momento.
    </div>
}
else if (leaderboardUsers == null)
{
    <!-- Loading state -->
    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h2><i class="bi bi-trophy-fill"></i> Tabela de Classificação</h2>
        </div>
        <div class="leaderboard-body">
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">A carregar...</span>
                </div>
            </div>
        </div>
    </div>
}
else if (!leaderboardUsers.Any())
{
    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h2><i class="bi bi-trophy-fill"></i> Tabela de Classificação</h2>
        </div>
        <div class="leaderboard-body">
            <EmptyState Title="Nenhum membro encontrado"
                        Icon="bi-trophy"
                        Message="Não há membros classificados no momento." />
        </div>
    </div>
}
else
{
    <!-- Leaderboard Panel -->
    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h2><i class="bi bi-trophy-fill"></i> Tabela de Classificação</h2>
        </div>
        <div class="leaderboard-body">
            @{
                int position = 0;
            }
            @foreach (var item in leaderboardUsers)
            {
                position++;
                <LeaderboardCard 
                    Position="@position"
                    AvatarUrl="@item.User.ProfilePictureSrc"
                    Nickname="@item.User.Nickname"
                    FullName="@($"{item.User.FirstName} {item.User.LastName}")"
                    Instrument="@(item.User.MainInstrument.HasValue ? StatusHelper.GetInstrumentDisplay(item.User.MainInstrument.Value) : "")"
                    Level="@item.RankProgress.CurrentLevel"
                    RankName="@item.RankProgress.CurrentRankName"
                    Xp="@item.RankProgress.CurrentXp"
                    OnClick="@(() => OpenDetailsModal(item))" />
            }
        </div>
    </div>
}

<!-- Details Modal -->
@if (viewingItem != null)
{
    <Modal Show="@showDetailsModal" 
           ShowChanged="@((bool show) => showDetailsModal = show)"
           Title="Detalhes da Classificação" 
           Size="Modal.ModalSize.Large"
           Centered="true">
        <BodyContent>
            <!-- Centered Header Section -->
            <div class="text-center mb-4">
                <img src="@viewingItem.User.ProfilePictureSrc" alt="@viewingItem.User.GetDisplayName()"
                     class="member-avatar-large mb-3" style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--bs-primary);" />
                
                @if (!string.IsNullOrEmpty(viewingItem.User.Nickname))
                {
                    <h4 class="mb-1">@viewingItem.User.Nickname</h4>
                    <p class="text-muted mb-2">@viewingItem.User.FirstName @viewingItem.User.LastName</p>
                }
                else
                {
                    <h4 class="mb-2">@viewingItem.User.FirstName @viewingItem.User.LastName</h4>
                }
                
                <!-- Badges -->
                <div class="d-flex justify-content-center flex-wrap gap-1 mb-2">
                    <span class="badge" style="background-color: #8a2be2;">
                        <i class="bi bi-star-fill"></i> Nível @viewingItem.RankProgress.CurrentLevel
                    </span>
                    <span class="badge bg-info">
                        @viewingItem.RankProgress.CurrentRankName
                    </span>
                </div>
            </div>

            <div class="mb-3"></div>

            <!-- Statistics Section -->
            <div class="modal-info-section mb-4">
                <div class="modal-section-header">
                    <h6 class="modal-section-title">
                        <i class="bi bi-graph-up me-2 text-primary"></i>
                        Estatísticas
                    </h6>
                </div>
                <div class="modal-section-body">
                    <ProfileField Label="XP Total" Value="@viewingItem.RankProgress.CurrentXp.ToString()" />
                    <ProfileField Label="Ensaios Frequentados" Value="@viewingItem.TotalRehearsals.ToString()" />
                    <ProfileField Label="Atuações Participadas" Value="@viewingItem.TotalEvents.ToString()" />
                </div>
            </div>

            <!-- Rank Card Section -->
            <div class="modal-info-section mb-3">
                <RankCard RankProgress="@viewingItem.RankProgress" 
                          IsCollapsible="true" 
                          InitiallyCollapsed="true" />
            </div>
        </BodyContent>
        <FooterContent>
            <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Fechar</button>
        </FooterContent>
    </Modal>
}

@code {
    private List<LeaderboardEntry>? leaderboardUsers;
    private LeaderboardEntry? viewingItem;
    private bool showDetailsModal = false;
    private bool showLeaderboard = false;



    protected override async Task OnInitializedAsync()
    {
        await CheckLeaderboardVisibility();
        
        if (showLeaderboard)
        {
            await LoadLeaderboard();
        }
    }

    private async Task CheckLeaderboardVisibility()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserId = UserManager.GetUserId(authState.User);
        
        if (!string.IsNullOrEmpty(currentUserId))
        {
            showLeaderboard = await RankingService.IsRankingVisibleAsync(currentUserId);
        }
    }

    private async Task LoadLeaderboard()
    {
        var users = await UserManager.Users.ToListAsync();
        
        // Batch load all attendance and enrollment data in two queries to avoid N+1
        var allRehearsalAttendances = await DbContext.RehearsalAttendances
            .Where(a => a.Attended)
            .GroupBy(a => a.UserId)
            .Select(g => new { UserId = g.Key, Count = g.Count() })
            .ToDictionaryAsync(x => x.UserId, x => x.Count);
        
        var allEnrollments = await DbContext.Enrollments
            .GroupBy(e => e.UserId)
            .Select(g => new { UserId = g.Key, Count = g.Count() })
            .ToDictionaryAsync(x => x.UserId, x => x.Count);
        
        // Now build entries with cached data
        var entries = new List<LeaderboardEntry>();
        foreach (var user in users)
        {
            var rankProgress = await RankingService.GetRankProgressAsync(user.Id);
            
            entries.Add(new LeaderboardEntry
            {
                User = user,
                RankProgress = rankProgress,
                TotalRehearsals = allRehearsalAttendances.GetValueOrDefault(user.Id, 0),
                TotalEvents = allEnrollments.GetValueOrDefault(user.Id, 0)
            });
        }

        // Sort by Level DESC, then by XP DESC
        leaderboardUsers = entries
            .OrderByDescending(e => e.RankProgress.CurrentLevel)
            .ThenByDescending(e => e.RankProgress.CurrentXp)
            .ToList();
    }

    private void OpenDetailsModal(LeaderboardEntry item)
    {
        viewingItem = item;
        showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        viewingItem = null;
    }

    private class LeaderboardEntry
    {
        public ApplicationUser User { get; set; } = null!;
        public RankProgressInfo RankProgress { get; set; } = null!;
        public int TotalRehearsals { get; set; }
        public int TotalEvents { get; set; }
    }
}
