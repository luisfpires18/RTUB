@page "/events"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Application.Interfaces
@using RTUB.Shared
@using System.Web
@inject IEventService EventService
@inject IEnrollmentService EnrollmentService
@inject ITrophyService TrophyService
@inject IEmailNotificationService EmailNotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject IWebHostEnvironment Environment
@inject NavigationManager Navigation

<h1>Atuações</h1>
<p>Próximas atuações e atividades.</p>

<AuthorizeView Roles="Admin">
    <Authorized>
        <div class="mb-3">
            <button class="btn btn-success" @onclick="OpenCreateModal" title="Adicionar Novo Evento">
                <i class="bi bi-plus-lg"></i> Adicionar
            </button>
        </div>
    </Authorized>
</AuthorizeView>

@if (events == null)
{
    <p>A carregar atuações...</p>
}
else if (!events.Any())
{
    <EmptyState Title="Nenhum evento criado ainda"
               Icon="bi-info-circle" />
}
else
{
    <div class="row">
        @foreach (var eventItem in events)
        {
            <div class="col-md-4 mb-4">
                <AuthorizeView>
                    <Authorized>
                        @{
                            var userEnrollment = GetUserEnrollment(eventItem.Id);
                        }
                        <EventCard Event="@eventItem"
                                   ImageUrl="@GetEventImageUrl(eventItem.ImageSrc)"
                                   UserEnrollment="@userEnrollment"
                                   EnrollmentCount="@GetEnrollmentCount(eventItem.Id)"
                                   IsAdmin="@isUserAdmin"
                                   IsPastEvent="false"
                                   OnEdit="@(() => OpenEditModal(eventItem))"
                                   OnDelete="@(() => OpenDeleteModal(eventItem))"
                                   OnSendEmail="@(() => OpenEmailNotificationModal(eventItem))"
                                   OnCancelEvent="@(() => OpenCancelEventModal(eventItem))"
                                   OnUncancelEvent="@(() => UncancelEvent(eventItem))"
                                   OnEnroll="@(() => OpenEnrollModal(eventItem))"
                                   OnEditEnrollment="@(() => { if (userEnrollment != null) OpenEditEnrollmentModal(userEnrollment); })"
                                   OnRemoveEnrollment="@(() => { if (userEnrollment != null) OpenRemoveEnrollmentModal(userEnrollment); })"
                                   OnViewDetails="@(() => OpenEventDetailsModal(eventItem))"
                                   OnViewEnrollments="@(() => OpenEnrollmentListModal(eventItem))"
                                   OnWatchRepertoire="@(() => OpenRepertoireModal(eventItem))" />
                    </Authorized>
                    <NotAuthorized Context="unauthorizedContext">
                        <EventCard Event="@eventItem"
                                   ImageUrl="@GetEventImageUrl(eventItem.ImageSrc)"
                                   EnrollmentCount="@GetEnrollmentCount(eventItem.Id)"
                                   IsAdmin="false"
                                   IsPastEvent="false"
                                   ShowButtons="false" />
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        }
    </div>
}

<!-- Admin: Previous Events Section -->
<AuthorizeView Roles="Admin,Owner">
    <Authorized>
        <hr class="my-5" />

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Atuações Anteriores</h2>
        </div>

        <TableSearchBar SearchTerm="@previousEventsSearch"
                        Placeholder="Pesquisar atuações anteriores..."
                       OnSearchChanged="@HandlePreviousEventsSearch" />

        @if (filteredPreviousEvents == null)
        {
            <p>A carregar atuações anteriores...</p>
        }
        else if (!filteredPreviousEvents.Any())
        {
            <EmptyState Title="Nenhum evento anterior encontrado"
                             Message="Não existem atuações passados para mostrar."
                           Icon="bi-calendar-x" />
        }
        else
        {
            <div class="row">
                @foreach (var eventItem in paginatedPreviousEvents)
                {
                    <div class="col-md-4 mb-4">
                        <AuthorizeView Roles="Owner">
                            <Authorized Context="editContext">
                                <EventCard Event="@eventItem"
                                           ImageUrl="@GetEventImageUrl(eventItem.ImageSrc)"
                                           EnrollmentCount="@GetEnrollmentCount(eventItem.Id)"
                                           IsAdmin="true"
                                           IsPastEvent="true"
                                           ShowTrophy="true"
                                           OnEdit="@(() => OpenEditModal(eventItem))"
                                           OnDelete="@(() => OpenDeleteModal(eventItem))"
                                           OnViewDetails="@(() => OpenEventDetailsModal(eventItem))"
                                           OnViewEnrollments="@(() => OpenEnrollmentListModal(eventItem))"
                                           OnWatchRepertoire="@(() => OpenRepertoireModal(eventItem))"
                                           OnViewTrophies="@(() => OpenTrophyModal(eventItem))" />
                            </Authorized>
                            <NotAuthorized Context="adminOnlyContext">
                                <EventCard Event="@eventItem"
                                           ImageUrl="@GetEventImageUrl(eventItem.ImageSrc)"
                                           EnrollmentCount="@GetEnrollmentCount(eventItem.Id)"
                                           IsAdmin="false"
                                           IsPastEvent="true"
                                           ShowTrophy="true"
                                           OnViewDetails="@(() => OpenEventDetailsModal(eventItem))"
                                           OnViewEnrollments="@(() => OpenEnrollmentListModal(eventItem))"
                                           OnWatchRepertoire="@(() => OpenRepertoireModal(eventItem))"
                                           OnViewTrophies="@(() => OpenTrophyModal(eventItem))" />
                            </NotAuthorized>
                        </AuthorizeView>
                    </div>
                }
            </div>

            <TablePagination CurrentPage="@paginationHelper.CurrentPage"
                            PageSize="@paginationHelper.PageSize"
                            TotalItems="@(filteredPreviousEvents?.Count ?? 0)"
                            ItemLabel="eventos"
                            PageSizeOptions="@(new[] { 3, 6, 9, 12, 15 })"
                            OnPageChanged="@HandlePreviousEventsPageChange"
                            OnPageSizeChanged="@HandlePreviousEventsPageSizeChange" />
        }
    </Authorized>
</AuthorizeView>

<!-- Edit/Create Modal -->
<Modal Show="@showEditModal" 
       ShowChanged="@((bool show) => showEditModal = show)"
       Title="@(isCreateMode ? "Criar Novo Evento" : "Editar Evento")" 
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        <EditForm Model="editingEvent" OnValidSubmit="SaveEvent">
            <DataAnnotationsValidator />
            <ErrorDisplay />

            @if (showPastDateWarning && editingEvent != null && editingEvent.Date.Date < DateTime.Today)
            {
                <Alert Type="Alert.AlertType.Purple"
                       Icon="bi-info-circle"
                       Dismissible="false"
                       AdditionalClasses="mb-3">
                    <strong>Nota:</strong> Esta data é anterior à data atual. O evento será disponibilizado nas atuações anteriores.
                </Alert>
            }

            <div class="mb-3">
                <label class="form-label">Nome da Atuação</label>
                <InputText class="form-control" @bind-Value="editingEvent!.Name" />
            </div>

            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input clickable-row" type="checkbox" id="dateRangeToggle"
                           @bind="isDateRange" @bind:after="OnDateRangeToggled" />
                    <label class="form-check-label form-check-label-white-clickable" for="dateRangeToggle">
                        Intervalo de Datas (em vez de data única)
                    </label>
                </div>
            </div>

            <div class="row">
                @if (!isDateRange)
                {
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Data</label>
                        <InputDate class="form-control" @bind-Value="editingEvent!.Date" @bind-Value:after="OnDateChanged" />
                        @if (!string.IsNullOrEmpty(dateValidationError))
                        {
                            <div class="text-danger small mt-1">@dateValidationError</div>
                        }
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Hora</label>
                        <input type="time" class="form-control" value="@eventTimeString" @onchange="@((ChangeEventArgs e) => { eventTimeString = e.Value?.ToString() ?? "19:00"; OnTimeChanged(); })" />
                    </div>
                }
                else
                {
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Data Início</label>
                        <InputDate class="form-control" @bind-Value="editingEvent!.Date" @bind-Value:after="OnDateChanged" />
                        @if (!string.IsNullOrEmpty(dateValidationError))
                        {
                            <div class="text-danger small mt-1">@dateValidationError</div>
                        }
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Data Fim (opcional)</label>
                        <InputDate class="form-control" @bind-Value="editingEvent!.EndDate" />
                    </div>
                }
            </div>

            <div class="mb-3">
                <label class="form-label">Localização</label>
                <InputText class="form-control" @bind-Value="editingEvent!.Location" />
            </div>

            <div class="mb-3">
                <label class="form-label">Tipo de Atuação</label>
                <InputSelect class="form-select" @bind-Value="editingEvent!.Type">
                    @foreach (var type in Enum.GetValues<EventType>())
                    {
                        <option value="@type">@GetEventTypeDisplay(type)</option>
                    }
                </InputSelect>
            </div>

            <ImageUploadManager @ref="imageUploadManager"
                               Label="Imagem do Evento"
                               CurrentImageUrl="@(uploadedImagePath == null && !string.IsNullOrEmpty(editingEvent!.ImageSrc) ? GetEventImageUrl(editingEvent.ImageSrc) : null)"
                               ShowCurrentImage="@(uploadedImagePath == null)"
                               PreviewCssClass="slideshow-preview"
                               OnFileSelected="HandleImageUpload" />

            <div class="mb-3">
                <label class="form-label">Descrição</label>
                <InputTextArea class="form-control" rows="4" @bind-Value="editingEvent!.Description" />
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancelar</button>
                <button type="submit" class="btn btn-primary btn-primary-purple">Guardar</button>
            </div>
        </EditForm>
    </BodyContent>
</Modal>

<!-- Delete Confirmation Modal -->
<Modal Show="@showDeleteModal" 
       ShowChanged="@((bool show) => showDeleteModal = show)"
       Title="Confirmar Eliminação" 
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        <p>Tem a certeza de que pretende eliminar a atuação <strong>@deletingEvent?.Name</strong>?</p>
        <p class="text-muted">Esta ação não pode ser anulada..</p>
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal">Cancelar</button>
        <button type="button" class="btn btn-danger" @onclick="DeleteEvent">Eliminar</button>
    </FooterContent>
</Modal>

<!-- Enrollment Modal (using unified ParticipationModal) -->
@if (enrollmentForm != null)
{
    <ParticipationModal Show="@showEnrollModal"
                       ShowChanged="@((bool show) => showEnrollModal = show)"
                       Title="@(isEditingEnrollment ? "Editar Inscrição" : $"Inscrever em {selectedEvent?.Name}")"
                       ShowWillAttend="true"
                       WillAttend="@enrollmentForm.WillAttend"
                       WillAttendChanged="@((bool value) => enrollmentForm.WillAttend = value)"
                       IsLeitao="@(currentUser != null && currentUser.Categories.Contains(MemberCategory.Leitao))"
                       Instrument="@enrollmentForm.Instrument"
                       InstrumentChanged="@((InstrumentType? value) => enrollmentForm.Instrument = value)"
                       Notes="@enrollmentForm.Notes"
                       NotesChanged="@((string value) => enrollmentForm.Notes = value)"
                       NotesRows="4"
                       NotesPlaceholder="Informações adicionais..."
                       SubmitButtonText="@(isEditingEnrollment ? "Atualizar" : "Inscrever")"
                       WantToPlay="@wantToPlay"
                       OnSubmit="@SaveEnrollment"
                       OnCancel="@CloseEnrollModal" />
}

<!-- Remove Enrollment Confirmation Modal -->
<Modal Show="@showRemoveEnrollmentModal" 
       ShowChanged="@((bool show) => showRemoveEnrollmentModal = show)"
       Title="Confirmar Cancelamento de Inscrição" 
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        <p>Tem certeza que deseja cancelar sua inscrição neste evento?</p>
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseRemoveEnrollmentModal">Não</button>
        <button type="button" class="btn btn-danger" @onclick="RemoveEnrollment">Sim, Cancelar</button>
    </FooterContent>
</Modal>

<!-- View Enrollments Modal -->
@if (selectedEvent != null)
{
    <Modal Show="@showEnrollmentListModal" 
           ShowChanged="@((bool show) => showEnrollmentListModal = show)"
           Title="@($"Inscrições em {selectedEvent.Name}")" 
           Size="Modal.ModalSize.Large"
           Centered="true">
        <BodyContent>
            @if (eventEnrollments == null || !eventEnrollments.Any())
            {
                <EmptyState Title="Nenhuma inscrição ainda para este evento"
                           Icon="bi-people" />
            }
            else
            {
                var performingMembers = eventEnrollments.Where(e => e.User != null && e.WillAttend && !e.User.Categories.Contains(MemberCategory.Leitao)).ToList();
                var leitaoMembers = eventEnrollments.Where(e => e.User != null && e.WillAttend && e.User.Categories.Contains(MemberCategory.Leitao)).ToList();
                var notAttendingMembers = eventEnrollments.Where(e => e.User != null && !e.WillAttend).ToList();

                @if (performingMembers.Any())
                {
                    <h6 class="mb-3 heading-purple">Membros (@performingMembers.Count)</h6>
                    
                    <!-- Search Control -->
                    <div class="mb-3">
                        <input type="text" class="form-control" placeholder="Pesquisar por nome..." 
                               @bind="enrollmentSearchTerm" @bind:event="oninput" @onkeyup="FilterEnrollments" />
                    </div>
                    
                    <div class="enrollment-card-grid mb-4">
                        @foreach (var enrollment in paginatedPerformingMembers)
                        {
                            <EnrollmentCard 
                                AvatarUrl="@enrollment.User?.ProfilePictureSrc"
                                TunaName="@enrollment.User?.Nickname"
                                FullName="@($"{enrollment.User?.FirstName} {enrollment.User?.LastName}")"
                                InstrumentText="@(enrollment.Instrument.HasValue ? StatusHelper.GetInstrumentDisplay(enrollment.Instrument.Value) : "")"
                                Notes="@enrollment.Notes"
                                AltText="@enrollment.User?.GetDisplayName()"
                                ShowEditButton="false"
                                ShowDeleteButton="@isUserOwner"
                                OnDelete="@(() => OpenDeleteEnrollmentModal(enrollment))"
                                DeleteTooltip="Eliminar Inscrição">
                                <BadgeContent>
                                    @if (enrollment.User != null)
                                    {
                                        <div class="enrollment-card-badges-row">
                                            @if (enrollment.User.Positions.Contains(Position.Magister))
                                            {
                                                <PositionBadge Position="Position.Magister" />
                                            }
                                            else if (enrollment.User.Categories.Contains(MemberCategory.Tuno))
                                            {
                                                <CategoryBadge Category="MemberCategory.Tuno" />
                                            }
                                            else if (enrollment.User.Categories.Contains(MemberCategory.Caloiro))
                                            {
                                                <CategoryBadge Category="MemberCategory.Caloiro" />
                                            }
                                        </div>
                                    }
                                </BadgeContent>
                            </EnrollmentCard>
                        }
                    </div>

                    <!-- Pagination for Performing Members -->
                    @if (filteredPerformingMembers.Count > 0)
                    {
                        <div class="mb-3">
                            <TablePagination 
                                TotalItems="@filteredPerformingMembers.Count"
                                CurrentPage="@performingMembersPagination.CurrentPage"
                                PageSize="@performingMembersPagination.PageSize"
                                PageSizeOptions="@(new[] { 4, 8, 12, 16 })"
                                OnPageChanged="@HandlePerformingMembersPageChange"
                                OnPageSizeChanged="@HandlePerformingMembersPageSizeChange" />
                        </div>
                    }

                    @* Instrument Counts - Horizontal Counter Section *@
                    var instrumentCounts = new Dictionary<InstrumentType, int>();
                    foreach (var inst in Enum.GetValues<InstrumentType>())
                    {
                        instrumentCounts[inst] = performingMembers.Count(e => e.Instrument == inst);
                    }

                    <InstrumentCounter InstrumentCounts="@instrumentCounts" />
                }

                @if (leitaoMembers.Any())
                {
                    <h6 class="mb-3 heading-warning">Leitões (@leitaoMembers.Count)</h6>
                    <div class="enrollment-card-grid">
                        @foreach (var enrollment in paginatedLeitoes)
                        {
                            <EnrollmentCard 
                                AvatarUrl="@enrollment.User?.ProfilePictureSrc"
                                TunaName="@enrollment.User?.Nickname"
                                FullName="@($"{enrollment.User?.FirstName} {enrollment.User?.LastName}")"
                                InstrumentText=""
                                Notes="@enrollment.Notes"
                                AltText="@enrollment.User?.GetDisplayName()"
                                ShowEditButton="false"
                                ShowDeleteButton="@isUserOwner"
                                OnDelete="@(() => OpenDeleteEnrollmentModal(enrollment))"
                                DeleteTooltip="Eliminar Inscrição">
                                <BadgeContent>
                                    <div class="enrollment-card-badges-row">
                                        <CategoryBadge Category="MemberCategory.Leitao" />
                                    </div>
                                </BadgeContent>
                            </EnrollmentCard>
                        }
                    </div>
                    
                    <!-- Pagination for Leitões -->
                    @if (filteredLeitoes.Count > 0)
                    {
                        <div class="mt-3">
                            <TablePagination 
                                TotalItems="@filteredLeitoes.Count"
                                CurrentPage="@leitoesPagination.CurrentPage"
                                PageSize="@leitoesPagination.PageSize"
                                PageSizeOptions="@(new[] { 4, 8, 12, 16 })"
                                OnPageChanged="@HandleLeitoesPageChange"
                                OnPageSizeChanged="@HandleLeitoesPageSizeChange" />
                        </div>
                    }
                }

                @if (notAttendingMembers.Any())
                {
                    <h6 class="mb-3 mt-4 heading-danger">Não vão participar (@notAttendingMembers.Count)</h6>
                    <div class="enrollment-card-grid">
                        @foreach (var enrollment in notAttendingMembers)
                        {
                            <EnrollmentCard 
                                AvatarUrl="@enrollment.User?.ProfilePictureSrc"
                                TunaName="@enrollment.User?.Nickname"
                                FullName="@($"{enrollment.User?.FirstName} {enrollment.User?.LastName}")"
                                InstrumentText=""
                                Notes="@enrollment.Notes"
                                AltText="@enrollment.User?.GetDisplayName()"
                                ShowEditButton="false"
                                ShowDeleteButton="@isUserOwner"
                                OnDelete="@(() => OpenDeleteEnrollmentModal(enrollment))"
                                DeleteTooltip="Eliminar Inscrição">
                                <BadgeContent>
                                    @if (enrollment.User != null)
                                    {
                                        <div class="enrollment-card-badges-row">
                                            @if (enrollment.User.Positions.Contains(Position.Magister))
                                            {
                                                <PositionBadge Position="Position.Magister" />
                                            }
                                            else if (enrollment.User.Categories.Contains(MemberCategory.Tuno))
                                            {
                                                <CategoryBadge Category="MemberCategory.Tuno" />
                                            }
                                            else if (enrollment.User.Categories.Contains(MemberCategory.Caloiro))
                                            {
                                                <CategoryBadge Category="MemberCategory.Caloiro" />
                                            }
                                            else if (enrollment.User.Categories.Contains(MemberCategory.Leitao))
                                            {
                                                <CategoryBadge Category="MemberCategory.Leitao" />
                                            }
                                        </div>
                                    }
                                </BadgeContent>
                            </EnrollmentCard>
                        }
                    </div>
                }
            }
        </BodyContent>
        <FooterContent>
            <button type="button" class="btn btn-secondary" @onclick="CloseEnrollmentListModal">Fechar</button>
        </FooterContent>
    </Modal>
}

<!-- Image Cropper Component -->
<ImageCropper @ref="imageCropper"
              ShowModal="showCropperModal"
              ShowModalChanged="OnCropperModalChanged"
              OnImageCropped="OnImageCropped"
              AspectRatio="1.5"
              AspectRatioHelp="Event images are displayed in 3:2 aspect ratio for better presentation"
              ImageFormat="image/webp"
              ImageQuality="0.85" />

<!-- Repertoire Modal -->
<RepertoireModal Show="@showRepertoireModal"
                ShowChanged="@((bool show) => showRepertoireModal = show)"
                EventId="@(selectedEventForRepertoire?.Id ?? 0)"
                EventName="@(selectedEventForRepertoire?.Name ?? "")"
                IsAdmin="@isUserAdmin"
                OnRepertoireChanged="@HandleRepertoireChanged" />

<!-- Event Details Modal -->
@if (selectedEvent != null)
{
    <DetailsModal Show="@showEventDetailsModal"
                  ShowChanged="@((bool show) => showEventDetailsModal = show)"
                  Title="Detalhes da Atuação"
                  HeaderTitle="@(selectedEvent?.Name ?? "")"
                  ImageUrl="@(selectedEvent != null && !string.IsNullOrEmpty(selectedEvent.ImageSrc) ? selectedEvent.ImageSrc : null)"
                  IconClass="@(selectedEvent != null && string.IsNullOrEmpty(selectedEvent.ImageSrc) ? "bi-calendar-event" : null)"
                  OnClose="@(() => showEventDetailsModal = false)">
        <BadgesContent>
            @if (selectedEvent != null)
            {
                <span class="badge bg-primary">@GetEventTypeDisplay(selectedEvent.Type)</span>
            }
        </BadgesContent>
        <Sections>
            @if (selectedEvent != null)
            {
                <!-- Event Information Section -->
                <InfoSection SectionTitle="Informação da Atuação" 
                            IconClass="bi-info-circle-fill" 
                            CssClass="mb-4">
                    <ProfileField Label="Nome" Value="@selectedEvent.Name" />
                    <ProfileField Label="Tipo" Value="@GetEventTypeDisplay(selectedEvent.Type)" />
                    <ProfileField Label="Data" 
                                Value="@GetEventDateDisplay(selectedEvent)" />
                    <ProfileField Label="Localização" Value="@selectedEvent.Location" />
                </InfoSection>

                <!-- Description Section -->
                @if (!string.IsNullOrEmpty(selectedEvent.Description))
                {
                    <InfoSection SectionTitle="Descrição" 
                                IconClass="bi-file-text" 
                                CssClass="mb-3">
                        <p class="text-white-full mb-0" style="white-space: pre-line;">@selectedEvent.Description</p>
                    </InfoSection>
                }
            }
        </Sections>
    </DetailsModal>
}

<!-- Trophy Modal -->
<Modal Show="@showTrophyModal"
       ShowChanged="@((bool show) => showTrophyModal = show)"
       Title="@($"Prémios  de {selectedEventForTrophies?.Name ?? ""}")"
       Size="Modal.ModalSize.Large"
       Centered="true">
    <BodyContent>
        <AuthorizeView Roles="Admin,Owner">
            <Authorized>
                <div class="mb-3">
                    <button class="btn btn-success btn-sm" @onclick="OpenCreateTrophyModal">
                        <i class="bi bi-plus-lg"></i> Adicionar Prémio
                    </button>
                </div>
            </Authorized>
        </AuthorizeView>

        @if (eventTrophies == null || !eventTrophies.Any())
        {
            <EmptyState Title="Nenhum prémio conquistado neste evento."
                            Icon="bi-trophy" />
        }
        else
        {
            <div class="row g-3">
                @foreach (var trophy in eventTrophies)
                {
                    <div class="col-md-4 col-sm-6">
                        <div class="card h-100 text-center p-3 position-relative trophy-card" style="background-color: #151516; border: 2px solid #2f2f2f; transition: border-color 0.2s ease, box-shadow 0.2s ease;">
                            <AuthorizeView Roles="Admin,Owner">
                                <Authorized>
                                    <div class="position-absolute top-0 end-0 p-2">
                                        <button class="btn btn-sm btn-light me-1" @onclick="() => OpenEditTrophyModal(trophy)" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" @onclick="() => OpenDeleteTrophyModal(trophy)" title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                            <div class="card-body d-flex flex-column align-items-center justify-content-center">
                                <i class="bi bi-trophy-fill text-warning mb-3" style="font-size: 3rem;"></i>
                                <h5 class="card-title mb-0">@trophy.Name</h5>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseTrophyModal">Fechar</button>
    </FooterContent>
</Modal>

<!-- Trophy Edit Modal -->
<Modal Show="@showTrophyEditModal"
       ShowChanged="@((bool show) => showTrophyEditModal = show)"
       Title="@(isTrophyCreateMode ? "Adicionar Prémio" : "Editar Prémio")"
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        @if (editingTrophy != null)
        {
            <EditForm Model="editingTrophy" OnValidSubmit="SaveTrophy">
                <DataAnnotationsValidator />
                <ErrorDisplay />

                <div class="mb-3">
                    <label class="form-label">Nome do Prémio</label>
                    <InputText class="form-control" @bind-Value="editingTrophy.Name" placeholder="Ex: 1º Lugar, Melhor Apresentação..." />
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" @onclick="CloseTrophyEditModal">Cancelar</button>
                    <button type="submit" class="btn btn-primary btn-primary-purple">Guardar</button>
                </div>
            </EditForm>
        }
    </BodyContent>
</Modal>

<!-- Trophy Delete Modal -->
<Modal Show="@showTrophyDeleteModal"
       ShowChanged="@((bool show) => showTrophyDeleteModal = show)"
       Title="Confirmar Eliminação"
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        <p>Tem a certeza que deseja eliminar o prémio <strong>@deletingTrophy?.Name</strong>?</p>
        <p class="text-muted small">Esta ação não pode ser revertida.</p>
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseTrophyDeleteModal">Cancelar</button>
        <button type="button" class="btn btn-danger" @onclick="DeleteTrophy">Eliminar</button>
    </FooterContent>
</Modal>

<!-- Delete Enrollment Confirmation Modal (Owner Only) -->
<Modal Show="@showDeleteEnrollmentModal"
       ShowChanged="@((bool show) => showDeleteEnrollmentModal = show)"
       Title="Confirmar Eliminação de Inscrição"
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        @if (deletingEnrollment != null)
        {
            <p>Tem a certeza que deseja eliminar a inscrição de <strong>@deletingEnrollment.User?.GetDisplayName()</strong> neste evento?</p>
            <p class="text-muted small">Esta ação não pode ser revertida.</p>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseDeleteEnrollmentModal">Cancelar</button>
        <button type="button" class="btn btn-danger" @onclick="DeleteEnrollment">Eliminar</button>
    </FooterContent>
</Modal>

<!-- Email Notification Confirmation Modal -->
<ConfirmDialog Show="@showEmailNotificationModal"
               ShowChanged="@((bool show) => showEmailNotificationModal = show)"
               Title="Enviar notificação desta atuação?"
               ConfirmText="Sim"
               CancelText="Não"
               ConfirmButtonClass="btn-primary"
               OnConfirm="@SendEventNotification"
               OnCancel="@CloseEmailNotificationModal"
               Size="Modal.ModalSize.Large">
    <BodyContent>
        @if (selectedEventForEmail != null)
        {
            <div class="mb-3">
                <h6 class="text-white-full">Detalhes do Evento:</h6>
                <div class="event-summary p-3 rounded bg-dark">
                    <div><strong>Título:</strong> @selectedEventForEmail.Name</div>
                    <div><strong>Data:</strong> @selectedEventForEmail.Date.ToString("dddd, dd 'de' MMMM 'de' yyyy • HH:mm", new System.Globalization.CultureInfo("pt-PT"))</div>
                    <div><strong>Local:</strong> @selectedEventForEmail.Location</div>
                </div>
            </div>

            @if (emailLoadingSubscribers)
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">A carregar...</span>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(emailErrorMessage))
            {
                <Alert Title="@emailErrorMessage" 
                       Type="Alert.AlertType.Error" 
                       Dismissible="true"
                       OnDismiss="@(() => emailErrorMessage = null)" />
            }
            else
            {
                <div class="mb-3">
                    <span class="badge bg-purple text-white p-2">
                        @($"{subscribedUsersCount} / {totalUsersCount} membros têm 'Notificações por email' ativas e irão receber esta mensagem.")
                    </span>
                </div>

                @if (subscribedUsers != null && subscribedUsers.Any())
                {
                    <div class="mb-3">
                        <h6 class="text-white-full mb-2">Membros que irão receber:</h6>
                        <div class="subscriber-list" style="max-height: 300px; overflow-y: auto;">
                            @foreach (var user in subscribedUsers)
                            {
                                <div class="subscriber-item p-2 mb-1 rounded bg-dark text-white-full">
                                    @(user.Nickname ?? $"{user.FirstName} {user.LastName}")
                                </div>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <Alert Title="Nenhum membro subscrito às notificações por email." 
                           Type="Alert.AlertType.Warning" />
                }
            }
        }
    </BodyContent>
</ConfirmDialog>

<!-- Cancel Event Confirmation Modal -->
<Modal Show="@showCancelEventModal"
       ShowChanged="@((bool show) => showCancelEventModal = show)"
       Title="Cancelar Evento"
       Size="Modal.ModalSize.Large"
       Centered="true"
       ShowCloseButton="true">
    <BodyContent>
        @if (selectedEventForCancellation != null)
        {
            <div class="mb-3">
                <h6 class="text-white-full">Evento:</h6>
                <div class="event-summary p-3 rounded bg-dark">
                    <div><strong>Título:</strong> @selectedEventForCancellation.Name</div>
                    <div><strong>Data:</strong> @selectedEventForCancellation.Date.ToString("dddd, dd 'de' MMMM 'de' yyyy • HH:mm", new System.Globalization.CultureInfo("pt-PT"))</div>
                    <div><strong>Local:</strong> @selectedEventForCancellation.Location</div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(cancelEventErrorMessage))
            {
                <Alert Message="@cancelEventErrorMessage" 
                       Type="Alert.AlertType.Error" 
                       Dismissible="true"
                       OnDismiss="@(() => cancelEventErrorMessage = null)" />
            }

            @if (cancelEventLoadingSubscribers)
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">A carregar...</span>
                    </div>
                </div>
            }
            
            <div class="mb-3 form-check">
                <input class="form-check-input" type="checkbox" id="notifySubscribersCheckbox"
                       @bind="notifySubscribersOnCancel">
                <label class="form-check-label text-white-full" for="notifySubscribersCheckbox">
                    Notificar todos os inscritos por email
                </label>
            </div>
            
            @if (notifySubscribersOnCancel)
            {
                <div class="mb-3">
                    <span class="badge bg-purple text-white p-2">
                        @($"{cancelEventSubscribedCount} / {cancelEventTotalCount} membros têm 'Notificações por email' ativas e irão receber esta mensagem.")
                    </span>
                </div>
            }

            <div class="mb-3">
                <label class="form-label text-white-full">Motivo do Cancelamento <span class="text-danger">*</span></label>
                <textarea class="form-control" rows="4" 
                          @bind="cancelEventReason" 
                          placeholder="Descreva o motivo do cancelamento do evento..."
                          maxlength="1000"></textarea>
                <small class="text-muted">Máximo 1000 caracteres</small>
            </div>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseCancelEventModal">Não Cancelar</button>
        <button type="button" class="btn btn-danger" @onclick="ConfirmCancelEvent">Cancelar Evento</button>
    </FooterContent>
</Modal>

@code {
    private List<Event>? events;
    private List<Enrollment>? enrollments;
    private List<Enrollment>? eventEnrollments;
    private ApplicationUser? currentUser;
    private bool showEditModal = false;
    private bool showDeleteModal = false;
    private bool showEnrollModal = false;
    private bool showRemoveEnrollmentModal = false;
    private bool showEnrollmentListModal = false;
    private bool showCropperModal = false;
    private bool showRepertoireModal = false;
    private bool showEventDetailsModal = false;
    private bool showTrophyModal = false;
    private bool showTrophyEditModal = false;
    private bool showTrophyDeleteModal = false;
    private bool showDeleteEnrollmentModal = false;
    private bool showEmailNotificationModal = false;
    private bool showCancelEventModal = false;
    private bool isCreateMode = false;
    private bool isEditingEnrollment = false;
    private bool wantToPlay = false; // Toggle for "Quero tocar"
    private bool isUserAdmin = false;
    private bool isUserOwner = false;
    private bool isTrophyCreateMode = false;
    private Event? editingEvent;
    private Event? deletingEvent;
    private Event? selectedEvent;
    private Event? selectedEventForRepertoire;
    private Event? selectedEventForTrophies;
    private Event? selectedEventForEmail;
    private Event? selectedEventForCancellation;
    private Enrollment? enrollmentForm;
    private Enrollment? removingEnrollment;
    private Enrollment? deletingEnrollment;
    private Trophy? editingTrophy;
    private Trophy? deletingTrophy;
    private List<Trophy>? eventTrophies;
    private string? uploadedImagePath;
    private string dateValidationError = string.Empty;
    private bool showPastDateWarning = false;
    private bool isDateRange = false;
    private string eventTimeString = "19:00"; // Default to 19:00 (7 PM)
    private ImageCropper? imageCropper;
    private IBrowserFile? selectedFile;
    private ImageUploadManager? imageUploadManager;
    private int imageRefreshTrigger = 0;
    private byte[]? croppedImageBytes;
    private string? croppedImageFileName = "event-image.webp";

    // Previous events (admin only)
    private List<Event>? allPreviousEvents;
    private List<Event>? filteredPreviousEvents;
    private string previousEventsSearch = string.Empty;
    
    // Helper instances for previous events
    private SearchHelper<Event> searchHelper = new();
    private PaginationHelper<Event> paginationHelper = new() { PageSize = 6 };
    private List<Event> paginatedPreviousEvents => paginationHelper.GetPageData(filteredPreviousEvents ?? new List<Event>());
    
    // Enrollment modal filter variables
    private string enrollmentSearchTerm = string.Empty;
    private SortableTableHelper<Enrollment> enrollmentSortHelper = new() { SortColumn = "EnrolledAt", SortAscending = false };
    private List<Enrollment> filteredPerformingMembers = new();
    private List<Enrollment> filteredLeitoes = new();
    
    // Pagination for enrollment modals
    private PaginationHelper<Enrollment> performingMembersPagination = new() { PageSize = 8 };
    private PaginationHelper<Enrollment> leitoesPagination = new() { PageSize = 8 };
    private List<Enrollment> paginatedPerformingMembers => performingMembersPagination.GetPageData(filteredPerformingMembers ?? new List<Enrollment>());
    private List<Enrollment> paginatedLeitoes => leitoesPagination.GetPageData(filteredLeitoes ?? new List<Enrollment>());
    
    // Email notification modal variables
    private List<ApplicationUser>? subscribedUsers;
    private int subscribedUsersCount = 0;
    private int totalUsersCount = 0;
    private bool emailLoadingSubscribers = false;
    private string? emailErrorMessage;
    
    // Cancel event modal variables
    private bool notifySubscribersOnCancel = false;
    private string cancelEventReason = string.Empty;
    private List<ApplicationUser>? cancelEventSubscribedUsers;
    private int cancelEventSubscribedCount = 0;
    private int cancelEventTotalCount = 0;
    private bool cancelEventLoadingSubscribers = false;
    private string? cancelEventErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadEvents();
        await LoadPreviousEvents();
        await LoadEnrollments();
        await LoadCurrentUser();
        
        // Check for query parameters to auto-open create modal with pre-filled data
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        if (query["openModal"] == "true" && isUserAdmin)
        {
            // Pre-fill event creation modal from request data
            isCreateMode = true;
            uploadedImagePath = null;
            dateValidationError = string.Empty;
            showPastDateWarning = false;
            isDateRange = false;
            eventTimeString = "19:00";
            
            var name = query["name"];
            var location = query["location"];
            var dateStr = query["date"];
            var description = query["description"];
            
            var parsedDate = DateTime.TryParse(dateStr, out var date) ? date : DateTime.Today;
            var eventTime = TimeSpan.Parse(eventTimeString);
            
            editingEvent = new Event
            {
                Name = !string.IsNullOrEmpty(name) ? name : string.Empty,
                Location = !string.IsNullOrEmpty(location) ? location : string.Empty,
                Description = !string.IsNullOrEmpty(description) ? description : string.Empty,
                Date = parsedDate.Date.Add(eventTime),
                ImageUrl = string.Empty,
                Type = EventType.Atuacao
            };
            
            // Check if the date is in the past to show warning
            if (editingEvent.Date.Date < DateTime.Today)
            {
                showPastDateWarning = true;
            }
            
            showEditModal = true;
        }
    }

    private async Task LoadEvents()
    {
        events = (await EventService.GetUpcomingEventsAsync(100)).ToList();
    }

    private async Task LoadEnrollments()
    {
        enrollments = (await EnrollmentService.GetAllEnrollmentsAsync()).ToList();
    }

    private async Task LoadPreviousEvents()
    {
        allPreviousEvents = (await EventService.GetPastEventsAsync(100)).ToList();
        FilterPreviousEvents();
    }

    private void FilterPreviousEvents()
    {
        if (allPreviousEvents == null)
        {
            filteredPreviousEvents = new List<Event>();
            return;
        }

        // Use SearchHelper for filtering
        searchHelper.SearchTerm = previousEventsSearch;
        filteredPreviousEvents = searchHelper.FilterMultiple(allPreviousEvents, new List<Func<Event, string>>
        {
            e => e.Name ?? "",
            e => e.Location ?? "",
            e => e.Description ?? ""
        })
        .OrderByDescending(e => e.Date)
        .ToList();

        paginationHelper.Reset(); // Reset to first page when filtering
    }

    private async Task HandlePreviousEventsSearch(string searchTerm)
    {
        previousEventsSearch = searchTerm;
        FilterPreviousEvents();
        await Task.CompletedTask;
    }

    private async Task HandlePreviousEventsPageChange(int newPage)
    {
        paginationHelper.GoToPage(newPage);
        await Task.CompletedTask;
    }

    private async Task HandlePreviousEventsPageSizeChange(int newPageSize)
    {
        paginationHelper.PageSize = newPageSize;
        paginationHelper.Reset();
        await Task.CompletedTask;
    }

    private void ChangePreviousEventsPage(int newPage)
    {
        paginationHelper.GoToPage(newPage);
    }

    private async Task LoadCurrentUser()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.Name;

        if (!string.IsNullOrEmpty(userName))
        {
            currentUser = await UserManager.FindByNameAsync(userName);
            isUserAdmin = authState.User.IsInRole("Admin") || authState.User.IsInRole("Owner");
            isUserOwner = authState.User.IsInRole("Owner");
        }
    }

    private Enrollment? GetUserEnrollment(int eventId)
    {
        if (currentUser == null || enrollments == null) return null;
        return enrollments.FirstOrDefault(e => e.EventId == eventId && e.UserId == currentUser.Id);
    }

    private int GetEnrollmentCount(int eventId)
    {
        if (enrollments == null) return 0;
        return enrollments.Count(e => e.EventId == eventId && e.WillAttend);
    }

    private void OpenCreateModal()
    {
        isCreateMode = true;
        uploadedImagePath = null;
        dateValidationError = string.Empty;
        showPastDateWarning = false;
        isDateRange = false;
        eventTimeString = "19:00"; // Default to 19:00
        
        var eventTime = TimeSpan.Parse(eventTimeString);
        editingEvent = new Event
        {
            Date = DateTime.Today.Add(eventTime),
            Name = string.Empty,
            Description = string.Empty,
            ImageUrl = string.Empty,
            Location = string.Empty,
            Type = EventType.Atuacao
        };
        showEditModal = true;
    }

    private void OpenEditModal(Event eventItem)
    {
        isCreateMode = false;
        uploadedImagePath = null;
        dateValidationError = string.Empty;
        showPastDateWarning = false;
        
        // Detect if this is a date range (has EndDate and different from Date)
        isDateRange = eventItem.EndDate.HasValue && eventItem.EndDate.Value.Date != eventItem.Date.Date;
        
        // Extract time from the DateTime
        eventTimeString = eventItem.Date.ToString("HH:mm");
        
        editingEvent = new Event
        {
            Id = eventItem.Id,
            Name = eventItem.Name,
            Date = eventItem.Date,
            EndDate = eventItem.EndDate,
            Description = eventItem.Description,
            ImageUrl = eventItem.ImageUrl,
            Location = eventItem.Location,
            Type = eventItem.Type,
            CreatedAt = eventItem.CreatedAt
        };
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingEvent = null;
        uploadedImagePath = null;
        showPastDateWarning = false;
    }

    private async Task HandleImageUpload(IBrowserFile file)
    {
        try
        {
            if (file != null)
            {
                var maxFileSize = 10 * 1024 * 1024;
                if (file.Size > maxFileSize)
                {
                    return;
                }

                selectedFile = file;

                if (imageCropper != null)
                {
                    await imageCropper.LoadImageAsync(selectedFile);
                }
            }
        }
        catch (Exception)
        {
            // Handle error silently or show message
        }
    }

    private void OnImageCropped(byte[] croppedImageData)
    {
        try
        {
            if (editingEvent != null && croppedImageData != null && croppedImageData.Length > 0)
            {
                // Store the cropped image bytes for upload when saving
                croppedImageBytes = croppedImageData;
                uploadedImagePath = "uploaded";
                
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            // Handle error
        }
    }

    private void OnCropperModalChanged(bool isOpen)
    {
        showCropperModal = isOpen;
        StateHasChanged();
    }

    private async Task SaveEvent()
    {
        if (editingEvent == null) return;

        // Clear any validation errors
        dateValidationError = string.Empty;

        if (isCreateMode)
        {
            var newEvent = await EventService.CreateEventAsync(
                editingEvent.Name,
                editingEvent.Date,
                editingEvent.Location,
                editingEvent.Type,
                editingEvent.Description ?? string.Empty
            );

            // Update with EndDate if provided
            await EventService.UpdateEventAsync(
                newEvent.Id,
                newEvent.Name,
                newEvent.Date,
                newEvent.Location,
                newEvent.Description ?? string.Empty,
                editingEvent.EndDate
            );

            // Upload image to R2 if one was cropped
            if (croppedImageBytes != null && croppedImageBytes.Length > 0)
            {
                using var stream = new MemoryStream(croppedImageBytes);
                await EventService.SetEventImageAsync(newEvent.Id, stream, croppedImageFileName!, "image/webp");
            }
        }
        else
        {
            await EventService.UpdateEventAsync(
                editingEvent.Id,
                editingEvent.Name,
                editingEvent.Date,
                editingEvent.Location,
                editingEvent.Description ?? string.Empty,
                editingEvent.EndDate
            );

            // Upload new image to R2 if one was cropped
            if (croppedImageBytes != null && croppedImageBytes.Length > 0 && uploadedImagePath != null)
            {
                using var stream = new MemoryStream(croppedImageBytes);
                await EventService.SetEventImageAsync(editingEvent.Id, stream, croppedImageFileName!, "image/webp");
                imageRefreshTrigger++;
            }
        }

        await LoadEvents();
        await LoadPreviousEvents();
        CloseEditModal();
    }

    private void OpenDeleteModal(Event eventItem)
    {
        deletingEvent = eventItem;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        deletingEvent = null;
    }

    private async Task DeleteEvent()
    {
        if (deletingEvent == null) return;

        await EventService.DeleteEventAsync(deletingEvent.Id);
        await LoadEvents();
        await LoadPreviousEvents();

        CloseDeleteModal();
    }

    // Enrollment methods
    private void OpenEnrollModal(Event eventItem)
    {
        if (currentUser == null) return;

        isEditingEnrollment = false;
        selectedEvent = eventItem;
        wantToPlay = true; // Default to showing instrument field
        enrollmentForm = new Enrollment
        {
            UserId = currentUser.Id,
            EventId = eventItem.Id,
            Instrument = null,
            Notes = string.Empty
        };
        showEnrollModal = true;
    }

    private void OpenEditEnrollmentModal(Enrollment enrollment)
    {
        isEditingEnrollment = true;
        selectedEvent = events?.FirstOrDefault(e => e.Id == enrollment.EventId);
        wantToPlay = enrollment.Instrument.HasValue; // Set toggle based on whether instrument is set
        enrollmentForm = new Enrollment
        {
            Id = enrollment.Id,
            UserId = enrollment.UserId,
            EventId = enrollment.EventId,
            Instrument = enrollment.Instrument,
            Notes = enrollment.Notes,
            WillAttend = enrollment.WillAttend
        };
        showEnrollModal = true;
    }

    private void CloseEnrollModal()
    {
        showEnrollModal = false;
        enrollmentForm = null;
        selectedEvent = null;
        isEditingEnrollment = false;
        wantToPlay = false;
    }

    private async Task SaveEnrollment()
    {
        if (enrollmentForm == null || currentUser == null) return;

        if (isEditingEnrollment)
        {
            var existingEnrollment = await EnrollmentService.GetEnrollmentByIdAsync(enrollmentForm.Id);
            if (existingEnrollment != null && existingEnrollment.UserId == currentUser.Id)
            {
                // Update enrollment - delete old and create new with updated data
                await EnrollmentService.DeleteEnrollmentAsync(enrollmentForm.Id);
                await EnrollmentService.CreateEnrollmentAsync(
                    enrollmentForm.UserId,
                    enrollmentForm.EventId,
                    enrollmentForm.Instrument,
                    enrollmentForm.Notes,
                    enrollmentForm.WillAttend
                );
            }
        }
        else
        {
            await EnrollmentService.CreateEnrollmentAsync(
                enrollmentForm.UserId,
                enrollmentForm.EventId,
                enrollmentForm.Instrument,
                enrollmentForm.Notes,
                enrollmentForm.WillAttend
            );
        }

        await LoadEnrollments();
        CloseEnrollModal();
        StateHasChanged();
    }

    private void OpenRemoveEnrollmentModal(Enrollment enrollment)
    {
        removingEnrollment = enrollment;
        showRemoveEnrollmentModal = true;
    }

    private void CloseRemoveEnrollmentModal()
    {
        showRemoveEnrollmentModal = false;
        removingEnrollment = null;
    }

    private async Task RemoveEnrollment()
    {
        if (removingEnrollment == null || currentUser == null) return;

        var enrollmentToRemove = await EnrollmentService.GetEnrollmentByIdAsync(removingEnrollment.Id);
        if (enrollmentToRemove != null && enrollmentToRemove.UserId == currentUser.Id)
        {
            await EnrollmentService.DeleteEnrollmentAsync(removingEnrollment.Id);
            await LoadEnrollments();
        }

        CloseRemoveEnrollmentModal();
        StateHasChanged();
    }

    private async Task OpenEnrollmentListModal(Event eventItem)
    {
        selectedEvent = eventItem;
        eventEnrollments = (await EnrollmentService.GetEnrollmentsByEventIdAsync(eventItem.Id)).ToList();
        enrollmentSearchTerm = string.Empty;
        enrollmentSortHelper = new() { SortColumn = "EnrolledAt", SortAscending = false };
        FilterEnrollments();
        showEnrollmentListModal = true;
    }

    private void CloseEnrollmentListModal()
    {
        showEnrollmentListModal = false;
        selectedEvent = null;
        eventEnrollments = null;
        filteredPerformingMembers.Clear();
        filteredLeitoes.Clear();
    }
    
    private void FilterEnrollments()
    {
        if (eventEnrollments == null)
        {
            filteredPerformingMembers = new List<Enrollment>();
            filteredLeitoes = new List<Enrollment>();
            return;
        }
        
        var performingMembers = eventEnrollments
            .Where(e => e.User != null && e.WillAttend && !e.User.Categories.Contains(MemberCategory.Leitao))
            .ToList();
        
        var leitaoMembers = eventEnrollments
            .Where(e => e.User != null && e.WillAttend && e.User.Categories.Contains(MemberCategory.Leitao))
            .ToList();
        
        // Apply search filter to performing members
        if (!string.IsNullOrWhiteSpace(enrollmentSearchTerm))
        {
            var searchTerms = enrollmentSearchTerm.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries)
                .Select(t => t.ToLower())
                .ToArray();
            
            performingMembers = performingMembers.Where(e =>
            {
                if (e.User == null) return false;
                
                var searchableText = $"{e.User.FirstName} {e.User.LastName} {e.User.Nickname}".ToLower();
                return searchTerms.All(term => searchableText.Contains(term));
            }).ToList();
        }
        
        filteredPerformingMembers = performingMembers;
        filteredLeitoes = leitaoMembers.OrderBy(e => e.User?.FirstName).ToList();
        
        // Reset to page 1 when search changes
        performingMembersPagination.CurrentPage = 1;
        leitoesPagination.CurrentPage = 1;
        
        ApplySortToEnrollments();
    }
    
    private void HandlePerformingMembersPageChange(int page)
    {
        performingMembersPagination.CurrentPage = page;
        StateHasChanged();
    }

    private void HandlePerformingMembersPageSizeChange(int pageSize)
    {
        performingMembersPagination.PageSize = pageSize;
        performingMembersPagination.CurrentPage = 1;
        StateHasChanged();
    }

    private void HandleLeitoesPageChange(int page)
    {
        leitoesPagination.CurrentPage = page;
        StateHasChanged();
    }

    private void HandleLeitoesPageSizeChange(int pageSize)
    {
        leitoesPagination.PageSize = pageSize;
        leitoesPagination.CurrentPage = 1;
        StateHasChanged();
    }
    
    private void SortEnrollmentsBy(string column)
    {
        enrollmentSortHelper.ChangeSortColumn(column);
        ApplySortToEnrollments();
    }
    
    private void ApplySortToEnrollments()
    {
        if (filteredPerformingMembers == null || !filteredPerformingMembers.Any())
            return;
        
        var columnSelectors = new Dictionary<string, Func<Enrollment, IComparable>>
        {
            [nameof(ApplicationUser.FirstName)] = e => e.User?.FirstName ?? "",
            ["Category"] = e =>
            {
                if (e.User == null) return "3";
                if (e.User.Positions.Contains(Position.Magister)) return "0";
                if (e.User.Categories.Contains(MemberCategory.Tuno)) return "1";
                if (e.User.Categories.Contains(MemberCategory.Caloiro)) return "2";
                return "3";
            },
            ["Instrument"] = e => e.Instrument?.ToString() ?? "ZZZ",
            ["EnrolledAt"] = e => e.EnrolledAt
        };
        
        filteredPerformingMembers = enrollmentSortHelper.ApplySort(filteredPerformingMembers, columnSelectors);
    }

    private string GetEventTypeDisplay(EventType type)
    {
        return type switch
        {
            EventType.Atuacao => "Atuação",
            _ => type.ToString()
        };
    }

    private string GetEventDateDisplay(Event eventItem)
    {
        if (eventItem.EndDate.HasValue && eventItem.EndDate.Value.Date != eventItem.Date.Date)
        {
            // Date range
            return $"{eventItem.Date:dd MMM} - {eventItem.EndDate.Value:dd MMM yyyy}";
        }
        else if (eventItem.Date.TimeOfDay != TimeSpan.Zero)
        {
            // Single date with time
            return $"{eventItem.Date:dd MMM yyyy}, {eventItem.Date:HH:mm}h";
        }
        else
        {
            // Single date without time (all-day)
            return eventItem.Date.ToString("dd MMM yyyy");
        }
    }

    // Repertoire modal methods
    private void OpenRepertoireModal(Event eventItem)
    {
        selectedEventForRepertoire = eventItem;
        showRepertoireModal = true;
    }

    private void OpenEventDetailsModal(Event eventItem)
    {
        selectedEvent = eventItem;
        showEventDetailsModal = true;
    }

    private async Task HandleRepertoireChanged()
    {
        // Refresh data if needed
        await Task.CompletedTask;
    }

    // Trophy modal methods
    private async Task OpenTrophyModal(Event eventItem)
    {
        selectedEventForTrophies = eventItem;
        eventTrophies = (await TrophyService.GetByEventIdAsync(eventItem.Id)).ToList();
        showTrophyModal = true;
    }

    private void CloseTrophyModal()
    {
        showTrophyModal = false;
        selectedEventForTrophies = null;
        eventTrophies = null;
    }

    private void OpenCreateTrophyModal()
    {
        if (selectedEventForTrophies == null) return;
        
        editingTrophy = new Trophy(selectedEventForTrophies.Id);
        isTrophyCreateMode = true;
        showTrophyEditModal = true;
    }

    private void OpenEditTrophyModal(Trophy trophy)
    {
        editingTrophy = trophy;
        isTrophyCreateMode = false;
        showTrophyEditModal = true;
    }

    private void CloseTrophyEditModal()
    {
        showTrophyEditModal = false;
        editingTrophy = null;
        isTrophyCreateMode = false;
    }

    private async Task SaveTrophy()
    {
        if (editingTrophy == null) return;

        try
        {
            if (isTrophyCreateMode)
            {
                await TrophyService.CreateAsync(editingTrophy);
            }
            else
            {
                await TrophyService.UpdateAsync(editingTrophy);
            }

            // Refresh trophy list
            if (selectedEventForTrophies != null)
            {
                eventTrophies = (await TrophyService.GetByEventIdAsync(selectedEventForTrophies.Id)).ToList();
            }

            CloseTrophyEditModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving trophy: {ex.Message}");
        }
    }

    private void OpenDeleteTrophyModal(Trophy trophy)
    {
        deletingTrophy = trophy;
        showTrophyDeleteModal = true;
    }

    private void CloseTrophyDeleteModal()
    {
        showTrophyDeleteModal = false;
        deletingTrophy = null;
    }

    private async Task DeleteTrophy()
    {
        if (deletingTrophy == null) return;

        try
        {
            await TrophyService.DeleteAsync(deletingTrophy.Id);

            // Refresh trophy list
            if (selectedEventForTrophies != null)
            {
                eventTrophies = (await TrophyService.GetByEventIdAsync(selectedEventForTrophies.Id)).ToList();
            }

            CloseTrophyDeleteModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting trophy: {ex.Message}");
        }
    }
    
    // Owner-only enrollment deletion methods
    private void OpenDeleteEnrollmentModal(Enrollment enrollment)
    {
        deletingEnrollment = enrollment;
        showDeleteEnrollmentModal = true;
    }
    
    private void CloseDeleteEnrollmentModal()
    {
        showDeleteEnrollmentModal = false;
        deletingEnrollment = null;
    }
    
    private async Task DeleteEnrollment()
    {
        if (deletingEnrollment == null) return;
        
        try
        {
            await EnrollmentService.DeleteEnrollmentAsync(deletingEnrollment.Id);
            
            // Refresh the enrollment list for the selected event
            if (selectedEvent != null)
            {
                eventEnrollments = (await EnrollmentService.GetEnrollmentsByEventIdAsync(selectedEvent.Id)).ToList();
                enrollmentSearchTerm = string.Empty;
                FilterEnrollments();
            }
            
            // Also reload general enrollments to update counts
            await LoadEnrollments();
            
            CloseDeleteEnrollmentModal();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting enrollment: {ex.Message}");
        }
    }
    
    private string GetEventImageUrl(string imageSrc)
    {
        if (string.IsNullOrEmpty(imageSrc)) return string.Empty;
        
        // Add refresh trigger only when an image has been updated
        // This forces browser to re-fetch after edits while maintaining ETag caching
        if (imageRefreshTrigger > 0 && imageSrc.StartsWith("/api/images/"))
        {
            return $"{imageSrc}?r={imageRefreshTrigger}";
        }
        
        return imageSrc;
    }

    // Email notification methods
    private async Task OpenEmailNotificationModal(Event eventItem)
    {
        selectedEventForEmail = eventItem;
        emailLoadingSubscribers = true;
        emailErrorMessage = null;
        showEmailNotificationModal = true;
        StateHasChanged();

        try
        {
            // Get all users with Subscribed = true and EmailConfirmed = true
            var allUsers = await UserManager.Users.ToListAsync();
            subscribedUsers = allUsers
                .Where(u => u.Subscribed && u.EmailConfirmed)
                .OrderBy(u => u.Nickname ?? u.FirstName)
                .ToList();
            
            subscribedUsersCount = subscribedUsers.Count;
            totalUsersCount = allUsers.Count(u => u.EmailConfirmed);
        }
        catch (Exception ex)
        {
            emailErrorMessage = $"Erro ao carregar membros: {ex.Message}";
        }
        finally
        {
            emailLoadingSubscribers = false;
            StateHasChanged();
        }
    }

    private void CloseEmailNotificationModal()
    {
        showEmailNotificationModal = false;
        selectedEventForEmail = null;
        subscribedUsers = null;
        subscribedUsersCount = 0;
        totalUsersCount = 0;
        emailErrorMessage = null;
    }

    private async Task SendEventNotification()
    {
        if (selectedEventForEmail == null || subscribedUsers == null || !subscribedUsers.Any())
        {
            CloseEmailNotificationModal();
            return;
        }

        StateHasChanged();

        try
        {
            // Get the event link (absolute URL)
            var baseUri = Navigation.BaseUri.TrimEnd('/');
            var eventLink = $"{baseUri}/events";

            // Get recipient emails
            var recipientEmails = subscribedUsers
                .Where(u => !string.IsNullOrWhiteSpace(u.Email))
                .Select(u => u.Email!)
                .ToList();

            // Build recipient data dictionary with nickname and full name
            var recipientData = subscribedUsers
                .Where(u => !string.IsNullOrWhiteSpace(u.Email))
                .ToDictionary(
                    u => u.Email!,
                    u => (
                        nickname: u.Nickname ?? "",
                        fullName: $"{u.FirstName ?? ""} {u.LastName ?? ""}".Trim()
                    )
                );

            // Send the email
            var (success, count, errorMessage) = await EmailNotificationService.SendEventNotificationAsync(
                selectedEventForEmail.Id,
                selectedEventForEmail.Name,
                selectedEventForEmail.Date,
                selectedEventForEmail.Location,
                eventLink,
                recipientEmails,
                recipientData
            );

            if (success)
            {
                // Close modal on success
                CloseEmailNotificationModal();
                
                // Could show a success toast here if implemented
                // For now, just close the modal
            }
            else
            {
                emailErrorMessage = errorMessage ?? "Erro ao enviar notificação.";
            }
        }
        catch (Exception ex)
        {
            emailErrorMessage = $"Erro ao enviar notificação: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void OnDateChanged()
    {
        if (editingEvent != null)
        {
            showPastDateWarning = editingEvent.Date.Date < DateTime.Today;
            
            // When date changes and not a date range, update the time component
            if (!isDateRange && TimeSpan.TryParse(eventTimeString, out var time))
            {
                editingEvent.Date = editingEvent.Date.Date.Add(time);
            }
            
            StateHasChanged();
        }
    }
    
    private void OnTimeChanged()
    {
        if (editingEvent != null && !isDateRange && TimeSpan.TryParse(eventTimeString, out var time))
        {
            // Update the event date with the new time
            editingEvent.Date = editingEvent.Date.Date.Add(time);
            StateHasChanged();
        }
    }
    
    private void OnDateRangeToggled()
    {
        if (editingEvent != null)
        {
            if (isDateRange)
            {
                // Switching to date range mode - set time to midnight
                editingEvent.Date = editingEvent.Date.Date;
                editingEvent.EndDate = null;
            }
            else
            {
                // Switching to single date mode - add the time component
                if (TimeSpan.TryParse(eventTimeString, out var time))
                {
                    editingEvent.Date = editingEvent.Date.Date.Add(time);
                }
                editingEvent.EndDate = null;
            }
            StateHasChanged();
        }
    }
    
    // Cancel event methods
    private async Task OpenCancelEventModal(Event eventItem)
    {
        selectedEventForCancellation = eventItem;
        notifySubscribersOnCancel = false;
        cancelEventReason = string.Empty;
        cancelEventLoadingSubscribers = true;
        cancelEventErrorMessage = null;
        showCancelEventModal = true;
        StateHasChanged();

        try
        {
            // Get all users with Subscribed = true and EmailConfirmed = true
            var allUsers = await UserManager.Users.ToListAsync();
            cancelEventSubscribedUsers = allUsers
                .Where(u => u.Subscribed && u.EmailConfirmed)
                .OrderBy(u => u.Nickname ?? u.FirstName)
                .ToList();
            
            cancelEventSubscribedCount = cancelEventSubscribedUsers.Count;
            cancelEventTotalCount = allUsers.Count(u => u.EmailConfirmed);
        }
        catch (Exception ex)
        {
            cancelEventErrorMessage = $"Erro ao carregar membros: {ex.Message}";
        }
        finally
        {
            cancelEventLoadingSubscribers = false;
            StateHasChanged();
        }
    }

    private void CloseCancelEventModal()
    {
        showCancelEventModal = false;
        selectedEventForCancellation = null;
        notifySubscribersOnCancel = false;
        cancelEventReason = string.Empty;
        cancelEventSubscribedUsers = null;
        cancelEventSubscribedCount = 0;
        cancelEventTotalCount = 0;
        cancelEventErrorMessage = null;
    }

    private async Task ConfirmCancelEvent()
    {
        if (selectedEventForCancellation == null || string.IsNullOrWhiteSpace(cancelEventReason))
        {
            cancelEventErrorMessage = "O motivo do cancelamento é obrigatório.";
            StateHasChanged();
            return;
        }

        try
        {
            // Cancel the event
            await EventService.CancelEventAsync(selectedEventForCancellation.Id, cancelEventReason);

            // Send notification emails if checkbox is selected
            if (notifySubscribersOnCancel && cancelEventSubscribedUsers != null && cancelEventSubscribedUsers.Any())
            {
                var baseUri = Navigation.BaseUri.TrimEnd('/');
                var eventLink = $"{baseUri}/events";

                // Get recipient emails
                var recipientEmails = cancelEventSubscribedUsers
                    .Where(u => !string.IsNullOrWhiteSpace(u.Email))
                    .Select(u => u.Email!)
                    .ToList();

                // Build recipient data dictionary with nickname and full name
                var recipientData = cancelEventSubscribedUsers
                    .Where(u => !string.IsNullOrWhiteSpace(u.Email))
                    .ToDictionary(
                        u => u.Email!,
                        u => (
                            nickname: u.Nickname ?? "",
                            fullName: $"{u.FirstName ?? ""} {u.LastName ?? ""}".Trim()
                        )
                    );

                // Send the cancellation notification email
                await EmailNotificationService.SendEventCancellationNotificationAsync(
                    selectedEventForCancellation.Id,
                    selectedEventForCancellation.Name,
                    selectedEventForCancellation.Date,
                    selectedEventForCancellation.Location,
                    cancelEventReason,
                    eventLink,
                    recipientEmails,
                    recipientData
                );
            }

            // Reload events
            await LoadEvents();
            await LoadPreviousEvents();

            CloseCancelEventModal();
        }
        catch (Exception ex)
        {
            cancelEventErrorMessage = $"Erro ao cancelar evento: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task UncancelEvent(Event eventItem)
    {
        try
        {
            await EventService.UncancelEventAsync(eventItem.Id);
            await LoadEvents();
            await LoadPreviousEvents();
        }
        catch (Exception ex)
        {
            // Could show an error message here
            Console.WriteLine($"Error uncanceling event: {ex.Message}");
        }
    }
}

