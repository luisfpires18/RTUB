@page "/requests"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using RTUB.Core.Enums
@using RTUB.Application.Interfaces
@using RTUB.Application.Extensions
@using RTUB.Application.Helpers
@using RTUB.Shared
@attribute [Authorize]
@inherits CrudTablePageBase<Request>
@inject IRequestService RequestService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<h1>Gestão de Pedidos</h1>
<p class="lead mb-4 lead-light">Gerir todos os pedidos submetidos através do website.</p>

<!-- Search and Filter Controls -->
<div class="row mb-3">
    <div class="col-md-6">
        <TableSearchBar 
            SearchTerm="@SearchTerm"
            OnSearchChanged="UpdateSearch"
            Placeholder="Pesquisar por nome, email, tipo de evento..." />
    </div>
    <div class="col-md-3">
        <FilterDropdown 
            Items="@statusFilterOptions"
            SelectedValue="@selectedStatusFilter"
            SelectedValueChanged="@((value) => { selectedStatusFilter = value; ApplyFiltersAndPagination(); })"
            AllItemsLabel="Todos os Estados"
            IconClass="bi-funnel" />
    </div>
</div>

<!-- Pending Requests Grid -->
<h3 class="mt-4 mb-3">Pedidos Pendentes</h3>
@if (PendingRequests.Any())
{
    <div class="request-grid">
        @foreach (var req in PaginatedPendingRequests)
        {
            <AuthorizeView Roles="Owner">
                <Authorized Context="ownerContext">
                    <RequestCard Request="@req"
                                IsOwner="true"
                                ShowAdminActions="@isAdmin"
                                OnViewDetails="@(() => ViewRequest(req))"
                                OnDelete="@(() => OpenDeleteModal(req))"
                                OnApprove="@(() => OpenApproveModal(req))"
                                OnReject="@(() => OpenRejectModal(req))" />
                </Authorized>
                <NotAuthorized>
                    <RequestCard Request="@req"
                                IsOwner="false"
                                ShowAdminActions="@isAdmin"
                                OnViewDetails="@(() => ViewRequest(req))"
                                OnDelete="@(() => {})"
                                OnApprove="@(() => OpenApproveModal(req))"
                                OnReject="@(() => OpenRejectModal(req))" />
                </NotAuthorized>
            </AuthorizeView>
        }
    </div>

    <!-- Pagination for Pending -->
    <TablePagination 
        CurrentPage="@pendingPagination.CurrentPage"
        PageSize="@pendingPagination.PageSize"
        TotalItems="@PendingRequests.Count"
        ItemLabel="pedidos pendentes"
        PageSizeOptions="@(new[] { 4, 8, 12, 16, 20 })"
        OnPageChanged="@((page) => { pendingPagination.GoToPage(page); UpdatePendingPagination(); })"
        OnPageSizeChanged="@((size) => { pendingPagination.PageSize = size; pendingPagination.Reset(); UpdatePendingPagination(); })" />
}
else
{
    <EmptyState 
        Title="Nenhum pedido pendente encontrado." 
        Icon="bi-info-circle" />
}

<!-- Answered Requests Grid -->
<h3 class="mt-5 mb-3">Pedidos Respondidos</h3>
@if (AnsweredRequests.Any())
{
    <div class="request-grid">
        @foreach (var req in PaginatedAnsweredRequests)
        {
            <AuthorizeView Roles="Owner">
                <Authorized Context="ownerContext">
                    <RequestCard Request="@req"
                                IsOwner="true"
                                ShowAdminActions="false"
                                OnViewDetails="@(() => ViewRequest(req))"
                                OnDelete="@(() => OpenDeleteModal(req))"
                                OnApprove="@(() => {})"
                                OnReject="@(() => {})" />
                </Authorized>
                <NotAuthorized>
                    <RequestCard Request="@req"
                                IsOwner="false"
                                ShowAdminActions="false"
                                OnViewDetails="@(() => ViewRequest(req))"
                                OnDelete="@(() => {})"
                                OnApprove="@(() => {})"
                                OnReject="@(() => {})" />
                </NotAuthorized>
            </AuthorizeView>
        }
    </div>

    <!-- Pagination for Answered -->
    <TablePagination 
        CurrentPage="@answeredPagination.CurrentPage"
        PageSize="@answeredPagination.PageSize"
        TotalItems="@AnsweredRequests.Count"
        ItemLabel="pedidos respondidos"
        PageSizeOptions="@(new[] { 4, 8, 12, 16, 20 })"
        OnPageChanged="@((page) => { answeredPagination.GoToPage(page); UpdateAnsweredPagination(); })"
        OnPageSizeChanged="@((size) => { answeredPagination.PageSize = size; answeredPagination.Reset(); UpdateAnsweredPagination(); })" />
}
else
{
    <EmptyState 
        Title="Nenhum pedido respondido encontrado." 
        Icon="bi-info-circle" />
}
<!-- View Details Modal using DetailsModal -->
<DetailsModal Show="@(selectedRequest != null)" 
              ShowChanged="@((bool show) => { if (!show) CloseModal(); })" 
              Title="Detalhes do Pedido"
              HeaderTitle="@(selectedRequest?.Name ?? "")"
              IconClass="bi-envelope-fill">
    <BadgesContent>
        @if (selectedRequest != null)
        {
            <StatusBadge Status="@selectedRequest.Status" />
        }
    </BadgesContent>
    <Sections>
        @if (selectedRequest != null)
        {
            <!-- Contact Information Section -->
            <InfoSection SectionTitle="Informação de Contacto" 
                        IconClass="bi-person-fill" 
                        CssClass="mb-4">
                <ProfileField Label="Nome" Value="@selectedRequest.Name" />
                <ProfileField Label="Email" Value="@selectedRequest.Email" />
                <ProfileField Label="Telefone" Value="@selectedRequest.Phone" />
            </InfoSection>

            <!-- Event Information Section -->
            <InfoSection SectionTitle="Informação do Evento" 
                        IconClass="bi-calendar-event-fill" 
                        CssClass="mb-4">
                <ProfileField Label="Tipo de Evento" Value="@selectedRequest.EventType" />
                <ProfileField Label="Data Preferida" Value="@selectedRequest.PreferredDate.ToPortugueseShortDate()" />
                <ProfileField Label="Localização" Value="@selectedRequest.Location" />
                <ProfileField Label="Submetido" Value="@selectedRequest.CreatedAt.ToPortugueseDateTime()" />
            </InfoSection>

            <!-- Additional Information Section -->
            @if (!string.IsNullOrEmpty(selectedRequest.Message))
            {
                <InfoSection SectionTitle="Informações Adicionais" 
                            IconClass="bi-file-text" 
                            CssClass="mb-4">
                    <p class="text-white-full mb-0" style="white-space: pre-line;">@selectedRequest.Message</p>
                </InfoSection>
            }
        }
    </Sections>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Fechar</button>
    </FooterContent>
</DetailsModal>

<!-- Approve Confirmation Dialog -->
<ConfirmDialog Show="@showApproveDialog"
               ShowChanged="@((bool show) => showApproveDialog = show)"
               Title="Aprovar Pedido"
               Message="@($"Deseja aprovar o pedido de {approvingRequest?.Name}?")"
               ConfirmText="Aprovar"
               CancelText="Cancelar"
               ConfirmButtonClass="btn-success"
               OnConfirm="ConfirmApprove"
               OnCancel="@(() => { showApproveDialog = false; approvingRequest = null; })" />

<!-- Create Event Dialog -->
<ConfirmDialog Show="@showCreateEventDialog"
               ShowChanged="@((bool show) => showCreateEventDialog = show)"
               Title="Criar Evento"
               Message="@($"Pedido aprovado! Deseja criar um evento associado a este pedido?")"
               ConfirmText="Sim"
               CancelText="Não"
               ConfirmButtonClass="btn-primary"
               OnConfirm="CreateEventFromRequest"
               OnCancel="@(() => { showCreateEventDialog = false; approvingRequest = null; })" />

<!-- Reject Confirmation Dialog -->
<ConfirmDialog Show="@showRejectDialog"
               ShowChanged="@((bool show) => showRejectDialog = show)"
               Title="Rejeitar Pedido"
               WarningMessage="Esta ação não pode ser revertida."
               ConfirmText="Rejeitar"
               CancelText="Cancelar"
               ConfirmButtonClass="btn-danger"
               OnConfirm="ConfirmReject"
               OnCancel="@(() => { showRejectDialog = false; rejectingRequest = null; })">
    <BodyContent>
        <p>Tem a certeza que pretende rejeitar o pedido de <strong>@rejectingRequest?.Name</strong>?</p>
    </BodyContent>
</ConfirmDialog>

<!-- Delete Confirmation Modal -->
<ConfirmDialog Show="@(deletingRequest != null)"
               ShowChanged="@((bool show) => { if (!show) CloseDeleteModal(); })"
               Title="Confirmar Eliminação"
               WarningMessage="Esta ação não pode ser revertida."
               ConfirmText="Eliminar"
               CancelText="Cancelar"
               ConfirmButtonClass="btn-danger"
               OnConfirm="DeleteRequest"
               OnCancel="CloseDeleteModal">
    <BodyContent>
        <p>Tem a certeza que pretende eliminar o pedido de <strong>@deletingRequest?.Name</strong>?</p>
    </BodyContent>
</ConfirmDialog>

@code {
    private Request? selectedRequest = null;
    private Request? deletingRequest = null;
    private Request? approvingRequest = null;
    private Request? rejectingRequest = null;
    
    private bool showApproveDialog = false;
    private bool showCreateEventDialog = false;
    private bool showRejectDialog = false;
    private bool isAdmin = false;

    // Filter state
    private string selectedStatusFilter = string.Empty;
    private List<string> statusFilterOptions = new() { "Pendente", "Aprovado", "Rejeitado" };

    // Separate lists for pending and answered requests
    private List<Request> PendingRequests = new();
    private List<Request> AnsweredRequests = new();
    private List<Request> PaginatedPendingRequests = new();
    private List<Request> PaginatedAnsweredRequests = new();
    
    // Separate pagination helpers
    private PaginationHelper<Request> pendingPagination = new() { PageSize = 4 };
    private PaginationHelper<Request> answeredPagination = new() { PageSize = 4 };

    protected override async Task OnInitializedAsync()
    {
        SortHelper.SortColumn = nameof(Request.CreatedAt);
        SortHelper.SortAscending = false;
        await LoadItemsAsync();
        
        // Check if user is admin
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAdmin = user.IsInRole("Admin");
        
        ApplyFiltersAndPagination();
    }

    protected override async Task LoadItemsAsync()
    {
        var requests = await RequestService.GetAllRequestsAsync();
        AllItems = requests.ToList();
    }

    protected override Dictionary<string, Func<Request, IComparable>> GetSortColumnSelectors()
    {
        return new Dictionary<string, Func<Request, IComparable>>
        {
            [nameof(Request.Status)] = r => r.Status.ToString(),
            [nameof(Request.Name)] = r => r.Name ?? "",
            [nameof(Request.EventType)] = r => r.EventType ?? "",
            [nameof(Request.PreferredDate)] = r => r.PreferredDate,
            [nameof(Request.Location)] = r => r.Location ?? "",
            [nameof(Request.CreatedAt)] = r => r.CreatedAt
        };
    }

    protected override List<Func<Request, string>> GetSearchSelectors()
    {
        return new List<Func<Request, string>>
        {
            r => r.Name ?? "",
            r => r.Email ?? "",
            r => r.EventType ?? "",
            r => r.Location ?? "",
            r => r.Phone ?? ""
        };
    }

    protected override void ApplyFiltersAndPagination()
    {
        if (AllItems == null) return;

        // Apply search filter
        SearchHelper.SearchTerm = SearchTerm;
        FilteredItems = SearchHelper.FilterMultiple(AllItems, GetSearchSelectors());

        // Apply status filter if selected
        if (!string.IsNullOrEmpty(selectedStatusFilter))
        {
            FilteredItems = selectedStatusFilter switch
            {
                "Pendente" => FilteredItems.Where(r => r.Status == RequestStatus.Pending).ToList(),
                "Aprovado" => FilteredItems.Where(r => r.Status == RequestStatus.Confirmed).ToList(),
                "Rejeitado" => FilteredItems.Where(r => r.Status == RequestStatus.Rejected).ToList(),
                _ => FilteredItems
            };
        }

        // Apply sorting
        FilteredItems = SortHelper.ApplySort(FilteredItems, GetSortColumnSelectors());

        // Separate into pending and answered (this will filter the already filtered items)
        PendingRequests = FilteredItems.Where(r => r.Status == RequestStatus.Pending).ToList();
        AnsweredRequests = FilteredItems.Where(r => r.Status == RequestStatus.Confirmed || r.Status == RequestStatus.Rejected).ToList();

        // Reset pagination when filter changes
        pendingPagination.Reset();
        answeredPagination.Reset();

        // Update pagination for both grids
        UpdatePendingPagination();
        UpdateAnsweredPagination();
    }

    private void UpdatePendingPagination()
    {
        PaginatedPendingRequests = pendingPagination.GetPageData(PendingRequests);
    }

    private void UpdateAnsweredPagination()
    {
        PaginatedAnsweredRequests = answeredPagination.GetPageData(AnsweredRequests);
    }

    private void ViewRequest(Request request)
    {
        selectedRequest = request;
    }

    private void CloseModal()
    {
        selectedRequest = null;
    }

    private void OpenApproveModal(Request request)
    {
        approvingRequest = request;
        showApproveDialog = true;
    }

    private async Task ConfirmApprove()
    {
        if (approvingRequest != null)
        {
            await RequestService.UpdateRequestStatusAsync(approvingRequest.Id, RequestStatus.Confirmed);
            await RefreshDataAsync();
            showApproveDialog = false;
            CloseModal();
            
            // Show create event dialog
            showCreateEventDialog = true;
        }
    }

    private void CreateEventFromRequest()
    {
        if (approvingRequest != null)
        {
            // Build event name: "EventType em Location"
            var eventName = $"{approvingRequest.EventType} em {approvingRequest.Location}";
            
            // Build description: "Pedido de Name"
            var description = $"Pedido de {approvingRequest.Name}";
            
            // Navigate to events page with query parameters to pre-fill the modal
            var queryParams = new Dictionary<string, object?>
            {
                ["openModal"] = "true",
                ["name"] = eventName,
                ["location"] = approvingRequest.Location,
                ["date"] = approvingRequest.PreferredDate.ToString("yyyy-MM-dd"),
                ["description"] = description,
                ["type"] = "Atuacao", // Default event type
                ["requestId"] = approvingRequest.Id
            };
            
            var uri = Navigation.GetUriWithQueryParameters("/events", queryParams);
            Navigation.NavigateTo(uri);
        }
        
        showCreateEventDialog = false;
        approvingRequest = null;
    }

    private void OpenRejectModal(Request request)
    {
        rejectingRequest = request;
        showRejectDialog = true;
    }

    private async Task ConfirmReject()
    {
        if (rejectingRequest != null)
        {
            await RequestService.UpdateRequestStatusAsync(rejectingRequest.Id, RequestStatus.Rejected);
            await RefreshDataAsync();
            showRejectDialog = false;
            rejectingRequest = null;
            CloseModal();
        }
    }
    
    private void OpenDeleteModal(Request request)
    {
        deletingRequest = request;
    }
    
    private void CloseDeleteModal()
    {
        deletingRequest = null;
    }
    
    private async Task DeleteRequest()
    {
        if (deletingRequest != null)
        {
            await RequestService.DeleteRequestAsync(deletingRequest.Id);
            await RefreshDataAsync();
            CloseDeleteModal();
        }
    }
}

