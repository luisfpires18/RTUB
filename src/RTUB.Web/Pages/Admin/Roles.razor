@page "/admin/roles"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using RTUB.Application.Interfaces
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Shared
@inject IRoleAssignmentService RoleAssignmentService
@inject IFiscalYearService FiscalYearService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<h1>Cargos por Ano Fiscal</h1>
<p>Consultar e gerir cargos dos membros da RTUB por ano fiscal.</p>

<AuthorizeView>
    <Authorized>
        @{
            var isAdmin = context.User.IsInRole("Admin");
            var isMember = context.User.IsInRole("Member") || isAdmin;
        }

        @if (isAdmin)
        {
            <div class="mb-3">
                <button class="btn btn-success" @onclick="OpenCreateFiscalYearModal">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        }

        <!-- Fiscal Year Selector (Member and Admin only) -->
        @if (isMember)
        {
            @if (fiscalYears.Any())
            {
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Selecionar Ano Fiscal</label>
                        <div class="input-group">
                            <select class="form-select" @bind="selectedFiscalYear" @bind:after="LoadRoleAssignments">
                                @foreach (var year in fiscalYears)
                                {
                                    var isCurrent = year == currentFiscalYear;
                                    <option value="@year">@year@(isCurrent ? " (ATUAL)" : "")</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            }
            else if (isAdmin)
            {
                <div class="card shadow-sm mb-4 card-purple-no-border">
                    <h5 class="card-title text-white"><i class="bi bi-info-circle"></i> Nenhum ano fiscal criado ainda</h5>
                </div>
            }
            else
            {
                <div class="card shadow-sm card-purple-no-border">
                    <div class="card-body">
                        <h5 class="card-title text-white"><i class="bi bi-info-circle"></i> Nenhum ano fiscal criado ainda</h5>
                        <p class="text-white mb-2 text-white-opacity">Aguarde a criação do primeiro ano fiscal por um administrador.</p>
                        <ul class="text-white mb-0 text-white-opacity">
                            <li>Os anos fiscais organizam cargos e responsabilidades</li>
                            <li>Cada ano fiscal tem direção, mesa e conselhos próprios</li>
                            <li>Consulte cargos passados e atuais</li>
                            <li>Mantenha o histórico organizacional da tuna</li>
                        </ul>
                    </div>
                </div>
            }
        }

        @if (string.IsNullOrEmpty(selectedFiscalYear) && fiscalYears.Any())
        {
            <p>A carregar dados...</p>
        }
        else if (fiscalYears.Any())
        {
            <h3>Cargos para @selectedFiscalYear</h3>

            <!-- All Positions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Cargos Atribuídos</h4>
                </div>
                <div class="card-body">
                    <h5 class="mb-3">Direção</h5>
                    @RenderPositionRow(Position.Magister, "Presidente (Magister)", isAdmin)
                    @RenderPositionRow(Position.ViceMagister, "Vice-Presidente (Vice-Magister)", isAdmin)
                    @RenderPositionRow(Position.Secretario, "Secretário", isAdmin)
                    @RenderPositionRow(Position.PrimeiroTesoureiro, "1.º Tesoureiro", isAdmin)
                    @RenderPositionRow(Position.SegundoTesoureiro, "2.º Tesoureiro", isAdmin)

                    <hr class="my-4" />
                    <h5 class="mb-3">Mesa da Assembleia</h5>
                    @RenderPositionRow(Position.PresidenteMesaAssembleia, "Presidente da Mesa", isAdmin)
                    @RenderPositionRow(Position.PrimeiroSecretarioMesaAssembleia, "1.º Secretário", isAdmin)
                    @RenderPositionRow(Position.SegundoSecretarioMesaAssembleia, "2.º Secretário", isAdmin)

                    <hr class="my-4" />
                    <h5 class="mb-3">Conselho Fiscal</h5>
                    @RenderPositionRow(Position.PresidenteConselhoFiscal, "Presidente do Conselho Fiscal", isAdmin)
                    @RenderPositionRow(Position.PrimeiroRelatorConselhoFiscal, "1º Relator", isAdmin)
                    @RenderPositionRow(Position.SegundoRelatorConselhoFiscal, "2º Relator", isAdmin)

                    <hr class="my-4" />
                    <h5 class="mb-3">Conselho de Veteranos</h5>
                    @RenderPositionRow(Position.PresidenteConselhoVeteranos, "Presidente do Conselho de Veteranos", isAdmin)
                </div>
            </div>
        }
    </Authorized>
</AuthorizeView>

<!-- Create Fiscal Year Modal (Admin only) -->
<Modal Show="@showCreateFiscalYearModal" 
       ShowChanged="@((bool show) => showCreateFiscalYearModal = show)"
       Title="Criar Novo Ano Fiscal" 
       Size="Modal.ModalSize.Default"
       Centered="true">
    <BodyContent>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        <div class="mb-3">
            <label class="form-label">Ano de Início</label>
            <input type="number" class="form-control" @bind="newStartYear" min="1900" max="2100" />
            <small class="text-muted">O ano fiscal será criado automaticamente como @newStartYear-@(newStartYear + 1)</small>
        </div>
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseCreateFiscalYearModal">Cancelar</button>
        <button type="button" class="btn btn-primary" @onclick="CreateFiscalYear">Criar</button>
    </FooterContent>
</Modal>

<!-- Assign Member Modal (Admin only) -->
<Modal Show="@showAssignMemberModal" 
       ShowChanged="@((bool show) => showAssignMemberModal = show)"
       Title="@("Atribuir Membro ao Cargo: " + selectedPositionName)" 
       Size="Modal.ModalSize.Large"
       Centered="true">
    <BodyContent>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        <div class="mb-3">
            <label class="form-label">Pesquisar Membro</label>
            <input type="text" class="form-control" placeholder="Inserir nome, email ou tuna name..."
                   @bind="memberSearchTerm" @bind:event="oninput" @onkeyup="FilterMembers" />
        </div>
        @if (filteredMembers.Any())
        {
            <div class="member-list member-list-scrollable">
                @foreach (var member in filteredMembers.Take(20))
                {
                    <div class="member-item p-2 mb-2 border rounded clickable-row"
                         @onclick="() => SelectMember(member)">
                        <div class="d-flex align-items-center">
                            <img src="@member.ProfilePictureSrc" alt="@member.GetDisplayName()"
                                 class="member-avatar-small me-2" />
                            <div>
                                @if (!string.IsNullOrEmpty(member.Nickname))
                                {
                                    <div><strong>@member.Nickname</strong></div>
                                    <div class="text-muted small">@member.FirstName @member.LastName</div>
                                }
                                else
                                {
                                    <div><strong>@member.FirstName @member.LastName</strong></div>
                                }
                                <div class="text-muted small">@member.Email</div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else if (!string.IsNullOrEmpty(memberSearchTerm))
        {
            <div class="alert alert-purple">Nenhum membro encontrado.</div>
        }

        @if (selectedMember != null)
        {
            <div class="alert alert-success mt-3">
                <strong>Membro Selecionado:</strong> @selectedMember.GetDisplayName()
            </div>
        }
    </BodyContent>
    <FooterContent>
        <button type="button" class="btn btn-secondary" @onclick="CloseAssignMemberModal">Cancelar</button>
        <button type="button" class="btn btn-primary" @onclick="SaveAssignment"
                disabled="@(selectedMember == null)">Atribuir</button>
    </FooterContent>
</Modal>

@code {
    private List<string> fiscalYears = new();
    private string selectedFiscalYear = "";
    private string currentFiscalYear = "";
    private Dictionary<Position, RoleAssignment?> currentAssignments = new();
    private List<ApplicationUser> allMembers = new();
    private List<ApplicationUser> filteredMembers = new();

    private bool showCreateFiscalYearModal = false;
    private bool showAssignMemberModal = false;
    private int newStartYear = DateTime.Now.Year;
    private string errorMessage = "";

    private Position? selectedPosition;
    private string selectedPositionName = "";
    private string memberSearchTerm = "";
    private ApplicationUser? selectedMember;
    
    // Helper for multi-word search
    private SearchHelper<ApplicationUser> searchHelper = new();

    protected override async Task OnInitializedAsync()
    {
        CalculateCurrentFiscalYear();
        await LoadFiscalYears();
        LoadAllMembers();
    }

    private void CalculateCurrentFiscalYear()
    {
        currentFiscalYear = FiscalYearHelper.GetCurrentFiscalYearString();
    }

    private async Task LoadFiscalYears()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var isPublic = !authState.User.IsInRole("Member") && !authState.User.IsInRole("Admin");

        var years = (await FiscalYearService.GetAllFiscalYearsAsync())
            .OrderByDescending(y => y.StartYear)
            .ToList();

        fiscalYears = years.Select(y => y.FiscalYearString).ToList();

        // Public users only see current fiscal year
        if (isPublic)
        {
            if (fiscalYears.Contains(currentFiscalYear))
            {
                selectedFiscalYear = currentFiscalYear;
            }
        }
        else
        {
            // Set current fiscal year as default if it exists
            if (fiscalYears.Contains(currentFiscalYear))
            {
                selectedFiscalYear = currentFiscalYear;
            }
            else if (fiscalYears.Any())
            {
                selectedFiscalYear = fiscalYears.First();
            }
        }

        if (!string.IsNullOrEmpty(selectedFiscalYear))
        {
            await LoadRoleAssignments();
        }
    }

    private void LoadAllMembers()
    {
        allMembers = UserManager.Users
            .OrderBy(u => u.FirstName)
            .ThenBy(u => u.LastName)
            .ToList();
    }

    private async Task LoadRoleAssignments()
    {
        if (string.IsNullOrEmpty(selectedFiscalYear)) return;

        var parts = selectedFiscalYear.Split('-');
        if (parts.Length != 2 || !int.TryParse(parts[0], out var startYear) || !int.TryParse(parts[1], out var endYear))
            return;

        var assignments = (await RoleAssignmentService.GetAllRoleAssignmentsAsync())
            .Where(r => r.StartYear == startYear && r.EndYear == endYear)
            .ToList();

        currentAssignments.Clear();
        foreach (Position position in Enum.GetValues(typeof(Position)))
        {
            currentAssignments[position] = assignments.FirstOrDefault(a => a.Position == position);
        }
    }

    private RenderFragment RenderPositionRow(Position position, string displayName, bool isAdmin) => builder =>
    {
        var assignment = currentAssignments.GetValueOrDefault(position);

        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "row mb-3 align-items-center");

        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", isAdmin ? "col-md-4" : "col-md-6");
        builder.OpenElement(4, "strong");
        builder.AddContent(5, displayName);
        builder.CloseElement(); // strong
        builder.CloseElement(); // div

        builder.OpenElement(6, "div");
        builder.AddAttribute(7, "class", isAdmin ? "col-md-6" : "col-md-6");
        if (assignment?.User != null)
        {
            builder.OpenElement(8, "div");
            builder.AddAttribute(9, "class", "d-flex align-items-center");

            builder.OpenElement(10, "img");
            builder.AddAttribute(11, "src", assignment.User.ProfilePictureSrc);
            builder.AddAttribute(12, "alt", assignment.User.GetDisplayName());
            builder.AddAttribute(13, "class", "member-avatar-small me-2");
            builder.CloseElement(); // img

            builder.OpenElement(14, "div");
            
            if (!string.IsNullOrEmpty(assignment.User.Nickname))
            {
                builder.OpenElement(15, "div");
                builder.AddContent(16, $"{assignment.User.Nickname}");
                builder.CloseElement(); // div
                
                builder.OpenElement(17, "div");
                builder.AddAttribute(18, "class", "text-muted small");
                builder.AddContent(19, $"{assignment.User.FirstName} {assignment.User.LastName}");
                builder.CloseElement(); // div
            }
            else
            {
                builder.OpenElement(15, "div");
                builder.AddContent(16, $"{assignment.User.FirstName} {assignment.User.LastName}");
                builder.CloseElement(); // div
            }

            builder.CloseElement(); // div
            builder.CloseElement(); // div flex
        }
        else
        {
            builder.OpenElement(23, "span");
            builder.AddAttribute(24, "class", "text-muted");
            builder.AddContent(25, "Não atribuído");
            builder.CloseElement(); // span
        }
        builder.CloseElement(); // div col

        // Only show action buttons for Admin
        if (isAdmin)
        {
            builder.OpenElement(26, "div");
            builder.AddAttribute(27, "class", "col-md-2 text-end");
            if (assignment != null)
            {
                builder.OpenElement(28, "button");
                builder.AddAttribute(29, "class", "btn btn-sm btn-danger");
                builder.AddAttribute(30, "onclick", EventCallback.Factory.Create(this, () => RemoveAssignment(assignment.Id)));
                builder.OpenElement(31, "i");
                builder.AddAttribute(32, "class", "bi bi-trash");
                builder.CloseElement(); // i
                builder.CloseElement(); // button
            }
            else
            {
                builder.OpenElement(33, "button");
                builder.AddAttribute(34, "class", "btn btn-sm btn-primary");
                builder.AddAttribute(35, "onclick", EventCallback.Factory.Create(this, () => OpenAssignMemberModal(position, displayName)));
                builder.OpenElement(36, "i");
                builder.AddAttribute(37, "class", "bi bi-plus-lg");
                builder.CloseElement(); // i
                builder.CloseElement(); // button
            }
            builder.CloseElement(); // div col
        }

        builder.CloseElement(); // div row
    };

    private void OpenCreateFiscalYearModal()
    {
        newStartYear = DateTime.Now.Year;
        errorMessage = "";
        showCreateFiscalYearModal = true;
    }

    private void CloseCreateFiscalYearModal()
    {
        showCreateFiscalYearModal = false;
        errorMessage = "";
    }

    private async Task CreateFiscalYear()
    {
        errorMessage = "";

        try
        {
            // Create fiscal year via service (validation is done in the service)
            var newFiscalYear = await FiscalYearService.CreateFiscalYearAsync(newStartYear);

            // Reload fiscal years and select the new one
            await LoadFiscalYears();
            selectedFiscalYear = newFiscalYear.FiscalYearString;
            await LoadRoleAssignments();
            CloseCreateFiscalYearModal();
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
    }

    private void OpenAssignMemberModal(Position position, string displayName)
    {
        selectedPosition = position;
        selectedPositionName = displayName;
        memberSearchTerm = "";
        selectedMember = null;
        filteredMembers.Clear();
        errorMessage = "";
        showAssignMemberModal = true;
    }

    private void CloseAssignMemberModal()
    {
        showAssignMemberModal = false;
        selectedPosition = null;
        selectedPositionName = "";
        memberSearchTerm = "";
        selectedMember = null;
        filteredMembers.Clear();
        errorMessage = "";
    }

    private void FilterMembers()
    {
        if (string.IsNullOrEmpty(memberSearchTerm))
        {
            filteredMembers.Clear();
            return;
        }

        // Use SearchHelper for multi-word search support
        // This allows searching for "Pedro P" to match "Pedro Pereira"
        searchHelper.SearchTerm = memberSearchTerm;
        filteredMembers = searchHelper.FilterMultiple(allMembers, new List<Func<ApplicationUser, string>>
        {
            u => u.FirstName ?? "",
            u => u.LastName ?? "",
            u => u.Nickname ?? "",
            u => u.Email ?? ""
        });
    }

    private void SelectMember(ApplicationUser member)
    {
        selectedMember = member;
    }

    private async Task SaveAssignment()
    {
        if (selectedMember == null || selectedPosition == null || string.IsNullOrEmpty(selectedFiscalYear))
            return;

        errorMessage = "";

        // Check if member is LEITAO
        if (selectedMember.IsLeitao())
        {
            errorMessage = "Não é possível atribuir cargos a membros LEITÃO.";
            return;
        }

        // President positions that Caloiro cannot hold
        var presidentPositions = new[]
        {
            Position.Magister,
            Position.PresidenteMesaAssembleia,
            Position.PresidenteConselhoFiscal,
            Position.PresidenteConselhoVeteranos
        };

        // Check if member is CALOIRO and trying to assign a President position
        if (selectedMember.IsCaloiro() &&
            presidentPositions.Contains(selectedPosition.Value))
        {
            errorMessage = "CALOIRO não pode ser atribuído a cargos de Presidente.";
            return;
        }

        // Check if position is Presidente do Conselho de Veteranos and member is not Tuno Veterano
        if (selectedPosition.Value == Position.PresidenteConselhoVeteranos)
        {
            var isTunoVeterano = selectedMember.IsTuno() && selectedMember.QualifiesForVeterano();

            if (!isTunoVeterano)
            {
                errorMessage = "Presidente do Conselho de Veteranos deve ser TUNO VETERANO (mínimo 2 anos como Tuno).";
                return;
            }
        }

        var parts = selectedFiscalYear.Split('-');
        if (parts.Length != 2 || !int.TryParse(parts[0], out var startYear) || !int.TryParse(parts[1], out var endYear))
        {
            errorMessage = "Ano fiscal inválido.";
            return;
        }

        // Check if this position is already assigned for this fiscal year
        var existing = (await RoleAssignmentService.GetAllRoleAssignmentsAsync())
            .FirstOrDefault(r => r.Position == selectedPosition.Value &&
                                 r.StartYear == startYear &&
                                 r.EndYear == endYear);

        if (existing != null)
        {
            errorMessage = "Este cargo já está atribuído para este ano fiscal.";
            return;
        }

        // Check if member already has a position assigned in this fiscal year
        var memberHasAssignment = (await RoleAssignmentService.GetRoleAssignmentsByUserIdAsync(selectedMember.Id))
            .Any(r => r.StartYear == startYear && r.EndYear == endYear);

        if (memberHasAssignment)
        {
            errorMessage = "Este membro já tem um cargo atribuído para este ano fiscal.";
            return;
        }

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserId = UserManager.GetUserId(authState.User);

        await RoleAssignmentService.CreateRoleAssignmentAsync(
            selectedMember.Id,
            selectedPosition.Value,
            startYear,
            endYear,
            null,
            currentUserId
        );

        // Update user's current Positions property and promote to Admin ONLY if fiscal year is current
        int currentFiscalStartYear = FiscalYearHelper.GetCurrentFiscalYearStartYear();

        bool isFiscalYearCurrent = (startYear == currentFiscalStartYear);

        var user = await UserManager.FindByIdAsync(selectedMember.Id);
        if (user != null && isFiscalYearCurrent)
        {
            var positions = user.Positions.ToList();
            if (!positions.Contains(selectedPosition.Value))
            {
                positions.Add(selectedPosition.Value);
                user.Positions = positions;
                await UserManager.UpdateAsync(user);
            }

            // Promote user from Member to Admin role
            var currentRoles = await UserManager.GetRolesAsync(user);
            if (!currentRoles.Contains("Admin"))
            {
                // Remove Member role if present
                if (currentRoles.Contains("Member"))
                {
                    await UserManager.RemoveFromRoleAsync(user, "Member");
                }
                // Add Admin role
                await UserManager.AddToRoleAsync(user, "Admin");
            }
        }

        await LoadRoleAssignments();
        CloseAssignMemberModal();
    }

    private async Task RemoveAssignment(int assignmentId)
    {
        // Get assignment details before deleting
        var assignment = await RoleAssignmentService.GetRoleAssignmentByIdAsync(assignmentId);
        if (assignment == null) return;

        await RoleAssignmentService.DeleteRoleAssignmentAsync(assignmentId);

        // Remove from user's current Positions property ONLY if fiscal year is current
        int currentFiscalStartYear = FiscalYearHelper.GetCurrentFiscalYearStartYear();
        bool isFiscalYearCurrent = (assignment.StartYear == currentFiscalStartYear);

        var user = await UserManager.FindByIdAsync(assignment.UserId);
        if (user != null && isFiscalYearCurrent)
        {
            var positions = user.Positions.ToList();
            if (positions.Contains(assignment.Position))
            {
                positions.Remove(assignment.Position);
                user.Positions = positions;
                await UserManager.UpdateAsync(user);
            }
        }

        await LoadRoleAssignments();
    }
}

