@page "/admin/rehearsals"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using RTUB.Application.Interfaces
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Core.Enums
@using RTUB.Shared
@attribute [Authorize(Roles = "Admin")]
@inject IRehearsalService RehearsalService
@inject IRehearsalAttendanceService AttendanceService
@inject UserManager<ApplicationUser> UserManager

<h1>Gestão de Ensaios</h1>
<p>Gestão de ensaios e estatísticas de presenças.</p>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "rehearsals" ? "active" : "")" @onclick='() => SetActiveTab("rehearsals")'>
            <i class="bi bi-music-note-beamed"></i> Ensaios
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "stats" ? "active" : "")" @onclick='() => SetActiveTab("stats")'>
            <i class="bi bi-bar-chart"></i> Estatísticas
        </button>
    </li>
</ul>

@if (loading)
{
    <p>A carregar...</p>
}
else
{
    @if (activeTab == "rehearsals")
    {
        <div class="mb-3">
            <button class="btn btn-success me-2" @onclick="OpenCreateSingleModal" title="Criar Ensaio (Data Específica)">
                <i class="bi bi-plus-lg"></i>
            </button>
            <button class="btn btn-sm btn-light me-2" @onclick="OpenCreateRangeModal" title="Criar Ensaios (Intervalo)">
                <i class="bi bi-calendar-range"></i>
            </button>
        </div>

        <!-- Search Bar and Filter -->
        <div class="row mb-3">
            <div class="col-md-8">
                <TableSearchBar SearchTerm="@searchTerm"
                               Placeholder="Pesquisar por localização ou tema..."
                               OnSearchChanged="@HandleSearchChanged" />
            </div>
            <div class="col-md-4">
                <select class="form-select" @bind="statusFilter" @bind:after="ApplyFiltersAndPagination">
                    <option value="all">Todos os Ensaios</option>
                    <option value="upcoming">Agendados (Futuros)</option>
                    <option value="past">Passados</option>
                </select>
            </div>
        </div>

        @if (rehearsals == null || !rehearsals.Any())
        {
            <EmptyTableState 
                Message="Nenhum ensaio registado." 
                IconClass="bi-info-circle" />
        }
        else if (!filteredRehearsals.Any())
        {
            <EmptyTableState 
                Message="Nenhum ensaio encontrado com os critérios de pesquisa." 
                IconClass="bi-search" />
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th @onclick="() => SortBy(nameof(Rehearsal.Date))" class="clickable-row">
                                Data
                                @if (sortHelper.IsActiveSortColumn(nameof(Rehearsal.Date)))
                                {
                                    <i class="bi @sortHelper.GetSortIcon(nameof(Rehearsal.Date))"></i>
                                }
                            </th>
                            <th @onclick="() => SortBy(nameof(Rehearsal.Location))" class="clickable-row">
                                Localização
                                @if (sortHelper.IsActiveSortColumn(nameof(Rehearsal.Location)))
                                {
                                    <i class="bi @sortHelper.GetSortIcon(nameof(Rehearsal.Location))"></i>
                                }
                            </th>
                            <th @onclick="() => SortBy(nameof(Rehearsal.Theme))" class="clickable-row">
                                Tema
                                @if (sortHelper.IsActiveSortColumn(nameof(Rehearsal.Theme)))
                                {
                                    <i class="bi @sortHelper.GetSortIcon(nameof(Rehearsal.Theme))"></i>
                                }
                            </th>
                            <th>Presenças</th>
                            <th>Estado</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var rehearsal in paginatedRehearsals)
                        {
                            <tr>
                                <td>@rehearsal.Date.ToString("dddd, dd MMM yyyy")</td>
                                <td>@rehearsal.Location</td>
                                <td>@(rehearsal.Theme ?? "-")</td>
                                <td>
                                    @{
                                        var confirmedCount = rehearsal.Attendances.Count(a => a.Attended);
                                        var pendingCount = rehearsal.Attendances.Count(a => !a.Attended);
                                    }
                                    <span class="text-muted">Por confirmar (@pendingCount)</span> | <span class="text-success">Confirmadas (@confirmedCount)</span>
                                </td>
                                <td>
                                    @if (rehearsal.IsCanceled)
                                    {
                                        <span class="badge bg-danger">Cancelado</span>
                                    }
                                    else if (rehearsal.Date.Date == DateTime.Today)
                                    {
                                        <span class="badge bg-primary">Hoje</span>
                                    }
                                    else if (IsLastPast(rehearsal))
                                    {
                                        <span class="badge bg-secondary">Último</span>
                                    }
                                    else if (rehearsal.Date < DateTime.Today)
                                    {
                                        <span class="badge bg-secondary">Passado</span>
                                    }
                                    else if (IsNextUpcoming(rehearsal))
                                    {
                                        <span class="badge bg-success">Próximo</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Agendado</span>
                                    }
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-1" @onclick="() => ViewAttendances(rehearsal)" title="Ver Presenças">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light me-1" @onclick="() => OpenEditModal(rehearsal)" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger me-1" @onclick="() => OpenDeleteConfirmation(rehearsal)" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <TablePagination CurrentPage="@paginationHelper.CurrentPage"
                            PageSize="@paginationHelper.PageSize"
                            TotalItems="@filteredRehearsals.Count"
                            ItemLabel="ensaios"
                            OnPageChanged="@HandlePageChange"
                            OnPageSizeChanged="@HandlePageSizeChange" />
        }
    }
    else if (activeTab == "stats")
    {
        <div class="card">
            <div class="card-header">
                <h5>Estatísticas de Presenças</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Data Início</label>
                            <input type="date" class="form-control" @bind="statsStartDate" @bind:format="yyyy-MM-dd" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data Fim</label>
                            <input type="date" class="form-control" @bind="statsEndDate" @bind:format="yyyy-MM-dd" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100 d-block" @onclick="LoadStats">Carregar Estatísticas</button>
                        </div>
                    </div>
                </div>

                @if (attendanceStatsUsers != null && attendanceStatsUsers.Any())
                {
                    <!-- Search Bar -->
                    <TableSearchBar SearchTerm="@statsSearchTerm"
                                   Placeholder="Pesquisar por nome..."
                                   OnSearchChanged="@HandleStatsSearchChanged" />

                    @if (!filteredStatsUsers.Any())
                    {
                        <EmptyTableState 
                            Message="Nenhum membro encontrado com os critérios de pesquisa." 
                            IconClass="bi-search" />
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th @onclick="() => SortStatsBy(nameof(UserAttendanceStats.UserName))" class="clickable-row">
                                            Membro
                                            @if (statsSortHelper.IsActiveSortColumn(nameof(UserAttendanceStats.UserName)))
                                            {
                                                <i class="bi @statsSortHelper.GetSortIcon(nameof(UserAttendanceStats.UserName))"></i>
                                            }
                                        </th>
                                        <th @onclick="() => SortStatsBy(nameof(UserAttendanceStats.Count))" class="clickable-row">
                                            Total de Presenças
                                            @if (statsSortHelper.IsActiveSortColumn(nameof(UserAttendanceStats.Count)))
                                            {
                                                <i class="bi @statsSortHelper.GetSortIcon(nameof(UserAttendanceStats.Count))"></i>
                                            }
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var stat in paginatedStatsUsers)
                                    {
                                        <tr>
                                            <td>@stat.UserName</td>
                                            <td>@stat.Count</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <TablePagination CurrentPage="@statsPaginationHelper.CurrentPage"
                                        PageSize="@statsPaginationHelper.PageSize"
                                        TotalItems="@filteredStatsUsers.Count"
                                        ItemLabel="membros"
                                        OnPageChanged="@HandleStatsPageChange"
                                        OnPageSizeChanged="@HandleStatsPageSizeChange" />
                    }
                }
                else if (attendanceStatsUsers != null)
                {
                    <EmptyTableState 
                        Message="Sem dados para o período selecionado." 
                        IconClass="bi-info-circle" />
                }
            </div>
        </div>
    }
}

<!-- Create Range Modal -->
@if (showRangeModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Criar Ensaios (Intervalo)</h5>
                    <button type="button" class="btn-close" @onclick="CloseRangeModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Data Início</label>
                        <input type="date" class="form-control" @bind="rangeStartDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data Fim</label>
                        <input type="date" class="form-control" @bind="rangeEndDate" />
                    </div>
                    @if (rangeEndDate.Date < rangeStartDate.Date)
                    {
                        <div class="alert alert-danger">
                            A data de fim não pode ser anterior à data de início.
                        </div>
                    }
                    <div class="mb-3">
                        <label class="form-label">Localização</label>
                        <input type="text" class="form-control" @bind="rangeLocation" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tema (Opcional)</label>
                        <input type="text" class="form-control" @bind="rangeTheme" />
                    </div>
                    <p class="text-muted">
                        <small>Serão criados ensaios às Terças e Quintas no intervalo selecionado.</small>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseRangeModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateRangeRehearsals" disabled="@(rangeEndDate.Date < rangeStartDate.Date)">Criar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Create/Edit Single Rehearsal Modal -->
@if (showSingleModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingRehearsal == null ? "Criar Ensaio" : "Editar Ensaio")</h5>
                    <button type="button" class="btn-close" @onclick="CloseSingleModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Data</label>
                        <input type="date" class="form-control" @bind="singleDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Localização</label>
                        <input type="text" class="form-control" @bind="singleLocation" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tema (Opcional)</label>
                        <input type="text" class="form-control" @bind="singleTheme" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas (Opcional)</label>
                        <textarea class="form-control" rows="3" @bind="singleNotes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSingleModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveSingleRehearsal">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- View Attendances Modal -->
@if (showAttendancesModal && selectedRehearsal != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Presenças - @selectedRehearsal.Date.ToString("dddd, dd MMM yyyy")</h5>
                    <button type="button" class="btn-close" @onclick="CloseAttendancesModal"></button>
                </div>
                <div class="modal-body">
                    @if (selectedRehearsalAttendances != null && selectedRehearsalAttendances.Any())
                    {
                        <!-- Search Bar -->
                        <div class="mb-3">
                            <TableSearchBar SearchTerm="@attendanceSearchTerm"
                                           Placeholder="Pesquisar por nome..."
                                           OnSearchChanged="@HandleAttendanceSearchChanged" />
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Membro</th>
                                        <th>Instrumento</th>
                                        <th>Presença (por aprovação)</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var attendance in filteredAttendances)
                                    {
                                        <tr>
                                            <td>
                                                @if (!string.IsNullOrEmpty(attendance.User?.Nickname))
                                                {
                                                    <text>@attendance.User.Nickname</text>
                                                }
                                                else if (attendance.User != null)
                                                {
                                                    <text>@attendance.User.FirstName @attendance.User.LastName</text>
                                                }
                                                else
                                                {
                                                    <text>@attendance.UserId</text>
                                                }
                                            </td>
                                            <td>@(attendance.Instrument?.ToString() ?? "-")</td>
                                            <td>
                                                @if (attendance.Attended)
                                                {
                                                    <span class="badge bg-success">Aprovado</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">Pendente</span>
                                                }
                                            </td>
                                            <td>
                                            @if (!attendance.Attended)
                                            {
                                                <button class="btn btn-sm btn-success" @onclick="() => ApproveAttendance(attendance)">
                                                    <i class="bi bi-check"></i> Aprovar
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-sm btn-danger" @onclick="() => OpenDeleteAttendanceConfirmation(attendance)" title="Eliminar">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        </div>
                    }
                    else
                    {
                        <p>Nenhuma presença registada ainda.</p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAttendancesModal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Dialog -->
<ConfirmDialog 
    Show="@showDeleteConfirmation"
    ShowChanged="@((show) => showDeleteConfirmation = show)"
    Title="Eliminar Ensaio"
    Message="@($"Tem a certeza que deseja eliminar o ensaio de {rehearsalToDelete?.Date.ToString("dddd, dd MMM yyyy")}?")"
    WarningMessage="Esta ação não pode ser revertida."
    ConfirmText="Eliminar"
    CancelText="Cancelar"
    ConfirmButtonClass="btn-danger"
    OnConfirm="ConfirmDelete"
    OnCancel="CancelDelete" />

<!-- Delete Attendance Confirmation Dialog -->
<ConfirmDialog 
    Show="@showDeleteAttendanceConfirmation"
    ShowChanged="@((show) => showDeleteAttendanceConfirmation = show)"
    Title="Eliminar Presença"
    Message="@($"Tem a certeza que deseja eliminar a presença de {attendanceToDelete?.User?.FirstName} \"{attendanceToDelete?.User?.Nickname}\"?")"
    WarningMessage="Esta ação não pode ser revertida."
    ConfirmText="Eliminar"
    CancelText="Cancelar"
    ConfirmButtonClass="btn-danger"
    OnConfirm="ConfirmDeleteAttendance"
    OnCancel="CancelDeleteAttendance" />

@code {
    private bool loading = true;
    private string activeTab = "rehearsals";

    // Rehearsals data
    private List<Rehearsal>? rehearsals;
    private List<Rehearsal> filteredRehearsals = new();
    private List<Rehearsal> paginatedRehearsals = new();
    
    // Search, filter and pagination
    private string searchTerm = string.Empty;
    private string statusFilter = "all";
    private SortableTableHelper<Rehearsal> sortHelper = new() { SortColumn = nameof(Rehearsal.Date), SortAscending = true };
    private PaginationHelper<Rehearsal> paginationHelper = new() { PageSize = 20 };
    
    // Range modal
    private bool showRangeModal = false;
    private DateTime rangeStartDate = DateTime.Today;
    private DateTime rangeEndDate = DateTime.Today.AddMonths(1);
    private string rangeLocation = "Centro Académico";
    private string? rangeTheme;
    
    // Single modal
    private bool showSingleModal = false;
    private Rehearsal? editingRehearsal;
    private DateTime singleDate = DateTime.Today.AddDays(1);
    private string singleLocation = "Centro Académico";
    private string? singleTheme;
    private string? singleNotes;

    // Attendances modal
    private bool showAttendancesModal = false;
    private Rehearsal? selectedRehearsal;
    private List<RehearsalAttendance>? selectedRehearsalAttendances;
    private List<RehearsalAttendance> filteredAttendances = new();
    private string attendanceSearchTerm = string.Empty;

    // Delete confirmation
    private bool showDeleteConfirmation = false;
    private Rehearsal? rehearsalToDelete;
    
    // Delete attendance confirmation
    private bool showDeleteAttendanceConfirmation = false;
    private RehearsalAttendance? attendanceToDelete;

    // Stats data
    private DateTime statsStartDate = DateTime.Today.AddDays(-30);
    private DateTime statsEndDate = DateTime.Today;
    private List<UserAttendanceStats>? attendanceStatsUsers;
    private List<UserAttendanceStats> filteredStatsUsers = new();
    private List<UserAttendanceStats> paginatedStatsUsers = new();
    private string statsSearchTerm = string.Empty;
    private SortableTableHelper<UserAttendanceStats> statsSortHelper = new() { SortColumn = nameof(UserAttendanceStats.Count), SortAscending = false };
    private PaginationHelper<UserAttendanceStats> statsPaginationHelper = new() { PageSize = 20 };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        loading = false;
    }

    private async Task LoadData()
    {
        // Load 1 year ahead and behind to support long-range creation
        var startDate = DateTime.Today.AddDays(-365);
        var endDate = DateTime.Today.AddDays(365);
        rehearsals = (await RehearsalService.GetRehearsalsAsync(startDate, endDate)).ToList();
        ApplyFiltersAndPagination();
    }
    
    private bool IsNextUpcoming(Rehearsal rehearsal)
    {
        if (rehearsals == null || rehearsal.Date < DateTime.Today)
            return false;
            
        var firstUpcoming = rehearsals
            .Where(r => !r.IsCanceled && r.Date >= DateTime.Today)
            .OrderBy(r => r.Date)
            .FirstOrDefault();
            
        return firstUpcoming?.Id == rehearsal.Id;
    }
    
    private bool IsLastPast(Rehearsal rehearsal)
    {
        if (rehearsals == null || rehearsal.Date >= DateTime.Today)
            return false;
            
        var lastPast = rehearsals
            .Where(r => !r.IsCanceled && r.Date < DateTime.Today)
            .OrderByDescending(r => r.Date)
            .FirstOrDefault();
            
        return lastPast?.Id == rehearsal.Id;
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    // Search and filtering
    private void HandleSearchChanged(string newSearchTerm)
    {
        searchTerm = newSearchTerm;
        paginationHelper.CurrentPage = 1;
        ApplyFiltersAndPagination();
    }

    private void ApplyFiltersAndPagination()
    {
        if (rehearsals == null)
        {
            filteredRehearsals = new List<Rehearsal>();
            paginatedRehearsals = new List<Rehearsal>();
            return;
        }

        // Apply search filter
        filteredRehearsals = string.IsNullOrWhiteSpace(searchTerm)
            ? rehearsals.ToList()
            : rehearsals.Where(r =>
                (r.Location?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (r.Theme?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();
        
        // Apply status filter
        if (statusFilter == "upcoming")
        {
            filteredRehearsals = filteredRehearsals.Where(r => r.Date >= DateTime.Today).ToList();
        }
        else if (statusFilter == "past")
        {
            filteredRehearsals = filteredRehearsals.Where(r => r.Date < DateTime.Today).ToList();
        }

        // Apply sorting
        var columnSelectors = new Dictionary<string, Func<Rehearsal, IComparable>>
        {
            { nameof(Rehearsal.Date), r => r.Date },
            { nameof(Rehearsal.Location), r => r.Location },
            { nameof(Rehearsal.Theme), r => r.Theme ?? string.Empty }
        };
        filteredRehearsals = sortHelper.ApplySort(filteredRehearsals, columnSelectors);

        // Apply pagination
        paginatedRehearsals = paginationHelper.GetPageData(filteredRehearsals);
    }

    private void SortBy(string columnName)
    {
        sortHelper.ChangeSortColumn(columnName);
        ApplyFiltersAndPagination();
    }

    private void HandlePageChange(int newPage)
    {
        paginationHelper.GoToPage(newPage);
        ApplyFiltersAndPagination();
    }

    private void HandlePageSizeChange(int newPageSize)
    {
        paginationHelper.PageSize = newPageSize;
        paginationHelper.CurrentPage = 1;
        ApplyFiltersAndPagination();
    }

    // Range modal methods
    private void OpenCreateRangeModal()
    {
        rangeStartDate = DateTime.Today;
        rangeEndDate = DateTime.Today.AddMonths(1);
        rangeLocation = "Centro Académico";
        rangeTheme = null;
        showRangeModal = true;
    }

    private void CloseRangeModal()
    {
        showRangeModal = false;
    }

    private async Task CreateRangeRehearsals()
    {
        if (rangeEndDate.Date < rangeStartDate.Date)
            return;

        // Reload rehearsals to check against fresh data
        await LoadData();

        int createdCount = 0;
        for (var date = rangeStartDate.Date; date <= rangeEndDate.Date; date = date.AddDays(1))
        {
            if (date.DayOfWeek == DayOfWeek.Tuesday || date.DayOfWeek == DayOfWeek.Thursday)
            {
                // Check if rehearsal already exists on this date
                var existing = rehearsals?.FirstOrDefault(r => r.Date.Date == date.Date);
                if (existing == null)
                {
                    await RehearsalService.CreateRehearsalAsync(date, rangeLocation, rangeTheme);
                    createdCount++;
                }
            }
        }
        
        await LoadData();
        CloseRangeModal();
        StateHasChanged();
    }

    // Single modal methods
    private void OpenCreateSingleModal()
    {
        editingRehearsal = null;
        singleDate = DateTime.Today.AddDays(1);
        singleLocation = "Centro Académico";
        singleTheme = null;
        singleNotes = null;
        showSingleModal = true;
    }

    private void OpenEditModal(Rehearsal rehearsal)
    {
        editingRehearsal = rehearsal;
        singleDate = rehearsal.Date;
        singleLocation = rehearsal.Location;
        singleTheme = rehearsal.Theme;
        singleNotes = rehearsal.Notes;
        showSingleModal = true;
    }

    private void CloseSingleModal()
    {
        showSingleModal = false;
        editingRehearsal = null;
    }

    private async Task SaveSingleRehearsal()
    {
        if (editingRehearsal == null)
        {
            await RehearsalService.CreateRehearsalAsync(singleDate, singleLocation, singleTheme);
        }
        else
        {
            await RehearsalService.UpdateRehearsalAsync(editingRehearsal.Id, singleLocation, singleTheme, singleNotes);
        }
        
        await LoadData();
        CloseSingleModal();
    }

    // Delete methods
    private void OpenDeleteConfirmation(Rehearsal rehearsal)
    {
        rehearsalToDelete = rehearsal;
        showDeleteConfirmation = true;
    }

    private async Task ConfirmDelete()
    {
        if (rehearsalToDelete != null)
        {
            await RehearsalService.DeleteRehearsalAsync(rehearsalToDelete.Id);
            await LoadData();
            rehearsalToDelete = null;
        }
    }

    private void CancelDelete()
    {
        rehearsalToDelete = null;
    }

    // Attendances modal methods
    private async Task ViewAttendances(Rehearsal rehearsal)
    {
        selectedRehearsal = rehearsal;
        selectedRehearsalAttendances = (await AttendanceService.GetAttendancesByRehearsalIdAsync(rehearsal.Id)).ToList();
        
        // Load user details
        foreach (var attendance in selectedRehearsalAttendances)
        {
            if (attendance.User == null)
            {
                attendance.User = await UserManager.FindByIdAsync(attendance.UserId);
            }
        }
        
        attendanceSearchTerm = string.Empty;
        ApplyAttendanceSearch();
        showAttendancesModal = true;
    }
    
    private void ApplyAttendanceSearch()
    {
        if (selectedRehearsalAttendances == null)
        {
            filteredAttendances = new List<RehearsalAttendance>();
            return;
        }
        
        filteredAttendances = string.IsNullOrWhiteSpace(attendanceSearchTerm)
            ? selectedRehearsalAttendances.ToList()
            : selectedRehearsalAttendances.Where(a =>
                (a.User?.FirstName?.Contains(attendanceSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (a.User?.Nickname?.Contains(attendanceSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();
    }
    
    private void HandleAttendanceSearchChanged(string newSearchTerm)
    {
        attendanceSearchTerm = newSearchTerm;
        ApplyAttendanceSearch();
    }

    private void CloseAttendancesModal()
    {
        showAttendancesModal = false;
        selectedRehearsal = null;
        selectedRehearsalAttendances = null;
        filteredAttendances = new();
        attendanceSearchTerm = string.Empty;
    }

    private async Task ApproveAttendance(RehearsalAttendance attendance)
    {
        await AttendanceService.UpdateAttendanceAsync(attendance.Id, true, attendance.Instrument);
        await ViewAttendances(selectedRehearsal!);
        await LoadData();
    }

    private async Task UnapproveAttendance(RehearsalAttendance attendance)
    {
        await AttendanceService.UpdateAttendanceAsync(attendance.Id, false, attendance.Instrument);
        await ViewAttendances(selectedRehearsal!);
        await LoadData();
    }
    
    private void OpenDeleteAttendanceConfirmation(RehearsalAttendance attendance)
    {
        attendanceToDelete = attendance;
        showDeleteAttendanceConfirmation = true;
    }
    
    private async Task ConfirmDeleteAttendance()
    {
        if (attendanceToDelete != null)
        {
            await AttendanceService.DeleteAttendanceAsync(attendanceToDelete.Id);
            await ViewAttendances(selectedRehearsal!);
            await LoadData();
            attendanceToDelete = null;
        }
    }
    
    private void CancelDeleteAttendance()
    {
        attendanceToDelete = null;
    }

    // Stats methods
    private async Task LoadStats()
    {
        var stats = await AttendanceService.GetAttendanceStatsAsync(statsStartDate, statsEndDate);
        attendanceStatsUsers = new List<UserAttendanceStats>();
        
        foreach (var stat in stats)
        {
            var user = await UserManager.FindByIdAsync(stat.Key);
            if (user != null)
            {
                attendanceStatsUsers.Add(new UserAttendanceStats
                {
                    UserId = stat.Key,
                    UserName = $"{user.FirstName} \"{user.Nickname}\"",
                    Count = stat.Value
                });
            }
        }
        
        ApplyStatsFiltersAndPagination();
        StateHasChanged();
    }
    
    private void HandleStatsSearchChanged(string newSearchTerm)
    {
        statsSearchTerm = newSearchTerm;
        statsPaginationHelper.CurrentPage = 1;
        ApplyStatsFiltersAndPagination();
    }
    
    private void ApplyStatsFiltersAndPagination()
    {
        if (attendanceStatsUsers == null)
        {
            filteredStatsUsers = new List<UserAttendanceStats>();
            paginatedStatsUsers = new List<UserAttendanceStats>();
            return;
        }

        // Apply search filter
        filteredStatsUsers = string.IsNullOrWhiteSpace(statsSearchTerm)
            ? attendanceStatsUsers.ToList()
            : attendanceStatsUsers.Where(s =>
                (s.UserName?.Contains(statsSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();

        // Apply sorting
        var columnSelectors = new Dictionary<string, Func<UserAttendanceStats, IComparable>>
        {
            { nameof(UserAttendanceStats.UserName), s => s.UserName },
            { nameof(UserAttendanceStats.Count), s => s.Count }
        };
        filteredStatsUsers = statsSortHelper.ApplySort(filteredStatsUsers, columnSelectors);

        // Apply pagination
        paginatedStatsUsers = statsPaginationHelper.GetPageData(filteredStatsUsers);
    }
    
    private void SortStatsBy(string columnName)
    {
        statsSortHelper.ChangeSortColumn(columnName);
        ApplyStatsFiltersAndPagination();
    }
    
    private void HandleStatsPageChange(int newPage)
    {
        statsPaginationHelper.GoToPage(newPage);
        ApplyStatsFiltersAndPagination();
    }
    
    private void HandleStatsPageSizeChange(int newPageSize)
    {
        statsPaginationHelper.PageSize = newPageSize;
        statsPaginationHelper.CurrentPage = 1;
        ApplyStatsFiltersAndPagination();
    }

    private class UserAttendanceStats
    {
        public string UserId { get; set; } = string.Empty;
        public string UserName { get; set; } = string.Empty;
        public int Count { get; set; }
    }
}
