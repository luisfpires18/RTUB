@page "/admin/rehearsals"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using RTUB.Application.Interfaces
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Core.Enums
@using RTUB.Shared
@attribute [Authorize(Roles = "Admin")]
@inject IRehearsalService RehearsalService
@inject IRehearsalAttendanceService AttendanceService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<h1>Gestão de Ensaios</h1>
<p>Gestão de ensaios e estatísticas de presenças.</p>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "rehearsals" ? "active" : "")" @onclick='() => SetActiveTab("rehearsals")'>
            <i class="bi bi-music-note-beamed"></i> Ensaios
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "stats" ? "active" : "")" @onclick='() => SetActiveTab("stats")'>
            <i class="bi bi-bar-chart"></i> Estatísticas
        </button>
    </li>
</ul>

@if (loading)
{
    <p>A carregar...</p>
}
else
{
    @if (activeTab == "rehearsals")
    {
        <div class="mb-3">
            <button class="btn btn-success me-2" @onclick="OpenCreateSingleModal" title="Criar Ensaio (Data Específica)">
                <i class="bi bi-plus-lg"></i>
            </button>
            <button class="btn btn-sm btn-light me-2" @onclick="OpenCreateRangeModal" title="Criar Ensaios (Intervalo)">
                <i class="bi bi-calendar-range"></i>
            </button>
        </div>

        <!-- Search Bar and Filter -->
        <div class="row mb-3">
            <div class="col-md-8">
                <TableSearchBar SearchTerm="@searchTerm"
                               Placeholder="Pesquisar por localização ou tema..."
                               OnSearchChanged="@HandleSearchChanged" />
            </div>
            <div class="col-md-4">
                <select class="form-select" @bind="statusFilter" @bind:after="ApplyFiltersAndPagination">
                    <option value="all">Todos os Ensaios</option>
                    <option value="upcoming">Agendados (Futuros)</option>
                    <option value="past">Passados</option>
                </select>
            </div>
        </div>

        @if (rehearsals == null || !rehearsals.Any())
        {
            <EmptyTableState 
                Message="Nenhum ensaio registado." 
                IconClass="bi-info-circle" />
        }
        else if (!filteredRehearsals.Any())
        {
            <EmptyTableState 
                Message="Nenhum ensaio encontrado com os critérios de pesquisa." 
                IconClass="bi-search" />
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th @onclick="() => SortBy(nameof(Rehearsal.Date))" class="clickable-row">
                                Data
                                @if (sortHelper.IsActiveSortColumn(nameof(Rehearsal.Date)))
                                {
                                    <i class="bi @sortHelper.GetSortIcon(nameof(Rehearsal.Date))"></i>
                                }
                            </th>
                            <th @onclick="() => SortBy(nameof(Rehearsal.Location))" class="clickable-row">
                                Localização
                                @if (sortHelper.IsActiveSortColumn(nameof(Rehearsal.Location)))
                                {
                                    <i class="bi @sortHelper.GetSortIcon(nameof(Rehearsal.Location))"></i>
                                }
                            </th>
                            <th @onclick="() => SortBy(nameof(Rehearsal.Theme))" class="clickable-row">
                                Tema
                                @if (sortHelper.IsActiveSortColumn(nameof(Rehearsal.Theme)))
                                {
                                    <i class="bi @sortHelper.GetSortIcon(nameof(Rehearsal.Theme))"></i>
                                }
                            </th>
                            <th>Presenças</th>
                            <th>Estado</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var rehearsal in paginatedRehearsals)
                        {
                            <tr>
                                <td>@rehearsal.Date.ToString("dddd, dd MMM yyyy")</td>
                                <td>@rehearsal.Location</td>
                                <td>@(rehearsal.Theme ?? "-")</td>
                                <td>
                                    @{
                                        var confirmedCount = rehearsal.Attendances.Count(a => a.Attended);
                                        var pendingCount = rehearsal.Attendances.Count(a => !a.Attended);
                                    }
                                    <span class="text-muted">Por confirmar (@pendingCount)</span> | <span class="text-success">Confirmadas (@confirmedCount)</span>
                                </td>
                                <td>
                                    @if (rehearsal.IsCanceled)
                                    {
                                        <span class="badge bg-danger">Cancelado</span>
                                    }
                                    else if (rehearsal.Date.Date == DateTime.Today)
                                    {
                                        <span class="badge bg-primary">Hoje</span>
                                    }
                                    else if (IsLastPast(rehearsal))
                                    {
                                        <span class="badge bg-secondary">Último</span>
                                    }
                                    else if (rehearsal.Date < DateTime.Today)
                                    {
                                        <span class="badge bg-secondary">Passado</span>
                                    }
                                    else if (IsNextUpcoming(rehearsal))
                                    {
                                        <span class="badge bg-success">Próximo</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Agendado</span>
                                    }
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-1" @onclick="() => ViewAttendances(rehearsal)" title="Ver Presenças">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light me-1" @onclick="() => OpenEditModal(rehearsal)" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger me-1" @onclick="() => OpenDeleteConfirmation(rehearsal)" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <TablePagination CurrentPage="@paginationHelper.CurrentPage"
                            PageSize="@paginationHelper.PageSize"
                            TotalItems="@filteredRehearsals.Count"
                            ItemLabel="ensaios"
                            OnPageChanged="@HandlePageChange"
                            OnPageSizeChanged="@HandlePageSizeChange" />
        }
    }
    else if (activeTab == "stats")
    {
        <div class="card">
            <div class="card-header">
                <h5>Estatísticas de Presenças</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Data Início</label>
                            <input type="date" class="form-control" @bind="statsStartDate" @bind:format="yyyy-MM-dd" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data Fim</label>
                            <input type="date" class="form-control" @bind="statsEndDate" @bind:format="yyyy-MM-dd" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100 d-block" @onclick="LoadStats">Carregar Estatísticas</button>
                        </div>
                    </div>
                </div>

                @if (attendanceStatsUsers != null && attendanceStatsUsers.Any())
                {
                    <!-- Search Bar -->
                    <TableSearchBar SearchTerm="@statsSearchTerm"
                                   Placeholder="Pesquisar por nome..."
                                   OnSearchChanged="@HandleStatsSearchChanged" />

                    @if (!filteredStatsUsers.Any())
                    {
                        <EmptyTableState 
                            Message="Nenhum membro encontrado com os critérios de pesquisa." 
                            IconClass="bi-search" />
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th @onclick="() => SortStatsBy(nameof(UserAttendanceStats.UserName))" class="clickable-row">
                                            Membro
                                            @if (statsSortHelper.IsActiveSortColumn(nameof(UserAttendanceStats.UserName)))
                                            {
                                                <i class="bi @statsSortHelper.GetSortIcon(nameof(UserAttendanceStats.UserName))"></i>
                                            }
                                        </th>
                                        <th @onclick="() => SortStatsBy(nameof(UserAttendanceStats.Count))" class="clickable-row">
                                            Total de Presenças
                                            @if (statsSortHelper.IsActiveSortColumn(nameof(UserAttendanceStats.Count)))
                                            {
                                                <i class="bi @statsSortHelper.GetSortIcon(nameof(UserAttendanceStats.Count))"></i>
                                            }
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var stat in paginatedStatsUsers)
                                    {
                                        <tr>
                                            <td>@stat.UserName</td>
                                            <td>@stat.Count</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <TablePagination CurrentPage="@statsPaginationHelper.CurrentPage"
                                        PageSize="@statsPaginationHelper.PageSize"
                                        TotalItems="@filteredStatsUsers.Count"
                                        ItemLabel="membros"
                                        OnPageChanged="@HandleStatsPageChange"
                                        OnPageSizeChanged="@HandleStatsPageSizeChange" />
                    }
                }
                else if (attendanceStatsUsers != null)
                {
                    <EmptyTableState 
                        Message="Sem dados para o período selecionado." 
                        IconClass="bi-info-circle" />
                }
            </div>
        </div>
    }
}

<!-- Create Range Modal -->
@if (showRangeModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Criar Ensaios (Intervalo)</h5>
                    <button type="button" class="btn-close" @onclick="CloseRangeModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Data Início</label>
                        <input type="date" class="form-control" @bind="rangeStartDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data Fim</label>
                        <input type="date" class="form-control" @bind="rangeEndDate" />
                    </div>
                    @if (rangeEndDate.Date < rangeStartDate.Date)
                    {
                        <div class="alert alert-danger">
                            A data de fim não pode ser anterior à data de início.
                        </div>
                    }
                    <div class="mb-3">
                        <label class="form-label">Localização</label>
                        <input type="text" class="form-control" @bind="rangeLocation" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tema (Opcional)</label>
                        <input type="text" class="form-control" @bind="rangeTheme" />
                    </div>
                    <p class="text-muted">
                        <small>Serão criados ensaios às Terças e Quintas no intervalo selecionado.</small>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseRangeModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateRangeRehearsals" disabled="@(rangeEndDate.Date < rangeStartDate.Date)">Criar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Create/Edit Single Rehearsal Modal -->
@if (showSingleModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingRehearsal == null ? "Criar Ensaio" : "Editar Ensaio")</h5>
                    <button type="button" class="btn-close" @onclick="CloseSingleModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Data</label>
                        <input type="date" class="form-control" @bind="singleDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Localização</label>
                        <input type="text" class="form-control" @bind="singleLocation" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tema (Opcional)</label>
                        <input type="text" class="form-control" @bind="singleTheme" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas (Opcional)</label>
                        <textarea class="form-control" rows="3" @bind="singleNotes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSingleModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveSingleRehearsal">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- View Attendances Modal -->
@if (showAttendancesModal && selectedRehearsal != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Presenças - @selectedRehearsal.Date.ToString("dddd, dd MMM yyyy")</h5>
                    <button type="button" class="btn-close" @onclick="CloseAttendancesModal"></button>
                </div>
                <div class="modal-body">
                    @if (selectedRehearsalAttendances != null && selectedRehearsalAttendances.Any())
                    {
                        <!-- Search Bar (top, unchanged) -->
                        <div class="mb-3">
                            <TableSearchBar SearchTerm="@attendanceSearchTerm"
                                           Placeholder="Pesquisar por nome..."
                                           OnSearchChanged="@HandleAttendanceSearchChanged" />
                        </div>
                        
                        <div class="enrollment-card-grid">
                            @foreach (var attendance in filteredAttendances)
                            {
                                var instrumentDisplay = attendance.Instrument?.ToString() ?? "—";
                                <EnrollmentCard 
                                    AvatarUrl="@attendance.User?.ProfilePictureSrc"
                                    TunaName="@attendance.User?.Nickname"
                                    FullName="@($"{attendance.User?.FirstName} {attendance.User?.LastName}")"
                                    InstrumentText="@instrumentDisplay"
                                    Notes=""
                                    AltText="@attendance.User?.GetDisplayName()"
                                    ShowEditButton="false"
                                    ShowDeleteButton="@attendance.Attended"
                                    ShowApproveButton="@(!attendance.Attended)"
                                    OnDelete="@(() => OpenDeleteAttendanceConfirmation(attendance))"
                                    OnApprove="@(() => ApproveAttendance(attendance))"
                                    DeleteTooltip="Eliminar"
                                    ApproveTooltip="Aprovar">
                                    <BadgeContent>
                                        <div class="enrollment-card-badges-row">
                                            @if (attendance.Attended)
                                            {
                                                <span class="badge bg-success">Aprovado</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">Pendente</span>
                                            }
                                        </div>
                                    </BadgeContent>
                                </EnrollmentCard>
                            }
                        </div>
                        
                        <!-- Add Member Section (Bottom Right) -->
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <div class="mt-3">
                                    <!-- Success Alert (auto-dismiss) -->
                                    @if (!string.IsNullOrEmpty(addMemberFeedbackMessage) && !addMemberFeedbackIsError)
                                    {
                                        <Alert Type="Alert.AlertType.Purple" 
                                               Message="@addMemberFeedbackMessage" 
                                               Dismissible="true"
                                               OnDismiss="ClearAddMemberFeedback"
                                               AdditionalClasses="mb-2" />
                                    }
                                    
                                    <!-- Error Alert (manual dismiss) -->
                                    @if (!string.IsNullOrEmpty(addMemberFeedbackMessage) && addMemberFeedbackIsError)
                                    {
                                        <Alert Type="Alert.AlertType.Error" 
                                               Message="@addMemberFeedbackMessage" 
                                               Dismissible="true"
                                               OnDismiss="ClearAddMemberFeedback"
                                               AdditionalClasses="mb-2" />
                                    }
                                    
                                    <!-- Collapsible Search Bar -->
                                    @if (showAddMemberDropdown)
                                    {
                                        <div class="mb-2" @onkeydown="HandleAddMemberKeyDown">
                                            <TableSearchBar SearchTerm="@addMemberSearchTerm"
                                                           Placeholder="Pesquisar membro por nome..."
                                                           OnSearchChanged="@HandleAddMemberSearchChanged" />
                                            
                                            @if (filteredMembersForAdd.Any())
                                            {
                                                <div class="member-list member-list-scrollable mt-2">
                                                    @foreach (var member in filteredMembersForAdd.Take(MaxMemberSearchResults))
                                                    {
                                                        <div class="member-item p-2 mb-2 border rounded clickable-row"
                                                             @onclick="() => AddMemberToAttendance(member)"
                                                             tabindex="0"
                                                             @onkeydown="@(async (e) => await HandleMemberItemKeyDown(e, member))">
                                                            <div class="d-flex align-items-center">
                                                                <img src="@member.ProfilePictureSrc" alt="@member.GetDisplayName()"
                                                                     class="member-avatar-small me-2" />
                                                                <div>
                                                                    @if (!string.IsNullOrEmpty(member.Nickname))
                                                                    {
                                                                        <div><strong>@member.Nickname</strong></div>
                                                                        <div class="text-muted small">@member.FirstName @member.LastName</div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <div><strong>@member.FirstName @member.LastName</strong></div>
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(addMemberSearchTerm))
                                            {
                                                <Alert Type="Alert.AlertType.Purple" 
                                                       Message="Nenhum membro encontrado." 
                                                       AdditionalClasses="mt-2" />
                                            }
                                        </div>
                                    }
                                    
                                    <!-- Circular Add Button (Bottom Right) -->
                                    <div class="d-flex justify-content-end">
                                        <button class="btn btn-purple rounded-circle p-2" 
                                                @onclick="ToggleAddMemberDropdown" 
                                                title="Adicionar Membro"
                                                style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                                            <i class="bi @(showAddMemberDropdown ? "bi-x-lg" : "bi-plus-lg")"></i>
                                        </button>
                                    </div>
                                </div>
                            </Authorized>
                        </AuthorizeView>
                    }
                    else
                    {
                        <p>Nenhuma presença registada ainda.</p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAttendancesModal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Dialog -->
<ConfirmDialog 
    Show="@showDeleteConfirmation"
    ShowChanged="@((show) => showDeleteConfirmation = show)"
    Title="Eliminar Ensaio"
    Message="@($"Tem a certeza que deseja eliminar o ensaio de {rehearsalToDelete?.Date.ToString("dddd, dd MMM yyyy")}?")"
    WarningMessage="Esta ação não pode ser revertida."
    ConfirmText="Eliminar"
    CancelText="Cancelar"
    ConfirmButtonClass="btn-danger"
    OnConfirm="ConfirmDelete"
    OnCancel="CancelDelete" />

<!-- Delete Attendance Confirmation Dialog -->
<ConfirmDialog 
    Show="@showDeleteAttendanceConfirmation"
    ShowChanged="@((show) => showDeleteAttendanceConfirmation = show)"
    Title="Eliminar Presença"
    Message="@($"Tem a certeza que deseja eliminar a presença de {attendanceToDelete?.User?.FirstName} \"{attendanceToDelete?.User?.Nickname}\"?")"
    WarningMessage="Esta ação não pode ser revertida."
    ConfirmText="Eliminar"
    CancelText="Cancelar"
    ConfirmButtonClass="btn-danger"
    OnConfirm="ConfirmDeleteAttendance"
    OnCancel="CancelDeleteAttendance" />

@code {
    private bool loading = true;
    private string activeTab = "rehearsals";
    
    // Constants
    private const int MaxMemberSearchResults = 20;

    // Rehearsals data
    private List<Rehearsal>? rehearsals;
    private List<Rehearsal> filteredRehearsals = new();
    private List<Rehearsal> paginatedRehearsals = new();
    
    // Search, filter and pagination
    private string searchTerm = string.Empty;
    private string statusFilter = "all";
    private SortableTableHelper<Rehearsal> sortHelper = new() { SortColumn = nameof(Rehearsal.Date), SortAscending = true };
    private PaginationHelper<Rehearsal> paginationHelper = new() { PageSize = 20 };
    
    // Range modal
    private bool showRangeModal = false;
    private DateTime rangeStartDate = DateTime.Today;
    private DateTime rangeEndDate = DateTime.Today.AddMonths(1);
    private string rangeLocation = "Centro Académico";
    private string? rangeTheme;
    
    // Single modal
    private bool showSingleModal = false;
    private Rehearsal? editingRehearsal;
    private DateTime singleDate = DateTime.Today.AddDays(1);
    private string singleLocation = "Centro Académico";
    private string? singleTheme;
    private string? singleNotes;

    // Attendances modal
    private bool showAttendancesModal = false;
    private Rehearsal? selectedRehearsal;
    private List<RehearsalAttendance>? selectedRehearsalAttendances;
    private List<RehearsalAttendance> filteredAttendances = new();
    private string attendanceSearchTerm = string.Empty;
    
    // Add member to attendance
    private bool showAddMemberDropdown = false;
    private string addMemberSearchTerm = string.Empty;
    private List<ApplicationUser> allMembers = new();
    private List<ApplicationUser> filteredMembersForAdd = new();
    private string addMemberFeedbackMessage = string.Empty;
    private bool addMemberFeedbackIsError = false;
    private Timer? feedbackDismissTimer;

    // Delete confirmation
    private bool showDeleteConfirmation = false;
    private Rehearsal? rehearsalToDelete;
    
    // Delete attendance confirmation
    private bool showDeleteAttendanceConfirmation = false;
    private RehearsalAttendance? attendanceToDelete;

    // Stats data
    private DateTime statsStartDate = DateTime.Today.AddDays(-30);
    private DateTime statsEndDate = DateTime.Today;
    private List<UserAttendanceStats>? attendanceStatsUsers;
    private List<UserAttendanceStats> filteredStatsUsers = new();
    private List<UserAttendanceStats> paginatedStatsUsers = new();
    private string statsSearchTerm = string.Empty;
    private SortableTableHelper<UserAttendanceStats> statsSortHelper = new() { SortColumn = nameof(UserAttendanceStats.Count), SortAscending = false };
    private PaginationHelper<UserAttendanceStats> statsPaginationHelper = new() { PageSize = 20 };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await LoadMembers();
        loading = false;
    }
    
    private async Task LoadMembers()
    {
        // Load all members with Member role for the add dropdown
        var membersInRole = await UserManager.GetUsersInRoleAsync("Member");
        allMembers = membersInRole.OrderBy(u => u.FirstName).ThenBy(u => u.LastName).ToList();
    }

    private async Task LoadData()
    {
        // Load 1 year ahead and behind to support long-range creation
        var startDate = DateTime.Today.AddDays(-365);
        var endDate = DateTime.Today.AddDays(365);
        rehearsals = (await RehearsalService.GetRehearsalsAsync(startDate, endDate)).ToList();
        ApplyFiltersAndPagination();
    }
    
    private bool IsNextUpcoming(Rehearsal rehearsal)
    {
        if (rehearsals == null || rehearsal.Date < DateTime.Today)
            return false;
            
        var firstUpcoming = rehearsals
            .Where(r => !r.IsCanceled && r.Date >= DateTime.Today)
            .OrderBy(r => r.Date)
            .FirstOrDefault();
            
        return firstUpcoming?.Id == rehearsal.Id;
    }
    
    private bool IsLastPast(Rehearsal rehearsal)
    {
        if (rehearsals == null || rehearsal.Date >= DateTime.Today)
            return false;
            
        var lastPast = rehearsals
            .Where(r => !r.IsCanceled && r.Date < DateTime.Today)
            .OrderByDescending(r => r.Date)
            .FirstOrDefault();
            
        return lastPast?.Id == rehearsal.Id;
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    // Search and filtering
    private void HandleSearchChanged(string newSearchTerm)
    {
        searchTerm = newSearchTerm;
        paginationHelper.CurrentPage = 1;
        ApplyFiltersAndPagination();
    }

    private void ApplyFiltersAndPagination()
    {
        if (rehearsals == null)
        {
            filteredRehearsals = new List<Rehearsal>();
            paginatedRehearsals = new List<Rehearsal>();
            return;
        }

        // Apply search filter
        filteredRehearsals = string.IsNullOrWhiteSpace(searchTerm)
            ? rehearsals.ToList()
            : rehearsals.Where(r =>
                (r.Location?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (r.Theme?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();
        
        // Apply status filter
        if (statusFilter == "upcoming")
        {
            filteredRehearsals = filteredRehearsals.Where(r => r.Date >= DateTime.Today).ToList();
        }
        else if (statusFilter == "past")
        {
            filteredRehearsals = filteredRehearsals.Where(r => r.Date < DateTime.Today).ToList();
        }

        // Apply sorting
        var columnSelectors = new Dictionary<string, Func<Rehearsal, IComparable>>
        {
            { nameof(Rehearsal.Date), r => r.Date },
            { nameof(Rehearsal.Location), r => r.Location },
            { nameof(Rehearsal.Theme), r => r.Theme ?? string.Empty }
        };
        filteredRehearsals = sortHelper.ApplySort(filteredRehearsals, columnSelectors);

        // Apply pagination
        paginatedRehearsals = paginationHelper.GetPageData(filteredRehearsals);
    }

    private void SortBy(string columnName)
    {
        sortHelper.ChangeSortColumn(columnName);
        ApplyFiltersAndPagination();
    }

    private void HandlePageChange(int newPage)
    {
        paginationHelper.GoToPage(newPage);
        ApplyFiltersAndPagination();
    }

    private void HandlePageSizeChange(int newPageSize)
    {
        paginationHelper.PageSize = newPageSize;
        paginationHelper.CurrentPage = 1;
        ApplyFiltersAndPagination();
    }

    // Range modal methods
    private void OpenCreateRangeModal()
    {
        rangeStartDate = DateTime.Today;
        rangeEndDate = DateTime.Today.AddMonths(1);
        rangeLocation = "Centro Académico";
        rangeTheme = null;
        showRangeModal = true;
    }

    private void CloseRangeModal()
    {
        showRangeModal = false;
    }

    private async Task CreateRangeRehearsals()
    {
        if (rangeEndDate.Date < rangeStartDate.Date)
            return;

        // Reload rehearsals to check against fresh data
        await LoadData();

        int createdCount = 0;
        for (var date = rangeStartDate.Date; date <= rangeEndDate.Date; date = date.AddDays(1))
        {
            if (date.DayOfWeek == DayOfWeek.Tuesday || date.DayOfWeek == DayOfWeek.Thursday)
            {
                // Check if rehearsal already exists on this date
                var existing = rehearsals?.FirstOrDefault(r => r.Date.Date == date.Date);
                if (existing == null)
                {
                    await RehearsalService.CreateRehearsalAsync(date, rangeLocation, rangeTheme);
                    createdCount++;
                }
            }
        }
        
        await LoadData();
        CloseRangeModal();
        StateHasChanged();
    }

    // Single modal methods
    private void OpenCreateSingleModal()
    {
        editingRehearsal = null;
        singleDate = DateTime.Today.AddDays(1);
        singleLocation = "Centro Académico";
        singleTheme = null;
        singleNotes = null;
        showSingleModal = true;
    }

    private void OpenEditModal(Rehearsal rehearsal)
    {
        editingRehearsal = rehearsal;
        singleDate = rehearsal.Date;
        singleLocation = rehearsal.Location;
        singleTheme = rehearsal.Theme;
        singleNotes = rehearsal.Notes;
        showSingleModal = true;
    }

    private void CloseSingleModal()
    {
        showSingleModal = false;
        editingRehearsal = null;
    }

    private async Task SaveSingleRehearsal()
    {
        if (editingRehearsal == null)
        {
            await RehearsalService.CreateRehearsalAsync(singleDate, singleLocation, singleTheme);
        }
        else
        {
            await RehearsalService.UpdateRehearsalAsync(editingRehearsal.Id, singleLocation, singleTheme, singleNotes);
        }
        
        await LoadData();
        CloseSingleModal();
    }

    // Delete methods
    private void OpenDeleteConfirmation(Rehearsal rehearsal)
    {
        rehearsalToDelete = rehearsal;
        showDeleteConfirmation = true;
    }

    private async Task ConfirmDelete()
    {
        if (rehearsalToDelete != null)
        {
            await RehearsalService.DeleteRehearsalAsync(rehearsalToDelete.Id);
            await LoadData();
            rehearsalToDelete = null;
        }
    }

    private void CancelDelete()
    {
        rehearsalToDelete = null;
    }

    // Attendances modal methods
    private async Task ViewAttendances(Rehearsal rehearsal)
    {
        selectedRehearsal = rehearsal;
        selectedRehearsalAttendances = (await AttendanceService.GetAttendancesByRehearsalIdAsync(rehearsal.Id)).ToList();
        
        // Load user details
        foreach (var attendance in selectedRehearsalAttendances)
        {
            if (attendance.User == null)
            {
                attendance.User = await UserManager.FindByIdAsync(attendance.UserId);
            }
        }
        
        attendanceSearchTerm = string.Empty;
        ApplyAttendanceSearch();
        showAttendancesModal = true;
    }
    
    private void ApplyAttendanceSearch()
    {
        if (selectedRehearsalAttendances == null)
        {
            filteredAttendances = new List<RehearsalAttendance>();
            return;
        }
        
        filteredAttendances = string.IsNullOrWhiteSpace(attendanceSearchTerm)
            ? selectedRehearsalAttendances.ToList()
            : selectedRehearsalAttendances.Where(a =>
                (a.User?.FirstName?.Contains(attendanceSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (a.User?.Nickname?.Contains(attendanceSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();
    }
    
    private void HandleAttendanceSearchChanged(string newSearchTerm)
    {
        attendanceSearchTerm = newSearchTerm;
        ApplyAttendanceSearch();
    }

    private void CloseAttendancesModal()
    {
        showAttendancesModal = false;
        selectedRehearsal = null;
        selectedRehearsalAttendances = null;
        filteredAttendances = new();
        attendanceSearchTerm = string.Empty;
        
        // Reset add member state
        showAddMemberDropdown = false;
        addMemberSearchTerm = string.Empty;
        filteredMembersForAdd = new();
        feedbackDismissTimer?.Dispose();
        addMemberFeedbackMessage = string.Empty;
        addMemberFeedbackIsError = false;
    }
    
    private void ToggleAddMemberDropdown()
    {
        showAddMemberDropdown = !showAddMemberDropdown;
        if (!showAddMemberDropdown)
        {
            addMemberSearchTerm = string.Empty;
            filteredMembersForAdd = new();
        }
        ClearAddMemberFeedback();
    }
    
    private void FilterMembersForAdd()
    {
        if (string.IsNullOrWhiteSpace(addMemberSearchTerm))
        {
            filteredMembersForAdd = new();
            return;
        }
        
        // Filter members who are NOT already in the attendance list
        var existingUserIds = selectedRehearsalAttendances?.Select(a => a.UserId).ToHashSet() ?? new HashSet<string>();
        
        filteredMembersForAdd = allMembers
            .Where(m => !existingUserIds.Contains(m.Id))
            .Where(m =>
                (m.FirstName?.Contains(addMemberSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (m.LastName?.Contains(addMemberSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (m.Nickname?.Contains(addMemberSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                ($"{m.FirstName} {m.LastName}".Contains(addMemberSearchTerm, StringComparison.OrdinalIgnoreCase)))
            .OrderBy(m => m.FirstName)
            .ThenBy(m => m.LastName)
            .ToList();
    }
    
    private void ClearAddMemberSearch()
    {
        addMemberSearchTerm = string.Empty;
        filteredMembersForAdd = new();
    }
    
    private void ClearAddMemberFeedback()
    {
        feedbackDismissTimer?.Dispose();
        addMemberFeedbackMessage = string.Empty;
        addMemberFeedbackIsError = false;
    }
    
    private void HandleAddMemberSearchChanged(string searchTerm)
    {
        addMemberSearchTerm = searchTerm;
        FilterMembersForAdd();
    }
    
    private void HandleAddMemberKeyDown(KeyboardEventArgs e)
    {
        // Esc key collapses the search
        if (e.Key == "Escape")
        {
            showAddMemberDropdown = false;
            addMemberSearchTerm = string.Empty;
            filteredMembersForAdd = new();
        }
    }
    
    private async Task HandleMemberItemKeyDown(KeyboardEventArgs e, ApplicationUser member)
    {
        // Enter key confirms selection
        if (e.Key == "Enter")
        {
            await AddMemberToAttendance(member);
        }
    }
    
    private async Task AddMemberToAttendance(ApplicationUser member)
    {
        if (selectedRehearsal == null)
            return;
        
        try
        {
            // Create attendance record
            // Note: MarkAttendanceAsync defaults to Attended=false (pending approval)
            // We immediately update it to Attended=true since admin is adding them
            var attendance = await AttendanceService.MarkAttendanceAsync(
                selectedRehearsal.Id, 
                member.Id, 
                member.MainInstrument);
            
            // Mark as attended (confirmed) immediately for admin additions
            await AttendanceService.UpdateAttendanceAsync(attendance.Id, true, member.MainInstrument);
            
            // Reload modal data to show the new member in the attendance list
            await ViewAttendances(selectedRehearsal);
            
            // Reload main table data to update attendance counts in rehearsal list
            // (counts are calculated from rehearsal.Attendances navigation property)
            await LoadData();
            
            // Reset add member dropdown
            showAddMemberDropdown = false;
            addMemberSearchTerm = string.Empty;
            filteredMembersForAdd = new();
            
            // Show success feedback
            var displayName = !string.IsNullOrEmpty(member.Nickname) ? member.Nickname : $"{member.FirstName} {member.LastName}";
            addMemberFeedbackMessage = $"{displayName} foi adicionado à lista de presenças.";
            addMemberFeedbackIsError = false;
            
            // Auto-dismiss success message after 3 seconds
            feedbackDismissTimer?.Dispose();
            feedbackDismissTimer = new Timer(_ =>
            {
                InvokeAsync(() =>
                {
                    ClearAddMemberFeedback();
                    StateHasChanged();
                });
            }, null, 3000, Timeout.Infinite);
        }
        catch (Exception ex)
        {
            addMemberFeedbackMessage = $"Erro ao adicionar membro: {ex.Message}";
            addMemberFeedbackIsError = true;
            // Error messages require manual dismissal (no auto-dismiss)
        }
        
        StateHasChanged();
    }

    private async Task ApproveAttendance(RehearsalAttendance attendance)
    {
        await AttendanceService.UpdateAttendanceAsync(attendance.Id, true, attendance.Instrument);
        await ViewAttendances(selectedRehearsal!);
        await LoadData();
    }

    private async Task UnapproveAttendance(RehearsalAttendance attendance)
    {
        await AttendanceService.UpdateAttendanceAsync(attendance.Id, false, attendance.Instrument);
        await ViewAttendances(selectedRehearsal!);
        await LoadData();
    }
    
    private void OpenDeleteAttendanceConfirmation(RehearsalAttendance attendance)
    {
        attendanceToDelete = attendance;
        showDeleteAttendanceConfirmation = true;
    }
    
    private async Task ConfirmDeleteAttendance()
    {
        if (attendanceToDelete != null)
        {
            await AttendanceService.DeleteAttendanceAsync(attendanceToDelete.Id);
            await ViewAttendances(selectedRehearsal!);
            await LoadData();
            attendanceToDelete = null;
        }
    }
    
    private void CancelDeleteAttendance()
    {
        attendanceToDelete = null;
    }

    // Stats methods
    private async Task LoadStats()
    {
        var stats = await AttendanceService.GetAttendanceStatsAsync(statsStartDate, statsEndDate);
        attendanceStatsUsers = new List<UserAttendanceStats>();
        
        foreach (var stat in stats)
        {
            var user = await UserManager.FindByIdAsync(stat.Key);
            if (user != null)
            {
                attendanceStatsUsers.Add(new UserAttendanceStats
                {
                    UserId = stat.Key,
                    UserName = $"{user.FirstName} \"{user.Nickname}\"",
                    Count = stat.Value
                });
            }
        }
        
        ApplyStatsFiltersAndPagination();
        StateHasChanged();
    }
    
    private void HandleStatsSearchChanged(string newSearchTerm)
    {
        statsSearchTerm = newSearchTerm;
        statsPaginationHelper.CurrentPage = 1;
        ApplyStatsFiltersAndPagination();
    }
    
    private void ApplyStatsFiltersAndPagination()
    {
        if (attendanceStatsUsers == null)
        {
            filteredStatsUsers = new List<UserAttendanceStats>();
            paginatedStatsUsers = new List<UserAttendanceStats>();
            return;
        }

        // Apply search filter
        filteredStatsUsers = string.IsNullOrWhiteSpace(statsSearchTerm)
            ? attendanceStatsUsers.ToList()
            : attendanceStatsUsers.Where(s =>
                (s.UserName?.Contains(statsSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();

        // Apply sorting
        var columnSelectors = new Dictionary<string, Func<UserAttendanceStats, IComparable>>
        {
            { nameof(UserAttendanceStats.UserName), s => s.UserName },
            { nameof(UserAttendanceStats.Count), s => s.Count }
        };
        filteredStatsUsers = statsSortHelper.ApplySort(filteredStatsUsers, columnSelectors);

        // Apply pagination
        paginatedStatsUsers = statsPaginationHelper.GetPageData(filteredStatsUsers);
    }
    
    private void SortStatsBy(string columnName)
    {
        statsSortHelper.ChangeSortColumn(columnName);
        ApplyStatsFiltersAndPagination();
    }
    
    private void HandleStatsPageChange(int newPage)
    {
        statsPaginationHelper.GoToPage(newPage);
        ApplyStatsFiltersAndPagination();
    }
    
    private void HandleStatsPageSizeChange(int newPageSize)
    {
        statsPaginationHelper.PageSize = newPageSize;
        statsPaginationHelper.CurrentPage = 1;
        ApplyStatsFiltersAndPagination();
    }

    private class UserAttendanceStats
    {
        public string UserId { get; set; } = string.Empty;
        public string UserName { get; set; } = string.Empty;
        public int Count { get; set; }
    }
}
