@using RTUB.Application.Interfaces
@using RTUB.Shared
@using RTUB.Core.Entities
@inject ILabelService LabelService
@inject ILogger<FitabContent> Logger
@namespace RTUB.Components.Portal

<div class="fitab-page">
    <!-- Header / Intro Section -->
    <section class="fitab-intro">
        <div class="portal-section-header justify-content-between">
            <h1 class="portal-section-title">@(titleLabel?.Content ?? "A carregar...")</h1>
            <LabelEditButton CurrentLabel="@titleLabel" OnEditClick="@OpenEditModal" />
        </div>
        <div class="portal-section-divider"></div>
        <div class="fitab-section-header">
            <h2 class="fitab-subtitle">@(subtitleLabel?.Content ?? "")</h2>
            <LabelEditButton CurrentLabel="@subtitleLabel" OnEditClick="@OpenEditModal" />
        </div>
        @if (introLabel != null)
        {
            <div class="fitab-content-wrapper">
                <p class="fitab-intro-text fitab-content-text">@introLabel.Content</p>
                <LabelEditButton CurrentLabel="@introLabel" OnEditClick="@OpenEditModal" />
            </div>
        }
    </section>

    <!-- Overview Card: O que é + Importância -->
    <div class="fitab-overview-card">
        <div class="fitab-overview-grid">
            <!-- Left Column: What is FITAB -->
            <div class="fitab-overview-column">
                <div class="fitab-section-header">
                    <h3 class="fitab-overview-heading">
                        <i class="bi bi-info-circle"></i>
                        @(whatTitleLabel?.Content ?? "O que é")
                    </h3>
                    <LabelEditButton CurrentLabel="@whatTitleLabel" OnEditClick="@OpenEditModal" />
                </div>
                <div class="fitab-content-wrapper">
                    <div class="fitab-overview-content fitab-content-text">@(whatContentLabel?.Content ?? "")</div>
                    <LabelEditButton CurrentLabel="@whatContentLabel" OnEditClick="@OpenEditModal" />
                </div>
            </div>

            <!-- Right Column: Importance -->
            <div class="fitab-overview-column">
                <div class="fitab-section-header">
                    <h3 class="fitab-overview-heading">
                        <i class="bi bi-star"></i>
                        @(importanceTitleLabel?.Content ?? "Importância")
                    </h3>
                    <LabelEditButton CurrentLabel="@importanceTitleLabel" OnEditClick="@OpenEditModal" />
                </div>
                <div class="fitab-content-wrapper">
                    <div class="fitab-overview-content fitab-content-text">@(importanceContentLabel?.Content ?? "")</div>
                    <LabelEditButton CurrentLabel="@importanceContentLabel" OnEditClick="@OpenEditModal" />
                </div>
            </div>
        </div>
    </div>

    <!-- Características Section -->
    <div class="fitab-features-card">
        <div class="fitab-section-header">
            <h3 class="fitab-features-heading">
                <i class="bi bi-list-check"></i>
                @(featuresTitleLabel?.Content ?? "Características")
            </h3>
            <LabelEditButton CurrentLabel="@featuresTitleLabel" OnEditClick="@OpenEditModal" />
        </div>
        <div class="fitab-content-wrapper">
            <div class="fitab-content-text">
                @if (!string.IsNullOrEmpty(featuresContentLabel?.Content))
                {
                    <ul class="fitab-features-list">
                        @foreach (var line in featuresContentLabel.Content.Split('\n', StringSplitOptions.RemoveEmptyEntries))
                        {
                            <li>@line.Trim()</li>
                        }
                    </ul>
                }
            </div>
            <LabelEditButton CurrentLabel="@featuresContentLabel" OnEditClick="@OpenEditModal" />
        </div>
    </div>

    <!-- Quando Section -->
    <div class="fitab-when-card">
        <div class="fitab-section-header">
            <h3 class="fitab-when-heading">
                <i class="bi bi-calendar-event"></i>
                @(whenTitleLabel?.Content ?? "Quando")
            </h3>
            <LabelEditButton CurrentLabel="@whenTitleLabel" OnEditClick="@OpenEditModal" />
        </div>
        <div class="fitab-content-wrapper">
            <div class="fitab-when-content fitab-content-text">@(whenContentLabel?.Content ?? "")</div>
            <LabelEditButton CurrentLabel="@whenContentLabel" OnEditClick="@OpenEditModal" />
        </div>
    </div>
</div>

<!-- Edit Label Modal (at root level, outside cards) -->
<Modal Show="@showEditModal" 
       ShowChanged="@((value) => showEditModal = value)"
       Title="Editar Conteúdo"
       Size="Modal.ModalSize.Large"
       OnClose="CloseEditModal">
    <BodyContent>
        @if (editingLabel != null)
        {
            <EditForm Model="editingLabel" OnValidSubmit="SaveLabel">
                <DataAnnotationsValidator />
                <ErrorDisplay />

                <div class="mb-3">
                    <label class="form-label text-white-full">Referência</label>
                    <input type="text" class="form-control" value="@editingLabel.Reference" disabled />
                    <small class="text-white-opacity">Identificador único (não editável)</small>
                </div>

                <div class="mb-3">
                    <label class="form-label text-white-full">Título</label>
                    <InputText class="form-control" @bind-Value="editingLabel.Title" placeholder="Inserir título..." />
                </div>

                <div class="mb-3">
                    <label class="form-label text-white-full">Conteúdo</label>
                    <InputTextArea class="form-control" rows="10" @bind-Value="editingLabel.Content" 
                                   placeholder="Inserir conteúdo..." />
                    <small class="text-white-opacity">Dica: Use quebras de linha para formatar o texto</small>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </EditForm>
        }
    </BodyContent>
</Modal>

@code {
    private Label? titleLabel;
    private Label? subtitleLabel;
    private Label? introLabel;
    private Label? whatTitleLabel;
    private Label? whatContentLabel;
    private Label? featuresTitleLabel;
    private Label? featuresContentLabel;
    private Label? whenTitleLabel;
    private Label? whenContentLabel;
    private Label? importanceTitleLabel;
    private Label? importanceContentLabel;

    private Label? editingLabel;
    private bool showEditModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadLabels();
    }

    private async Task LoadLabels()
    {
        titleLabel = await LabelService.GetLabelByReferenceAsync("fitab_title");
        subtitleLabel = await LabelService.GetLabelByReferenceAsync("fitab_subtitle");
        introLabel = await LabelService.GetLabelByReferenceAsync("fitab_intro");
        whatTitleLabel = await LabelService.GetLabelByReferenceAsync("fitab_what_title");
        whatContentLabel = await LabelService.GetLabelByReferenceAsync("fitab_what_content");
        featuresTitleLabel = await LabelService.GetLabelByReferenceAsync("fitab_features_title");
        featuresContentLabel = await LabelService.GetLabelByReferenceAsync("fitab_features_content");
        whenTitleLabel = await LabelService.GetLabelByReferenceAsync("fitab_when_title");
        whenContentLabel = await LabelService.GetLabelByReferenceAsync("fitab_when_content");
        importanceTitleLabel = await LabelService.GetLabelByReferenceAsync("fitab_importance_title");
        importanceContentLabel = await LabelService.GetLabelByReferenceAsync("fitab_importance_content");
    }

    private void OpenEditModal(Label label)
    {
        editingLabel = new Label
        {
            Id = label.Id,
            Reference = label.Reference,
            Title = label.Title,
            Content = label.Content,
            IsActive = label.IsActive
        };
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingLabel = null;
    }

    private async Task SaveLabel()
    {
        if (editingLabel == null) return;

        try
        {
            await LabelService.UpdateLabelContentAsync(
                editingLabel.Id,
                editingLabel.Title,
                editingLabel.Content,
                editingLabel.IsActive
            );

            await LoadLabels();
            
            showEditModal = false;
            editingLabel = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating label");
        }
    }
}
