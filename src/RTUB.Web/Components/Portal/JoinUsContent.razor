@using RTUB.Application.Interfaces
@using RTUB.Shared
@using RTUB.Core.Entities
@inject ILabelService LabelService
@inject ILogger<JoinUsContent> Logger
@namespace RTUB.Components.Portal

<!-- Intro Area: Centered title, subtitle, and description -->
<section class="join-us-intro text-center mb-5">
    <div class="portal-section-header justify-content-center">
        <h1 class="portal-section-title">@(titleLabel?.Content ?? "A carregar...")</h1>
        <LabelEditButton CurrentLabel="@titleLabel" OnEditClick="@OpenEditModal" CssClass="ms-2" />
    </div>
    <div class="portal-section-divider"></div>
    <div class="d-flex justify-content-center align-items-baseline mb-3">
        <h2 class="join-us-subtitle">@(subtitleLabel?.Content ?? "")</h2>
        <LabelEditButton CurrentLabel="@subtitleLabel" OnEditClick="@OpenEditModal" CssClass="ms-2" />
    </div>
    @if (introLabel != null)
    {
        <div class="d-flex justify-content-center align-items-start">
            <p class="join-us-intro-text">@introLabel.Content</p>
            <LabelEditButton CurrentLabel="@introLabel" OnEditClick="@OpenEditModal" CssClass="ms-2" />
        </div>
    }
</section>

<!-- Schedule & Location: Merged horizontal info block -->
<section class="join-us-info-block mb-5">
    <div class="info-block-container">
        <div class="info-block-column">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="info-block-header">
                    <i class="bi bi-clock-fill me-2"></i>
                    <h3>@(scheduleTitleLabel?.Content ?? "")</h3>
                </div>
                <LabelEditButton CurrentLabel="@scheduleTitleLabel" OnEditClick="@OpenEditModal" />
            </div>
            <div class="d-flex justify-content-between align-items-start">
                <p class="info-block-content">@(scheduleContentLabel?.Content ?? "")</p>
                <LabelEditButton CurrentLabel="@scheduleContentLabel" OnEditClick="@OpenEditModal" CssClass="ms-2" />
            </div>
        </div>
        <div class="info-block-divider"></div>
        <div class="info-block-column">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="info-block-header">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    <h3>@(locationTitleLabel?.Content ?? "")</h3>
                </div>
                <LabelEditButton CurrentLabel="@locationTitleLabel" OnEditClick="@OpenEditModal" />
            </div>
            <div class="d-flex justify-content-between align-items-start">
                <p class="info-block-content">@(locationContentLabel?.Content ?? "")</p>
                <LabelEditButton CurrentLabel="@locationContentLabel" OnEditClick="@OpenEditModal" CssClass="ms-2" />
            </div>
        </div>
    </div>
</section>

<!-- Activities Section: Single wide card -->
<section class="join-us-activities mb-5">
    <div class="activities-card">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="activities-header">
                <i class="bi bi-music-note-list me-2"></i>
                <h3>@(activitiesTitleLabel?.Content ?? "")</h3>
            </div>
            <LabelEditButton CurrentLabel="@activitiesTitleLabel" OnEditClick="@OpenEditModal" />
        </div>
        <div class="d-flex justify-content-between align-items-start">
            <div class="activities-content">@(activitiesContentLabel?.Content ?? "")</div>
            <LabelEditButton CurrentLabel="@activitiesContentLabel" OnEditClick="@OpenEditModal" CssClass="ms-2" />
        </div>
    </div>
</section>

<!-- Motivational Banner: Purple gradient highlight -->
@if (noExperienceLabel != null)
{
    <section class="join-us-motivation mb-5">
        <div class="motivation-banner">
            <div class="d-flex justify-content-between align-items-center">
                <div class="motivation-content">
                    <i class="bi bi-lightning-charge-fill me-3"></i>
                    <strong>@noExperienceLabel.Content</strong>
                </div>
                <div class="motivation-edit-button">
                    <LabelEditButton CurrentLabel="@noExperienceLabel" OnEditClick="@OpenEditModal" />
                </div>
            </div>
        </div>
    </section>
}


<!-- How to Join: Simplified centered section -->
<section class="join-us-how-to text-center mb-5">
    <div class="d-flex justify-content-center align-items-baseline mb-3">
        <i class="bi bi-hand-thumbs-up-fill me-2 how-to-icon"></i>
        <h3>@(howToTitleLabel?.Content ?? "")</h3>
        <LabelEditButton CurrentLabel="@howToTitleLabel" OnEditClick="@OpenEditModal" CssClass="ms-2" />
    </div>
    <div class="d-flex justify-content-center align-items-start">
        <p class="how-to-content">@(howToContentLabel?.Content ?? "")</p>
        <LabelEditButton CurrentLabel="@howToContentLabel" OnEditClick="@OpenEditModal" CssClass="ms-2" />
    </div>
</section>

<!-- Edit Label Modal (at root level, outside cards) -->
<Modal Show="@showEditModal" 
       ShowChanged="@((value) => showEditModal = value)"
       Title="Editar Conteúdo"
       Size="Modal.ModalSize.Large"
       OnClose="CloseEditModal">
    <BodyContent>
        @if (editingLabel != null)
        {
            <EditForm Model="editingLabel" OnValidSubmit="SaveLabel">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="mb-3">
                    <label class="form-label text-white-full">Referência</label>
                    <input type="text" class="form-control" value="@editingLabel.Reference" disabled />
                    <small class="text-white-opacity">Identificador único (não editável)</small>
                </div>

                <div class="mb-3">
                    <label class="form-label text-white-full">Título</label>
                    <InputText class="form-control" @bind-Value="editingLabel.Title" placeholder="Inserir título..." />
                </div>

                <div class="mb-3">
                    <label class="form-label text-white-full">Conteúdo</label>
                    <InputTextArea class="form-control" rows="10" @bind-Value="editingLabel.Content" 
                                   placeholder="Inserir conteúdo..." />
                    <small class="text-white-opacity">Dica: Use quebras de linha para formatar o texto</small>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </EditForm>
        }
    </BodyContent>
</Modal>

@code {
    private Label? titleLabel;
    private Label? subtitleLabel;
    private Label? introLabel;
    private Label? scheduleTitleLabel;
    private Label? scheduleContentLabel;
    private Label? locationTitleLabel;
    private Label? locationContentLabel;
    private Label? activitiesTitleLabel;
    private Label? activitiesContentLabel;
    private Label? noExperienceLabel;
    private Label? howToTitleLabel;
    private Label? howToContentLabel;

    private Label? editingLabel;
    private bool showEditModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadLabels();
    }

    private async Task LoadLabels()
    {
        titleLabel = await LabelService.GetLabelByReferenceAsync("join_us_title");
        subtitleLabel = await LabelService.GetLabelByReferenceAsync("join_us_subtitle");
        introLabel = await LabelService.GetLabelByReferenceAsync("join_us_intro");
        scheduleTitleLabel = await LabelService.GetLabelByReferenceAsync("join_us_schedule_title");
        scheduleContentLabel = await LabelService.GetLabelByReferenceAsync("join_us_schedule_content");
        locationTitleLabel = await LabelService.GetLabelByReferenceAsync("join_us_location_title");
        locationContentLabel = await LabelService.GetLabelByReferenceAsync("join_us_location_content");
        activitiesTitleLabel = await LabelService.GetLabelByReferenceAsync("join_us_activities_title");
        activitiesContentLabel = await LabelService.GetLabelByReferenceAsync("join_us_activities_content");
        noExperienceLabel = await LabelService.GetLabelByReferenceAsync("join_us_no_experience");
        howToTitleLabel = await LabelService.GetLabelByReferenceAsync("join_us_how_to_title");
        howToContentLabel = await LabelService.GetLabelByReferenceAsync("join_us_how_to_content");
    }

    private void OpenEditModal(Label label)
    {
        editingLabel = new Label
        {
            Id = label.Id,
            Reference = label.Reference,
            Title = label.Title,
            Content = label.Content,
            IsActive = label.IsActive
        };
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingLabel = null;
    }

    private async Task SaveLabel()
    {
        if (editingLabel == null) return;

        try
        {
            await LabelService.UpdateLabelContentAsync(
                editingLabel.Id,
                editingLabel.Title,
                editingLabel.Content
            );

            await LoadLabels();
            
            showEditModal = false;
            editingLabel = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating label");
        }
    }
}
