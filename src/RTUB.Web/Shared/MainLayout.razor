@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using RTUB.Application.Data
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions
@using RTUB.Core.Entities
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IJSRuntime JSRuntime
@inject RTUB.Web.Services.ProfilePictureUpdateService ProfilePictureUpdateService
@implements IDisposable

<nav class="navbar navbar-expand-lg navbar-dark border-bottom navbar-main">
    <div class="container-xxl rtub-wide px-xxl-4">
        <a class="navbar-brand" href="/">RTUB</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav" aria-controls="topNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="topNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">

                <li class="nav-item"><NavLink class="nav-link" href="/music"><i class="bi bi-music-note-beamed"></i> Música</NavLink></li>
                <li class="nav-item"><NavLink class="nav-link" href="/events"><i class="bi bi-calendar-event"></i> Atuações</NavLink></li>

                <AuthorizeView>
                    <Authorized>
                        <li class="nav-item"><NavLink class="nav-link" href="/rehearsals"><i class="bi bi-music-note-list"></i> Ensaios</NavLink></li>
                        <li class="nav-item"><NavLink class="nav-link" href="/inventory"><i class="bi bi-music-note"></i> Instrumentos</NavLink></li>
                    </Authorized>
                </AuthorizeView>

                <AuthorizeView>
                    <NotAuthorized>
                <li class="nav-item"><NavLink class="nav-link" href="/request"><i class="bi bi-envelope"></i> Pedidos</NavLink></li>
                    </NotAuthorized>
                </AuthorizeView>

                <li class="nav-item"><NavLink class="nav-link" href="/roles"><i class="bi bi-bank"></i> Órgãos Sociais</NavLink></li>

                <AuthorizeView Context="mainAuthContext">
                    <Authorized>
                        <li class="nav-item"><NavLink class="nav-link" href="/hierarchy"><i class="bi bi-diagram-3"></i> Hierarquia</NavLink></li>
                        <li class="nav-item"><NavLink class="nav-link" href="/members"><i class="bi bi-people"></i> Membros</NavLink></li>
                        <li class="nav-item"><NavLink class="nav-link" href="/shop"><i class="bi bi-bag"></i> Loja</NavLink></li>
                        
                        <li class="nav-item dropdown">
                            <button class="nav-link dropdown-toggle" type="button" id="managementDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">
                                <i class="bi bi-gear-fill"></i> Gestão
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="managementDropdown">
                                @if (currentUser != null && !currentUser.IsLeitao())
                                {
                                    <li><NavLink class="dropdown-item" href="/finance"><i class="bi bi-cash-stack"></i> Tesouraria</NavLink></li>
                                }
                                <li><NavLink class="dropdown-item" href="/requests"><i class="bi bi-envelope"></i> Pedidos</NavLink></li>
                                <li><NavLink class="dropdown-item" href="/logistics"><i class="bi bi-kanban"></i> Logística</NavLink></li>
                                <AuthorizeView Roles="Admin" Context="adminContext">
                                    <Authorized>
                                        <li><NavLink class="dropdown-item" href="/images"><i class="bi bi-images"></i> Imagens</NavLink></li>
                                    </Authorized>
                                </AuthorizeView>
                            </ul>
                        </li>
                    </Authorized>
                </AuthorizeView>

                <AuthorizeView Roles="Owner">
                    <Authorized>
                        <li class="nav-item dropdown">
                            <button class="nav-link dropdown-toggle" type="button" id="ownerDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">
                                <i class="bi bi-shield-fill-check"></i> Owner
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="ownerDropdown">
                                <li><NavLink class="dropdown-item" href="/owner/user-roles"><i class="bi bi-people"></i> Funções</NavLink></li>
                                <li><NavLink class="dropdown-item" href="/owner/tracing"><i class="bi bi-shield-check"></i> Tracing</NavLink></li>
                                <li><NavLink class="dropdown-item" href="/owner/labels"><i class="bi bi-tag"></i> Conteúdo</NavLink></li>
                            </ul>
                        </li>
                    </Authorized>
                </AuthorizeView>
            </ul>

            <AuthorizeView>
                <Authorized>
                    <ul class="navbar-nav mb-2 mb-lg-0">
                        @if (currentUser != null)
                        {
                            @if (currentUser.IsLeitao())
                            {
                                <li class="nav-item d-flex align-items-center">
                                    <CategoryBadge Category="MemberCategory.Leitao" AdditionalClasses="me-1" />
                                </li>
                            }
                            else if (currentUser.IsCaloiro())
                            {
                                <li class="nav-item d-flex align-items-center">
                                    <CategoryBadge Category="MemberCategory.Caloiro" AdditionalClasses="me-1" />
                                </li>
                            }
                            else if (currentUser.IsTuno())
                            {
                                if (currentUser.Positions.Contains(Position.Magister))
                                {
                                    <li class="nav-item d-flex align-items-center">
                                        <PositionBadge Position="Position.Magister" AdditionalClasses="me-1" />
                                    </li>
                                }
                                else
                                {
                                    <li class="nav-item d-flex align-items-center">
                                        <CategoryBadge Category="MemberCategory.Tuno" AdditionalClasses="me-1" />
                                    </li>
                                }
                            }
                        }
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                @if (currentUser != null)
                                {
                                    <img src="@GetNavbarAvatarUrl()" 
                                         alt="@currentUser.Nickname" 
                                         class="navbar-avatar me-2"
                                         onerror="this.onerror=null; this.src='/images/default-avatar.webp';" />
                                    <span>@currentUser.Nickname</span>
                                }
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/profile"><i class="bi bi-person-circle"></i> Meu Perfil</a></li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <form method="post" action="/auth/logout" @formname="LogoutForm" class="logout-form">
                                        <button type="submit" class="dropdown-item"><i class="bi bi-box-arrow-right"></i> Sair</button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </Authorized>
                <NotAuthorized>
                    <a class="btn" href="/login">Entrar</a>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </div>
</nav>

<div class="layout d-flex">
    <main id="content" class="content flex-fill content-main">
        <div class="container-xxl rtub-wide py-4 px-xxl-4">
            @Body
        </div>
    </main>
</div>

<footer class="footer mt-auto py-3 footer-main">
    <div class="container-xxl rtub-wide text-center px-xxl-4">
        <p class="footer-text">
            &copy; 2025 Real Tuna Universitária de Bragança.
        </p>
    </div>
</footer>

<HeadContent>
    @* Mobile-first viewport configuration *@
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#6f42c1" />
    
    <link rel="icon" type="image/webp" href="/images/rtub_logo.webp" />

    @* Preconnect to CDN for faster loading *@
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

    <link href="/lib/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="/lib/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" crossorigin="anonymous" />
    <link href="/css/site.css" rel="stylesheet" />
    <link href="/css/profile.css" rel="stylesheet" />
    <link href="/css/aboutus.css" rel="stylesheet" />
    <link href="/css/joinus.css" rel="stylesheet" />
    <link href="/css/history.css" rel="stylesheet" />
    <link href="/css/hierarchy.css" rel="stylesheet" />
    <link href="/css/fitab.css" rel="stylesheet" />
    <link href="/css/avatarcard.css" rel="stylesheet" />
    <link href="/css/enrollmentcard.css" rel="stylesheet" />
    <link href="/css/instrumentcircle.css" rel="stylesheet" />
    <link href="/css/detailsmodal.css" rel="stylesheet" />
    <link href="/css/kanban.css" rel="stylesheet" />
</HeadContent>

<script src="/_framework/blazor.web.js" autostart="false" suppress-error="BL9992"></script>
<script src="/lib/bootstrap/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js" crossorigin="anonymous"></script>
<script src="/js/fileDownload.js"></script>
<script src="/js/imageCropper.js"></script>
<script src="/js/profilePictureRefresh.js"></script>
<script src="/js/familyTree.js"></script>
<script src="/js/roleBadge.js"></script>
<script src="/js/scrollToTop.js"></script>
<script src="/js/kanban.js"></script>
<script>
    // Configure Blazor to use absolute path for SignalR hub
    // This prevents 404 errors when on /admin/* or other sub-paths
    Blazor.start({
        circuit: {
            configureSignalR: function (builder) {
                builder.withUrl("/_blazor");
            }
        }
    });
</script>

@code {
    private ApplicationUser? currentUser;
    private string? _lastLocation;
    private System.Threading.Timer? _debounceTimer;
    private bool _isFirstRender = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        
        // Subscribe to profile picture updates
        ProfilePictureUpdateService.OnProfilePictureUpdated += HandleProfilePictureUpdated;
        
        // Subscribe to location changes
        NavigationManager.LocationChanged += HandleLocationChanged;
        _lastLocation = NavigationManager.Uri;
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isFirstRender = false;
        }
        return Task.CompletedTask;
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Debounce to avoid double fires
        _debounceTimer?.Dispose();
        
        _debounceTimer = new System.Threading.Timer(_ =>
        {
            try
            {
                var newLocation = e.Location;
                
                // Check if we have a valid previous location
                if (string.IsNullOrEmpty(_lastLocation))
                {
                    _lastLocation = newLocation;
                    return;
                }
                
                var oldUri = new Uri(_lastLocation);
                var newUri = new Uri(newLocation);
                
                // Check if it's a hash change only (same path)
                bool isHashChangeOnly = oldUri.GetLeftPart(UriPartial.Path) == newUri.GetLeftPart(UriPartial.Path);
                
                // Reload user when navigating away from profile page (avatar may have changed)
                if (_lastLocation.Contains("/profile", StringComparison.OrdinalIgnoreCase) && 
                    !newLocation.Contains("/profile", StringComparison.OrdinalIgnoreCase))
                {
                    _ = InvokeAsync(async () =>
                    {
                        await LoadCurrentUser();
                        StateHasChanged();
                    });
                }
                
                // Only scroll if it's not a hash-only change and not the first render
                if (!isHashChangeOnly && !_isFirstRender)
                {
                    // Fire-and-forget is intentional here; we don't need to wait for scroll completion
                    _ = JSRuntime.InvokeVoidAsync("scrollToTop.scrollInstant");
                }
                
                _lastLocation = newLocation;
            }
            catch
            {
                // Ignore errors during navigation or disposal
            }
        }, null, 50, Timeout.Infinite);
    }

    private async Task LoadCurrentUser()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var claimsPrincipal = authState.User;

        if (claimsPrincipal?.Identity?.IsAuthenticated == true)
        {
            // Try multiple ways to get the user identifier
            var userName = claimsPrincipal.Identity.Name;
            var nameIdentifierClaim = claimsPrincipal.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var nameClaim = claimsPrincipal.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value;

            ApplicationUser? user = null;
            
            // Try to find by username first
            if (!string.IsNullOrEmpty(userName))
            {
                user = await UserManager.FindByNameAsync(userName);
            }

            // Try by name claim
            if (user == null && !string.IsNullOrEmpty(nameClaim))
            {
                user = await UserManager.FindByNameAsync(nameClaim);
                if (user == null)
                {
                    user = await UserManager.FindByEmailAsync(nameClaim);
                }
            }

            // Try by user ID from NameIdentifier claim
            if (user == null && !string.IsNullOrEmpty(nameIdentifierClaim))
            {
                user = await UserManager.FindByIdAsync(nameIdentifierClaim);
            }
            
            // Reload the user to ensure we have the latest data from database
            if (user != null)
            {
                // Force Entity Framework to reload from database instead of using cached data
                var entry = UserManager.Users.AsNoTracking().FirstOrDefault(u => u.Id == user.Id);
                currentUser = entry ?? user;
            }
        }
    }

    private string GetNavbarAvatarUrl()
    {
        if (currentUser == null) return "/images/default-avatar.webp";
        return currentUser.ProfilePictureSrc ?? "/images/default-avatar.webp";
    }

    private void HandleProfilePictureUpdated()
    {
        // Reload user data when profile picture is updated
        _ = InvokeAsync(async () =>
        {
            await LoadCurrentUser();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= HandleLocationChanged;
        ProfilePictureUpdateService.OnProfilePictureUpdated -= HandleProfilePictureUpdated;
        _debounceTimer?.Dispose();
    }
}