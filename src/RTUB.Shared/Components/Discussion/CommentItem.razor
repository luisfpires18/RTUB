@namespace RTUB.Shared
@using RTUB.Core.Entities
@using System.ComponentModel.DataAnnotations

<div class="comment-item">
    @if (isEditing)
    {
        <!-- Edit mode -->
        <EditForm Model="@editModel" OnValidSubmit="HandleEditSubmit">
            <DataAnnotationsValidator />
            <div class="mb-2">
                <InputTextArea class="form-control" 
                              rows="3" 
                              @bind-Value="editModel.Body" />
                <ValidationMessage For="@(() => editModel.Body)" />
            </div>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-sm btn-secondary" @onclick="CancelEdit">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-sm btn-primary" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    }
                    Guardar
                </button>
            </div>
        </EditForm>
    }
    else
    {
        <!-- View mode -->
        <div class="comment-header">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <img src="@(Comment.Author.ProfilePictureSrc)" 
                         class="rounded-circle me-2" 
                         alt="@(Comment.Author.Nickname ?? Comment.Author.UserName)" 
                         style="width: 28px; height: 28px; object-fit: cover;" />
                    <div>
                        <div class="fw-bold">@(Comment.Author.Nickname ?? Comment.Author.UserName)</div>
                        <small class="text-muted">
                            @Comment.CreatedAt.ToString("dd MMM yyyy, HH:mm")
                            @if (Comment.IsEdited)
                            {
                                <span>(editado)</span>
                            }
                        </small>
                    </div>
                </div>

                @if (CanEdit || CanDelete)
                {
                    <div class="comment-actions">
                        @if (CanEdit)
                        {
                            <button class="btn btn-sm btn-outline-light" 
                                    @onclick="StartEdit"
                                    title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                        }
                        @if (CanDelete)
                        {
                            <button class="btn btn-sm btn-danger" 
                                    @onclick="OnDelete"
                                    title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="comment-body">
            @if (Comment.IsDeleted)
            {
                <p class="text-muted fst-italic mb-0">
                    <i class="bi bi-ban"></i> Removido por moderação
                </p>
            }
            else
            {
                <p class="mb-0" style="white-space: pre-line;">@Comment.Body</p>
            }
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public Comment Comment { get; set; } = null!;

    [Parameter]
    public bool CanEdit { get; set; }

    [Parameter]
    public bool CanDelete { get; set; }

    [Parameter]
    public EventCallback<string> OnEdit { get; set; }

    [Parameter]
    public EventCallback OnDelete { get; set; }
    
    private bool isEditing = false;
    private bool isSaving = false;
    private CommentEditModel editModel = new();
    
    private void StartEdit()
    {
        editModel = new CommentEditModel { Body = Comment.Body };
        isEditing = true;
    }
    
    private void CancelEdit()
    {
        isEditing = false;
        editModel = new();
    }
    
    private async Task HandleEditSubmit()
    {
        if (isSaving) return;
        
        isSaving = true;
        try
        {
            await OnEdit.InvokeAsync(editModel.Body);
            isEditing = false;
            editModel = new();
        }
        finally
        {
            isSaving = false;
        }
    }
    
    private class CommentEditModel
    {
        [Required(ErrorMessage = "O comentário é obrigatório")]
        [MinLength(1, ErrorMessage = "O comentário deve ter pelo menos 1 caractere")]
        public string Body { get; set; } = string.Empty;
    }
}
