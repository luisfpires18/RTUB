@namespace RTUB.Shared
@using System.ComponentModel.DataAnnotations

<div class="comment-composer">
    <EditForm Model="@model" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ErrorDisplay />

        <div class="mb-3">
            <InputTextArea class="form-control" 
                          rows="3" 
                          @bind-Value="model.Body" 
                          placeholder="Escreva um comentário... Use arroba-usuario para mencionar alguém" />
            <ValidationMessage For="@(() => model.Body)" />
        </div>

        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-primary-purple" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                Comentar
            </button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter]
    public EventCallback<string> OnSubmit { get; set; }

    private CommentComposerModel model = new();
    private bool isSubmitting = false;

    private async Task HandleSubmit()
    {
        if (isSubmitting) return;

        isSubmitting = true;
        try
        {
            await OnSubmit.InvokeAsync(model.Body);
            model = new CommentComposerModel(); // Reset form
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private class CommentComposerModel
    {
        [Required(ErrorMessage = "O comentário é obrigatório")]
        [MinLength(1, ErrorMessage = "O comentário deve ter pelo menos 1 caractere")]
        public string Body { get; set; } = string.Empty;
    }
}
