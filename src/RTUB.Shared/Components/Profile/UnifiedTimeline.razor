@namespace RTUB.Shared
@using RTUB.Core.Entities
@using RTUB.Core.Enums
@using RTUB.Application.Extensions
@using RTUB.Application.Helpers

@*
    UnifiedTimeline Component
    Displays a unified timeline combining membership progression (LEITÃO → CALOIRO → TUNO) 
    with role assignments, all in chronological order
*@

<div class="unified-timeline @AdditionalClasses">
    @if (TimelineItems.Any())
    {
        <div class="timeline-container-unified">
            @{
                var orderedItems = TimelineItems.OrderBy(t => t.Year).ThenBy(t => t.Order).ToList();
                var lastIndex = orderedItems.Count - 1;
            }
            @for (int i = 0; i < orderedItems.Count; i++)
            {
                var item = orderedItems[i];
                <div class="timeline-item-unified @GetItemStateClass(item)">
                    @if (item.Position.HasValue && item.Position.Value == Position.Magister)
                    {
                        <div class="timeline-crown">
                            <i class="bi bi-star-fill"></i>
                        </div>
                    }
                    @if (item.Category.HasValue && item.Category.Value == MemberCategory.Fundador)
                    {
                        <div class="timeline-crown">
                            <i class="bi bi-award-fill"></i>
                        </div>
                    }
                    <div class="timeline-badge-unified">
                        <i class="bi @GetItemIcon(item)"></i>
                    </div>
                    <div class="timeline-content-unified">
                        <span class="timeline-label-unified">@item.Label</span>
                        <span class="timeline-year-unified">@GetYearDisplay(item)</span>
                        @if (!string.IsNullOrEmpty(item.Notes))
                        {
                            <span class="timeline-notes text-muted">@item.Notes</span>
                        }
                    </div>
                </div>
                
                @if (i < lastIndex)
                {
                    <div class="timeline-connector-unified"></div>
                }
            }
        </div>
    }
    else
    {
        <span class="text-muted profile-empty-value" title="Este campo ainda não foi preenchido">
            Não definido
            <i class="bi bi-info-circle-fill ms-1" style="font-size: 0.85em;"></i>
        </span>
    }
</div>

@code {
    [Parameter]
    public ApplicationUser User { get; set; } = null!;

    [Parameter]
    public List<RoleAssignment> RoleAssignments { get; set; } = new();

    [Parameter]
    public string AdditionalClasses { get; set; } = "";

    public class TimelineItemModel
    {
        public int Year { get; set; }
        public int Order { get; set; } // For sorting items in the same year
        public string Label { get; set; } = "";
        public string Type { get; set; } = ""; // "membership", "subcategory", or "role"
        public string State { get; set; } = ""; // "active", "completed", or ""
        public int? EndYear { get; set; }
        public string? Notes { get; set; }
        public Position? Position { get; set; } // For role items
        public MemberCategory? Category { get; set; } // For membership items
    }

    private List<TimelineItemModel> TimelineItems
    {
        get
        {
            var items = new List<TimelineItemModel>();
            var currentYear = DateTime.Now.Year;

            // Add membership milestones
            if (User.YearLeitao.HasValue)
            {
                items.Add(new TimelineItemModel
                {
                    Year = User.YearLeitao.Value,
                    Order = 1,
                    Label = "LEITÃO",
                    Type = "membership",
                    State = User.IsLeitao() && !User.IsCaloiro() && !User.IsTuno() ? "active" : "completed",
                    Category = MemberCategory.Leitao
                });
            }

            if (User.YearCaloiro.HasValue)
            {
                items.Add(new TimelineItemModel
                {
                    Year = User.YearCaloiro.Value,
                    Order = 2,
                    Label = "CALOIRO",
                    Type = "membership",
                    State = User.IsCaloiro() && !User.IsTuno() ? "active" : User.IsTuno() ? "completed" : "",
                    Category = MemberCategory.Caloiro
                });
            }

            if (User.YearTuno.HasValue)
            {
                // Always add TUNO item
                items.Add(new TimelineItemModel
                {
                    Year = User.YearTuno.Value,
                    Order = 3,
                    Label = "TUNO",
                    Type = "membership",
                    State = "active",
                    Category = MemberCategory.Tuno
                });
                
                // If user is Fundador, also add Fundador item
                if (User.IsFundador())
                {
                    items.Add(new TimelineItemModel
                    {
                        Year = User.YearTuno.Value,
                        Order = 4, // Same year but shown after TUNO
                        Label = "FUNDADOR",
                        Type = "subcategory",
                        State = "active",
                        Category = MemberCategory.Fundador
                    });
                }
            }

            // Add VETERANO and TUNOSSAURO as separate items if qualified
            if (User.YearTuno.HasValue)
            {
                if (User.QualifiesForVeterano())
                {
                    var veteranoYear = User.YearTuno.Value + 2;
                    items.Add(new TimelineItemModel
                    {
                        Year = veteranoYear,
                        Order = 4,
                        Label = "VETERANO",
                        Type = "subcategory",
                        State = "active",
                        Category = MemberCategory.Veterano
                    });
                }

                if (User.QualifiesForTunossauro())
                {
                    var tunossauroYear = User.YearTuno.Value + 6;
                    items.Add(new TimelineItemModel
                    {
                        Year = tunossauroYear,
                        Order = 5,
                        Label = "TUNOSSAURO",
                        Type = "subcategory",
                        State = "active",
                        Category = MemberCategory.Tunossauro
                    });
                }
            }

            // Add role assignments
            foreach (var assignment in RoleAssignments.OrderBy(a => a.StartYear))
            {
                items.Add(new TimelineItemModel
                {
                    Year = assignment.StartYear,
                    Order = 10, // Roles come after memberships in the same year
                    Label = StatusHelper.GetPositionDisplay(assignment.Position),
                    Type = "role",
                    State = assignment.EndYear >= currentYear ? "active" : "completed",
                    EndYear = assignment.EndYear,
                    Notes = assignment.Notes,
                    Position = assignment.Position
                });
            }

            return items;
        }
    }

    private string GetItemStateClass(TimelineItemModel item)
    {
        var classes = new List<string>();
        
        // Add state class
        if (item.State == "active")
            classes.Add("active");
        else if (item.State == "completed")
            classes.Add("completed");
        
        // Add category-specific or position-specific class
        if (item.Category.HasValue)
        {
            classes.Add(item.Category.Value switch
            {
                MemberCategory.Leitao => "timeline-leitao",
                MemberCategory.Caloiro => "timeline-caloiro",
                MemberCategory.Tuno => "timeline-tuno",
                MemberCategory.Veterano => "timeline-veterano",
                MemberCategory.Tunossauro => "timeline-tunossauro",
                MemberCategory.Fundador => "timeline-fundador",
                _ => ""
            });
        }
        else if (item.Position.HasValue)
        {
            // Check if it's Magister for special purple color, otherwise green
            if (item.Position.Value == Position.Magister)
                classes.Add("timeline-magister");
            else
                classes.Add("timeline-role");
        }
        
        return string.Join(" ", classes.Where(c => !string.IsNullOrEmpty(c)));
    }

    private string GetItemIcon(TimelineItemModel item)
    {
        return item.Type switch
        {
            "membership" => "bi-circle-fill",
            "subcategory" => "bi-arrow-right-circle-fill",
            "role" => "bi-star-fill",
            _ => "bi-circle-fill"
        };
    }

    private string GetYearDisplay(TimelineItemModel item)
    {
        if (item.EndYear.HasValue && item.Type == "role")
        {
            return $"{item.Year}–{item.EndYear}";
        }
        return item.Year.ToString();
    }
}
