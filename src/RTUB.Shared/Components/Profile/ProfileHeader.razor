@namespace RTUB.Shared
@using RTUB.Core.Entities
@using RTUB.Core.Enums
@using RTUB.Application.Helpers
@using RTUB.Application.Extensions

@*
    ProfileHeader Component
    Displays the user's header card with avatar, display name, tuna name, role badges, and primary actions
*@

<div class="profile-header-card card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <!-- Avatar Section -->
            <div class="col-12 col-md-auto text-center mb-3 mb-md-0">
                <div class="profile-avatar-wrapper">
                    <img src="@GetProfilePictureUrl()" alt="Foto de Perfil" class="profile-avatar" />
                </div>
                <button class="btn btn-sm btn-outline-light mt-2 d-md-none" @onclick="OnUploadPhoto">
                    <i class="bi bi-upload"></i> Carregar Foto
                </button>
            </div>

            <!-- User Info Section -->
            <div class="col-12 col-md">
                <div class="profile-header-info">
                    <h2 class="profile-display-name mb-1">@GetDisplayName()</h2>
                    @if (!string.IsNullOrEmpty(User.Nickname))
                    {
                        <p class="profile-tuna-name text-muted mb-2">
                            <i class="bi bi-quote"></i> @User.Nickname
                        </p>
                    }
                    
                    <!-- Role Badges -->
                    <div class="profile-badges mb-2">
                        @{
                            var displayCategories = StatusHelper.GetDisplayCategories(User);
                        }
                        @foreach (var category in displayCategories)
                        {
                            <CategoryBadge Category="category" AdditionalClasses="me-1 mb-1" />
                        }
                        @if (User.Positions.Any())
                        {
                            @foreach (var position in User.Positions)
                            {
                                <PositionBadge Position="position" AdditionalClasses="me-1 mb-1" />
                            }
                        }
                    </div>

                    <!-- Primary Actions - Desktop -->
                    <div class="d-none d-md-flex gap-2 mt-3">
                        <button class="btn btn-sm btn-outline-light" @onclick="OnUploadPhoto">
                            <i class="bi bi-upload"></i> Carregar Foto
                        </button>
                        <button class="btn btn-sm btn-primary btn-primary-purple" @onclick="OnEditProfile">
                            <i class="bi bi-pencil"></i> Editar Perfil
                        </button>
                        <button class="btn btn-sm btn-outline-light" @onclick="OnChangePassword">
                            <i class="bi bi-key"></i> Alterar Palavra-passe
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Primary Actions - Mobile (Stacked) -->
        <div class="d-md-none mt-3">
            <div class="d-grid gap-2">
                <button class="btn btn-primary btn-primary-purple" @onclick="OnEditProfile">
                    <i class="bi bi-pencil"></i> Editar Perfil
                </button>
                <button class="btn btn-outline-light" @onclick="OnChangePassword">
                    <i class="bi bi-key"></i> Alterar Palavra-passe
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public ApplicationUser User { get; set; } = null!;

    [Parameter]
    public long ProfilePictureVersion { get; set; }

    [Parameter]
    public EventCallback OnEditProfile { get; set; }

    [Parameter]
    public EventCallback OnChangePassword { get; set; }

    [Parameter]
    public EventCallback OnUploadPhoto { get; set; }

    private string GetProfilePictureUrl()
    {
        if (User == null) return "/images/default-avatar.png";
        
        if (!string.IsNullOrEmpty(User.ProfilePictureSrc) && User.ProfilePictureSrc.StartsWith("/api/images/"))
        {
            return $"{User.ProfilePictureSrc}?v={ProfilePictureVersion}";
        }
        return User.ProfilePictureSrc ?? "/images/default-avatar.png";
    }

    private string GetDisplayName()
    {
        if (User == null) return "";
        return $"{User.FirstName} {User.LastName}";
    }
}
