@namespace RTUB.Shared
@*
    RehearsalCard Component
    Compact card for displaying rehearsal information with attendance actions
*@

<div class="card rehearsal-card h-100">
    <div class="position-relative">
        @if (IsAdmin)
        {
            <div class="rehearsal-admin-overlay">
                <button class="btn btn-sm music-btn-edit" @onclick="HandleEdit" title="Editar">
                    <i class="bi bi-pencil music-icon-edit"></i>
                </button>
                <button class="btn btn-sm music-btn-delete" @onclick="HandleDelete" title="Eliminar">
                    <i class="bi bi-trash music-icon-delete"></i>
                </button>
            </div>
        }
        <div class="rehearsal-icon-header">
            <div class="rehearsal-icon-circle">
                <i class="bi bi-music-note-beamed"></i>
            </div>
        </div>
    </div>
    <div class="card-body d-flex flex-column">
        @if (Rehearsal.IsCanceled)
        {
            <div class="rehearsal-status-badge cancelled">
                <i class="bi bi-x-circle"></i> Cancelado
            </div>
        }
        
        <div class="rehearsal-info">
         
            <!-- Date, Time and Day in one row -->
            <div class="rehearsal-info-row">
                <i class="bi bi-calendar3 rehearsal-icon"></i>
                <span class="rehearsal-text">@Rehearsal.Date.ToString("dd MMM yyyy")</span>
                <span class="rehearsal-day">(@GetDayOfWeek(Rehearsal.Date))</span>
            </div>
            
            <div class="rehearsal-info-row">
                <i class="bi bi-clock rehearsal-icon"></i>
                <span class="rehearsal-text">@Rehearsal.StartTime.ToString(@"hh\:mm") - @Rehearsal.EndTime.ToString(@"hh\:mm")</span>
                @if (Rehearsal.Date.Date == DateTime.Today)
                {
                    <span class="rehearsal-today-badge">Hoje</span>
                }
            </div>
            
            @if (!string.IsNullOrEmpty(Rehearsal.Location))
            {
                <div class="rehearsal-info-row">
                    <i class="bi bi-geo-alt rehearsal-icon"></i>
                    <span class="rehearsal-text">@Rehearsal.Location</span>
                </div>
            }
            
            @if (!string.IsNullOrEmpty(Rehearsal.Theme))
            {
                <div class="rehearsal-theme-row">
                    <span class="rehearsal-theme-label">Tema:</span>
                    <span class="rehearsal-theme-text">@Rehearsal.Theme</span>
                </div>
            }
        </div>

        @if (!Rehearsal.IsCanceled)
        {
            <div class="rehearsal-actions-section mt-auto p-2 rounded">
                <!-- First row: View Details and View Attendances buttons -->
                <div class="d-flex flex-wrap gap-2 align-items-center justify-content-center mb-2">
                    <!-- View Details button -->
                    <button class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1 rehearsal-action-btn" 
                            @onclick="HandleViewDetails" 
                            title="Ver Detalhes">
                        <i class="bi bi-eye-fill icon-size-1rem"></i>
                        <span>Ver</span>
                    </button>

                    <!-- View Attendances button -->
                    <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1 rehearsal-action-btn" 
                            @onclick="HandleViewAttendances" 
                            title="Ver Presenças">
                        <i class="bi bi-people icon-size-1rem"></i>
                        <span>@AttendanceCount</span>
                    </button>
                </div>

                @if (!IsPastRehearsal)
                {
                    <!-- Second row: User attendance action buttons -->
                    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-center">
                        @if (UserAttendance == null)
                        {
                            <!-- Mark Attendance button -->
                            <button class="btn btn-sm btn-purple d-flex align-items-center gap-1 rehearsal-mark-btn" 
                                    @onclick="HandleMarkAttendance" 
                                    title="Marcar Presença">
                                <i class="bi bi-plus-circle-fill icon-size-1rem"></i>
                                <span>Marcar</span>
                            </button>
                        }
                        else
                        {
                            <!-- Attendance Pending button (disabled, warning) -->
                            <button class="btn btn-sm btn-warning d-flex align-items-center gap-1 rehearsal-status-btn" 
                                    disabled 
                                    title="Presença Pendente">
                                <i class="bi bi-clock-fill icon-size-1rem"></i>
                                <span>Pendente</span>
                            </button>
                            
                            <!-- Edit Attendance button (white) -->
                            <button class="btn btn-sm btn-light d-flex align-items-center rehearsal-edit-btn" 
                                    @onclick="HandleEditAttendance" 
                                    title="Editar Presença">
                                <i class="bi bi-pencil-fill icon-size-1rem"></i>
                                <span class="d-none d-sm-inline ms-1">Editar</span>
                            </button>
                            
                            <!-- Remove Attendance button (red) -->
                            <button class="btn btn-sm btn-danger d-flex align-items-center rehearsal-remove-btn" 
                                    @onclick="HandleRemoveAttendance" 
                                    title="Remover Presença">
                                <i class="bi bi-x-circle-fill icon-size-1rem"></i>
                                <span class="d-none d-sm-inline ms-1">Remover</span>
                            </button>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    /// <summary>
    /// The rehearsal to display
    /// </summary>
    [Parameter]
    public Rehearsal Rehearsal { get; set; } = null!;

    /// <summary>
    /// The current user's attendance for this rehearsal (if any)
    /// </summary>
    [Parameter]
    public RehearsalAttendance? UserAttendance { get; set; }

    /// <summary>
    /// Total number of attendances for this rehearsal
    /// </summary>
    [Parameter]
    public int AttendanceCount { get; set; }

    /// <summary>
    /// Whether the current user has admin privileges
    /// </summary>
    [Parameter]
    public bool IsAdmin { get; set; }

    /// <summary>
    /// Whether this is a past rehearsal (changes display behavior)
    /// </summary>
    [Parameter]
    public bool IsPastRehearsal { get; set; }

    /// <summary>
    /// Callback when the edit button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnEdit { get; set; }

    /// <summary>
    /// Callback when the delete button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnDelete { get; set; }

    /// <summary>
    /// Callback when the mark attendance button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnMarkAttendance { get; set; }

    /// <summary>
    /// Callback when the view attendances button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnViewAttendances { get; set; }

    /// <summary>
    /// Callback when the edit attendance button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnEditAttendance { get; set; }

    /// <summary>
    /// Callback when the remove attendance button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnRemoveAttendance { get; set; }

    /// <summary>
    /// Callback when the view details button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnViewDetails { get; set; }

    // Handler methods to ensure events fire properly
    private async Task HandleViewAttendances()
    {
        if (OnViewAttendances.HasDelegate)
        {
            await OnViewAttendances.InvokeAsync();
        }
    }

    private async Task HandleViewDetails()
    {
        if (OnViewDetails.HasDelegate)
        {
            await OnViewDetails.InvokeAsync();
        }
    }

    private async Task HandleMarkAttendance()
    {
        if (OnMarkAttendance.HasDelegate)
        {
            await OnMarkAttendance.InvokeAsync();
        }
    }

    private async Task HandleEditAttendance()
    {
        if (OnEditAttendance.HasDelegate)
        {
            await OnEditAttendance.InvokeAsync();
        }
    }

    private async Task HandleRemoveAttendance()
    {
        if (OnRemoveAttendance.HasDelegate)
        {
            await OnRemoveAttendance.InvokeAsync();
        }
    }

    private async Task HandleEdit()
    {
        if (OnEdit.HasDelegate)
        {
            await OnEdit.InvokeAsync();
        }
    }

    private async Task HandleDelete()
    {
        if (OnDelete.HasDelegate)
        {
            await OnDelete.InvokeAsync();
        }
    }

    // Helper method to get day of week in Portuguese
    private string GetDayOfWeek(DateTime date)
    {
        return date.DayOfWeek switch
        {
            DayOfWeek.Monday => "Segunda",
            DayOfWeek.Tuesday => "Terça",
            DayOfWeek.Wednesday => "Quarta",
            DayOfWeek.Thursday => "Quinta",
            DayOfWeek.Friday => "Sexta",
            DayOfWeek.Saturday => "Sábado",
            DayOfWeek.Sunday => "Domingo",
            _ => ""
        };
    }
}

<style>
    .rehearsal-action-btn {
        min-width: 80px;
        flex: 1 1 auto;
    }

    .rehearsal-mark-btn {
        min-width: 110px;
        flex: 1 1 auto;
    }

    .rehearsal-status-btn {
        min-width: 110px;
        flex: 1 1 auto;
    }

    .rehearsal-edit-btn,
    .rehearsal-remove-btn {
        min-width: 44px;
        flex: 0 1 auto;
    }

    /* Mobile responsiveness */
    @@media (max-width: 576px) {
        .rehearsal-action-btn {
            min-width: calc(50% - 0.25rem);
            flex: 1 1 calc(50% - 0.25rem);
        }

        .rehearsal-mark-btn {
            min-width: 100%;
            flex: 1 1 100%;
        }

        .rehearsal-status-btn {
            min-width: 100%;
            flex: 1 1 100%;
        }

        .rehearsal-edit-btn,
        .rehearsal-remove-btn {
            min-width: calc(50% - 0.25rem);
            flex: 1 1 calc(50% - 0.25rem);
        }
    }
</style>
