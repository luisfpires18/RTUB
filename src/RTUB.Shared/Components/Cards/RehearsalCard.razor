@namespace RTUB.Shared
@*
    RehearsalCard Component
    Reusable card for displaying rehearsal information with attendance actions
*@

<div class="card event-card h-100">
    <div class="position-relative">
        <div class="card-img-top event-image-placeholder">
            <i class="bi bi-music-note-beamed music-icon-large"></i>
        </div>
        @if (IsAdmin)
        {
            <div class="admin-overlay">
                <button class="btn btn-sm music-btn-edit" @onclick="HandleEdit" title="Editar">
                    <i class="bi bi-pencil music-icon-edit"></i>
                </button>
                <button class="btn btn-sm music-btn-delete" @onclick="HandleDelete" title="Eliminar">
                    <i class="bi bi-trash music-icon-delete"></i>
                </button>
            </div>
        }
    </div>
    <div class="card-body d-flex flex-column">
        <h5 class="card-title">
            @if (Rehearsal.IsCanceled)
            {
                <span class="text-danger"><i class="bi bi-x-circle"></i> Cancelado</span>
            }
            else
            {
                <span>Ensaio</span>
            }
        </h5>
        <p class="card-text text-light-theme">
            <small>
                <i class="bi bi-calendar me-1"></i>
                <span>@Rehearsal.Date.ToString("dd MMM yyyy")</span>
            </small>
        </p>
        <p class="card-text text-light-theme">
            <small>
                <i class="bi bi-clock"></i> @Rehearsal.StartTime.ToString(@"hh\:mm") - @Rehearsal.EndTime.ToString(@"hh\:mm")
            </small>
        </p>
        @if (!string.IsNullOrEmpty(Rehearsal.Location))
        {
            <p class="card-text text-light-theme">
                <small>
                    <i class="bi bi-geo-alt"></i> @Rehearsal.Location
                </small>
            </p>
        }
        @if (!string.IsNullOrEmpty(Rehearsal.Theme))
        {
            <p class="card-text">
                <small><strong>Tema:</strong> @Rehearsal.Theme</small>
            </p>
        }
        @if (!string.IsNullOrEmpty(Rehearsal.Notes))
        {
            <p class="card-text flex-grow-1">@Rehearsal.Notes</p>
        }

        @if (!IsPastRehearsal && !Rehearsal.IsCanceled)
        {
            <div class="enrollment-section mt-auto p-2 rounded">
                <div class="d-flex gap-2 align-items-center justify-content-center">
                    <!-- View Attendances button -->
                    <button class="btn btn-sm btn-outline-info btn-sm-padded" @onclick="HandleViewAttendances" title="Ver Presenças">
                        <i class="bi bi-people icon-size-1rem"></i> @AttendanceCount
                    </button>

                    <!-- User attendance buttons container -->
                    <div class="d-flex gap-1 enrollment-actions">
                        @if (UserAttendance == null)
                        {
                            <button class="btn btn-sm btn-purple btn-sm-padded" @onclick="HandleMarkAttendance" title="Marcar Presença">
                                <i class="bi bi-plus-circle-fill icon-size-1rem"></i>
                            </button>
                        }
                        else
                        {
                            @if (UserAttendance.Attended)
                            {
                                <button class="btn btn-sm btn-success btn-sm-padded" disabled title="Presença Aprovada">
                                    <i class="bi bi-check-circle-fill icon-size-1rem"></i>
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-warning btn-sm-padded" disabled title="Presença Pendente">
                                    <i class="bi bi-clock-fill icon-size-1rem"></i>
                                </button>
                            }
                            <button class="btn btn-sm btn-light btn-sm-padded" @onclick="HandleEditAttendance" title="Editar Presença">
                                <i class="bi bi-pencil-fill icon-size-1rem"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-sm-padded" @onclick="HandleRemoveAttendance" title="Remover Presença">
                                <i class="bi bi-x-circle-fill icon-size-1rem"></i>
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    /// <summary>
    /// The rehearsal to display
    /// </summary>
    [Parameter]
    public Rehearsal Rehearsal { get; set; } = null!;

    /// <summary>
    /// The current user's attendance for this rehearsal (if any)
    /// </summary>
    [Parameter]
    public RehearsalAttendance? UserAttendance { get; set; }

    /// <summary>
    /// Total number of attendances for this rehearsal
    /// </summary>
    [Parameter]
    public int AttendanceCount { get; set; }

    /// <summary>
    /// Whether the current user has admin privileges
    /// </summary>
    [Parameter]
    public bool IsAdmin { get; set; }

    /// <summary>
    /// Whether this is a past rehearsal (changes display behavior)
    /// </summary>
    [Parameter]
    public bool IsPastRehearsal { get; set; }

    /// <summary>
    /// Callback when the edit button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnEdit { get; set; }

    /// <summary>
    /// Callback when the delete button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnDelete { get; set; }

    /// <summary>
    /// Callback when the mark attendance button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnMarkAttendance { get; set; }

    /// <summary>
    /// Callback when the view attendances button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnViewAttendances { get; set; }

    /// <summary>
    /// Callback when the edit attendance button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnEditAttendance { get; set; }

    /// <summary>
    /// Callback when the remove attendance button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnRemoveAttendance { get; set; }

    // Handler methods to ensure events fire properly
    private async Task HandleViewAttendances()
    {
        if (OnViewAttendances.HasDelegate)
        {
            await OnViewAttendances.InvokeAsync();
        }
    }

    private async Task HandleMarkAttendance()
    {
        if (OnMarkAttendance.HasDelegate)
        {
            await OnMarkAttendance.InvokeAsync();
        }
    }

    private async Task HandleEditAttendance()
    {
        if (OnEditAttendance.HasDelegate)
        {
            await OnEditAttendance.InvokeAsync();
        }
    }

    private async Task HandleRemoveAttendance()
    {
        if (OnRemoveAttendance.HasDelegate)
        {
            await OnRemoveAttendance.InvokeAsync();
        }
    }

    private async Task HandleEdit()
    {
        if (OnEdit.HasDelegate)
        {
            await OnEdit.InvokeAsync();
        }
    }

    private async Task HandleDelete()
    {
        if (OnDelete.HasDelegate)
        {
            await OnDelete.InvokeAsync();
        }
    }
}
