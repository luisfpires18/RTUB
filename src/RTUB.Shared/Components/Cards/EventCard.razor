@namespace RTUB.Shared
@*
    EventCard Component
    Reusable card for displaying event information with enrollment actions
*@

<div class="card event-card h-100">
    <div class="position-relative">
        @if (!string.IsNullOrEmpty(ImageUrl) || !string.IsNullOrEmpty(Event.ImageSrc))
        {
            <img src="@(ImageUrl ?? Event.ImageSrc)" class="card-img-top event-image" alt="@Event.Name">
        }
        else
        {
            <div class="card-img-top event-image-placeholder">
                <i class="bi bi-calendar-event music-icon-large"></i>
            </div>
        }
        
        @* Trophy corner badge for AboutUsContent (Festival events only) *@
        @if (ShowTrophyCorner && Event.Type == EventType.Festival)
        {
            <div class="position-absolute top-0 end-0 p-2">
                <div class="badge bg-warning text-dark">
                    <i class="bi bi-trophy-fill"></i>
                </div>
            </div>
        }
        
        @if (IsAdmin)
        {
            <div class="admin-overlay">
                <button class="btn btn-sm music-btn-edit" 
                        @onclick="OnEdit" 
                        title="Editar evento">
                    <i class="bi bi-pencil music-icon-edit"></i>
                </button>
                <button class="btn btn-sm music-btn-delete" 
                        @onclick="OnDelete" 
                        title="Eliminar evento">
                    <i class="bi bi-trash music-icon-delete"></i>
                </button>
            </div>
            
            @* Email notification button in bottom-right corner *@
            @if (!IsPastEvent)
            {
                <div class="position-absolute bottom-0 end-0 p-2">
                    <button class="btn btn-sm btn-primary music-btn-email" 
                            @onclick="OnSendEmail" 
                            title="Notificar por email">
                        <i class="bi bi-envelope-fill"></i>
                    </button>
                </div>
            }
        }
    </div>
    <div class="card-body d-flex flex-column p-3">
        <h5 class="card-title mb-2">@Event.Name</h5>
        <p class="card-text text-light-theme mb-2">
            <small>
                <i class="bi bi-calendar me-1"></i>
                @if (Event.EndDate.HasValue && Event.EndDate.Value.Date != Event.Date.Date)
                {
                    <span>@Event.Date.ToString("dd MMM") - @Event.EndDate.Value.ToString("dd MMM yyyy")</span>
                }
                else
                {
                    <span>@Event.Date.ToString("dd MMM yyyy")</span>
                }
            </small>
        </p>
        @if (!string.IsNullOrEmpty(Event.Location))
        {
            <p class="card-text text-light-theme mb-2">
                <small>
                    <i class="bi bi-geo-alt me-1"></i> @Event.Location
                </small>
            </p>
        }

        @if (ShowOnlyTrophy)
        {
            <!-- Show only trophy button (for public portal) -->
            @if (Event.Type == EventType.Festival)
            {
                <div class="enrollment-section mt-auto p-2 rounded">
                    <div class="event-buttons-container">
                        <button class="btn event-icon-btn btn-warning" 
                                @onclick="OnViewTrophies" 
                                title="Prémios">
                            <i class="bi bi-trophy-fill"></i>
                        </button>
                    </div>
                </div>
            }
        }
        else if (ShowButtons)
        {
            @if (!IsPastEvent)
            {
                <div class="enrollment-section mt-auto p-2 rounded">
                    <!-- Event buttons row -->
                    <div class="event-buttons-container mb-2">
                        <!-- View Details button -->
                        <button class="btn event-icon-btn btn-outline-secondary" 
                                @onclick="OnViewDetails" 
                                title="Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>

                        <!-- View Enrollments button with centered count -->
                        <button class="btn event-icon-btn event-icon-btn-with-count btn-outline-secondary" 
                                @onclick="OnViewEnrollments" 
                                title="Participantes">
                            <i class="bi bi-people"></i>
                            <span class="enrollment-count-centered">@EnrollmentCount</span>
                        </button>

                        <!-- Watch Repertoire button -->
                        <button class="btn event-icon-btn btn-outline-primary" 
                                @onclick="OnWatchRepertoire" 
                                title="Repertório">
                            <i class="bi bi-music-note-list"></i>
                        </button>
                    </div>

                    <!-- Enrollment action buttons row -->
                    <div class="event-buttons-container">
                        @if (UserEnrollment == null)
                        {
                            <!-- Enroll button -->
                            <button class="btn event-icon-btn btn-purple" 
                                    @onclick="OnEnroll" 
                                    title="Inscrever">
                                <i class="bi bi-plus-circle-fill"></i>
                            </button>
                        }
                        else if (UserEnrollment.WillAttend)
                        {
                            <!-- Enrolled status button (disabled, purple) -->
                            <button class="btn event-icon-btn btn-purple" 
                                    disabled 
                                    title="Inscrito">
                                <i class="bi bi-check-circle-fill"></i>
                            </button>
                            
                            <!-- Edit enrollment button (white) -->
                            <button class="btn event-icon-btn btn-light" 
                                    @onclick="OnEditEnrollment" 
                                    title="Editar Inscrição">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            
                            <!-- Remove enrollment button (red) -->
                            <button class="btn event-icon-btn btn-danger" 
                                    @onclick="OnRemoveEnrollment" 
                                    title="Cancelar Inscrição">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        }
                        else
                        {
                            <!-- Not attending status button (disabled, red) -->
                            <button class="btn event-icon-btn btn-danger" 
                                    disabled 
                                    title="Não vou">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                            
                            <!-- Edit enrollment button (white) -->
                            <button class="btn event-icon-btn btn-light" 
                                    @onclick="OnEditEnrollment" 
                                    title="Editar Inscrição">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                        }
                    </div>
                </div>
            }
            else
            {
                <!-- Past event buttons -->
                <div class="enrollment-section mt-auto p-2 rounded">
                    <div class="event-buttons-container">
                        <!-- View Details button -->
                        <button class="btn event-icon-btn btn-outline-secondary" 
                                @onclick="OnViewDetails" 
                                title="Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>

                        <!-- View Enrollments button with centered count -->
                        <button class="btn event-icon-btn event-icon-btn-with-count btn-outline-secondary" 
                                @onclick="OnViewEnrollments" 
                                title="Participantes">
                            <i class="bi bi-people"></i>
                            <span class="enrollment-count-centered">@EnrollmentCount</span>
                        </button>

                        <!-- Watch Repertoire button -->
                        <button class="btn event-icon-btn btn-outline-primary" 
                                @onclick="OnWatchRepertoire" 
                                title="Repertório">
                            <i class="bi bi-music-note-list"></i>
                        </button>

                        <!-- Trophy button (for Festival events only) -->
                        @if (ShowTrophy && Event.Type == EventType.Festival)
                        {
                            <button class="btn event-icon-btn btn-warning" 
                                    @onclick="OnViewTrophies" 
                                    title="Prémios">
                                <i class="bi bi-trophy-fill"></i>
                            </button>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    /// <summary>
    /// The event to display
    /// </summary>
    [Parameter]
    public Event Event { get; set; } = null!;

    /// <summary>
    /// The current user's enrollment for this event (if any)
    /// </summary>
    [Parameter]
    public Enrollment? UserEnrollment { get; set; }

    /// <summary>
    /// Total number of enrollments for this event
    /// </summary>
    [Parameter]
    public int EnrollmentCount { get; set; }

    /// <summary>
    /// Whether the current user has admin privileges
    /// </summary>
    [Parameter]
    public bool IsAdmin { get; set; }

    /// <summary>
    /// Whether this is a past event (changes display behavior)
    /// </summary>
    [Parameter]
    public bool IsPastEvent { get; set; }

    /// <summary>
    /// Callback when the edit button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnEdit { get; set; }

    /// <summary>
    /// Callback when the delete button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnDelete { get; set; }

    /// <summary>
    /// Callback when the send email button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnSendEmail { get; set; }

    /// <summary>
    /// Callback when the enroll button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnEnroll { get; set; }

    /// <summary>
    /// Callback when the view enrollments button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnViewEnrollments { get; set; }

    /// <summary>
    /// Callback when the edit enrollment button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnEditEnrollment { get; set; }

    /// <summary>
    /// Callback when the remove enrollment button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnRemoveEnrollment { get; set; }

    /// <summary>
    /// Callback when the watch repertoire button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnWatchRepertoire { get; set; }

    /// <summary>
    /// Callback when the view details button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnViewDetails { get; set; }

    /// <summary>
    /// Callback when the view trophies button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnViewTrophies { get; set; }

    /// <summary>
    /// Optional image URL to display (supports cache-busting)
    /// </summary>
    [Parameter]
    public string? ImageUrl { get; set; }

    /// <summary>
    /// Whether to show the trophy button in action section (for past events)
    /// </summary>
    [Parameter]
    public bool ShowTrophy { get; set; }

    /// <summary>
    /// Whether to show trophy corner badge (for AboutUsContent)
    /// </summary>
    [Parameter]
    public bool ShowTrophyCorner { get; set; }

    /// <summary>
    /// Whether to show action buttons (default: true, false for public portal)
    /// </summary>
    [Parameter]
    public bool ShowButtons { get; set; } = true;

    /// <summary>
    /// Whether to show only the trophy button (for public portal with trophies)
    /// </summary>
    [Parameter]
    public bool ShowOnlyTrophy { get; set; }
}

<style>
    /* Horizontal scrollable container for buttons */
    .event-buttons-container {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: center;
        overflow-x: auto;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        padding: 0.25rem 0;
    }
    
    /* Hide scrollbar for cleaner look */
    .event-buttons-container::-webkit-scrollbar {
        height: 4px;
    }
    
    .event-buttons-container::-webkit-scrollbar-track {
        background: rgba(111, 66, 193, 0.1);
        border-radius: 2px;
    }
    
    .event-buttons-container::-webkit-scrollbar-thumb {
        background: rgba(111, 66, 193, 0.3);
        border-radius: 2px;
    }
    
    .event-buttons-container::-webkit-scrollbar-thumb:hover {
        background: rgba(111, 66, 193, 0.5);
    }
    
    /* Icon-only square buttons */
    .event-icon-btn {
        width: 52px;
        height: 52px;
        min-width: 52px;
        min-height: 52px;
        padding: 0;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        border-radius: 0.75rem;
        position: relative;
        flex-shrink: 0;
        transition: all 0.2s ease;
    }
    
    .event-icon-btn i {
        font-size: 1.25rem;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Enrollment count badge (top-right corner - legacy, kept for compatibility) */
    .event-icon-btn .enrollment-count {
        position: absolute;
        top: -4px;
        right: -4px;
        background-color: #6f42c1;
        color: white;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 2px 5px;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
        line-height: 1.2;
        border: 2px solid var(--bs-body-bg);
    }
    
    /* Enrollment count to the right of icon */
    .event-icon-btn .enrollment-count-centered {
        position: relative;
        color: inherit;
        font-size: 1.25rem;
        font-weight: 700;
        line-height: 1;
    }
    
    /* Participants button with count needs to be wider */
    .event-icon-btn-with-count {
        width: auto;
        min-width: 52px;
        padding: 0 0.5rem;
    }
    
    /* Button hover effects */
    .event-icon-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .event-icon-btn:disabled {
        opacity: 0.65;
        cursor: not-allowed;
    }
    
    /* Mobile adjustments */
    @@media (max-width: 768px) {
        .event-buttons-container {
            justify-content: flex-start;
            padding-left: 0.25rem;
            padding-right: 0.25rem;
        }
    }
    
    .music-btn-email {
        background: rgba(106, 27, 154, 0.9);
        border: none;
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        transition: all 0.3s ease;
    }
    
    .music-btn-email:hover {
        background: rgba(106, 27, 154, 1);
        transform: scale(1.05);
    }
</style>
